<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Consultas de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Aptos', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif; }
        #auth-container, #app-container { transition: opacity 0.5s ease-in-out; }
        .table-sort-button { background: none; border: none; cursor: pointer; font-weight: 700; width: 100%; text-align: inherit; display: flex; align-items: center; justify-content: inherit; gap: 4px; color: inherit; }
        .table-sort-button:hover { color: #4f46e5; }
        .table-sort-button.active { /* Color heredado del th */ }
        .sort-icon { width: 16px; height: 16px; transition: transform 0.2s ease-in-out; }
        .table-sort-button.active.asc .sort-icon { transform: rotate(180deg); }
        .table-sort-button.active.desc .sort-icon { transform: rotate(0deg); }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #38bdf8; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }
        .loader { border: 2px solid #f1f5f9; border-top: 2px solid #6366f1; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 240px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 20; border-radius: 8px; border: 1px solid #e2e8f0; padding: 8px 0; margin-top: 4px; }
        .dropdown-content.show { display: block; }
        .dropdown-content a, .dropdown-content button { color: #334155; padding: 10px 16px; text-decoration: none; display: flex; align-items:center; gap: 8px; font-size: 14px; font-weight: 500; transition: background-color 0.2s; width: 100%; text-align: left; background: none; border: none; cursor: pointer;}
        .dropdown-content a:hover, .dropdown-content button:hover { background-color: #f1f5f9; }
        .dropdown-divider { height: 1px; margin: 8px 0; overflow: hidden; background-color: #e2e8f0; }
        .query-result-row { cursor: pointer; transition: background-color 0.2s; }
        .query-result-row:hover { background-color: #f8fafc; }
        .admin-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .admin-tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .online-indicator { display: inline-block; width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; margin-right: 8px; }
        .btn-main-style {
            background-color: white;
            color: #334155;
            font-weight: 600;
            padding: 0 12px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border-radius: 0.375rem;
            border: 1px solid #cbd5e1;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 36px;
        }
        .btn-main-style:hover {
            background-color: #f8fafc;
            border-color: #94a3b8;
        }
        .nav-link {
            padding: 8px 16px;
            font-weight: 600;
            color: #475569;
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
        }
        .nav-link:hover {
            color: #1e293b;
            background-color: #f1f5f9;
        }
        .nav-link.active {
            color: #ffffff;
            background-color: #6366f1;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .nav-link.active::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -16px; /* Se ajusta para que la línea toque el borde inferior de la barra de navegación */
            height: 4px;
            background-color: #6366f1;
        }
        .kpi-card { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .favorite-btn {
            background: none;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .favorite-btn:hover {
            background-color: #fef9c3;
            border-color: #fde047;
        }
        .favorite-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .favorite-btn:disabled:hover {
            background-color: transparent;
        }
        .favorite-btn svg {
            width: 18px;
            height: 18px;
            stroke: #fde047;
            stroke-width: 2;
        }
        .favorite-btn.is-favorite {
            background-color: #16a34a; /* green-600 */
            border-color: #16a34a;
        }
        .favorite-btn.is-favorite:hover {
            background-color: #15803d; /* green-700 */
            border-color: #15803d;
        }
        .favorite-btn.is-favorite svg {
            fill: white;
            stroke: white;
        }
        .consumo-chart-wrapper { display: flex; height: 250px; padding-top: 20px; border-top: 1px solid #e2e8f0; margin-top: 1rem; padding-bottom: 25px; /* Espacio para etiquetas X */ }
        .consumo-y-axis { display: flex; flex-direction: column; justify-content: space-between; height: 100%; padding-right: 10px; text-align: right; font-size: 12px; color: #64748b; }
        .consumo-chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 100%; flex-grow: 1; border-left: 1px solid #e2e8f0; position: relative; }
        .consumo-chart-bar-wrapper { 
            position: relative; /* Clave para posicionar la etiqueta */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 8%;
            height: 100%; /* Clave para que la altura % de la barra funcione */
            justify-content: flex-end; /* Pone la barra en la parte inferior */
        }
        .consumo-chart-bar { width: 60%; border-radius: 4px 4px 0 0; position: relative; display: flex; justify-content: center; align-items: flex-start; transition: height 0.3s ease-out, background-color 0.3s ease-out; }
        .consumo-chart-projected-line { position: absolute; width: 100%; border-top: 2px dashed #ef4444; left: 0; z-index: 5; }
        .consumo-chart-projected-label { position: absolute; right: -4px; top: 0; transform: translateY(-50%); background-color: #ef4444; color: white; padding: 1px 4px; font-size: 10px; font-weight: bold; border-radius: 4px; }
        .consumo-chart-value { padding-top: 8px; color: white; font-weight: 600; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .consumo-chart-label {
            position: absolute;
            bottom: -22px; /* La mueve debajo del eje 0 */
            font-size: 12px; 
            color: #64748b; 
        }
        .indice-coverage-btn {
            padding: 0 10px;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            color: #c7d2fe;
            height: 32px;
        }
        .indice-coverage-btn:not(.active):hover {
            background-color: #4f46e5;
            color: white;
        }
        .indice-coverage-btn.active {
            background-color: white;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            border-color: #cbd5e1;
            color: #1e293b;
        }
        .notification-item.unread { background-color: #eef2ff; }
        .notification-item:hover { background-color: #f8fafc; }
        .history-table thead th {
            position: sticky;
            top: 0;
            background-color: #f1f5f9; /* slate-100 */
            z-index: 10;
        }
        .history-table thead th:first-child {
            left: 0;
            z-index: 20;
            border-right: 1px solid #e2e8f0;
        }
        .history-table tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 10;
            border-right: 1px solid #e2e8f0;
        }
        .history-table tbody tr:hover td:first-child {
            background-color: #f8fafc; /* slate-50 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="auth-container" class="hidden min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="inline-block">
                    <svg width="64" height="64" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="50" fill="#6366f1"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M50 18L15 85H31L50 46L69 85H85L50 18ZM50 58L40 85H60L50 58Z" fill="white"/>
                    </svg>
                </div>
            </div>
            
            <div id="login-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-slate-800">ALMACEN</h2>
                <p class="text-center text-sm text-slate-500 mt-1 mb-6">v2.10</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-slate-700">Email</label>
                        <input id="login-email" type="email" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-slate-700">Contraseña</label>
                        <input id="login-password" type="password" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm text-center h-5"></div>
                    <div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Iniciar Sesión</button></div>
                </form>
                <p class="mt-6 text-center text-sm text-slate-500">¿No tienes cuenta? <button id="show-register-view-btn" class="font-medium text-blue-600 hover:text-blue-500">Regístrate</button></p>
            </div>
            
            <div id="register-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-slate-800">Crear Cuenta</h2>
                <p id="register-subtitle" class="text-center text-sm text-slate-500 mt-1 mb-6">El primer usuario será Administrador.</p>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-email" class="text-sm font-medium text-slate-700">Email</label>
                        <input id="register-email" type="email" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-password" class="text-sm font-medium text-slate-700">Contraseña</label>
                        <input id="register-password" type="password" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="register-error" class="text-red-500 text-sm text-center h-5"></div>
                    <div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Registrar</button></div>
                </form>
                <p class="mt-6 text-center text-sm text-slate-500">¿Ya tienes cuenta? <button id="show-login-view-btn" class="font-medium text-blue-600 hover:text-blue-500">Inicia sesión</button></p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-14">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center gap-2">
                            <svg width="32" height="32" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="50" fill="#6366f1"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M50 18L15 85H31L50 46L69 85H85L50 18ZM50 58L40 85H60L50 58Z" fill="white"/>
                            </svg>
                            <span class="font-bold text-xl text-slate-800">ALMACEN</span>
                            <span class="ml-2 text-xs font-semibold text-slate-400">v2.10</span>
                        </div>
                        <div class="hidden md:block">
                            <div id="main-nav-links" class="ml-10 flex items-center space-x-1">
                                <button data-view="dashboard" class="nav-link active uppercase">Dashboard</button>
                                <button data-view="consumos" class="nav-link uppercase">Análisis</button>
                                <button data-view="indice" class="nav-link uppercase">Insumos</button>
                                <button data-view="solpeds" class="nav-link uppercase">SOLPEDS</button>
                                <button data-view="ocs" class="nav-link uppercase">O/C</button>
                                <button data-view="reportes" class="nav-link uppercase">Reportes</button>
                                <button data-view="revision" class="nav-link hidden uppercase">Revisión</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="db-info-container"></div>
                        <div id="notification-container" class="relative hidden">
                            <button id="notification-bell-btn" class="p-2 rounded-full hover:bg-slate-100 relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                                <span id="notification-count-badge" class="absolute top-0 right-0 block h-4 w-4 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center" style="font-size: 10px; display: none;"></span>
                            </button>
                            <div id="notification-dropdown" class="dropdown-content" style="min-width: 360px; max-height: 400px; overflow-y: auto;">
                            </div>
                        </div>
                        <div id="user-menu-container" class="relative">
                            <button id="user-menu-button" class="flex items-center gap-2 p-2 rounded-full hover:bg-slate-100 disabled:cursor-default disabled:hover:bg-transparent">
                                <div id="user-avatar" class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center"></div>
                                <span id="user-name" class="font-semibold text-sm hidden sm:block"></span>
                            </button>
                            <div id="user-dropdown-content" class="dropdown-content">
                                <div class="px-4 py-3 border-b border-slate-200">
                                    <p id="user-dropdown-email" class="text-sm font-semibold text-slate-800 truncate"></p>
                                    <p id="user-dropdown-role" class="text-xs font-medium text-indigo-600 uppercase"></p>
                                </div>

                                <div class="py-1">
                                    <button id="admin-button-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg><span class="uppercase">Configuración</span></button>
                                </div>
                                
                                <div id="admin-actions-divider" class="dropdown-divider hidden"></div>
                                
                                <div class="py-1">
                                    <button id="dashboard-preload-btn-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><span class="uppercase">Precarga BD</span></button>
                                    <button id="dashboard-clear-btn-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span class="uppercase">Limpiar BD</span></button>
                                </div>
                                
                                <div id="links-divider" class="dropdown-divider hidden"></div>

                                <div class="py-1">
                                    <a id="iweb-sap-link-dropdown" href="#" target="_blank" rel="noopener noreferrer" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3L4 7l4 4"/><path d="M4 7h16"/><path d="M16 21l4-4-4-4"/><path d="M20 17H4"/></svg><span class="uppercase">IWEB vs SAP</span></a>
                                    <a id="depositos-externos-link-dropdown" href="#" target="_blank" rel="noopener noreferrer" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><span class="uppercase">DEPOSITOS EXTERNOS</span></a>
                                </div>

                                <div class="dropdown-divider"></div>
                                
                                <div class="py-1">
                                    <button id="manual-button-dropdown"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg><span class="uppercase">Manual de Usuario</span></button>
                                </div>
                                
                                <div class="dropdown-divider"></div>

                                <div class="py-1">
                                    <button id="logout-button-dropdown"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span class="uppercase">Cerrar Sesión</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main>
            <div id="dashboard-view">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 p-4 sm:p-6 lg:p-8 items-start">
                    <!-- Columna Izquierda -->
                    <div class="flex flex-col gap-6 lg:col-span-8">
                        <div id="kpi-container" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4"></div>
                        <div id="kpi-detail-container" class="hidden"></div>
                    </div>
                    <!-- Columna Derecha -->
                    <div class="flex flex-col gap-6 lg:col-span-4">
                        <div id="date-week-container">
                            <!-- JS will inject date and week here -->
                        </div>
                        <div id="low-stock-container" class="bg-white rounded-lg shadow">
                            <!-- Content will be injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="indice-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold text-white">INSUMOS</h2>
                            <span id="indice-counter" class="text-sm font-medium text-indigo-200"></span>
                            <div id="indice-group-filter-container" class="mr-4"></div>
                            <div class="relative">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="indice-search-input" placeholder="Buscar por nombre o código..." class="w-80 p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                            </div>
                            <button id="indice-clear-filters-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <div id="indice-coverage-filter-buttons" class="flex items-center p-1 bg-indigo-600 rounded-lg">
                                <button data-filter="all" class="indice-coverage-btn active">Todos</button>
                                <button data-filter="red" class="indice-coverage-btn"></button>
                                <button data-filter="yellow" class="indice-coverage-btn"></button>
                                <button data-filter="green" class="indice-coverage-btn"></button>
                            </div>
                            <div class="h-6 border-l border-slate-200 mx-2"></div>
                            <button id="export-indice-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                            <div class="h-6 border-l border-slate-200 mx-2"></div>
                            <button id="add-new-item-btn" class="btn-main-style bg-blue-600 text-white hover:bg-blue-700 border-blue-600 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="indice-table-container" class="max-h-[calc(100vh-145px)] overflow-y-auto">
                    <!-- La tabla del indice se inyectará aquí -->
                </div>
            </div>

            <div id="consumos-view" class="hidden">
                <div class="flex flex-col h-full">
                    <div class="bg-indigo-500 p-4 z-10">
                        <div class="flex items-center gap-4">
                            <div id="primary-search-wrapper" class="w-[55%]">
                                <div class="flex items-center gap-2 w-full">
                                    <div id="consumo-group-filter-container"></div>
                                    <button id="consumo-favorites-filter-btn" data-type="primary" class="favorite-btn flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                                    </button>
                                    <div class="relative flex-grow">
                                        <input type="text" id="consumo-search-input" placeholder="Buscar producto 1..." class="w-full p-2 pl-10 pr-8 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <button id="consumo-clear-text-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 rounded-full hidden">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                        <div id="consumo-search-results" class="absolute top-full left-0 right-0 bg-white border mt-1 rounded-lg shadow-lg z-20 max-h-60 overflow-y-auto hidden"></div>
                                    </div>
                                    <button id="consumo-clear-primary-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="h-6 border-l border-white/40 mx-2"></div>
                            <div id="comparison-search-wrapper" class="w-[45%]">
                                <div class="flex items-center gap-2 w-full">
                                    <div id="consumo-comparison-group-filter-container"></div>
                                    <button id="consumo-comparison-favorites-filter-btn" data-type="comparison" class="favorite-btn flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                                    </button>
                                    <div class="relative flex-grow">
                                        <input type="text" id="consumo-comparison-search-input" placeholder="Buscar producto 2..." class="w-full p-2 pl-10 pr-8 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <button id="consumo-comparison-clear-text-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 rounded-full hidden">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                        <div id="consumo-comparison-search-results" class="absolute top-full left-0 right-0 bg-white border mt-1 rounded-lg shadow-lg z-20 max-h-60 overflow-y-auto hidden"></div>
                                    </div>
                                    <button id="consumo-clear-comparison-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="consumo-content-area" class="flex-grow flex">
                        <!-- Contenido dinámico (2 paneles) -->
                    </div>
                </div>
            </div>

            <div id="solpeds-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold text-white">SOLPEDS</h2>
                            <span id="solpeds-counter" class="text-sm font-medium text-indigo-200"></span>
                            <div id="solpeds-group-filter-container" class="mr-2"></div>
                            <div id="solpeds-date-filter-container" class="flex items-center gap-2"></div>
                            <div class="relative">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="solpeds-search-input" placeholder="Buscar..." class="w-80 p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                            </div>
                            <button id="solpeds-clear-filters-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="solpeds-delayed-filter-btn" class="btn-main-style">Demoradas</button>
                            <div class="h-6 border-l border-slate-200 mx-2"></div>
                            <button id="export-solpeds-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="solpeds-table-container" class="max-h-[calc(100vh-145px)] overflow-y-auto">
                    <!-- La tabla de Solpeds se inyectará aquí -->
                </div>
            </div>
            
            <div id="ocs-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                           <h2 class="text-2xl font-bold text-white">O/C</h2>
                           <span id="ocs-counter" class="text-sm font-medium text-indigo-200"></span>
                           <div id="ocs-group-filter-container" class="mr-2"></div>
                           <div id="ocs-date-filter-container" class="flex items-center gap-2"></div>
                           <div class="relative">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="ocs-search-input" placeholder="Buscar..." class="w-80 p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                           </div>
                           <button id="ocs-clear-filters-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                           </button>
                        </div>
                        <div class="flex items-center gap-2">
                           <div id="ocs-status-filter-container" class="mr-2"></div>
                           <button id="ocs-delayed-filter-btn" class="btn-main-style">Demoradas</button>
                           <div class="h-6 border-l border-slate-200 mx-2"></div>
                           <button id="export-ocs-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="ocs-table-container" class="max-h-[calc(100vh-145px)] overflow-y-auto">
                    <!-- La tabla de OCs se inyectará aquí -->
                </div>
            </div>

            <div id="reportes-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold text-white">REPORTE DE STOCK INMOVILIZADO</h2>
                             <span id="immobilized-counter" class="text-sm font-medium text-indigo-200"></span>
                            <div class="relative">
                               <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                               <input type="text" id="immobilized-search-input" placeholder="Buscar..." class="w-80 p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                           </div>
                        </div>
                        <button id="export-immobilized-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                    </div>
                </div>
                
                <div id="immobilized-report-content">
                    <div id="immobilized-stock-table-container" class="max-h-[calc(100vh-145px)] overflow-y-auto"></div>
                </div>
            </div>

            <div id="revision-view" class="hidden">
                <div class="flex h-[calc(100vh-56px)]"> <!-- 56px is nav height -->
                    <!-- Columna Izquierda: Log de Revisiones (70%) -->
                    <div class="w-[70%] border-r border-slate-200 flex flex-col bg-white">
                        <div class="bg-indigo-500 p-4 flex justify-between items-center flex-shrink-0">
                            <h2 class="text-2xl font-bold text-white">LOG DE REVISIONES</h2>
                            <div class="flex items-center gap-4">
                                <div class="relative">
                                   <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    <input type="text" id="history-search-input" placeholder="Buscar grupo..." class="w-80 p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                                </div>
                                <button id="export-history-btn" class="btn-main-style hover:bg-green-50 hover:text-green-700">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                </button>
                            </div>
                        </div>
                        <div id="history-table-container" class="flex-grow overflow-auto">
                        </div>
                    </div>
                    <!-- Columna Derecha: Revisión Semanal (30%) -->
                    <div class="w-[30%] p-4 bg-slate-50 flex flex-col space-y-4">
                        <div id="progress-bar-container" class="w-full hidden flex-shrink-0 items-center gap-4">
                            <span id="week-number-display" class="text-2xl font-bold text-indigo-700 whitespace-nowrap"></span>
                            <div class="w-full bg-slate-200 rounded-full h-8 relative">
                                <div id="progress-bar" class="bg-indigo-500 h-8 rounded-full transition-all duration-500" style="width: 0%"></div>
                                <span id="progress-bar-text" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">0%</span>
                            </div>
                        </div>
                        <div id="review-container" class="bg-white rounded-lg shadow overflow-hidden hidden flex-grow flex flex-col min-h-0">
                            <div class="bg-indigo-500 p-4 flex justify-between items-center flex-shrink-0 rounded-t-lg">
                                <h2 class="text-xl font-bold text-white">Revisión Semanal</h2>
                                <div class="flex items-center gap-2">
                                    <button id="save-review-btn" class="btn-main-style !bg-white/90 !text-indigo-700 hover:!bg-white">Guardar</button>
                                    <button id="clear-review-btn" class="btn-main-style !bg-white/90 !text-red-700 hover:!bg-white">Limpiar</button>
                                </div>
                            </div>
                            <div id="groups-review-list" class="flex-grow overflow-y-auto">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Modales -->
        <div id="item-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
                <form id="item-form">
                    <h3 id="item-modal-title" class="text-lg leading-6 font-medium text-slate-900">Agregar Nuevo Insumo</h3>
                    <div class="mt-4 space-y-4">
                        <div>
                            <label for="item-group" class="block text-sm font-medium text-slate-700">Grupo</label>
                            <input type="text" id="item-group" list="group-datalist" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <datalist id="group-datalist"></datalist>
                        </div>
                        <div>
                            <label for="item-code" class="block text-sm font-medium text-slate-700">Código</label>
                            <input type="text" id="item-code" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="item-name" class="block text-sm font-medium text-slate-700">Nombre</label>
                            <input type="text" id="item-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div>
                            <label for="item-stock" class="block text-sm font-medium text-slate-700">Stock Inicial</label>
                            <input type="number" id="item-stock" required value="0" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                    <div class="items-center px-4 py-3 mt-4 text-right">
                        <button id="close-item-modal" type="button" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md shadow-sm hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 mr-2">Cancelar</button>
                        <button id="save-item-button" type="submit" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
        <div id="preload-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Precarga masiva de datos</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-slate-500 mb-4"> Selecciona un archivo <code class="text-xs bg-slate-100 p-1 rounded">.xlsx</code>. Hojas requeridas:<br> <code class="text-xs bg-slate-100 p-1 rounded">Inventario</code>, <code class="text-xs bg-slate-100 p-1 rounded">Historial Consumo</code>, <code class="text-xs bg-slate-100 p-1 rounded">Solped</code>, <code class="text-xs bg-slate-100 p-1 rounded">OC</code></p>
                        <input type="file" id="preload-file-input" accept=".xlsx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                        <div id="preload-feedback" class="mt-4 text-sm h-5"></div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="process-preload-data" class="flex items-center justify-center px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50"> <span id="process-preload-text">Procesar y Sincronizar Datos</span> <span id="process-preload-loader" class="loader hidden"></span> </button>
                        <button id="close-preload-modal" class="mt-2 px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400"> Cerrar </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="confirm-clear-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"> <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /> </svg> </div>
                    <h3 id="confirm-modal-title" class="text-lg leading-6 font-medium text-slate-900 mt-4"></h3>
                    <div class="mt-2 px-7 py-3"> <p id="confirm-modal-text" class="text-sm text-slate-500"></p> </div>
                    <div class="items-center px-4 py-3 flex justify-center gap-4"> <button id="cancel-clear-button" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400"> Cancelar </button> <button id="confirm-clear-button" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Sí, Continuar</button> </div>
                </div>
            </div>
        </div>
        <div id="admin-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-800">Panel de Administración</h2>
                    <button id="close-admin-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div class="border-b border-slate-200">
                    <nav class="flex -mb-px" id="admin-tabs">
                        <button data-tab="permissions" class="admin-tab active">Usuarios y Permisos</button>
                        <button data-tab="settings" class="admin-tab">Configuración</button>
                    </nav>
                </div>
                <div id="admin-content-permissions" class="py-4">
                    <p class="text-sm text-slate-600 mb-4">Gestiona los roles de los usuarios registrados. El rol "Propietario" no puede ser modificado.</p>
                    <div id="permissions-list" class="max-h-[50vh] overflow-y-auto"></div>
                </div>
                <div id="admin-content-settings" class="py-4 hidden">
                     <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-medium text-slate-900">Umbrales de Cobertura (Días)</h3>
                            <p class="text-sm text-slate-500 mt-1">Define los rangos para los indicadores de color en toda la aplicación.</p>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="setting-red-threshold" class="block text-sm font-medium text-slate-700">Rojo (Crítico) - Límite superior</label>
                                    <input type="number" id="setting-red-threshold" class="mt-1 block w-full bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="setting-yellow-threshold" class="block text-sm font-medium text-slate-700">Amarillo (Precaución) - Límite superior</label>
                                    <input type="number" id="setting-yellow-threshold" class="mt-1 block w-full bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-slate-200 pt-6">
                             <h3 class="text-lg font-medium text-slate-900">Notificaciones</h3>
                             <p class="text-sm text-slate-500 mt-1">Define cuándo se deben generar las notificaciones de stock bajo.</p>
                             <div class="mt-4">
                                 <label for="setting-notification-threshold" class="block text-sm font-medium text-slate-700">Alertar insumos con cobertura menor a (días)</label>
                                 <input type="number" id="setting-notification-threshold" class="mt-1 block w-full md:w-1/2 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             </div>
                        </div>
                         <div class="border-t border-slate-200 pt-6">
                             <h3 class="text-lg font-medium text-slate-900">Análisis de Reportes</h3>
                             <p class="text-sm text-slate-500 mt-1">Configuraciones para los reportes generados.</p>
                             <div class="mt-4">
                                 <label for="setting-immobilization-months" class="block text-sm font-medium text-slate-700">Meses para análisis de stock inmovilizado</label>
                                 <input type="number" id="setting-immobilization-months" class="mt-1 block w-full md:w-1/2 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             </div>
                         </div>
                        <div class="border-t border-slate-200 pt-6">
                            <h3 class="text-lg font-medium text-slate-900">Enlaces Externos</h3>
                            <p class="text-sm text-slate-500 mt-1">Configura URLs para enlaces en el menú de usuario.</p>
                            <div class="mt-4">
                                <label for="setting-iweb-sap-url" class="block text-sm font-medium text-slate-700">URL para "IWEB vs SAP"</label>
                                <input type="url" id="setting-iweb-sap-url" placeholder="https://ejemplo.com" class="mt-1 block w-full md:w-1/2 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="mt-4">
                                <label for="setting-depositos-externos-url" class="block text-sm font-medium text-slate-700">URL para "DEPOSITOS EXTERNOS"</label>
                                <input type="url" id="setting-depositos-externos-url" placeholder="https://ejemplo.com" class="mt-1 block w-full md:w-1/2 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                         <div class="border-t border-slate-200 pt-6">
                             <h3 class="text-lg font-medium text-slate-900">Visualización de Consumos</h3>
                             <p class="text-sm text-slate-500 mt-1">Selecciona los meses del historial de consumo que se mostrarán en el gráfico.</p>
                             <div id="consumption-months-checkboxes" class="mt-4 grid grid-cols-4 sm:grid-cols-6 gap-x-6 gap-y-3">
                                <!-- Checkboxes for months -->
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="0" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M1</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="1" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M2</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="2" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M3</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="3" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M4</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="4" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M5</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="5" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M6</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="6" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M7</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="7" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M8</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="8" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M9</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="9" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M10</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="10" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M11</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="11" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> <span class="text-sm font-medium text-slate-700">M12</span></label>
                             </div>
                        </div>
                     </div>
                     <div class="mt-8 flex justify-end">
                        <button id="save-settings-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Guardar Cambios</button>
                     </div>
                </div>
            </div>
        </div>
        <div id="record-consumption-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Insumos con Consumo Récord</h3>
                    <button id="close-record-consumption-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <p class="text-sm text-slate-500 mb-4">Este reporte muestra los insumos cuyo consumo en el último mes ha superado su pico histórico registrado.</p>
                <div id="record-consumption-item-list" class="max-h-60 overflow-y-auto">
                    <!-- Item list will be injected here -->
                </div>
            </div>
        </div>
        <div id="group-stats-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Estadísticas por Grupo</h3>
                    <button id="close-group-stats-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div id="group-stats-list" class="max-h-[60vh] overflow-y-auto">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
        <div id="delayed-solpeds-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Solpeds Vencidas por Grupo de Compras</h3>
                    <button id="close-delayed-solpeds-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <p class="text-sm text-slate-500 mb-4">Este reporte desglosa las Solicitudes de Pedido cuya fecha de liberación ya ha pasado, agrupadas por responsable de compras.</p>
                <div id="delayed-solpeds-list" class="max-h-[60vh] overflow-y-auto">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
        <div id="delayed-ocs-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">O/C Vencidas por Grupo de Compras</h3>
                    <button id="close-delayed-ocs-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <p class="text-sm text-slate-500 mb-4">Este reporte desglosa las Órdenes de Compra cuya fecha de entrega ya ha pasado, agrupadas por responsable de compras.</p>
                <div id="delayed-ocs-list" class="max-h-[60vh] overflow-y-auto">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
        <div id="manual-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                 <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h2 class="text-2xl font-semibold text-slate-800">Guía Rápida - Insumos Almacén</h2>
                    <button id="close-manual-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div class="prose max-w-none max-h-[75vh] overflow-y-auto pr-4 text-slate-600">
                    
                    <h3 class="font-semibold text-slate-900 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Roles y Permisos</h3>
                    <p>La aplicación tiene 3 roles con distintos niveles de acceso:</p>
                    <div class="not-prose mt-4 grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                        <!-- Rol Propietario -->
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                                <svg viewBox="0 0 100 100" class="w-6 h-6"><circle cx="50" cy="50" r="50" fill="#6366f1"/><path fill-rule="evenodd" clip-rule="evenodd" d="M50 18L15 85H31L50 46L69 85H85L50 18ZM50 58L40 85H60L50 58Z" fill="white"/></svg>
                                <span>Propietario</span>
                            </h4>
                            <p class="text-indigo-600 mt-1 mb-4 h-10">Control total sobre la aplicación, datos y usuarios.</p>
                            <ul class="space-y-1 text-xs">
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Administra usuarios.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Accede a Configuración.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Realiza la revisión semanal.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Ve el historial de revisiones.</span></li>
                            </ul>
                        </div>
                        <!-- Rol Editor -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-lg font-bold text-green-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                <span>Editor</span>
                            </h4>
                            <p class="text-green-600 mt-1 mb-4 h-10">Gestión de datos del inventario.</p>
                             <ul class="space-y-1 text-xs">
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Agrega, edita y elimina insumos.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Marca favoritos y edita notas.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Precarga y limpia la base de datos.</span></li>
                            </ul>
                        </div>
                        <!-- Rol Visor -->
                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <span>Visor</span>
                            </h4>
                            <p class="text-slate-600 mt-1 mb-4 h-10">Acceso de solo lectura.</p>
                             <ul class="space-y-1 text-xs">
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Visualiza todos los datos.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg><span>No puede realizar ninguna modificación.</span></li>
                            </ul>
                        </div>
                    </div>

                    <h3 class="font-semibold text-slate-900 mt-8 pt-4 border-t flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>Dashboard</h3>
                    <ul class="list-none pl-0 space-y-3">
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg></div><div><strong>Indicadores (KPIs):</strong> Resumen del estado del inventario. Haz clic en ellos para ver detalles, como filtrar por favoritos o ver reportes de O/C vencidas.</div></li>
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div><div><strong>Revisión Semanal:</strong> Controla el progreso de revisión de los grupos de insumos. Función para Propietarios.</div></li>
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg></div><div><strong>Insumos Críticos:</strong> Tabla de acceso rápido a productos con baja cobertura de stock.</div></li>
                    </ul>

                    <h3 class="font-semibold text-slate-900 mt-8 pt-4 border-t flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>Insumos</h3>
                     <ul class="list-none pl-0 space-y-3">
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></div><div><strong>Búsqueda y Filtros:</strong> Usa la barra para buscar por nombre/código. Filtra por <strong>Cobertura</strong> (rojo, amarillo, verde), <strong>Grupos</strong> o <strong>Favoritos</strong>.</div></li>
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></div><div><strong>Favoritos:</strong> Haz clic en la <strong>estrella (★)</strong> para marcar/desmarcar un insumo. Es la forma más rápida de acceder a tus productos clave.</div></li>
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"></path><line x1="8" y1="16" x2="8" y2="16"></line><line x1="8" y1="20" x2="8" y2="20"></line><line x1="12" y1="18" x2="12" y2="18"></line><line x1="12" y1="22" x2="12" y2="22"></line><line x1="16" y1="16" x2="16" y2="16"></line><line x1="16" y1="20" x2="16" y2="20"></line></svg></div><div><strong>Navegación:</strong> Haz clic en cualquier fila de la tabla para ir a la vista de <strong>Análisis de Consumos</strong> de ese producto.</div></li>
                    </ul>

                    <h3 class="font-semibold text-slate-900 mt-8 pt-4 border-t flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>Análisis de Consumos</h3>
                    <ul class="list-none pl-0 space-y-3">
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"/></svg></div><div><strong>Gráfico de Consumo:</strong> Visualiza el historial mensual. Una línea punteada roja marca el consumo proyectado para una referencia rápida.</div></li>
                         <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></div><div><strong>Notas y Pedidos:</strong> Revisa las Solpeds/O.C. asociadas y añade notas importantes sobre el insumo.</div></li>
                    </ul>
                    
                    <h3 class="font-semibold text-slate-900 mt-8 pt-4 border-t flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>SOLPEDS y O/C</h3>
                    <p>Tablas detalladas con todas las Solicitudes de Pedido y Órdenes de Compra. Permiten buscar, filtrar por pedidos demorados y ordenar la información.</p>

                    <h3 class="font-semibold text-slate-900 mt-8 pt-4 border-t flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>Administración (Solo Propietarios)</h3>
                    <p>Panel accesible desde el <strong>menú de usuario</strong> para configurar la aplicación.</p>
                     <ul class="list-none pl-0 space-y-3">
                        <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></div><div><strong>Gestión de Datos:</strong> Carga masiva desde Excel o limpia la base de datos (conservando favoritos y notas).</div></li>
                         <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div><strong>Permisos:</strong> Asigna roles de Editor o Visor a otros usuarios.</div></li>
                         <li class="flex items-start gap-3"><div class="pt-1"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div><div><strong>Configuración:</strong> Define los umbrales de cobertura (días), el umbral para notificaciones y los meses a mostrar en el gráfico de consumo.</div></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ESTADO DE LA APLICACIÓN ---
        let items = [];
        let solpeds = [];
        let ocs = [];
        let notifications = [];
        let appSettings = {
            coverageThresholds: { red: 30, yellow: 60 },
            notificationThreshold: 15,
            consumptionMonths: [true, true, true, true, true, true, true, true, true, true, true, true],
            immobilizationMonths: 6,
            iwebSapUrl: '',
            depositosExternosUrl: ''
        };
        let solpedsSortConfig = { key: 'fechaSolicitud', direction: 'desc' };
        let ocsSortConfig = { key: 'proxFechaEntrega', direction: 'asc' };
        let indiceSortConfig = { key: 'group', direction: 'asc' };
        let immobilizedSortConfig = { key: 'monthsWithoutConsumption', direction: 'desc' };
        let allUserPermissions = new Map();
        let currentView = 'dashboard';
        let isAuthReady = false;
        let selectedConsumptionItemId = null;
        let comparisonItemId = null;
        let consumoSelectedGroup = 'all';
        let consumoShowOnlyFavorites = false;
        let consumoComparisonSelectedGroup = 'all';
        let consumoComparisonShowOnlyFavorites = false;
        let showOnlyDelayedOCs = false;
        let ocsSelectedGroup = 'all';
        let ocsSelectedStatus = 'all';
        let ocsSelectedYear = 'all';
        let ocsSelectedMonths = [];
        let showOnlyDelayedSolpeds = false;
        let solpedsSelectedGroup = 'all';
        let solpedsSelectedYear = 'all';
        let solpedsSelectedMonths = [];
        let showOnlyFavoriteCriticals = false;
        let criticalsSelectedGroup = 'all';
        let indiceSearchTerm = '';
        let indiceSelectedGroup = 'all';
        let indiceShowFavorites = false;
        let indiceCoverageFilter = 'all';
        let notesSaveTimeout;
        let activeKpi = null;
        let isInitialLoad = true;
        
        // --- VARIABLES DE FIREBASE Y USUARIO ---
        let app, db, auth, userId, appId;
        let inventoryCollectionRef, permissionsCollectionRef, metadataDocRef, reviewHistoryCollectionRef, solpedsCollectionRef, ocsCollectionRef, appConfigDocRef;
        let unsubscribeInventory, unsubscribePermissions, unsubscribeMetadata, unsubscribeSolpeds, unsubscribeOCs, unsubscribeAppConfig;
        let currentUserRole = 'viewer';
        
        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCpEzBrL-Yi6kwPshw63UgwqnNOXWHH9eU",
          authDomain: "gestion-inventario-app-a11d6.firebaseapp.com",
          projectId: "gestion-inventario-app-a11d6",
          storageBucket: "gestion-inventario-app-a11d6.appspot.com",
          messagingSenderId: "817333595251",
          appId: "1:817333595251:web:437b7b2f91bdae506f4e06"
        };

        // --- FUNCIONES DE UTILIDAD ---
        function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => { toast.remove(); }, 5000); }
        
        function getCurrentDateString() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0!
            const year = today.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function handleCopyText(textToCopy, buttonElement) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = `<span class="text-xs font-bold text-green-600">Copiado!</span>`;
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                }, 2000);
            } catch (err) {
                console.error('Error al copiar texto: ', err);
                showToast('No se pudo copiar el texto.', 'error');
            }
            document.body.removeChild(tempTextArea);
        }

        function formatDate(isoDateString) {
            if (!isoDateString) return '';
            const date = parseDateString(isoDateString);
            if (!date) return isoDateString;

            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            
            return `${day}-${month}-${year}`;
        }

        function parseDateString(dateStr) {
            if (!dateStr || (typeof dateStr !== 'string' && typeof dateStr !== 'number') || String(dateStr).trim() === '') return null;
            
            if(typeof dateStr === 'number' && dateStr > 1) {
                const d = new Date((dateStr - 25569) * 86400000);
                 if (d instanceof Date && !isNaN(d)) {
                     d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                     return d;
                 }
            }

            const trimmedStr = String(dateStr).trim();
            
            const matchDMY = trimmedStr.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{4})$/);
            if (matchDMY) {
                const day = parseInt(matchDMY[1], 10);
                const month = parseInt(matchDMY[2], 10) - 1;
                const year = parseInt(matchDMY[3], 10);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    const d = new Date(Date.UTC(year, month, day));
                    if (d.getUTCFullYear() === year && d.getUTCMonth() === month && d.getUTCDate() === day) {
                        return d;
                    }
                }
            }

            const isoDate = new Date(trimmedStr + 'T00:00:00Z');
            if (!isNaN(isoDate.getTime())) {
                return isoDate;
            }

            return null;
        }

        const parseAndFormatDateToISO = (val) => {
            if (!val) return '';
            const d = parseDateString(val);
            if (d) return d.toISOString().split('T')[0];
            return '';
        };

        function getWeekId(d) {
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            const weekNumber = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            return `${date.getFullYear()}-${String(weekNumber).padStart(2, '0')}`;
        }
        function daysBetween(date1, date2) { return Math.round((new Date(date2) - new Date(date1)) / (1000 * 60 * 60 * 24)); }
        function formatNumber(num) { return new Intl.NumberFormat('es-AR').format(num); }

        function renderDateAndWeek() {
            const container = document.getElementById('date-week-container');
            if (!container) return;

            const today = new Date();
            const weekId = getWeekId(today);
            const weekNumber = parseInt(weekId.split('-')[1], 10);

            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let formattedDate = today.toLocaleDateString('es-AR', dateOptions);
            formattedDate = formattedDate.toUpperCase();

            container.innerHTML = `
                <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
                     <div>
                        <p class="text-lg font-bold text-[#6366f1]">${formattedDate}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-slate-500 uppercase">SEMANA</p>
                        <p class="text-3xl font-bold text-[#6366f1]">${weekNumber}</p>
                    </div>
                </div>
            `;
        }

        function transformOCStatus(status) {
            if (!status) return '';
            const lowerStatus = status.toLowerCase();
            if (lowerStatus.includes('enviados') || lowerStatus.includes('docum.subsiguientes')) return 'Aprobada';
            if (lowerStatus.includes('en proceso de autorización')) return 'Pendiente';
            if (lowerStatus.includes('rechazado')) return 'Rechazada';
            return status;
        }

        function extractGroupCode(groupName) {
            if (!groupName || typeof groupName !== 'string') return '';
            // Elimina el texto entre paréntesis (ej. "GRUPO (COMPRADOR)") para quedarse solo con "GRUPO"
            return groupName.replace(/\s*\([^)]*\)/g, '').trim();
        }

        // --- LÓGICA DE AUTENTICACIÓN Y UI INICIAL ---
        function handleAuthError(error, elementId) { const errorEl = document.getElementById(elementId); let message = "Ocurrió un error."; switch (error.code) { case 'auth/user-not-found': case 'auth/invalid-credential': message = "Credenciales incorrectas."; break; case 'auth/wrong-password': message = "Contraseña incorrecta."; break; case 'auth/email-already-in-use': message = "El email ya está registrado."; break; case 'auth/weak-password': message = "La contraseña debe tener al menos 6 caracteres."; break; case 'auth/invalid-email': message = "El formato del email no es válido."; break; } errorEl.textContent = message; }
        async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { handleAuthError(error, 'login-error'); } }
        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast('Cuenta creada. Serás redirigido.', 'success');
            } catch (error) {
                handleAuthError(error, 'register-error');
            }
        }
        async function handleLogout() { try { await signOut(auth); window.location.reload(); } catch (error) { console.error("Error al cerrar sesión:", error); showToast('Error al cerrar sesión.', 'error'); } }
        function switchAuthView(view) { document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.add('hidden'); if (document.getElementById(view)) { document.getElementById(view).classList.remove('hidden'); } }

        // --- LÓGICA DE NAVEGACIÓN Y VISTAS ---
        function switchMainView(view) {
            currentView = view;
            document.getElementById('dashboard-view').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('indice-view').classList.toggle('hidden', view !== 'indice');
            document.getElementById('consumos-view').classList.toggle('hidden', view !== 'consumos');
            document.getElementById('solpeds-view').classList.toggle('hidden', view !== 'solpeds');
            document.getElementById('ocs-view').classList.toggle('hidden', view !== 'ocs');
            document.getElementById('reportes-view').classList.toggle('hidden', view !== 'reportes');
            document.getElementById('revision-view').classList.toggle('hidden', view !== 'revision');
            
            document.querySelectorAll('#main-nav-links .nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === view);
            });

            if (view === 'indice') {
                renderIndiceView();
            } else if (view === 'consumos') {
                renderConsumosView();
            } else if (view === 'solpeds') {
                renderSolpedsView();
            } else if (view === 'ocs') {
                renderOCsView();
            } else if (view === 'reportes') {
                renderReportesView();
            } else if (view === 'revision') {
                renderHistoryView();
                if(currentUserRole === 'owner') {
                    renderReviewTable();
                }
            }
        }

        // --- LÓGICA DE PERMISOS Y UI ---
        function adaptUiToRole(role, user) {
            const isOwner = role === 'owner';
            const isEditorOrOwner = role === 'owner' || role === 'editor';
            const userMenuButton = document.getElementById('user-menu-button');
            const userEmail = user.email || '';
            
            // Populate dropdown header
            document.getElementById('user-dropdown-email').textContent = userEmail;
            document.getElementById('user-dropdown-role').textContent = role;

            // --- Menu Dropdown ---
            const adminBtn = document.getElementById('admin-button-dropdown');
            const preloadBtn = document.getElementById('dashboard-preload-btn-dropdown');
            const clearBtn = document.getElementById('dashboard-clear-btn-dropdown');
            const iwebLink = document.getElementById('iweb-sap-link-dropdown');
            const depositosLink = document.getElementById('depositos-externos-link-dropdown');
            const adminActionsDivider = document.getElementById('admin-actions-divider');
            const linksDivider = document.getElementById('links-divider');
            
            // Set visibility of role-based items
            adminBtn.classList.toggle('hidden', !isOwner);
            preloadBtn.classList.toggle('hidden', !isEditorOrOwner);
            clearBtn.classList.toggle('hidden', !isEditorOrOwner);
            
            // Set visibility of dividers
            const adminSectionVisible = !adminBtn.classList.contains('hidden');
            const dataMgmtSectionVisible = !preloadBtn.classList.contains('hidden') || !clearBtn.classList.contains('hidden');
            adminActionsDivider.classList.toggle('hidden', !(adminSectionVisible || dataMgmtSectionVisible));
            
            const externalLinksVisible = !iwebLink.classList.contains('hidden') || !depositosLink.classList.contains('hidden');
            linksDivider.classList.toggle('hidden', !externalLinksVisible);


            // --- Otros elementos de la UI ---
            document.querySelector('[data-view="reportes"]').classList.toggle('hidden', !isEditorOrOwner);
            document.querySelector('[data-view="revision"]').classList.toggle('hidden', !isOwner);
            document.getElementById('notification-container').classList.toggle('hidden', !isEditorOrOwner);
            
            userMenuButton.disabled = false;

            document.getElementById('review-container').classList.toggle('hidden', !isOwner);
            document.getElementById('progress-bar-container').classList.toggle('hidden', !isOwner);
            
            const addNewItemBtn = document.getElementById('add-new-item-btn');
            if (addNewItemBtn) {
                addNewItemBtn.classList.toggle('hidden', !isEditorOrOwner);
            }

            const userName = userEmail.split('@')[0];
            const userAvatar = document.getElementById('user-avatar');
            document.getElementById('user-name').textContent = userName;
            
            // Asigna color e ícono al avatar según el rol
            userAvatar.classList.remove('bg-indigo-500', 'bg-green-500', 'bg-slate-500');
            let avatarIcon = '';

            if (role === 'owner') {
                userAvatar.classList.add('bg-indigo-500');
                avatarIcon = `<svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M50 18L15 85H31L50 46L69 85H85L50 18ZM50 58L40 85H60L50 58Z" fill="white"/></svg>`;
            } else if (role === 'editor') {
                userAvatar.classList.add('bg-green-500');
                avatarIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
            } else { // viewer
                userAvatar.classList.add('bg-slate-500');
                avatarIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
            }
            userAvatar.innerHTML = avatarIcon;
        }

        // --- LÓGICA DE NOTIFICACIONES ---
        function generateNotifications() {
            const newNotifications = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const lowStockItems = getProcessedItems().filter(item => item.isFavorite && item.coverageDays < appSettings.notificationThreshold && item.coverageDays !== Infinity);
            lowStockItems.forEach(item => {
                newNotifications.push({
                    id: `lowstock_${item.id}`,
                    type: 'low_stock',
                    text: `Cobertura baja para <strong>${item.name}</strong> (${Math.round(item.coverageDays)} días).`,
                    targetId: item.id,
                    timestamp: new Date().toISOString()
                });
            });

            const existingNotificationsMap = new Map(notifications.map(n => [n.id, n]));
            newNotifications.forEach(newNotif => {
                const existing = existingNotificationsMap.get(newNotif.id);
                if (existing) {
                    newNotif.read = existing.read;
                } else {
                    newNotif.read = false;
                }
            });
            
            notifications = newNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderNotifications();
        }

        function renderNotifications() {
            const badge = document.getElementById('notification-count-badge');
            const dropdown = document.getElementById('notification-dropdown');
            const unreadCount = notifications.filter(n => !n.read).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
            
            let dropdownHTML = `
                <div class="p-3 border-b flex justify-between items-center">
                    <h4 class="font-semibold text-slate-800">Notificaciones</h4>
                    ${unreadCount > 0 ? '<button id="mark-all-read-btn" class="text-xs font-medium text-indigo-600 hover:underline">Marcar todas como leídas</button>' : ''}
                </div>
            `;
            
            if (notifications.length === 0) {
                dropdownHTML += '<p class="p-4 text-sm text-center text-slate-500">No hay notificaciones.</p>';
            } else {
                dropdownHTML += notifications.map(n => `
                    <div class="p-3 border-b text-sm notification-item ${!n.read ? 'unread' : ''}" data-id="${n.id}" data-type="${n.type}" data-target-id="${n.targetId}">
                        <div class="flex items-start gap-3">
                           <div class="flex-shrink-0 mt-1">
                                <svg class="w-5 h-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                           </div>
                           <div>${n.text}</div>
                        </div>
                    </div>
                `).join('');
            }
            dropdown.innerHTML = dropdownHTML;
        }

        function handleNotificationClick(e) {
            const item = e.target.closest('.notification-item');
            if (!item) return;
            
            const { id, type, targetId } = item.dataset;
            
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
            }
            renderNotifications();
            document.getElementById('notification-dropdown').classList.remove('show');
            
            if (type === 'low_stock') {
                selectedConsumptionItemId = targetId;
                comparisonItemId = null;
                switchMainView('consumos');
            }
        }

        // --- FUNCIONES DE FIREBASE ---
        async function handleToggleFavorite(itemId) {
            if (currentUserRole === 'viewer') {
                showToast('No tienes permiso para cambiar favoritos.', 'error');
                return;
            }
            const itemRef = doc(inventoryCollectionRef, itemId);
            const currentItem = items.find(i => i.id === itemId);
            if (!currentItem) return;
            const newFavoriteStatus = !currentItem.isFavorite;
            try {
                await updateDoc(itemRef, { isFavorite: newFavoriteStatus });
                showToast(newFavoriteStatus ? 'Añadido a favoritos.' : 'Quitado de favoritos.', 'success');
            } catch (error) {
                console.error("Error al actualizar favorito:", error);
                showToast('Error al cambiar estado de favorito.', 'error');
            }
        }
        function handleClearAll() { 
            document.getElementById('confirm-modal-title').textContent = 'Limpiar datos de inventario';
            document.getElementById('confirm-modal-text').textContent = 'Se borrarán todos los insumos que no estén marcados como favoritos. Los favoritos (y sus notas) se conservarán, pero su stock y pedidos se reiniciarán a cero. ¿Continuar?';
            document.getElementById('confirm-clear-modal').classList.remove('hidden');
            document.getElementById('confirm-clear-button').onclick = executeClearAll;
        }
        async function executeClearAll() { 
            if (!db) return; 
            showToast('Limpiando datos...', 'info'); 
            try { 
                const batch = writeBatch(db); 
                const querySnapshot = await getDocs(inventoryCollectionRef); 
                let favoritesKept = 0; 
                let nonFavoritesDeleted = 0; 
                querySnapshot.forEach((doc) => { 
                    const data = doc.data();
                    if (data.isFavorite) { 
                        batch.update(doc.ref, { 
                            stock: 0, 
                            monthlyConsumption: 0, 
                            delayedQuantity: 0, 
                            orderQuantities: [], 
                            isModified: false, 
                            consumos: [],
                            description_notes: data.description_notes || ''
                        }); 
                        favoritesKept++; 
                    } else { 
                        batch.delete(doc.ref); 
                        nonFavoritesDeleted++; 
                    } 
                }); 
                batch.delete(metadataDocRef); 
                await batch.commit(); 
                showToast(`Limpieza completa: ${nonFavoritesDeleted} borrados, ${favoritesKept} conservados.`, 'success'); 
            } catch (error) { 
                console.error("Error al limpiar:", error); 
                showToast('Error al limpiar los datos.', 'error'); 
            } finally { 
                document.getElementById('confirm-clear-modal').classList.add('hidden'); 
            } 
        }
        
        // --- LÓGICA DE PRECARGA Y MODALES ---
        function handleOpenPreloadModal() { document.getElementById('preload-modal').classList.remove('hidden'); document.getElementById('preload-feedback').textContent = ''; document.getElementById('preload-file-input').value = ''; }
        function handleClosePreloadModal() { document.getElementById('preload-modal').classList.add('hidden'); }
        function handleFileInputChange() { const fileInput = document.getElementById('preload-file-input'); const feedbackEl = document.getElementById('preload-feedback'); if (fileInput.files.length > 0) { feedbackEl.textContent = `Archivo: ${fileInput.files[0].name}`; } else { feedbackEl.textContent = ''; } }
        async function handleProcessPreloadData() {
            const processButton = document.getElementById('process-preload-data'), buttonText = document.getElementById('process-preload-text'), loader = document.getElementById('process-preload-loader'), fileInput = document.getElementById('preload-file-input');
            if (fileInput.files.length === 0) { showToast('Selecciona un archivo.', 'error'); return; }
            processButton.disabled = true; buttonText.classList.add('hidden'); loader.classList.remove('hidden');
            
            const favoritesMap = new Map();
            const currentInventorySnapshot = await getDocs(inventoryCollectionRef);
            currentInventorySnapshot.forEach(doc => {
                const data = doc.data();
                if (data.isFavorite) {
                    favoritesMap.set(data.code, { 
                        isFavorite: true, 
                        description_notes: data.description_notes || '' 
                    });
                }
            });

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array', cellDates: true });
                    
                    const { inventoryItems: newItemsFromExcel } = processInventorySheet(workbook);
                    const { historyMap } = processHistorySheet(workbook);
                    const { solpedsData } = processSolpedsSheet(workbook);
                    const { ocsData } = processOCSheet(workbook);

                    newItemsFromExcel.forEach(item => {
                        item.consumos = historyMap.get(item.code) || [];
                        if (favoritesMap.has(item.code)) {
                            const persistentData = favoritesMap.get(item.code);
                            item.isFavorite = persistentData.isFavorite;
                            item.description_notes = persistentData.description_notes;
                        }
                    });

                    const batch = writeBatch(db);
                    
                    currentInventorySnapshot.forEach(doc => batch.delete(doc.ref));
                    newItemsFromExcel.forEach(item => batch.set(doc(inventoryCollectionRef), item));

                    const oldSolpedsSnapshot = await getDocs(solpedsCollectionRef);
                    oldSolpedsSnapshot.forEach(doc => batch.delete(doc.ref));
                    solpedsData.forEach(item => batch.set(doc(solpedsCollectionRef), item));

                    const oldOCsSnapshot = await getDocs(ocsCollectionRef);
                    oldOCsSnapshot.forEach(doc => batch.delete(doc.ref));
                    ocsData.forEach(item => batch.set(doc(ocsCollectionRef), item));

                    batch.set(metadataDocRef, { filename: file.name, lastUpdated: new Date().toISOString() });
                    await batch.commit();
                    showToast(`Sincronización completa.`, 'success');
                    setTimeout(handleClosePreloadModal, 2500);
                } catch (e) { 
                    console.error("Error procesando archivo:", e); 
                    showToast('Error al procesar el archivo.', 'error');
                } finally { 
                    processButton.disabled = false; 
                    buttonText.classList.remove('hidden'); 
                    loader.classList.add('hidden'); 
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        
        function processInventorySheet(workbook) {
            const sheetName = workbook.SheetNames[0];
            if (!sheetName) return { inventoryItems: [], inventoryReport: { processedCount: 0, ignoredCount: 0 } };
            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });
            const itemsMap = new Map();
            const report = { processedCount: 0, ignoredCount: 0, reasons: {} };
            const headerRow = rows[0].map(h => String(h).trim().toLowerCase().replace(/[\s_]+/g, ''));
            const colMap = {
                group: headerRow.indexOf('grupo'),
                code: headerRow.indexOf('código') !== -1 ? headerRow.indexOf('código') : headerRow.indexOf('cod'),
                name: headerRow.indexOf('nombre'),
                stock: headerRow.indexOf('stock'),
                monthlyConsumption: headerRow.indexOf('consumomensual'),
                delayedQuantity: headerRow.indexOf('demorados'),
                pedido: headerRow.indexOf('pedido'),
                fecha: headerRow.indexOf('fecha'),
                leadTimeDays: headerRow.indexOf('leadtime'),
                safetyStockDays: headerRow.indexOf('díasseguridad')
            };
            const parseNumeric = (val) => {
                if (val === null || val === undefined || typeof val === 'string' && val.trim() === '' || val === '-') return 0;
                const cleanVal = String(val).replace(/\./g, '').replace(',', '.');
                const num = parseFloat(cleanVal);
                return isNaN(num) ? 0 : num;
            };
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 2 || row.every(cell => cell === null || cell === '')) continue;
                const code = String(row[colMap.code] || '').trim();
                const name = String(row[colMap.name] || '').trim();
                if (!code || !name) {
                    report.ignoredCount++;
                    report.reasons['Falta Código/Nombre'] = (report.reasons['Falta Código/Nombre'] || 0) + 1;
                    continue;
                }
                let existingItem = itemsMap.get(code);
                if (!existingItem) {
                    existingItem = {
                        code: code,
                        group: String(row[colMap.group] || 'General').trim(),
                        name: `${code} ${name}`,
                        stock: parseNumeric(row[colMap.stock]),
                        monthlyConsumption: parseNumeric(row[colMap.monthlyConsumption]),
                        delayedQuantity: parseNumeric(row[colMap.delayedQuantity]),
                        leadTimeDays: parseNumeric(row[colMap.leadTimeDays]),
                        safetyStockDays: parseNumeric(row[colMap.safetyStockDays]),
                        orderQuantities: [],
                        isModified: false,
                        createdAt: new Date().toISOString(),
                        isFavorite: false,
                        description_notes: ''
                    };
                    itemsMap.set(code, existingItem);
                }
                const pedido = parseNumeric(row[colMap.pedido]);
                const fecha = parseAndFormatDateToISO(row[colMap.fecha]);
                if (pedido > 0) {
                    if (fecha) {
                        existingItem.orderQuantities.push({ quantity: pedido, date: fecha });
                    } else {
                        report.ignoredCount++;
                        report.reasons['Pedido sin Fecha'] = (report.reasons['Pedido sin Fecha'] || 0) + 1;
                    }
                }
            }
            report.processedCount = itemsMap.size;
            return { inventoryItems: Array.from(itemsMap.values()), inventoryReport: report };
        }
        function processHistorySheet(workbook) {
            const sheetName = workbook.SheetNames[1];
            if (!sheetName) return { historyMap: new Map(), historyReport: { processedCount: 0, ignoredCount: 0 } };
            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });
            const historyMap = new Map();
            const report = { processedCount: 0, ignoredCount: 0 };
            const headerRow = rows[0].map(h => String(h).trim().toLowerCase());
            const codeIndex = headerRow.indexOf('material') !== -1 ? headerRow.indexOf('material') : headerRow.indexOf('cod');
            if (codeIndex === -1) {
                console.error("No se encontró la columna 'material' o 'cod' en la Hoja2.");
                return { historyMap, historyReport: report };
            }
            const parseNumeric = (val) => {
                if (val === null || val === undefined || typeof val === 'string' && val.trim() === '' || val === '-') return 0;
                const cleanVal = String(val).replace(/\./g, '').replace(',', '.');
                const num = parseFloat(cleanVal);
                return isNaN(num) ? 0 : num;
            };
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[codeIndex]) continue;
                const code = String(row[codeIndex]).trim();
                const consumos = row.slice(2).map(parseNumeric);
                if (code) {
                    historyMap.set(code, consumos);
                } else {
                    report.ignoredCount++;
                }
            }
            report.processedCount = historyMap.size;
            return { historyMap, historyReport: report };
        }
        function processSolpedsSheet(workbook) {
            const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('solped'));
            if (!sheetName) {
                console.warn("No se encontró la hoja 'Solped' en el archivo.");
                return { solpedsData: [] };
            }
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
            const solpedsData = jsonData.map(row => ({
                solicitud: row['Solicitud de pedido'] || '',
                cod: row['Cod'] || '',
                descripcion: row['Texto breve'] || '',
                cantidad: parseFloat(String(row['Cantidad solicitada']).replace(',', '.')) || 0,
                fechaSolicitud: parseAndFormatDateToISO(row['Fecha de solicitud']),
                creadoPor: row['Creado por'] || '',
                status: row['Status'] || '',
                fechaLiberacion: parseAndFormatDateToISO(row['Fecha de liberación']),
                grupoDeCompras: row['Grupo de compras'] || '',
                grupoDeArticulos: row['Grupo de artículos'] || ''
            }));
            return { solpedsData };
        }
        function processOCSheet(workbook) {
            const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('oc'));
            if (!sheetName) {
                console.warn("No se encontró la hoja 'OC' en el archivo.");
                return { ocsData: [] };
            }
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
            const ocsData = jsonData.map(row => ({
                solped: row['Solped'] || '',
                ordenDeCompra: row['Orden de compra'] || '',
                posicion: row['Posición'] || '',
                proxFechaEntrega: parseAndFormatDateToISO(row['Próxima fecha de entrega']),
                cantEntregaSiguiente: parseFloat(String(row['Cantidad de entrega siguiente']).replace(',', '.')) || 0,
                codigo: row['Codigo'] || '',
                denominacion: row['Denominación de material'] || '',
                grupoDeArticulos: row['Grupo de artículos'] || '',
                grupoDeCompras: row['Grupo de compras'] || '',
                status: row['Status de la orden'] || ''
            }));
            return { ocsData };
        }
        
        // --- LÓGICA DEL PANEL DE ADMINISTRACIÓN ---
        async function openAdminModal() {
            document.getElementById('admin-modal').classList.remove('hidden');
            
            const permissionsTab = document.querySelector('.admin-tab[data-tab="permissions"]');
            const settingsTab = document.querySelector('.admin-tab[data-tab="settings"]');
            const permissionsContent = document.getElementById('admin-content-permissions');
            const settingsContent = document.getElementById('admin-content-settings');

            // Solo el 'owner' puede acceder a este modal
            if (currentUserRole === 'owner') {
                permissionsTab.classList.remove('hidden');
                permissionsTab.classList.add('active');
                settingsTab.classList.remove('active');
                permissionsContent.classList.remove('hidden');
                settingsContent.classList.add('hidden');
                
                allUserPermissions.clear();
                const querySnapshot = await getDocs(permissionsCollectionRef);
                querySnapshot.forEach(doc => { allUserPermissions.set(doc.id, doc.data().email || doc.id); });
                renderPermissionsList();
            }
            
            document.getElementById('setting-red-threshold').value = appSettings.coverageThresholds.red;
            document.getElementById('setting-yellow-threshold').value = appSettings.coverageThresholds.yellow;
            document.getElementById('setting-notification-threshold').value = appSettings.notificationThreshold;
            document.getElementById('setting-immobilization-months').value = appSettings.immobilizationMonths;
            document.getElementById('setting-iweb-sap-url').value = appSettings.iwebSapUrl || '';
            document.getElementById('setting-depositos-externos-url').value = appSettings.depositosExternosUrl || '';
            
            const monthCheckboxes = document.querySelectorAll('#consumption-months-checkboxes input[type="checkbox"]');
            const selectedMonths = appSettings.consumptionMonths || Array(12).fill(true);
            monthCheckboxes.forEach((checkbox, index) => {
                checkbox.checked = selectedMonths[index];
            });
        }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
        async function renderPermissionsList() { const listEl = document.getElementById('permissions-list'); listEl.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>'; const querySnapshot = await getDocs(permissionsCollectionRef); const permissions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); listEl.innerHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-4 py-2">Usuario</th><th class="px-4 py-2">Rol</th><th class="px-4 py-2">Grupos Editables</th></tr></thead><tbody>${permissions.map(p => `<tr class="border-b"><td class="px-4 py-2 font-mono text-xs">${p.email || p.id} ${p.id === userId ? '<span class="text-indigo-600 font-bold">(Tú)</span>' : ''}</td><td class="px-4 py-2"><select data-userid="${p.id}" class="role-select bg-slate-50 border rounded p-1" ${p.role === 'owner' || currentUserRole !== 'owner' ? 'disabled' : ''}><option value="owner" ${p.role === 'owner' ? 'selected' : ''} disabled>Propietario</option><option value="editor" ${p.role === 'editor' ? 'selected' : ''}>Editor</option><option value="viewer" ${p.role === 'viewer' ? 'selected' : ''}>Visor</option></select></td><td class="px-4 py-2"><input type="text" data-userid="${p.id}" class="groups-input w-full p-1 border rounded" value="${(p.editableGroups || []).join(',')}" ${p.role !== 'editor' || currentUserRole !== 'owner' ? 'disabled' : ''}></td></tr>`).join('')}</tbody></table>`; }
        async function updateUserPermissions(targetUserId, role, groups) { const userPermRef = doc(permissionsCollectionRef, targetUserId); const editableGroups = groups.split(',').map(g => g.trim()).filter(Boolean); try { await updateDoc(userPermRef, { role, editableGroups }); showToast(`Permisos actualizados.`, 'success'); } catch (error) { showToast('Error al actualizar permisos.', 'error'); console.error(error); } }
        async function handleSaveSettings() {
            const red = parseInt(document.getElementById('setting-red-threshold').value, 10);
            const yellow = parseInt(document.getElementById('setting-yellow-threshold').value, 10);
            const notification = parseInt(document.getElementById('setting-notification-threshold').value, 10);
            const immobilization = parseInt(document.getElementById('setting-immobilization-months').value, 10);
            const iwebSapUrl = document.getElementById('setting-iweb-sap-url').value.trim();
            const depositosExternosUrl = document.getElementById('setting-depositos-externos-url').value.trim();
            
            const monthCheckboxes = document.querySelectorAll('#consumption-months-checkboxes input[type="checkbox"]');
            const selectedMonths = Array.from(monthCheckboxes).map(cb => cb.checked);

            if (isNaN(red) || isNaN(yellow) || isNaN(notification) || isNaN(immobilization)) {
                showToast('Todos los valores deben ser números.', 'error');
                return;
            }
            if (red >= yellow) {
                showToast('El umbral rojo debe ser menor que el amarillo.', 'error');
                return;
            }
            if (red <= 0 || yellow <= 0 || notification <= 0 || immobilization <= 0) {
                showToast('Los valores deben ser mayores a cero.', 'error');
                return;
            }
            if (!selectedMonths.some(m => m)) {
                showToast('Debes seleccionar al menos un mes.', 'error');
                return;
            }

            const newSettings = {
                coverageThresholds: { red, yellow },
                notificationThreshold: notification,
                consumptionMonths: selectedMonths,
                immobilizationMonths: immobilization,
                iwebSapUrl: iwebSapUrl,
                depositosExternosUrl: depositosExternosUrl
            };

            try {
                await setDoc(appConfigDocRef, { settings: newSettings }, { merge: true });
                showToast('Configuración guardada correctamente.', 'success');
                closeAdminModal();
            } catch (error) {
                console.error("Error al guardar configuración:", error);
                showToast('Error al guardar la configuración.', 'error');
            }
        }

        // --- LÓGICA DE RENDERIZADO PRINCIPAL ---
        function renderApp() {
            if (!isAuthReady) return;
            
            switch (currentView) {
                case 'dashboard': renderDashboard(); break;
                case 'indice': renderIndiceView(); break;
                case 'consumos': renderConsumosView(); break;
                case 'reportes': renderReportesView(); break;
                case 'revision': 
                    renderHistoryView(); 
                    if(currentUserRole === 'owner') renderReviewTable(); 
                    break;
            }
        }
        function getProcessedItems() {
            return items.map(item => {
                const dailyConsumption = item.monthlyConsumption > 0 ? item.monthlyConsumption / 30 : 0;
                const coverageDays = dailyConsumption > 0 ? Math.floor(item.stock / dailyConsumption) : Infinity;
                const leadTimeDays = item.leadTimeDays || 0;
                const safetyStockDays = item.safetyStockDays || 0;
                const reorderPointDays = leadTimeDays + safetyStockDays;
                return { ...item, dailyConsumption, coverageDays, leadTimeDays, safetyStockDays, reorderPointDays };
            });
        }
        function updateExternalLinks() {
            const iwebLink = document.getElementById('iweb-sap-link-dropdown');
            if (iwebLink) {
                if (appSettings.iwebSapUrl && appSettings.iwebSapUrl.trim() !== '') {
                    iwebLink.href = appSettings.iwebSapUrl;
                    iwebLink.classList.remove('hidden');
                } else {
                    iwebLink.classList.add('hidden');
                }
            }

            const depositosLink = document.getElementById('depositos-externos-link-dropdown');
            if (depositosLink) {
                if (appSettings.depositosExternosUrl && appSettings.depositosExternosUrl.trim() !== '') {
                    depositosLink.href = appSettings.depositosExternosUrl;
                    depositosLink.classList.remove('hidden');
                } else {
                    depositosLink.classList.add('hidden');
                }
            }
        }
        async function renderDashboard() {
            const kpiContainer = document.getElementById('kpi-container');
            if (!kpiContainer) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const processedItems = getProcessedItems(true);
            const totalProducts = processedItems.length;
            const favoriteCount = processedItems.filter(item => item.isFavorite).length;
            const uniqueGroups = [...new Set(processedItems.map(item => item.group))].length;
            
            const recordConsumptionCount = processedItems.filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            }).length;

            const solpedsVencidasCount = solpeds.filter(s => {
                const releaseDate = parseDateString(s.fechaLiberacion);
                return releaseDate && releaseDate < today;
            }).length;

            const ocsVencidasCount = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate < today;
            }).length;

            const kpis = [
                { type: 'total', title: 'Productos Totales', value: formatNumber(totalProducts), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>', color: 'indigo' },
                { type: 'favorites', title: 'Favoritos', value: favoriteCount, subtitle: 'Insumos destacados', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>', color: 'yellow' },
                { type: 'groups', title: 'Total de Grupos', value: uniqueGroups, subtitle: 'Categorías activas', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>', color: 'green' },
                { type: 'consumption-peak', title: 'Consumo Récord', value: recordConsumptionCount, subtitle: 'Superando pico histórico', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>', color: 'red' },
                { type: 'solpeds-vencidas', title: 'Solpeds Vencidas', value: solpedsVencidasCount, subtitle: 'Liberación pasada', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M12 22a2 2 0 0 0 2-2V7H10v13a2 2 0 0 0 2 2z"/><path d="M16 10h4l-4-4v4z"/><path d="M16 10h4l-4-4v4z"/></svg>', color: 'red' },
                { type: 'ocs-vencidas', title: 'O/C Vencidas', value: ocsVencidasCount, subtitle: 'Entrega demorada', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>', color: 'red' }
            ];
            
            kpiContainer.innerHTML = kpis.map(kpi => {
                let iconClass = 'bg-indigo-100 text-indigo-600';
                let cardClass = '';

                if ((kpi.type === 'consumption-peak' || kpi.type === 'solpeds-vencidas' || kpi.type === 'ocs-vencidas') && kpi.value > 0) {
                    iconClass = 'bg-red-100 text-red-600';
                    cardClass = 'border-2 border-red-400';
                }

                return `
                <div class="kpi-card relative pt-6 text-center ${cardClass}" data-kpi="${kpi.type}">
                    <div class="absolute -top-2 -left-2 p-2 rounded-lg shadow-md ${iconClass}">${kpi.icon}</div>
                    <p class="text-2xl font-bold text-slate-900">${kpi.value}</p>
                    <p class="text-xs font-medium text-slate-500 mt-1 uppercase truncate">${kpi.title}</p>
                </div>`;
            }).join('');
            
            renderDateAndWeek();
            renderCriticalItemsTable();

            if (isInitialLoad && items.length > 0) {
                handleKpiClick('groups');
                isInitialLoad = false;
            }
        }

        function renderCriticalItemsTable() {
            const container = document.getElementById('low-stock-container');
            if (!container) return;

            const redThreshold = appSettings.coverageThresholds.red;
            let processedItems = getProcessedItems(true);
            let lowStockItems = processedItems.filter(item => item.coverageDays < redThreshold && item.coverageDays !== Infinity);
            const allGroups = [...new Set(lowStockItems.map(item => item.group || 'General'))].sort();

            const searchInput = container.querySelector('#low-stock-search');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            if (criticalsSelectedGroup !== 'all') {
                lowStockItems = lowStockItems.filter(item => item.group === criticalsSelectedGroup);
            }
            
            if (showOnlyFavoriteCriticals) {
                lowStockItems = lowStockItems.filter(item => item.isFavorite);
            }

            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                lowStockItems = lowStockItems.filter(item => {
                    const textToSearch = item.name.toLowerCase();
                    return searchWords.every(word => textToSearch.includes(word));
                });
            }
            
            lowStockItems.sort((a, b) => a.coverageDays - b.coverageDays);

            let groupFilterHTML = `<select id="low-stock-group-filter" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 w-full h-9"><option value="all">TODOS LOS GRUPOS</option>`;
            allGroups.forEach(group => {
                const selected = group === criticalsSelectedGroup ? 'selected' : '';
                groupFilterHTML += `<option value="${group}" ${selected}>${group}</option>`;
            });
            groupFilterHTML += `</select>`;

            let contentHTML = `
                <div class="p-4 border-b bg-[#6366f1] rounded-t-lg flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl font-bold text-white">${lowStockItems.length}</span>
                        <div>
                             <h3 class="text-lg font-semibold text-white uppercase tracking-wider">Insumos Críticos</h3>
                             <p class="text-xs text-indigo-100 -mt-1">con &lt; ${redThreshold} días</p>
                        </div>
                    </div>
                    <button id="low-stock-favorites-filter-btn" class="btn-main-style h-8 !text-xs ${showOnlyFavoriteCriticals ? 'bg-yellow-200 !text-yellow-800 !border-yellow-300 hover:!bg-yellow-300' : '!bg-transparent !text-white !border-white/40 hover:!bg-white/10'}">Favoritos</button>
                </div>
                 <div class="p-4 border-b">
                     <div class="flex items-center gap-2">
                        <div class="flex-1">${groupFilterHTML}</div>
                        <input type="text" id="low-stock-search" value="${searchTerm}" placeholder="Buscar en críticos..." class="w-full flex-1 p-2 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                    </div>
                </div>
                <div id="low-stock-list" class="max-h-[580px] overflow-y-auto">
                    ${generateLowStockListHTML(lowStockItems)}
                </div>
            `;
            container.innerHTML = contentHTML;
        }

        function generateLowStockListHTML(itemsToRender) {
            if (itemsToRender.length === 0) {
                return '<p class="p-4 text-center text-slate-500">No se encontraron insumos.</p>';
            }
            return itemsToRender.map(item => `
                <div class="p-3 flex items-center justify-between hover:bg-slate-50 border-b">
                    <div class="flex items-center gap-4 flex-1 min-w-0">
                         <button class="favorite-btn ${item.isFavorite ? 'is-favorite' : ''}" data-item-id="${item.id}" data-btn-type="low-stock-fav" ${currentUserRole === 'viewer' ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </button>
                        <div class="flex-1 cursor-pointer low-stock-item-details" data-item-id="${item.id}">
                            <p class="font-semibold text-sm text-slate-800 truncate">${item.name}</p>
                            <p class="text-xs text-slate-500">Grupo: ${item.group}</p>
                        </div>
                    </div>
                    <div class="text-right pl-2 cursor-pointer low-stock-item-details" data-item-id="${item.id}">
                        <p class="font-bold text-xl ${item.coverageDays < 7 ? 'text-red-600' : 'text-yellow-600'}">${Math.round(item.coverageDays)}</p>
                        <p class="text-xs text-slate-500 -mt-1">días</p>
                    </div>
                </div>
            `).join('');
        }


        async function renderReviewTable() {
            const groupsReviewContainer = document.getElementById('groups-review-list');
            if (!groupsReviewContainer) return;

            groupsReviewContainer.innerHTML = '<div class="p-6 text-center text-slate-500"><div class="loader inline-block"></div> Cargando...</div>';

            const today = new Date();
            const prevWeekDate = new Date();
            prevWeekDate.setDate(today.getDate() - 7);
            const prevWeekId = getWeekId(prevWeekDate);
            const prevWeekReviewDocRef = doc(reviewHistoryCollectionRef, prevWeekId);
            let reviewedGroupsLastWeek = new Set();

            try {
                const docSnap = await getDoc(prevWeekReviewDocRef);
                if (docSnap.exists()) {
                    reviewedGroupsLastWeek = new Set(docSnap.data().reviewedGroups || []);
                }
            } catch (e) {
                console.error("Could not fetch last week's review status", e);
            }
            
            const groups = items.reduce((acc, item) => {
                const group = item.group || 'General';
                acc[group] = (acc[group] || 0) + 1;
                return acc;
            }, {});
            const sortedGroups = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));

            if (sortedGroups.length > 0) {
                groupsReviewContainer.innerHTML = `<ul role="list" class="divide-y divide-slate-200">${sortedGroups.map(([groupName, count]) => {
                    const wasReviewedLastWeek = reviewedGroupsLastWeek.has(groupName);
                    const rowClass = !wasReviewedLastWeek ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-slate-50';
                    return `
                    <li class="p-4 flex items-center justify-between ${rowClass}">
                        <div class="group-item-name flex-1 min-w-0 cursor-pointer" data-group-name="${groupName}">
                            <p class="text-lg font-medium text-indigo-600 truncate">${groupName}</p>
                            <p class="text-sm text-slate-500">${count} insumos</p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-slate-200">
                                <input type="checkbox" data-group-name="${groupName}" class="review-checkbox h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-sm text-slate-600 hidden sm:inline">Revisado</span>
                            </label>
                        </div>
                    </li>`;
                }).join('')}</ul>`;
                loadCurrentWeekReview();
            } else {
                groupsReviewContainer.innerHTML = `<div class="p-6 text-center text-slate-500">No hay grupos para mostrar.</div>`;
            }
        }

        function handleKpiClick(kpiType) {
            const previouslyActiveKpi = activeKpi;
            closeKpiDetailView(); // Close any open detail view first

            if (previouslyActiveKpi === kpiType) {
                // If the same KPI was clicked again, it's now closed, so we're done.
                return;
            }
            
            activeKpi = kpiType;
            const detailContainer = document.getElementById('kpi-detail-container');
            if (!detailContainer) return;

            const kpiCard = document.querySelector(`.kpi-card[data-kpi="${kpiType}"]`);
            const kpiValue = kpiCard ? kpiCard.querySelector('p.text-2xl').textContent : '';

            if(kpiCard) {
                kpiCard.classList.add('border-2', 'border-indigo-500', 'shadow-xl');
            }

            let contentHTML = '';
            let title = '';

            switch (kpiType) {
                case 'favorites':
                    title = 'Insumos Favoritos';
                    contentHTML = generateFavoriteItemsTableHTML();
                    break;
                case 'consumption-peak':
                    title = 'Insumos con Consumo Récord';
                    contentHTML = generateRecordConsumptionHTML();
                    break;
                case 'groups':
                    title = 'Estadísticas por Grupo';
                    contentHTML = generateGroupStatsHTML();
                    break;
                case 'solpeds-vencidas':
                     title = 'Solpeds Vencidas por Grupo de Compras';
                     contentHTML = generateDelayedSolpedsHTML();
                    break;
                case 'ocs-vencidas':
                    title = 'O/C Vencidas por Grupo de Compras';
                    contentHTML = generateDelayedOCsHTML();
                    break;
                case 'total':
                    closeKpiDetailView();
                    switchMainView('indice'); // Navigate for the 'total' KPI
                    return;
                default:
                    closeKpiDetailView();
                    return;
            }

            if(contentHTML) {
                detailContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow">
                         <div class="p-4 border-b bg-[#6366f1] rounded-t-lg flex justify-between items-center flex-shrink-0">
                            <div class="flex items-center gap-4">
                                <span class="text-3xl font-bold text-white">${kpiValue}</span>
                                <h3 class="text-lg font-semibold text-white uppercase tracking-wider">${title}</h3>
                            </div>
                            <button id="close-kpi-detail-btn" class="text-white/70 hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div class="p-4 overflow-y-auto" style="max-height: 580px;">
                            ${contentHTML}
                        </div>
                    </div>
                `;
                detailContainer.classList.remove('hidden');
                // Se eliminó la línea scrollIntoView que causaba el salto de pantalla.
            }
        }
        
        function closeKpiDetailView() {
            const detailContainer = document.getElementById('kpi-detail-container');
            if (detailContainer) {
                detailContainer.innerHTML = '';
                detailContainer.classList.add('hidden');
            }
            document.querySelectorAll('.kpi-card.border-2').forEach(card => {
                card.classList.remove('border-2', 'border-indigo-500', 'shadow-xl');
            });
            activeKpi = null;
        }

        function generateFavoriteItemsTableHTML() {
            const favoriteItems = getProcessedItems().filter(item => item.isFavorite);
            if (favoriteItems.length === 0) {
                return '<p class="text-center text-slate-500 py-4">No has marcado ningún insumo como favorito.</p>';
            }
            
            let listHTML = '';
            favoriteItems.sort((a,b) => a.coverageDays - b.coverageDays).forEach(item => {
                const { red, yellow } = appSettings.coverageThresholds;
                let coverageClass = '';
                if (item.coverageDays !== Infinity) {
                    if (item.coverageDays < red) coverageClass = 'text-red-600';
                    else if (item.coverageDays <= yellow) coverageClass = 'text-yellow-600';
                    else coverageClass = 'text-green-600';
                } else {
                    coverageClass = 'text-green-600';
                }

                listHTML += `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-item-row" data-item-id="${item.id}">
                    <div>
                        <p class="font-semibold text-slate-800">${item.name}</p>
                        <p class="text-sm text-slate-500">Grupo: ${item.group}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl ${coverageClass}">${item.coverageDays === Infinity ? '∞' : Math.round(item.coverageDays)}</p>
                        <p class="text-xs text-slate-500 -mt-1">días cobertura</p>
                    </div>
                </div>`;
            });
            return listHTML;
        }

        function generateRecordConsumptionHTML() {
            const recordConsumptionItems = getProcessedItems(true).filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            });

            if (recordConsumptionItems.length === 0) {
                return '<p class="text-center text-slate-500 py-4">No hay insumos con consumo récord este mes.</p>';
            }

            return recordConsumptionItems.map(item => {
                const currentConsumption = item.consumos[item.consumos.length - 1];
                return `
                <div class="p-3 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-item-row" data-item-id="${item.id}">
                    <div>
                        <p class="font-semibold text-slate-800">${item.name}</p>
                        <p class="text-sm text-slate-500">Grupo: ${item.group}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${formatNumber(currentConsumption)}</p>
                        <p class="text-xs text-slate-500">Cons. Actual</p>
                    </div>
                </div>`;
            }).join('');
        }
        
        function generateGroupStatsHTML() {
            const stats = calculateGroupStats();
            if (!stats || stats.length === 0) {
                return '<p class="text-center text-slate-500 p-8">No hay grupos para mostrar.</p>';
            }

            let listHTML = '';
            stats.forEach(group => {
                listHTML += `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-group-row" data-group-name="${group.name}">
                    <div>
                        <p class="font-semibold text-lg text-slate-800">${group.name}</p>
                        <p class="text-sm text-slate-500">${group.totalItems} insumos en total</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-2xl text-yellow-600">${group.favoriteItems}</p>
                        <p class="text-sm text-slate-500">Favoritos (${group.percentage}%)</p>
                    </div>
                </div>`;
            });
            return listHTML;
        }

        function generateDelayedSolpedsHTML() {
            const stats = calculateDelayedSolpedsStats();
            if (!stats || stats.length === 0) {
                return '<p class="text-center text-slate-500 p-8">No hay Solpeds vencidas para mostrar.</p>';
            }

            let listHTML = '';
            stats.forEach(group => {
                listHTML += `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-solped-row" data-group-compras="${group.name}">
                    <div>
                        <p class="font-semibold text-slate-800">${group.name.toUpperCase()}</p>
                        <p class="text-sm text-slate-500">${group.percentage}% del total vencido</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl text-red-600">${group.count}</p>
                        <p class="text-xs text-slate-500 -mt-1">Solpeds</p>
                    </div>
                </div>`;
            });
            return listHTML;
        }
        
        function generateDelayedOCsHTML() {
            const stats = calculateDelayedOCsStats();
            if (!stats || stats.length === 0) {
                return '<p class="text-center text-slate-500 p-8">No hay O/C vencidas para mostrar.</p>';
            }

            let listHTML = '';
            stats.forEach(group => {
                listHTML += `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-oc-row" data-group-compras="${group.name}">
                    <div>
                        <p class="font-semibold text-slate-800">${group.name.toUpperCase()}</p>
                        <p class="text-sm text-slate-500">${group.percentage}% del total vencido</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl text-red-600">${group.count}</p>
                        <p class="text-xs text-slate-500 -mt-1">O/C</p>
                    </div>
                </div>`;
            });
            return listHTML;
        }

        function openRecordConsumptionModal() {
            const recordConsumptionItems = getProcessedItems(true).filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            });

            if (recordConsumptionItems.length === 0) {
                showToast('No hay insumos con consumo récord este mes.', 'info');
                return;
            }
            
            const modal = document.getElementById('record-consumption-modal');
            const listContainer = document.getElementById('record-consumption-item-list');

            listContainer.innerHTML = recordConsumptionItems.map(item => {
                const currentConsumption = item.consumos[item.consumos.length - 1];
                return `
                <div class="p-3 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer record-consumption-item" data-item-id="${item.id}">
                    <div>
                        <p class="font-semibold text-slate-800">${item.name}</p>
                        <p class="text-sm text-slate-500">Grupo: ${item.group}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${formatNumber(currentConsumption)}</p>
                        <p class="text-xs text-slate-500">Cons. Actual</p>
                    </div>
                </div>
            `}).join('');

            modal.classList.remove('hidden');
        }

        function openGroupStatsModal() {
            const stats = calculateGroupStats();
            renderGroupStatsModal(stats);
            document.getElementById('group-stats-modal').classList.remove('hidden');
        }

        function openDelayedSolpedsModal() {
            const stats = calculateDelayedSolpedsStats();
            renderDelayedSolpedsModal(stats);
            document.getElementById('delayed-solpeds-modal').classList.remove('hidden');
        }

        function openDelayedOCsModal() {
            const stats = calculateDelayedOCsStats();
            renderDelayedOCsModal(stats);
            document.getElementById('delayed-ocs-modal').classList.remove('hidden');
        }

        function calculateDelayedSolpedsStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const delayed = solpeds.filter(s => {
                const releaseDate = parseDateString(s.fechaLiberacion);
                return releaseDate && releaseDate < today;
            });

            if (delayed.length === 0) {
                return [];
            }

            const groupData = {};
            delayed.forEach(s => {
                const groupName = s.grupoDeCompras || 'Sin Grupo';
                groupData[groupName] = (groupData[groupName] || 0) + 1;
            });
            
            const totalDelayed = delayed.length;

            return Object.entries(groupData).map(([name, count]) => {
                const percentage = totalDelayed > 0 ? (count / totalDelayed) * 100 : 0;
                return { name, count, percentage: percentage.toFixed(1) };
            }).sort((a, b) => b.count - a.count);
        }

        function renderDelayedSolpedsModal(stats) {
            const listContainer = document.getElementById('delayed-solpeds-list');
            if (!stats || stats.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-500 p-8">No hay Solpeds vencidas para mostrar.</p>';
                return;
            }

            let tableHTML = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Grupo de Compras</th>
                            <th class="px-4 py-2 text-right">Cantidad Vencidas</th>
                            <th class="px-4 py-2 text-right">% del Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;

            stats.forEach(group => {
                tableHTML += `
                    <tr class="hover:bg-slate-50 cursor-pointer" data-group-compras="${group.name}">
                        <td class="px-4 py-2 font-medium text-slate-900">${group.name}</td>
                        <td class="px-4 py-2 text-right font-bold text-red-600">${group.count}</td>
                        <td class="px-4 py-2 text-right">${group.percentage}%</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;
        }

        function calculateDelayedOCsStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const delayed = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate < today;
            });

            if (delayed.length === 0) {
                return [];
            }

            const groupData = {};
            delayed.forEach(oc => {
                const groupName = extractGroupCode(oc.grupoDeCompras || 'Sin Grupo');
                groupData[groupName] = (groupData[groupName] || 0) + 1;
            });
            
            const totalDelayed = delayed.length;

            return Object.entries(groupData).map(([name, count]) => {
                const percentage = totalDelayed > 0 ? (count / totalDelayed) * 100 : 0;
                return { name, count, percentage: percentage.toFixed(1) };
            }).sort((a, b) => b.count - a.count);
        }

        function renderDelayedOCsModal(stats) {
            const listContainer = document.getElementById('delayed-ocs-list');
            if (!stats || stats.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-500 p-8">No hay O/C vencidas para mostrar.</p>';
                return;
            }

            let tableHTML = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Grupo de Compras</th>
                            <th class="px-4 py-2 text-right">Cantidad Vencidas</th>
                            <th class="px-4 py-2 text-right">% del Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;

            stats.forEach(group => {
                tableHTML += `
                    <tr class="hover:bg-slate-50 cursor-pointer" data-group-compras="${group.name}">
                        <td class="px-4 py-2 font-medium text-slate-900">${group.name}</td>
                        <td class="px-4 py-2 text-right font-bold text-red-600">${group.count}</td>
                        <td class="px-4 py-2 text-right">${group.percentage}%</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;
        }

        function calculateGroupStats() {
            const groupData = {};

            items.forEach(item => {
                const groupName = item.group || 'General';
                if (!groupData[groupName]) {
                    groupData[groupName] = { totalItems: 0, favoriteItems: 0 };
                }
                groupData[groupName].totalItems++;
                if (item.isFavorite) {
                    groupData[groupName].favoriteItems++;
                }
            });

            return Object.entries(groupData).map(([name, data]) => {
                const percentage = data.totalItems > 0 ? (data.favoriteItems / data.totalItems) * 100 : 0;
                return { name, ...data, percentage: percentage.toFixed(1) };
            }).sort((a, b) => a.name.localeCompare(b.name));
        }

        function renderGroupStatsModal(stats) {
            const listContainer = document.getElementById('group-stats-list');
            if (!stats || stats.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-500 p-8">No hay grupos para mostrar.</p>';
                return;
            }

            let tableHTML = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Grupo</th>
                            <th class="px-4 py-2 text-right">Total Insumos</th>
                            <th class="px-4 py-2 text-right">Favoritos</th>
                            <th class="px-4 py-2 text-right">% Favoritos</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;

            stats.forEach(group => {
                tableHTML += `
                    <tr class="hover:bg-slate-50 cursor-pointer" data-group-name="${group.name}">
                        <td class="px-4 py-2 font-medium text-slate-900">${group.name}</td>
                        <td class="px-4 py-2 text-right">${group.totalItems}</td>
                        <td class="px-4 py-2 text-right text-yellow-600 font-semibold">${group.favoriteItems}</td>
                        <td class="px-4 py-2 text-right">${group.percentage}%</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;
        }

        // --- LÓGICA DE REVISIÓN SEMANAL (FIRESTORE) ---
        async function handleSaveReview() {
            if (!userId || !reviewHistoryCollectionRef) return;
            const reviewedGroups = Array.from(document.querySelectorAll('.review-checkbox:checked')).map(cb => cb.dataset.groupName);
            
            const weekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, weekId);
            try {
                await setDoc(reviewDocRef, { 
                    reviewedGroups, 
                    lastUpdatedBy: userId, 
                    weekId, 
                    updatedAt: serverTimestamp()
                }, { merge: true });
                showToast('Revisión guardada en la base de datos.', 'success');
            } catch (error) {
                console.error("Error al guardar la revisión: ", error);
                showToast('Error al guardar la revisión.', 'error');
            }
        }

        async function handleClearReview() {
            document.querySelectorAll('.review-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateReviewProgressBar();
            
            const weekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, weekId);
            try {
                await setDoc(reviewDocRef, { reviewedGroups: [], lastUpdatedBy: userId, updatedAt: serverTimestamp() }, { merge: true });
                showToast('Revisión limpiada.', 'info');
            } catch (error) {
                console.error("Error al limpiar la revisión: ", error);
                showToast('Error al limpiar la revisión.', 'error');
            }
        }


        function handleReviewCheckboxChange(event) {
            if (!event.target.matches('.review-checkbox')) return;
            updateReviewProgressBar();
        }

        function updateReviewProgressBar() {
            const checkboxes = document.querySelectorAll('.review-checkbox');
            const total = checkboxes.length;
            if (total === 0) return;
            
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percentage = Math.round((checkedCount / total) * 100);
            
            const progressBar = document.getElementById('progress-bar');
            const progressBarText = document.getElementById('progress-bar-text');
            
            progressBar.style.width = `${percentage}%`;
            progressBarText.textContent = `${percentage}%`;
        }

        async function loadCurrentWeekReview() {
            if (!reviewHistoryCollectionRef) return;
            const currentWeekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, currentWeekId);
            
            try {
                const docSnap = await getDoc(reviewDocRef);
                if (docSnap.exists()) {
                    const { reviewedGroups } = docSnap.data();
                    if (reviewedGroups && Array.isArray(reviewedGroups)) {
                        reviewedGroups.forEach(groupName => {
                            const checkbox = document.querySelector(`.review-checkbox[data-group-name="${groupName}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            } catch (error) {
                console.error("Error al cargar la revisión semanal:", error);
            } finally {
                updateReviewProgressBar();
            }
        }

        async function handleExportHistory() {
            if (!reviewHistoryCollectionRef) {
                showToast('No se pudo acceder al historial de revisiones.', 'error');
                return;
            }

            try {
                const querySnapshot = await getDocs(reviewHistoryCollectionRef);
                const history = querySnapshot.docs.map(doc => doc.data());
                
                if (history.length === 0) {
                    showToast('No hay historial de revisiones para exportar.', 'info');
                    return;
                }

                const allGroups = [...new Set(items.map(item => item.group || 'General'))].sort();
                const dataToExport = [];
                
                const historyMap = new Map();
                history.forEach(record => {
                    historyMap.set(record.weekId, new Set(record.reviewedGroups));
                });

                const allWeeks = [...historyMap.keys()].sort();

                const header = ['Grupo', ...allWeeks];
                dataToExport.push(header);

                allGroups.forEach(groupName => {
                    const row = { 'Grupo': groupName };
                    allWeeks.forEach(weekId => {
                         row[weekId] = historyMap.get(weekId)?.has(groupName) ? 'Sí' : 'No';
                    });
                    dataToExport.push(row);
                });
                
                if (dataToExport.length > 1) { // Header + at least one row
                    const filename = `${getCurrentDateString()}_Historial.xlsx`;
                    exportToExcel(dataToExport, filename);
                } else {
                    showToast('No se encontraron datos para exportar.', 'info');
                }

            } catch (error) {
                console.error("Error al exportar historial de revisiones:", error);
                showToast('Error al exportar el historial.', 'error');
            }
        }


        // --- LÓGICA DE LA PESTAÑA INSUMOS ---
        function handleClearIndiceFilters() {
            indiceSearchTerm = '';
            indiceSelectedGroup = 'all';
            indiceShowFavorites = false;
            indiceCoverageFilter = 'all';
            renderIndiceView();
        }

        function handleClearSolpedsFilters() {
            showOnlyDelayedSolpeds = false;
            solpedsSelectedGroup = 'all';
            solpedsSelectedYear = 'all';
            solpedsSelectedMonths = [];
            document.getElementById('solpeds-search-input').value = '';
            renderSolpedsView();
        }

        function handleClearOCsFilters() {
            showOnlyDelayedOCs = false;
            ocsSelectedGroup = 'all';
            ocsSelectedStatus = 'all';
            ocsSelectedYear = 'all';
            ocsSelectedMonths = [];
            document.getElementById('ocs-search-input').value = '';
            renderOCsView();
        }

        function renderIndiceView() {
            const container = document.getElementById('indice-table-container');
            const searchInput = document.getElementById('indice-search-input');
            const groupFilterContainer = document.getElementById('indice-group-filter-container');
            const clearFiltersBtn = document.getElementById('indice-clear-filters-btn');
            const { red, yellow } = appSettings.coverageThresholds;
            
            const isAnyFilterActive = indiceCoverageFilter !== 'all' || indiceSelectedGroup !== 'all' || indiceShowFavorites || indiceSearchTerm !== '';
            if (clearFiltersBtn) {
                clearFiltersBtn.classList.toggle('hidden', !isAnyFilterActive);
                if (isAnyFilterActive) {
                    clearFiltersBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                } else {
                    clearFiltersBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                }
            }
            
            searchInput.value = indiceSearchTerm;
            
            const filterButtonsContainer = document.getElementById('indice-coverage-filter-buttons');
            filterButtonsContainer.querySelector('[data-filter="red"]').textContent = `Crítico`;
            filterButtonsContainer.querySelector('[data-filter="yellow"]').textContent = `Precaución`;
            filterButtonsContainer.querySelector('[data-filter="green"]').textContent = `OK`;
            
            document.querySelectorAll('#indice-coverage-filter-buttons button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === indiceCoverageFilter);
            });
            
            const uniqueGroups = [...new Set(items.map(item => item.group))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="indice-group-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS LOS GRUPOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === indiceSelectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
                document.getElementById('indice-group-filter').value = indiceSelectedGroup;
            } else {
                groupFilterContainer.innerHTML = '';
            }

            if (items.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No hay datos de insumos.</p>';
                return;
            }

            let filteredItems = getProcessedItems();

            if (indiceCoverageFilter !== 'all') {
                filteredItems = filteredItems.filter(item => {
                    const days = item.coverageDays;
                    if (indiceCoverageFilter === 'red') return days < red;
                    if (indiceCoverageFilter === 'yellow') return days >= red && days <= yellow;
                    if (indiceCoverageFilter === 'green') return days > yellow || days === Infinity;
                    return false;
                });
            }
            if (indiceSelectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === indiceSelectedGroup);
            }
            if (indiceShowFavorites) {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            }
            if (indiceSearchTerm) {
                const searchWords = indiceSearchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredItems = filteredItems.filter(item => {
                    const itemText = `${item.name} ${item.description_notes || ''}`.toLowerCase();
                    return searchWords.every(word => itemText.includes(word));
                });
            }

            const counterEl = document.getElementById('indice-counter');
            if (counterEl) {
                counterEl.textContent = `(${filteredItems.length} de ${items.length})`;
            }

            filteredItems.sort((a, b) => {
                const key = indiceSortConfig.key;
                const dir = indiceSortConfig.direction === 'asc' ? 1 : -1;

                if (key === 'name') {
                    const nameA = a.name.replace(new RegExp(`^${a.code}\\s*`), '').toLowerCase();
                    const nameB = b.name.replace(new RegExp(`^${b.code}\\s*`), '').toLowerCase();
                    return nameA.localeCompare(nameB) * dir;
                }
                
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                
                if (key === 'stock' || key === 'coverageDays' || key === 'monthlyConsumption') {
                    valA = valA === Infinity ? Number.MAX_SAFE_INTEGER : parseFloat(valA) || 0;
                    valB = valB === Infinity ? Number.MAX_SAFE_INTEGER : parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });

            if (filteredItems.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No se encontraron resultados.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'isFavorite', label: '★', noSort: true, width: 'w-[4%]' },
                { key: 'group', label: 'GRUPO', width: 'w-[8%]' },
                { key: 'code', label: 'CÓDIGO', width: 'w-[8%]' },
                { key: 'name', label: 'MATERIAL', width: 'w-[27%]' },
                { key: 'stock', label: 'STOCK ACTUAL', class: 'justify-end border-l border-r border-slate-300', width: 'w-[10%]' },
                { key: 'monthlyConsumption', label: 'CONS. MENSUAL', class: 'justify-end', width: 'w-[10%]' },
                { key: 'coverageDays', label: 'COBERTURA (DÍAS)', class: 'justify-end', width: 'w-[10%]' },
                { key: 'description_notes', label: 'NOTAS', noSort: true, width: 'w-[15%]' }
            ];

            if (currentUserRole === 'owner' || currentUserRole === 'editor') {
                headers.push({ key: 'actions', label: 'ACCIONES', noSort: true, width: 'w-[5%]', class: 'text-center' });
            }
            
            let tableHTML = `<table class="w-full text-sm text-left text-slate-500 table-fixed"><thead class="text-sm text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = !h.noSort && indiceSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                
                let thBaseClass = `px-4 py-1 text-center ${headerClasses}`;
                if (h.class && (h.class.includes('border-l') || h.class.includes('border-r'))) {
                    thBaseClass += ' border-l border-r border-slate-300';
                }

                const widthClass = h.width || '';

                if (h.key === 'isFavorite') {
                    const activeClasses = 'bg-yellow-100 text-yellow-500 border-yellow-300';
                    const inactiveClasses = 'bg-transparent text-slate-400 border-slate-300 hover:bg-slate-100';
                    const buttonClasses = indiceShowFavorites ? activeClasses : inactiveClasses;
                    
                    tableHTML += `<th scope="col" class="px-4 py-1 w-[4%] text-center">
                        <button id="indice-favorites-header-filter-btn" class="w-7 h-7 rounded-full flex items-center justify-center transition-colors border ${buttonClasses}">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </button>
                    </th>`;
                } else if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thBaseClass} ${widthClass}">${h.label}</th>`;
                } else {
                    const buttonClasses = `table-sort-button justify-center ${isSortingKey ? 'active ' + indiceSortConfig.direction : ''}`;
                    const sortIcon = isSortingKey ? sortIconSVG : '';
                    tableHTML += `<th scope="col" class="${thBaseClass} ${widthClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredItems.forEach(item => {
                let coverageClass = '';
                let coverageText = item.coverageDays === Infinity ? '∞' : Math.round(item.coverageDays);
                if (item.coverageDays !== Infinity) {
                    if (item.coverageDays < red) coverageClass = 'text-red-600 font-bold';
                    else if (item.coverageDays >= red && item.coverageDays <= yellow) coverageClass = 'text-yellow-500 font-bold';
                    else if (item.coverageDays > yellow) coverageClass = 'text-green-600 font-bold';
                } else {
                     coverageClass = 'text-green-600 font-bold';
                }

                tableHTML += `<tr class="border-b hover:bg-slate-100 even:bg-slate-50">
                    <td class="px-4 py-2 text-center">
                        <button class="favorite-btn ${item.isFavorite ? 'is-favorite' : ''}" data-item-id="${item.id}" data-btn-type="indice-fav" ${currentUserRole === 'viewer' ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </button>
                    </td>
                    <td class="px-4 py-1 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.group}</td>
                    <td class="px-4 py-1 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-slate-900 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}</td>
                    <td class="px-4 py-2 text-right truncate indice-item-details cursor-pointer text-xl font-bold border-l border-r border-slate-300" data-item-id="${item.id}">${formatNumber(item.stock)}</td>
                    <td class="px-4 py-2 text-right truncate indice-item-details cursor-pointer text-base" data-item-id="${item.id}">${formatNumber(item.monthlyConsumption)}</td>
                    <td class="px-4 py-2 text-right ${coverageClass} text-base">${coverageText}</td>
                    <td class="px-4 py-2">
                        <input type="text" value="${item.description_notes || ''}" data-item-id="${item.id}" class="w-full bg-transparent text-xs text-slate-600 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white rounded p-1 notes-input-indice placeholder:text-center placeholder:text-slate-400 placeholder:text-lg" placeholder="+" ${currentUserRole === 'viewer' ? 'disabled' : ''}>
                    </td>
                `;

                if (currentUserRole === 'owner' || currentUserRole === 'editor') {
                    tableHTML += `<td class="px-4 py-2 text-center">
                        <button class="p-1 text-slate-400 hover:text-red-600 delete-item-btn" data-item-id="${item.id}" data-item-name="${item.name}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </td>`;
                }

                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
        }


        // --- LÓGICA DE LA PESTAÑA CONSUMOS ---
        function renderConsumosView() {
            const searchInput = document.getElementById('consumo-search-input');
            const clearTextBtn = document.getElementById('consumo-clear-text-btn');
            if (searchInput) {
                const selectedItem = items.find(i => i.id === selectedConsumptionItemId);
                const hasValue = selectedItem ? selectedItem.name : '';
                searchInput.value = hasValue;
                if (clearTextBtn) {
                    clearTextBtn.classList.toggle('hidden', !hasValue);
                }
            }
            
            const comparisonSearchInput = document.getElementById('consumo-comparison-search-input');
            const comparisonClearTextBtn = document.getElementById('consumo-comparison-clear-text-btn');
            if (comparisonSearchInput) {
                const selectedComparisonItem = items.find(i => i.id === comparisonItemId);
                const hasValue = selectedComparisonItem ? selectedComparisonItem.name : '';
                comparisonSearchInput.value = hasValue;
                if (comparisonClearTextBtn) {
                    comparisonClearTextBtn.classList.toggle('hidden', !hasValue);
                }
            }
            
            renderConsumoFilters('primary');
            renderConsumoFilters('comparison');
            renderConsumosContent();
        }

        function renderConsumoFilters(type) {
            const prefix = type === 'primary' ? '' : '-comparison';
            const groupFilterContainer = document.getElementById(`consumo${prefix}-group-filter-container`);
            const favoritesBtn = document.getElementById(`consumo${prefix}-favorites-filter-btn`);
            const selectedGroup = type === 'primary' ? consumoSelectedGroup : consumoComparisonSelectedGroup;
            const showFavorites = type === 'primary' ? consumoShowOnlyFavorites : consumoComparisonShowOnlyFavorites;

            const uniqueGroups = [...new Set(items.map(item => item.group))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="consumo${prefix}-group-filter" data-type="${type}" class="consumo-group-filter bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === selectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
            } else {
                groupFilterContainer.innerHTML = '';
            }
            
            favoritesBtn.classList.toggle('is-favorite', showFavorites);
        }
        
        function renderConsumosContent() {
            const contentArea = document.getElementById('consumo-content-area');
            contentArea.innerHTML = `
                <div id="consumo-panel-primary" class="w-[55%] bg-white overflow-y-auto"></div>
                <div class="w-px bg-slate-300"></div>
                <div id="consumo-panel-comparison" class="w-[45%] bg-white overflow-y-auto"></div>
            `;
            renderSingleConsumoPanel(selectedConsumptionItemId, 'primary');
            renderSingleConsumoPanel(comparisonItemId, 'comparison');
        }

        function renderSingleConsumoPanel(itemId, type) {
            const panel = document.getElementById(`consumo-panel-${type}`);
            if (!panel) return;

            const consumoIcons = {
                stock: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
                avg: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>',
                peak: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>',
                monthly: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
                coverage: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>'
            };

            panel.innerHTML = `
            <div class="p-4">
                <div class="flex justify-between items-start gap-2">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                         <div id="consumo-favorite-btn-container-${type}" class="flex-shrink-0"></div>
                         <div>
                            <div class="flex items-center gap-2">
                                <h3 id="consumo-kpi-name-${type}" class="text-lg font-bold text-[#6366f1] consumo-name-link cursor-pointer hover:underline">-</h3>
                                <button id="copy-consumo-name-${type}" class="btn-main-style !p-1.5 !h-auto flex-shrink-0 hidden" title="Copiar al portapapeles">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                            </div>
                            <p id="consumo-kpi-code-${type}" class="text-sm text-slate-500"></p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-xs font-medium text-slate-500 uppercase">Grupo</p>
                        <p id="consumo-kpi-group-${type}" class="text-base font-semibold text-[#6366f1] consumo-group-link cursor-pointer hover:underline">-</p>
                    </div>
                </div>
                <div class="grid grid-cols-5 gap-3 mt-4">
                    <div class="relative bg-white p-3 pt-6 rounded-lg shadow text-center"> <div class="absolute -top-2 -left-2 p-1.5 rounded-lg bg-indigo-100 text-indigo-600 shadow-md">${consumoIcons.stock}</div> <p id="consumo-kpi-stock-${type}" class="text-2xl font-bold text-slate-900">-</p><p class="text-xs font-medium text-slate-500 mt-0.5 uppercase">Stock</p></div>
                    <div class="relative bg-white p-3 pt-6 rounded-lg shadow text-center"> <div class="absolute -top-2 -left-2 p-1.5 rounded-lg bg-indigo-100 text-indigo-600 shadow-md">${consumoIcons.avg}</div> <p id="consumo-kpi-avg-${type}" class="text-2xl font-bold text-indigo-600">-</p><p class="text-xs font-medium text-slate-500 mt-0.5 uppercase">Promedio</p></div>
                    <div class="relative bg-white p-3 pt-6 rounded-lg shadow text-center"> <div class="absolute -top-2 -left-2 p-1.5 rounded-lg bg-indigo-100 text-indigo-600 shadow-md">${consumoIcons.peak}</div> <p id="consumo-kpi-peak-${type}" class="text-2xl font-bold text-green-600">-</p><div class="flex justify-center items-baseline gap-1"><p class="text-xs font-medium text-slate-500 mt-0.5 uppercase">Pico</p><p id="consumo-kpi-peak-month-${type}" class="text-xs text-slate-500 truncate"></p></div></div>
                    <div class="relative bg-white p-3 pt-6 rounded-lg shadow text-center border-2 border-indigo-500"> <div class="absolute -top-2 -left-2 p-1.5 rounded-lg bg-indigo-100 text-indigo-600 shadow-md">${consumoIcons.monthly}</div> <p id="consumo-kpi-monthly-consumption-${type}" class="text-2xl font-bold text-slate-900">-</p><p class="text-xs font-medium text-slate-500 mt-0.5 uppercase">Cons. Mensual</p></div>
                    <div class="relative bg-white p-3 pt-6 rounded-lg shadow text-center border-2 border-indigo-500"> <div class="absolute -top-2 -left-2 p-1.5 rounded-lg bg-indigo-100 text-indigo-600 shadow-md">${consumoIcons.coverage}</div> <p id="consumo-kpi-coverage-today-${type}" class="text-2xl font-bold text-slate-900">-</p><p class="text-xs font-medium text-slate-500 mt-0.5 uppercase">Cobertura</p></div>
                </div>
                <div id="consumo-chart-wrapper-${type}" class="consumo-chart-wrapper">
                    <p class="text-slate-500 m-auto">Seleccione un producto para ver su historial.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
                    <div id="consumo-solpeds-container-${type}" class="md:col-span-2"></div>
                    <div id="consumo-ocs-container-${type}" class="md:col-span-3"></div>
                </div>
                 <div class="mt-4 pt-4 border-t flex items-center gap-4">
                    <label for="consumo-description-notes-${type}" class="font-medium text-sm text-slate-700 whitespace-nowrap">Notas:</label>
                    <textarea id="consumo-description-notes-${type}" rows="1" class="py-1 px-2 bg-white border border-slate-300 rounded-md w-full focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition text-sm resize-none" placeholder="Añadir una descripción..." disabled></textarea>
                </div>
            </div>
            `;
            
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const processedItem = getProcessedItems().find(i => i.id === itemId);

            const favoriteBtnContainer = document.getElementById(`consumo-favorite-btn-container-${type}`);
            const favoriteBtn = document.createElement('button');
            favoriteBtn.className = `favorite-btn ${item.isFavorite ? 'is-favorite' : ''}`;
            favoriteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>`;
            favoriteBtn.dataset.itemId = itemId;
            if (currentUserRole === 'viewer') {
                favoriteBtn.disabled = true;
            }
            favoriteBtnContainer.innerHTML = '';
            favoriteBtnContainer.appendChild(favoriteBtn);

            const nameEl = document.getElementById(`consumo-kpi-name-${type}`);
            nameEl.textContent = item.name.replace(new RegExp(`^${item.code}\\s*`), '');
            nameEl.dataset.itemCode = item.code;

            const groupEl = document.getElementById(`consumo-kpi-group-${type}`);
            groupEl.textContent = item.group || 'N/A';
            groupEl.dataset.groupName = item.group;

            const textToCopy = `${item.code} - ${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}`;
            document.getElementById(`consumo-kpi-code-${type}`).textContent = item.code;
            

            const copyBtn = document.getElementById(`copy-consumo-name-${type}`);
            if (copyBtn) {
                copyBtn.classList.remove('hidden');
                copyBtn.onclick = () => handleCopyText(textToCopy, copyBtn);
            }

            document.getElementById(`consumo-kpi-stock-${type}`).textContent = formatNumber(item.stock);
            
            const allConsumos = item.consumos || [];
            const selectedMonths = appSettings.consumptionMonths || Array(12).fill(true);
            const allMonthNames = ["M1", "M2", "M3", "M4", "M5", "M6", "M7", "M8", "M9", "M10", "M11", "M12"];
            
            const consumos = [];
            const monthLabels = [];

            selectedMonths.forEach((isSelected, index) => {
                if (isSelected && index < allConsumos.length) {
                    consumos.push(allConsumos[index]);
                    monthLabels.push(allMonthNames[index]);
                }
            });

            const avgConsumption = consumos.length > 0 ? consumos.reduce((a, b) => a + b, 0) / consumos.length : 0;
            const peakConsumption = consumos.length > 0 ? Math.max(...consumos) : 0;
            let peakMonths = [];
            if (peakConsumption > 0) {
                consumos.forEach((consumo, index) => {
                    if (consumo === peakConsumption) {
                        peakMonths.push(monthLabels[index]);
                    }
                });
            }

            document.getElementById(`consumo-kpi-avg-${type}`).textContent = formatNumber(Math.round(avgConsumption));
            document.getElementById(`consumo-kpi-peak-${type}`).textContent = formatNumber(Math.round(peakConsumption));
            const peakMonthEl = document.getElementById(`consumo-kpi-peak-month-${type}`);
            if(peakMonthEl) {
               peakMonthEl.textContent = peakMonths.join(', ');
            }
            document.getElementById(`consumo-kpi-monthly-consumption-${type}`).textContent = formatNumber(Math.round(item.monthlyConsumption));
            document.getElementById(`consumo-kpi-coverage-today-${type}`).textContent = (processedItem.coverageDays === Infinity) ? '∞' : Math.round(processedItem.coverageDays);
            
            const notesTextarea = document.getElementById(`consumo-description-notes-${type}`);
            notesTextarea.value = item.description_notes || '';
            notesTextarea.disabled = currentUserRole === 'viewer';
            notesTextarea.dataset.itemId = itemId;
            
            const chartWrapper = document.getElementById(`consumo-chart-wrapper-${type}`);
            if (!consumos || consumos.length === 0) {
                chartWrapper.innerHTML = '<p class="text-slate-500 m-auto">Este producto no tiene historial de consumo.</p>';
            } else {
                const getNiceMaxValue = (max) => { if (max <= 0) return 10; const power = Math.floor(Math.log10(max)); const magnitude = Math.pow(10, power); return Math.ceil(max / magnitude) * magnitude; };
                
                const nonZeroConsumos = consumos.filter(c => c > 0);
                const minValue = nonZeroConsumos.length > 0 ? Math.min(...nonZeroConsumos) : 0;
                const peakConsumption = Math.max(...consumos, item.monthlyConsumption);
                const uniqueValues = [...new Set(nonZeroConsumos)];
                
                const maxValue = getNiceMaxValue(peakConsumption);
                const yAxisLabels = [0, maxValue * 0.25, maxValue * 0.5, maxValue * 0.75, maxValue];
                let yAxisHtml = '<div class="consumo-y-axis">';
                yAxisLabels.reverse().forEach(label => { yAxisHtml += `<span>${formatNumber(Math.round(label))}</span>`; });
                yAxisHtml += '</div>';

                
                let barsHtml = '<div class="consumo-chart-container">';

                if (item.monthlyConsumption > 0 && maxValue > 0) {
                    const projectedLinePosition = Math.min((item.monthlyConsumption / maxValue) * 100, 100);
                    barsHtml += `<div class="consumo-chart-projected-line" style="bottom: ${projectedLinePosition}%;"><span class="consumo-chart-projected-label">${formatNumber(Math.round(item.monthlyConsumption))}</span></div>`;
                }

                barsHtml += consumos.map((value, index) => {
                    const barHeight = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    const displayValue = value > 5000 ? (value/1000).toFixed(0) + 'k' : formatNumber(value);
                    
                    let barClass = 'bg-indigo-500'; // Azul por defecto
                    if (value > 0 && uniqueValues.length > 1) {
                        if (value === Math.max(...nonZeroConsumos)) barClass = 'bg-green-600'; // Verde más intenso pero apagado
                        else if (value === minValue) barClass = 'bg-red-600'; // Rojo más intenso pero apagado
                    }

                    return `<div class="consumo-chart-bar-wrapper"><div class="consumo-chart-bar ${barClass}" style="height: ${barHeight}%;"><div class="consumo-chart-value">${displayValue}</div></div><div class="consumo-chart-label">${monthLabels[index]}</div></div>`;
                }).join('');
                barsHtml += '</div>';
                chartWrapper.innerHTML = yAxisHtml + barsHtml;
            }

            const solpedsContainer = document.getElementById(`consumo-solpeds-container-${type}`);
            const ocsContainer = document.getElementById(`consumo-ocs-container-${type}`);

            let itemSolpeds = solpeds.filter(s => s.cod == item.code);
            itemSolpeds.sort((a,b) => {
                const dateA = parseDateString(a.fechaLiberacion);
                const dateB = parseDateString(b.fechaLiberacion);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });
            let solpedsTableHTML = `<h4 class="font-bold text-slate-700 mb-2">Solicitudes de Pedido</h4>`;
            if(itemSolpeds.length > 0) {
                const today = new Date();
                today.setHours(0,0,0,0);
                solpedsTableHTML += `<div class="max-h-60 overflow-y-auto rounded-lg border border-slate-200"><table class="w-full text-sm table-fixed">
                    <thead class="bg-slate-50 sticky top-0"><tr class="border-b border-slate-200"><th class="px-3 py-2 text-left w-[30%] font-semibold text-slate-600">N° Solped</th><th class="px-3 py-2 text-right w-[30%] font-semibold text-slate-600">Cantidad</th><th class="px-3 py-2 text-left w-[40%] font-semibold text-slate-600">F. Lib.</th></tr></thead><tbody class="divide-y divide-slate-100">`;
                itemSolpeds.forEach(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    const isDelayed = releaseDate && releaseDate < today;
                    const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                    solpedsTableHTML += `<tr class="consumo-solped-link cursor-pointer hover:bg-slate-50" data-solped-id="${s.solicitud}"><td class="px-3 py-2 truncate font-medium text-slate-800">${s.solicitud}</td><td class="px-3 py-2 text-right">${formatNumber(s.cantidad)}</td><td class="px-3 py-2 whitespace-nowrap ${dateClass}">${formatDate(s.fechaLiberacion)}</td></tr>`;
                });
                solpedsTableHTML += `</tbody></table></div>`;
            } else {
                solpedsTableHTML += `<p class="text-sm text-slate-500">No hay Solpeds para este insumo.</p>`;
            }
            solpedsContainer.innerHTML = solpedsTableHTML;

            let itemOCs = ocs.filter(oc => oc.codigo == item.code);

            itemOCs.sort((a,b) => {
                const dateA = parseDateString(a.proxFechaEntrega);
                const dateB = parseDateString(b.proxFechaEntrega);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            let ocsTableHTML = `<h4 class="font-bold text-slate-700 mb-2">Órdenes de Compra</h4>`;
            if(itemOCs.length > 0) {
                const today = new Date();
                today.setHours(0,0,0,0);
                ocsTableHTML += `<div class="max-h-60 overflow-y-auto rounded-lg border border-slate-200"><table class="w-full text-sm table-fixed">
                    <thead class="bg-slate-50 sticky top-0"><tr class="border-b border-slate-200"><th class="px-3 py-2 text-left w-[20%] font-semibold text-slate-600">N° O/C</th><th class="px-3 py-2 text-left w-[35%] font-semibold text-slate-600">Status</th><th class="px-3 py-2 text-right w-[15%] font-semibold text-slate-600">Cant.</th><th class="px-3 py-2 text-left w-[30%] font-semibold text-slate-600">Entrega</th></tr></thead><tbody class="divide-y divide-slate-100">`;
                itemOCs.forEach(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    const isDelayed = deliveryDate && deliveryDate < today;
                    const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                    const transformedStatus = transformOCStatus(oc.status);
                    
                    let rowClass = 'consumo-oc-link cursor-pointer hover:bg-slate-50';
                     if (oc.status && oc.status.toLowerCase().includes('en proceso de autorización')) {
                        rowClass += ' bg-yellow-50 hover:bg-yellow-100';
                    }
                    if (oc.status && oc.status.toLowerCase().includes('rechazado')) {
                        rowClass += ' bg-red-50 hover:bg-red-100';
                    }

                    ocsTableHTML += `<tr class="${rowClass}" data-oc-id="${oc.ordenDeCompra}"><td class="px-3 py-2 truncate font-medium text-slate-800">${oc.ordenDeCompra}</td><td class="px-3 py-2 text-xs truncate">${transformedStatus}</td><td class="px-3 py-2 text-right">${formatNumber(oc.cantEntregaSiguiente)}</td><td class="px-3 py-2 whitespace-nowrap ${dateClass}">${formatDate(oc.proxFechaEntrega)}</td></tr>`;
                });
                ocsTableHTML += `</tbody></table></div>`;
            } else {
                ocsTableHTML += `<p class="text-sm text-slate-500">No hay O/Cs para este insumo.</p>`;
            }
            ocsContainer.innerHTML = ocsTableHTML;
        }

        function handleConsumosFilterChange(event) {
            const type = event.target.dataset.type;
            if (type === 'primary') {
                consumoSelectedGroup = event.target.value;
            } else {
                consumoComparisonSelectedGroup = event.target.value;
            }
            handleConsumosSearch({ target: { value: document.getElementById(`consumo${type === 'primary' ? '' : '-comparison'}-search-input`).value } }, type);
        }

        function handleConsumosFavoritesToggle(buttonElement) {
            const type = buttonElement.dataset.type;
            if (type === 'primary') {
                consumoShowOnlyFavorites = !consumoShowOnlyFavorites;
            } else {
                consumoComparisonShowOnlyFavorites = !consumoComparisonShowOnlyFavorites;
            }
            renderConsumoFilters(type);
            handleConsumosSearch({ target: { value: document.getElementById(`consumo${type === 'primary' ? '' : '-comparison'}-search-input`).value } }, type);
        }

        function handleClearConsumoPanel(type) {
            const prefix = type === 'primary' ? '' : '-comparison';
            
            if (type === 'primary') {
                selectedConsumptionItemId = null;
                consumoSelectedGroup = 'all';
                consumoShowOnlyFavorites = false;
            } else { // comparison
                comparisonItemId = null;
                consumoComparisonSelectedGroup = 'all';
                consumoComparisonShowOnlyFavorites = false;
            }
            
            const searchInput = document.getElementById(`consumo${prefix}-search-input`);
            const searchResults = document.getElementById(`consumo${prefix}-search-results`);
            const clearTextBtn = document.getElementById(`consumo${prefix}-clear-text-btn`);
            
            if(searchInput) searchInput.value = '';
            if(searchResults) {
                searchResults.innerHTML = '';
                searchResults.classList.add('hidden');
            }
            if(clearTextBtn) {
                clearTextBtn.classList.add('hidden');
            }
            
            renderConsumoFilters(type);
            renderSingleConsumoPanel(null, type);
        }

        function handleConsumosSearch(event, type) {
            const searchTerm = event.target.value.toLowerCase();
            const prefix = type === 'primary' ? '' : '-comparison';
            const resultsContainer = document.getElementById(`consumo${prefix}-search-results`);
            const selectedGroup = type === 'primary' ? consumoSelectedGroup : consumoComparisonSelectedGroup;
            const showFavorites = type === 'primary' ? consumoShowOnlyFavorites : consumoComparisonShowOnlyFavorites;
            const clearTextBtn = document.getElementById(`consumo${prefix}-clear-text-btn`);

            if (clearTextBtn) {
                clearTextBtn.classList.toggle('hidden', !searchTerm);
            }
            
            let filteredItems = items;

            if (selectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === selectedGroup);
            }
            if (showFavorites) {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            }
            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredItems = filteredItems.filter(item => {
                    const itemText = item.name.toLowerCase();
                    return searchWords.every(word => itemText.includes(word));
                });
            }

            if (!searchTerm && selectedGroup === 'all' && !showFavorites) {
                 resultsContainer.innerHTML = '';
                 resultsContainer.classList.add('hidden');
                 return;
            }
            
            resultsContainer.classList.remove('hidden');

            if (filteredItems.length > 0) {
                resultsContainer.innerHTML = filteredItems
                    .map(item => `<div class="p-2 hover:bg-slate-100 cursor-pointer" data-item-id="${item.id}" data-type="${type}">${item.name}</div>`)
                    .join('');
            } else {
                resultsContainer.innerHTML = '<div class="p-2 text-slate-500">No se encontraron productos.</div>';
            }
        }

        function handleSelectConsumosItem(event) {
            const target = event.target.closest('[data-item-id]');
            if (target) {
                const { itemId, type } = target.dataset;
                const prefix = type === 'primary' ? '' : '-comparison';
                if (type === 'primary') {
                    selectedConsumptionItemId = itemId;
                } else {
                    comparisonItemId = itemId;
                }
                document.getElementById(`consumo${prefix}-search-input`).value = target.textContent;
                const resultsContainer = document.getElementById(`consumo${prefix}-search-results`);
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');

                const clearTextBtn = document.getElementById(`consumo${prefix}-clear-text-btn`);
                if(clearTextBtn) {
                    clearTextBtn.classList.remove('hidden');
                }

                renderSingleConsumoPanel(itemId, type);
            }
        }

        // --- LÓGICA DE LA PESTAÑA SOLPEDS Y OCs ---
        function handleSolpedsSort(key) {
            if (solpedsSortConfig.key === key) {
                solpedsSortConfig.direction = solpedsSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                solpedsSortConfig.key = key;
                solpedsSortConfig.direction = 'asc';
            }
            renderSolpedsView();
        }
        function handleOCsSort(key) {
            if (ocsSortConfig.key === key) {
                ocsSortConfig.direction = ocsSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                ocsSortConfig.key = key;
                ocsSortConfig.direction = 'asc';
            }
            renderOCsView();
        }
        function renderSolpedsView() {
            const container = document.getElementById('solpeds-table-container');
            const searchInput = document.getElementById('solpeds-search-input');
            const delayedFilterBtn = document.getElementById('solpeds-delayed-filter-btn');
            const searchTerm = searchInput.value.toLowerCase();
            const groupFilterContainer = document.getElementById('solpeds-group-filter-container');
            const dateFilterContainer = document.getElementById('solpeds-date-filter-container');
            const clearFiltersBtn = document.getElementById('solpeds-clear-filters-btn');

            const isAnyFilterActive = showOnlyDelayedSolpeds || solpedsSelectedGroup !== 'all' || solpedsSelectedYear !== 'all' || solpedsSelectedMonths.length > 0 || searchTerm !== '';
            if (clearFiltersBtn) {
                clearFiltersBtn.classList.toggle('hidden', !isAnyFilterActive);
                if (isAnyFilterActive) {
                    clearFiltersBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                } else {
                    clearFiltersBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                }
            }

            delayedFilterBtn.classList.toggle('bg-red-200', showOnlyDelayedSolpeds);
            delayedFilterBtn.classList.toggle('border-red-400', showOnlyDelayedSolpeds);
            delayedFilterBtn.classList.toggle('text-red-800', showOnlyDelayedSolpeds);

            if (solpeds.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No hay datos de Solpeds. Precarga un archivo para visualizarlos.</p>';
                dateFilterContainer.innerHTML = '';
                groupFilterContainer.innerHTML = '';
                return;
            }

            const uniqueGroups = [...new Set(solpeds.map(s => s.grupoDeArticulos).filter(Boolean))].sort();
            if (uniqueGroups.length > 0) {
                let groupFilterHTML = `<select id="solpeds-group-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === solpedsSelectedGroup ? 'selected' : '';
                    groupFilterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                groupFilterHTML += `</select>`;
                groupFilterContainer.innerHTML = groupFilterHTML;
            } else {
                groupFilterContainer.innerHTML = '';
            }

            const allYears = [...new Set(solpeds.map(s => s.fechaLiberacion ? s.fechaLiberacion.substring(0, 4) : null).filter(Boolean))].sort((a, b) => b - a);

            let yearButtonsHTML = '<div class="flex items-center p-0.5 bg-indigo-600 rounded-lg">';
            yearButtonsHTML += `<button class="solpeds-year-btn indice-coverage-btn ${solpedsSelectedYear === 'all' ? 'active' : ''}" data-year="all">Todos</button>`;
            allYears.forEach(year => {
                yearButtonsHTML += `<button class="solpeds-year-btn indice-coverage-btn ${solpedsSelectedYear === year ? 'active' : ''}" data-year="${year}">${year}</button>`;
            });
            yearButtonsHTML += '</div>';

            let monthDropdownHTML = '<div id="solpeds-month-filter-dropdown" class="relative ml-2">';
            let monthButtonText = 'Seleccione Año';
            let monthButtonDisabled = 'disabled';
            let monthPanelContent = '';

            if (solpedsSelectedYear !== 'all') {
                monthButtonDisabled = '';
                const monthsInYear = [...new Set(solpeds
                    .filter(s => s.fechaLiberacion && s.fechaLiberacion.startsWith(solpedsSelectedYear))
                    .map(s => s.fechaLiberacion.substring(5, 7))
                )].sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

                if (monthsInYear.length > 0) {
                    if (solpedsSelectedMonths.length === 0 || solpedsSelectedMonths.length === monthsInYear.length) {
                        monthButtonText = 'Todos los Meses';
                    } else {
                        monthButtonText = `${solpedsSelectedMonths.length} Mes(es) Seleccionado(s)`;
                    }

                    monthPanelContent = monthsInYear.map(monthNum => {
                        const date = new Date(solpedsSelectedYear, parseInt(monthNum, 10) - 1);
                        let monthName = date.toLocaleString('es-AR', { month: 'long', timeZone: 'UTC' });
                        monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                        const isChecked = solpedsSelectedMonths.includes(monthNum);
                        return `
                            <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-100">
                                <input type="checkbox" class="solpeds-month-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="${monthNum}" ${isChecked ? 'checked' : ''}>
                                <span class="text-sm">${monthNum} - ${monthName}</span>
                            </label>`;
                    }).join('');
                } else {
                     monthButtonText = 'Sin Meses';
                     monthButtonDisabled = 'disabled';
                }
            }

            monthDropdownHTML += `<button id="solpeds-month-filter-btn" class="btn-main-style w-48 text-left justify-start" ${monthButtonDisabled}>${monthButtonText}</button>`;
            monthDropdownHTML += `<div id="solpeds-month-filter-panel" class="hidden absolute top-full left-0 mt-1 bg-white border rounded-lg shadow-lg z-30 p-2 space-y-1 w-48 max-h-60 overflow-y-auto">${monthPanelContent}</div>`;
            monthDropdownHTML += `</div>`;
            
            dateFilterContainer.innerHTML = yearButtonsHTML + monthDropdownHTML;


            const itemsByCode = new Map(items.map(item => [item.code, item.id]));

            let filteredSolpeds = solpeds;

            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredSolpeds = filteredSolpeds.filter(s => {
                    const searchableText = [
                        s.solicitud, s.cod, s.descripcion, s.creadoPor, s.grupoDeCompras, s.grupoDeArticulos
                    ].join(' ').toLowerCase();
                    return searchWords.every(word => searchableText.includes(word));
                });
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (showOnlyDelayedSolpeds) {
                filteredSolpeds = filteredSolpeds.filter(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    return releaseDate && releaseDate <= today;
                });
            }

            if (solpedsSelectedGroup !== 'all') {
                filteredSolpeds = filteredSolpeds.filter(s => s.grupoDeArticulos === solpedsSelectedGroup);
            }

            if (solpedsSelectedYear !== 'all') {
                filteredSolpeds = filteredSolpeds.filter(s => s.fechaLiberacion && s.fechaLiberacion.startsWith(solpedsSelectedYear));
                if (solpedsSelectedMonths.length > 0) {
                    filteredSolpeds = filteredSolpeds.filter(s => {
                        if (!s.fechaLiberacion) return false;
                        const month = s.fechaLiberacion.substring(5, 7);
                        return solpedsSelectedMonths.includes(month);
                    });
                }
            }

            const solpedsCounterEl = document.getElementById('solpeds-counter');
            if (solpedsCounterEl) {
                solpedsCounterEl.textContent = `(${filteredSolpeds.length} de ${solpeds.length})`;
            }

            filteredSolpeds.sort((a, b) => {
                const key = solpedsSortConfig.key;
                const dir = solpedsSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                if (key === 'cantidad') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else if (key === 'fechaSolicitud' || key === 'fechaLiberacion') {
                    valA = parseDateString(valA)?.getTime() || 0;
                    valB = parseDateString(valB)?.getTime() || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });

            if (filteredSolpeds.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No se encontraron resultados para tu búsqueda.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'diasDesdeCreacion', label: 'DÍAS ACTIVA', noSort: true, class: 'text-center' },
                { key: 'creadoPor', label: 'CREADO POR' }, { key: 'solicitud', label: 'SOLICITUD' },
                { key: 'fechaSolicitud', label: 'FECHA SOL.' }, { key: 'status', label: 'STATUS', noSort: true, class: 'text-center' },
                { key: 'grupoDeArticulos', label: 'GRUPO ARTÍCULOS' },
                { key: 'cod', label: 'CÓDIGO' }, { key: 'descripcion', label: 'DESCRIPCIÓN' },
                { key: 'cantidad', label: 'CANTIDAD', class: 'justify-end' },
                { key: 'grupoDeCompras', label: 'GRUPO COMPRAS' },
                { key: 'fechaLiberacion', label: 'FECHA LIBERACIÓN' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-sm text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = !h.noSort && solpedsSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                const thClass = `px-4 py-3 ${h.class && !h.noSort ? 'text-left' : h.class || ''} ${headerClasses}`;

                if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thClass}">${h.label}</th>`;
                } else {
                    const buttonClasses = `table-sort-button ${h.class || ''} ${isSortingKey ? 'active ' + solpedsSortConfig.direction : ''}`;
                    const sortIcon = isSortingKey ? sortIconSVG : '';
                    tableHTML += `<th scope="col" class="${thClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredSolpeds.forEach(s => {
                const itemId = itemsByCode.get(s.cod);
                
                const creationDate = parseDateString(s.fechaSolicitud);
                let daysActive = '';
                if (creationDate) {
                    daysActive = daysBetween(creationDate, today);
                }
                
                const releaseDate = parseDateString(s.fechaLiberacion);
                const isDelayed = releaseDate && releaseDate <= today;
                let rowClass = isDelayed ? 'bg-red-100 hover:bg-red-200 text-red-900' : 'hover:bg-indigo-50 even:bg-slate-50';
                if (itemId) rowClass += ' cursor-pointer solped-item-row';
                const dateClass = isDelayed ? 'font-bold' : '';

                tableHTML += `<tr class="border-b ${rowClass}" ${itemId ? `data-item-id="${itemId}"` : ''}>
                    <td class="px-4 py-3 text-center font-bold">${daysActive}</td>
                    <td class="px-4 py-3">${s.creadoPor}</td>
                    <td class="px-4 py-3 font-medium text-slate-900">${s.solicitud}</td>
                    <td class="px-4 py-3">${formatDate(s.fechaSolicitud)}</td>
                    <td class="px-4 py-3 text-center">${s.status}</td>
                    <td class="px-4 py-3">${extractGroupCode(s.grupoDeArticulos) || ''}</td>
                    <td class="px-4 py-3">${s.cod}</td>
                    <td class="px-4 py-3">${s.descripcion}</td>
                    <td class="px-4 py-3 text-right">${formatNumber(s.cantidad)}</td>
                    <td class="px-4 py-3">${s.grupoDeCompras || ''}</td>
                    <td class="px-4 py-3 ${dateClass}">${formatDate(s.fechaLiberacion)}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
        }

        function renderOCsView() {
            const container = document.getElementById('ocs-table-container');
            const searchInput = document.getElementById('ocs-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const delayedFilterBtn = document.getElementById('ocs-delayed-filter-btn');
            const groupFilterContainer = document.getElementById('ocs-group-filter-container');
            const statusFilterContainer = document.getElementById('ocs-status-filter-container');
            const dateFilterContainer = document.getElementById('ocs-date-filter-container');
            const clearFiltersBtn = document.getElementById('ocs-clear-filters-btn');

            const isAnyFilterActive = showOnlyDelayedOCs || ocsSelectedGroup !== 'all' || ocsSelectedStatus !== 'all' || ocsSelectedYear !== 'all' || ocsSelectedMonths.length > 0 || searchTerm !== '';
            if (clearFiltersBtn) {
                clearFiltersBtn.classList.toggle('hidden', !isAnyFilterActive);
                if (isAnyFilterActive) {
                    clearFiltersBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                } else {
                    clearFiltersBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                }
            }

            delayedFilterBtn.classList.toggle('bg-red-200', showOnlyDelayedOCs);
            delayedFilterBtn.classList.toggle('border-red-400', showOnlyDelayedOCs);
            delayedFilterBtn.classList.toggle('text-red-800', showOnlyDelayedOCs);

            if (ocs.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No hay datos de O/C. Precarga un archivo para visualizarlos.</p>';
                dateFilterContainer.innerHTML = '';
                groupFilterContainer.innerHTML = '';
                statusFilterContainer.innerHTML = '';
                return;
            }

            const uniqueGroups = [...new Set(ocs.map(oc => extractGroupCode(oc.grupoDeArticulos)).filter(Boolean))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="ocs-group-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === ocsSelectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
            } else {
                groupFilterContainer.innerHTML = '';
            }

            // --- Lógica del filtro de Fecha (Año y Mes) ---
            const allYears = [...new Set(ocs.map(oc => oc.proxFechaEntrega ? oc.proxFechaEntrega.substring(0, 4) : null).filter(Boolean))].sort((a, b) => b - a);

            let yearButtonsHTML = '<div class="flex items-center p-0.5 bg-indigo-600 rounded-lg">';
            yearButtonsHTML += `<button class="ocs-year-btn indice-coverage-btn ${ocsSelectedYear === 'all' ? 'active' : ''}" data-year="all">Todos</button>`;
            allYears.forEach(year => {
                yearButtonsHTML += `<button class="ocs-year-btn indice-coverage-btn ${ocsSelectedYear === year ? 'active' : ''}" data-year="${year}">${year}</button>`;
            });
            yearButtonsHTML += '</div>';

            let monthDropdownHTML = '<div id="ocs-month-filter-dropdown" class="relative ml-2">';
            let monthButtonText = 'Seleccione Año';
            let monthButtonDisabled = 'disabled';
            let monthPanelContent = '';

            if (ocsSelectedYear !== 'all') {
                monthButtonDisabled = '';
                const monthsInYear = [...new Set(ocs
                    .filter(oc => oc.proxFechaEntrega && oc.proxFechaEntrega.startsWith(ocsSelectedYear))
                    .map(oc => oc.proxFechaEntrega.substring(5, 7))
                )].sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

                if (monthsInYear.length > 0) {
                    if (ocsSelectedMonths.length === 0 || ocsSelectedMonths.length === monthsInYear.length) {
                        monthButtonText = 'Todos los Meses';
                    } else {
                        monthButtonText = `${ocsSelectedMonths.length} Mes(es) Seleccionado(s)`;
                    }

                    monthPanelContent = monthsInYear.map(monthNum => {
                        const date = new Date(ocsSelectedYear, parseInt(monthNum, 10) - 1);
                        let monthName = date.toLocaleString('es-AR', { month: 'long', timeZone: 'UTC' });
                        monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                        const isChecked = ocsSelectedMonths.includes(monthNum);
                        return `
                            <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-100">
                                <input type="checkbox" class="ocs-month-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="${monthNum}" ${isChecked ? 'checked' : ''}>
                                <span class="text-sm">${monthNum} - ${monthName}</span>
                            </label>`;
                    }).join('');
                } else {
                     monthButtonText = 'Sin Meses';
                     monthButtonDisabled = 'disabled';
                }
            }

            monthDropdownHTML += `<button id="ocs-month-filter-btn" class="btn-main-style w-48 text-left justify-start" ${monthButtonDisabled}>${monthButtonText}</button>`;
            monthDropdownHTML += `<div id="ocs-month-filter-panel" class="hidden absolute top-full left-0 mt-1 bg-white border rounded-lg shadow-lg z-30 p-2 space-y-1 w-48 max-h-60 overflow-y-auto">${monthPanelContent}</div>`;
            monthDropdownHTML += `</div>`;
            
            dateFilterContainer.innerHTML = yearButtonsHTML + monthDropdownHTML;


            const uniqueStatuses = [...new Set(ocs.map(oc => transformOCStatus(oc.status)).filter(Boolean))].sort();
            if (uniqueStatuses.length > 0) {
                let statusFilterHTML = `<select id="ocs-status-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS LOS STATUS</option>`;
                uniqueStatuses.forEach(status => {
                    const selected = status === ocsSelectedStatus ? 'selected' : '';
                    statusFilterHTML += `<option value="${status}" ${selected}>${status}</option>`;
                });
                statusFilterHTML += `</select>`;
                statusFilterContainer.innerHTML = statusFilterHTML;
            } else {
                statusFilterContainer.innerHTML = '';
            }

            const itemsByCode = new Map(items.map(item => [item.code, item.id]));

            let filteredOCs = ocs;

            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredOCs = filteredOCs.filter(oc => {
                    const searchableText = [
                        oc.solped, oc.ordenDeCompra, oc.codigo, oc.denominacion, oc.grupoDeArticulos, oc.grupoDeCompras, oc.status
                    ].join(' ').toLowerCase();
                    return searchWords.every(word => searchableText.includes(word));
                });
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (showOnlyDelayedOCs) {
                filteredOCs = filteredOCs.filter(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    return deliveryDate && deliveryDate < today;
                });
            }

            if (ocsSelectedGroup !== 'all') {
                filteredOCs = filteredOCs.filter(oc => extractGroupCode(oc.grupoDeArticulos) === ocsSelectedGroup);
            }
            
            if (ocsSelectedStatus !== 'all') {
                filteredOCs = filteredOCs.filter(oc => transformOCStatus(oc.status) === ocsSelectedStatus);
            }

            if (ocsSelectedYear !== 'all') {
                filteredOCs = filteredOCs.filter(oc => oc.proxFechaEntrega && oc.proxFechaEntrega.startsWith(ocsSelectedYear));
                if (ocsSelectedMonths.length > 0) {
                    filteredOCs = filteredOCs.filter(oc => {
                        if (!oc.proxFechaEntrega) return false;
                        const month = oc.proxFechaEntrega.substring(5, 7);
                        return ocsSelectedMonths.includes(month);
                    });
                }
            }

            const ocsCounterEl = document.getElementById('ocs-counter');
            if (ocsCounterEl) {
                ocsCounterEl.textContent = `(${filteredOCs.length} de ${ocs.length})`;
            }

            filteredOCs.sort((a, b) => {
                const key = ocsSortConfig.key;
                const dir = ocsSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';

                if (['cantEntregaSiguiente', 'posicion'].includes(key)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else if (key === 'proxFechaEntrega') {
                    valA = parseDateString(valA)?.getTime() || 0;
                    valB = parseDateString(valB)?.getTime() || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });


            if (filteredOCs.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No se encontraron resultados para tu búsqueda.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'diasParaEntrega', label: 'DÍAS ENTREGA', noSort: true, class: 'text-center' },
                { key: 'solped', label: 'SOLPED' }, 
                { key: 'ordenDeCompra', label: 'O/C' },
                { key: 'posicion', label: 'POS.' }, 
                { key: 'proxFechaEntrega', label: 'PRÓX. ENTREGA' },
                { key: 'grupoDeArticulos', label: 'GRUPO ARTÍCULOS' },
                { key: 'codigo', label: 'CÓDIGO' },
                { key: 'denominacion', label: 'DENOMINACIÓN' }, 
                { key: 'cantEntregaSiguiente', label: 'CANT. ENTREGA', class: 'justify-end' },
                { key: 'grupoDeCompras', label: 'GRUPO COMPRAS' }, 
                { key: 'status', label: 'STATUS' }
            ];

            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-sm text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = !h.noSort && ocsSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                const thClass = `px-4 py-3 ${h.class && !h.noSort ? 'text-left' : h.class || ''} ${headerClasses}`;

                if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thClass}">${h.label}</th>`;
                } else {
                    const buttonClasses = `table-sort-button ${h.class || ''} ${isSortingKey ? 'active ' + ocsSortConfig.direction : ''}`;
                    const sortIcon = isSortingKey ? sortIconSVG : '';
                    tableHTML += `<th scope="col" class="${thClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredOCs.forEach(oc => {
                const itemId = itemsByCode.get(oc.codigo);
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                let daysToDelivery = '';
                let daysClass = '';
                 if (deliveryDate) {
                       const diff = daysBetween(today, deliveryDate);
                       daysToDelivery = diff;
                       if (diff < 0) {
                             daysClass = 'text-red-600'; // Delayed
                       } else if (diff <= 7) {
                             daysClass = 'text-yellow-600'; // Upcoming
                       }
                 }
                const isDelayed = deliveryDate && deliveryDate < today;
                const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                const transformedStatus = transformOCStatus(oc.status);

                let rowClass = 'border-b hover:bg-indigo-50 even:bg-slate-50';
                if (itemId) rowClass += ' cursor-pointer oc-item-row';
                if (oc.status && oc.status.toLowerCase().includes('en proceso de autorización')) {
                    rowClass += ' bg-yellow-100 hover:bg-yellow-200';
                }
                if (oc.status && oc.status.toLowerCase().includes('rechazado')) {
                    rowClass += ' bg-red-100 hover:bg-red-200 text-red-900';
                }

                tableHTML += `<tr class="${rowClass}" ${itemId ? `data-item-id="${itemId}"` : ''}>
                    <td class="px-4 py-3 text-center font-bold ${daysClass}">${daysToDelivery}</td>
                    <td class="px-4 py-3">${oc.solped}</td>
                    <td class="px-4 py-3 font-medium">${oc.ordenDeCompra}</td>
                    <td class="px-4 py-3">${oc.posicion}</td>
                    <td class="px-4 py-3 ${dateClass}">${formatDate(oc.proxFechaEntrega)}</td>
                    <td class="px-4 py-3">${extractGroupCode(oc.grupoDeArticulos)}</td>
                    <td class="px-4 py-3">${oc.codigo}</td>
                    <td class="px-4 py-3">${oc.denominacion}</td>
                    <td class="px-4 py-3 text-right font-bold">${formatNumber(oc.cantEntregaSiguiente)}</td>
                    <td class="px-4 py-3">${extractGroupCode(oc.grupoDeCompras)}</td>
                    <td class="px-4 py-3">${transformedStatus}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
        }

        // --- LÓGICA DE LA PESTAÑA REPORTES ---
        function renderReportesView() {
            renderImmobilizedStockReport();
        }

        function renderImmobilizedStockReport() {
            const container = document.getElementById('immobilized-stock-table-container');
            const searchInput = document.getElementById('immobilized-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const immobilizationMonths = appSettings.immobilizationMonths;

            let processedItems = getProcessedItems().map(item => {
                let monthsWithoutConsumption = 0;
                if (item.consumos) {
                    for (let i = item.consumos.length - 1; i >= 0; i--) {
                        if (item.consumos[i] === 0) {
                            monthsWithoutConsumption++;
                        } else {
                            break;
                        }
                    }
                }
                return { ...item, monthsWithoutConsumption };
            });
            
            let immobilizedItems = processedItems.filter(item => 
                item.stock > 0 && item.monthsWithoutConsumption >= immobilizationMonths
            );
            
            if(searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                immobilizedItems = immobilizedItems.filter(item => {
                    const textToSearch = `${item.name} ${item.group}`.toLowerCase();
                    return searchWords.every(word => textToSearch.includes(word));
                });
            }

            const immobilizedCounterEl = document.getElementById('immobilized-counter');
            if (immobilizedCounterEl) {
                immobilizedCounterEl.textContent = `(${immobilizedItems.length} items encontrados)`;
            }

            immobilizedItems.sort((a, b) => {
                const key = immobilizedSortConfig.key;
                const dir = immobilizedSortConfig.direction === 'asc' ? 1 : -1;

                if (key === 'name') {
                    const nameA = a.name.replace(new RegExp(`^${a.code}\\s*`), '').toLowerCase();
                    const nameB = b.name.replace(new RegExp(`^${b.code}\\s*`), '').toLowerCase();
                    return nameA.localeCompare(nameB) * dir;
                }
                
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                
                if (key === 'stock' || key === 'monthsWithoutConsumption') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });
            
            if (immobilizedItems.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-10">No se encontraron insumos con stock inmovilizado por ${immobilizationMonths} o más meses.</p>`;
                return;
            }

            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'group', label: 'GRUPO' },
                { key: 'code', label: 'CÓDIGO' },
                { key: 'name', label: 'MATERIAL' },
                { key: 'stock', label: 'STOCK ACTUAL', class: 'justify-end' },
                { key: 'monthsWithoutConsumption', label: 'MESES SIN CONSUMO', class: 'justify-end' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-sm text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = immobilizedSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                const thClass = `px-4 py-2 ${h.class || ''} ${headerClasses}`;
                const buttonClasses = `table-sort-button ${h.class || ''} ${isSortingKey ? 'active ' + immobilizedSortConfig.direction : ''}`;
                const sortIcon = isSortingKey ? sortIconSVG : '';
                tableHTML += `<th scope="col" class="${thClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            immobilizedItems.forEach(item => {
                 tableHTML += `<tr class="border-b hover:bg-slate-100 even:bg-slate-50 cursor-pointer report-item-row" data-item-id="${item.id}">
                    <td class="px-4 py-2">${item.group}</td>
                    <td class="px-4 py-2">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-slate-900">${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatNumber(item.stock)}</td>
                    <td class="px-4 py-2 text-right font-bold text-red-600">${item.monthsWithoutConsumption}</td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;

        }
        
        function renderPeakConsumptionReport() {
            const container = document.getElementById('peak-consumption-table-container');
            const searchInput = document.getElementById('peak-consumption-search-input');
            const searchTerm = searchInput.value.toLowerCase();

            let peakItems = getProcessedItems().filter(item => {
                if (!item.consumos || item.consumos.length < 12) return false;
                
                const previousMonthConsumption = item.consumos[10]; // M11
                if (previousMonthConsumption <= 0) return false;

                const peakInHistory = Math.max(...item.consumos);
                
                return previousMonthConsumption === peakInHistory;

            }).map(item => ({
                ...item,
                peakConsumption: item.consumos[10],
                currentConsumption: item.consumos[11]
            }));

            if(searchTerm) {
                 peakItems = peakItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.group.toLowerCase().includes(searchTerm)
                );
            }

            const counterEl = document.getElementById('peak-consumption-counter');
            if (counterEl) {
                counterEl.textContent = `(${peakItems.length} items encontrados)`;
            }

            peakItems.sort((a, b) => {
                const key = peakConsumptionSortConfig.key;
                const dir = peakConsumptionSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? 0;
                let valB = b[key] ?? 0;
                
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });
            
            if (peakItems.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-10">No se encontraron insumos con pico de consumo el mes anterior (M11).</p>`;
                return;
            }

            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'group', label: 'Grupo' },
                { key: 'code', label: 'Código' },
                { key: 'name', label: 'Material' },
                { key: 'peakConsumption', label: 'Consumo Pico (Mes Anterior)', class: 'justify-end' },
                { key: 'currentConsumption', label: 'Consumo Mes Actual', class: 'justify-end' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0"><tr>`;
            headers.forEach(h => {
                const thClass = `px-4 py-2 ${h.class || ''}`;
                tableHTML += `<th scope="col" class="${thClass}"><button class="table-sort-button ${h.class || ''}" data-sort="${h.key}">${h.label}</button></th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            peakItems.forEach(item => {
                 tableHTML += `<tr class="border-b hover:bg-slate-100 even:bg-slate-50 cursor-pointer report-item-row" data-item-id="${item.id}">
                    <td class="px-4 py-2">${item.group}</td>
                    <td class="px-4 py-2">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-slate-900">${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600">${formatNumber(item.peakConsumption)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(item.currentConsumption)}</td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;

            const activeButton = container.querySelector(`.table-sort-button[data-sort="${peakConsumptionSortConfig.key}"]`);
            if (activeButton) {
                activeButton.classList.add('active', peakConsumptionSortConfig.direction);
                activeButton.innerHTML += sortIconSVG;
            }
        }
        
        function handleExportImmobilized() {
            const searchInput = document.getElementById('immobilized-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const immobilizationMonths = appSettings.immobilizationMonths;

            let processedItems = getProcessedItems().map(item => {
                let monthsWithoutConsumption = 0;
                if (item.consumos) {
                    for (let i = item.consumos.length - 1; i >= 0; i--) {
                        if (item.consumos[i] === 0) {
                            monthsWithoutConsumption++;
                        } else {
                            break;
                        }
                    }
                }
                return { ...item, monthsWithoutConsumption };
            });
            
            let immobilizedItems = processedItems.filter(item => item.stock > 0 && item.monthsWithoutConsumption >= immobilizationMonths);
            if (searchTerm) {
                immobilizedItems = immobilizedItems.filter(item => item.name.toLowerCase().includes(searchTerm) || item.group.toLowerCase().includes(searchTerm));
            }
            if (immobilizedItems.length === 0) { showToast('No hay datos para exportar.', 'info'); return; }

            const formattedData = immobilizedItems.map(item => ({
                'Grupo': item.group,
                'Código': item.code,
                'Material': item.name.replace(new RegExp(`^${item.code}\\s*`), ''),
                'Stock Actual': item.stock,
                'Meses sin Consumo': item.monthsWithoutConsumption
            }));
            const filename = `${getCurrentDateString()}_Reporte_Inmovilizado.xlsx`;
            exportToExcel(formattedData, filename);
        }

        function handleExportPeakConsumptionReport() {
             const searchInput = document.getElementById('peak-consumption-search-input');
            const searchTerm = searchInput.value.toLowerCase();

            let peakItems = getProcessedItems().filter(item => {
                if (!item.consumos || item.consumos.length < 12) return false;
                const previousMonthConsumption = item.consumos[10];
                if (previousMonthConsumption <= 0) return false;
                const peakInHistory = Math.max(...item.consumos);
                return previousMonthConsumption === peakInHistory;
            }).map(item => ({
                ...item,
                peakConsumption: item.consumos[10],
                currentConsumption: item.consumos[11]
            }));

            if(searchTerm) {
                 peakItems = peakItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.group.toLowerCase().includes(searchTerm)
                );
            }
            if (peakItems.length === 0) { showToast('No hay datos para exportar.', 'info'); return; }

            const formattedData = peakItems.map(item => ({
                'Grupo': item.group,
                'Código': item.code,
                'Material': item.name.replace(new RegExp(`^${item.code}\\s*`), ''),
                'Consumo Pico (Mes Anterior)': item.peakConsumption,
                'Consumo Mes Actual': item.currentConsumption
            }));
            exportToExcel(formattedData, 'picos_de_consumo.xlsx');
        }

        // --- LÓGICA DE EXPORTACIÓN ---
        function exportToExcel(data, filename) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Datos');
            XLSX.writeFile(workbook, filename);
            showToast(`Exportado a ${filename}`, 'success');
        }
        function handleExportSolpeds() {
            const searchInput = document.getElementById('solpeds-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            let dataToExport = solpeds.filter(s => 
                (s.solicitud.toString().toLowerCase().includes(searchTerm) || 
                 s.cod.toString().toLowerCase().includes(searchTerm) || 
                 s.descripcion.toLowerCase().includes(searchTerm) || 
                 s.creadoPor.toLowerCase().includes(searchTerm) ||
                 (s.grupoDeCompras || '').toLowerCase().includes(searchTerm) ||
                 (s.grupoDeArticulos || '').toLowerCase().includes(searchTerm))
            );
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (showOnlyDelayedSolpeds) {
                dataToExport = dataToExport.filter(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    return releaseDate && releaseDate <= today;
                });
            }
            if (solpedsSelectedGroup !== 'all') {
                dataToExport = dataToExport.filter(s => s.grupoDeArticulos === solpedsSelectedGroup);
            }
            if (solpedsSelectedYear !== 'all') {
                dataToExport = dataToExport.filter(s => s.fechaLiberacion && s.fechaLiberacion.startsWith(solpedsSelectedYear));
                if (solpedsSelectedMonths.length > 0) {
                    dataToExport = dataToExport.filter(s => {
                        if (!s.fechaLiberacion) return false;
                        const month = s.fechaLiberacion.substring(5, 7);
                        return solpedsSelectedMonths.includes(month);
                    });
                }
            }
            if(dataToExport.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }
            const formattedData = dataToExport.map(s => ({
                'Días Activa': s.fechaSolicitud ? daysBetween(parseDateString(s.fechaSolicitud), today) : '',
                'Creado Por': s.creadoPor,
                'Solicitud': s.solicitud,
                'Fecha Solicitud': formatDate(s.fechaSolicitud),
                'Status': s.status,
                'Grupo Artículos': s.grupoDeArticulos || '',
                'Código': s.cod,
                'Descripción': s.descripcion,
                'Cantidad': s.cantidad,
                'Grupo Compras': s.grupoDeCompras,
                'Fecha Liberación': formatDate(s.fechaLiberacion)
            }));
            const filename = `${getCurrentDateString()}_SOLPEDS.xlsx`;
            exportToExcel(formattedData, filename);
        }

        function handleExportOCs() {
            const searchInput = document.getElementById('ocs-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            let dataToExport = ocs.filter(oc => 
                (oc.solped.toString().toLowerCase().includes(searchTerm) || 
                 oc.ordenDeCompra.toString().toLowerCase().includes(searchTerm) || 
                 oc.codigo.toString().toLowerCase().includes(searchTerm) || 
                 oc.denominacion.toLowerCase().includes(searchTerm) ||
                 (oc.grupoDeArticulos || '').toLowerCase().includes(searchTerm) ||
                 (oc.grupoDeCompras || '').toLowerCase().includes(searchTerm) ||
                 (oc.status || '').toLowerCase().includes(searchTerm))
            );
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (showOnlyDelayedOCs) {
                dataToExport = dataToExport.filter(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    return deliveryDate && deliveryDate < today;
                });
            }
            if (ocsSelectedGroup !== 'all') {
                dataToExport = dataToExport.filter(oc => oc.grupoDeArticulos === ocsSelectedGroup);
            }
            if (ocsSelectedStatus !== 'all') {
                dataToExport = dataToExport.filter(oc => oc.status === ocsSelectedStatus);
            }
            if (ocsSelectedYear !== 'all') {
                dataToExport = dataToExport.filter(oc => oc.proxFechaEntrega && oc.proxFechaEntrega.startsWith(ocsSelectedYear));
                if (ocsSelectedMonths.length > 0) {
                    dataToExport = dataToExport.filter(oc => {
                        if (!oc.proxFechaEntrega) return false;
                        const month = oc.proxFechaEntrega.substring(5, 7);
                        return ocsSelectedMonths.includes(month);
                    });
                }
            }
            if(dataToExport.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }
            const formattedData = dataToExport.map(oc => ({
                'Días Para Entrega': oc.proxFechaEntrega ? daysBetween(today, parseDateString(oc.proxFechaEntrega)) : '',
                'Solped': oc.solped,
                'O/C': oc.ordenDeCompra,
                'Posición': oc.posicion,
                'Próxima Entrega': formatDate(oc.proxFechaEntrega),
                'Grupo Artículos': oc.grupoDeArticulos,
                'Código': oc.codigo,
                'Denominación': oc.denominacion,
                'Cant. Entrega': oc.cantEntregaSiguiente,
                'Grupo Compras': extractGroupCode(oc.grupoDeCompras),
                'Status': oc.status
            }));
            const filename = `${getCurrentDateString()}_OC.xlsx`;
            exportToExcel(formattedData, filename);
        }
        
        function handleExportIndice() {
            let filteredItems = getProcessedItems();

            if (indiceCoverageFilter !== 'all') {
                 filteredItems = filteredItems.filter(item => {
                    const days = item.coverageDays;
                    const { red, yellow } = appSettings.coverageThresholds;
                    if (indiceCoverageFilter === 'red') return days < red;
                    if (indiceCoverageFilter === 'yellow') return days >= red && days <= yellow;
                    if (indiceCoverageFilter === 'green') return days > yellow || days === Infinity;
                    return false;
                });
            }
            if (indiceSelectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === indiceSelectedGroup);
            }
            if (indiceShowFavorites) {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            }
            if (indiceSearchTerm) {
                filteredItems = filteredItems.filter(item => item.name.toLowerCase().includes(indiceSearchTerm));
            }

            if (filteredItems.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }

            const formattedData = filteredItems.map(item => ({
                'Favorito': item.isFavorite ? 'X' : '',
                'Grupo': item.group,
                'Código': item.code,
                'Material': item.name.replace(new RegExp(`^${item.code}\\s*`), ''),
                'Stock Actual': item.stock,
                'Consumo Mensual': item.monthlyConsumption,
                'Cobertura (Días)': item.coverageDays === Infinity ? 'N/A' : Math.round(item.coverageDays),
                'Notas': item.description_notes || ''
            }));
            const filename = `${getCurrentDateString()}_Insumos.xlsx`;
            exportToExcel(formattedData, filename);
        }

        // --- INICIALIZACIÓN ---
        async function initializeAppFlow() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                appId = firebaseConfig.projectId;

                permissionsCollectionRef = collection(db, `artifacts/${appId}/public/data/permissions`);
                
                onAuthStateChanged(auth, async (user) => {
                    if (unsubscribeInventory) unsubscribeInventory();
                    if (unsubscribePermissions) unsubscribePermissions();
                    if (unsubscribeMetadata) unsubscribeMetadata();
                    if (unsubscribeSolpeds) unsubscribeSolpeds();
                    if (unsubscribeOCs) unsubscribeOCs();
                    if (unsubscribeAppConfig) unsubscribeAppConfig();
                    isAuthReady = false;

                    if (user) {
                        userId = user.uid;
                        await checkUserPermissions(user);
                    } else {
                        document.getElementById('app-container').classList.add('hidden');
                        document.getElementById('auth-container').classList.remove('hidden');
                        switchAuthView('login-view');
                    }
                });
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                showToast("No se pudo conectar a la base de datos.", "error");
            }
        }

        async function checkUserPermissions(user) {
            const permissionsDocRef = doc(permissionsCollectionRef, user.uid);
            try {
                const docSnap = await getDoc(permissionsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentUserRole = data.role || 'viewer';
                    isAuthReady = true;
                    
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    adaptUiToRole(currentUserRole, user);
                    activateDataListeners();
                } else {
                    await createInitialPermissions(user);
                    await checkUserPermissions(user);
                }
            } catch (error) {
                console.error("FirebaseError checking permissions:", error);
                showToast("No se pudieron verificar sus permisos de acceso.", "error");
                await signOut(auth);
            }
        }

        async function createInitialPermissions(user) {
            appConfigDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'appConfig');
            const userPermRef = doc(permissionsCollectionRef, user.uid);
            try {
                await runTransaction(db, async (transaction) => {
                    const appConfigDoc = await transaction.get(appConfigDocRef);
                    let role = 'viewer';
                    if (!appConfigDoc.exists() || !appConfigDoc.data().ownerAssigned) {
                        role = 'owner';
                        transaction.set(appConfigDocRef, { ownerAssigned: true, settings: appSettings }, { merge: true });
                    }
                    transaction.set(userPermRef, { 
                        email: user.email, 
                        role: role, 
                        editableGroups: role === 'owner' ? ['*'] : []
                    });
                });
            } catch (error) {
                 console.error("Error creating initial permissions:", error);
                 throw error;
            }
        }

        function activateDataListeners() {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to activate data listeners before auth was ready. Aborting.");
                return;
            }
            if (unsubscribeInventory) unsubscribeInventory();
            if (unsubscribeMetadata) unsubscribeMetadata();
            if (unsubscribeSolpeds) unsubscribeSolpeds();
            if (unsubscribeOCs) unsubscribeOCs();
            if (unsubscribeAppConfig) unsubscribeAppConfig();

            inventoryCollectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            reviewHistoryCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/reviewHistory`);
            metadataDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'dataSource');
            solpedsCollectionRef = collection(db, `artifacts/${appId}/public/data/solpeds`);
            ocsCollectionRef = collection(db, `artifacts/${appId}/public/data/ocs`);
            appConfigDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'appConfig');
            
            unsubscribeAppConfig = onSnapshot(appConfigDocRef, (snap) => {
                if (snap.exists() && snap.data().settings) {
                    appSettings = { ...appSettings, ...snap.data().settings };
                }
                updateExternalLinks();
                renderApp(); 
            });

            unsubscribeInventory = onSnapshot(inventoryCollectionRef, (snap) => {
                items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateNotifications();
                renderApp();
            }, (error) => { console.error("Error de permisos:", error); showToast('No tienes permiso para ver el inventario.', 'error'); });
            
            unsubscribeSolpeds = onSnapshot(solpedsCollectionRef, (snap) => {
                solpeds = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'solpeds' || currentView === 'dashboard') {
                    renderApp(); 
                }
            }, (error) => { console.error("Error de permisos en Solpeds:", error); showToast('No tienes permiso para ver las Solpeds.', 'error'); });

            unsubscribeOCs = onSnapshot(ocsCollectionRef, (snap) => {
                ocs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateNotifications();
                if (currentView === 'ocs' || currentView === 'dashboard') {
                    renderApp();
                }
            }, (error) => { console.error("Error de permisos en OCs:", error); showToast('No tienes permiso para ver las O/C.', 'error'); });

            unsubscribeMetadata = onSnapshot(metadataDocRef, (docSnap) => {
                const dbInfoContainer = document.getElementById('db-info-container');
                if (dbInfoContainer) {
                    let dbName = "Sin Datos";
                    if (docSnap.exists()) { dbName = docSnap.data().filename.split('.').slice(0, -1).join('.') || docSnap.data().filename; }
                    dbInfoContainer.innerHTML = `<div class="btn-main-style bg-green-100 text-green-800 border-green-200 font-bold text-xs">DB: ${dbName}</div>`;
                }
            });
        }
        
        async function renderHistoryView() {
            const container = document.getElementById('history-table-container');
            const searchInput = document.getElementById('history-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            container.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';

            try {
                const querySnapshot = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/reviewHistory`)));
                const history = querySnapshot.docs.map(doc => doc.data());
                
                let allGroups = [...new Set(items.map(item => item.group || 'General'))].sort();
                const allWeeks = [...new Set(history.map(h => h.weekId))].sort().reverse();

                if (history.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 p-8">No hay historial de revisiones.</p>';
                    return;
                }
                
                if (searchTerm) {
                    const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                    allGroups = allGroups.filter(group => {
                        const textToSearch = group.toLowerCase();
                        return searchWords.every(word => textToSearch.includes(word));
                    });
                }

                if (allGroups.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 p-8">No se encontraron grupos.</p>';
                    return;
                }


                const historyMatrix = {};
                history.forEach(record => {
                    historyMatrix[record.weekId] = new Set(record.reviewedGroups);
                });

                let tableHTML = `<table class="w-full text-sm text-left text-slate-500 history-table table-fixed"><thead class="text-xs text-slate-700 uppercase"><tr><th class="px-2 py-3 font-bold w-32">Grupo</th>`;
                allWeeks.forEach(weekId => {
                    const weekNum = weekId.split('-')[1];
                    tableHTML += `<th class="px-1 py-3 text-center">${weekNum}</th>`;
                });
                tableHTML += `</tr></thead><tbody>`;

                allGroups.forEach(groupName => {
                    tableHTML += `<tr class="border-b hover:bg-slate-50"><td class="px-2 py-3 font-medium text-slate-900 whitespace-nowrap">${groupName}</td>`;
                    allWeeks.forEach(weekId => {
                        const isChecked = historyMatrix[weekId] && historyMatrix[weekId].has(groupName);
                        tableHTML += `<td class="px-1 py-3 text-center text-green-500 font-bold">${isChecked ? '✓' : ''}</td>`;
                    });
                    tableHTML += `</tr>`;
                });

                tableHTML += `</tbody></table>`;
                container.innerHTML = tableHTML;

            } catch (error) {
                console.error("Error fetching review history:", error);
                container.innerHTML = '<p class="text-center text-red-500 p-8">No se pudo cargar el historial.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeAppFlow();
            
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            document.getElementById('show-register-view-btn')?.addEventListener('click', () => switchAuthView('register-view'));
            document.getElementById('show-login-view-btn')?.addEventListener('click', () => switchAuthView('login-view'));
            document.getElementById('main-nav-links')?.addEventListener('click', (e) => { if (e.target.matches('.nav-link')) { switchMainView(e.target.dataset.view); } });
            
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown-content');
            userMenuButton?.addEventListener('click', (e) => { 
                if (!userMenuButton.disabled) {
                    e.stopPropagation(); 
                    userDropdown.classList.toggle('show'); 
                }
            });
            document.getElementById('logout-button-dropdown')?.addEventListener('click', handleLogout);
            document.getElementById('admin-button-dropdown')?.addEventListener('click', openAdminModal);
            document.getElementById('manual-button-dropdown')?.addEventListener('click', () => document.getElementById('manual-modal').classList.remove('hidden'));
            document.getElementById('close-manual-modal-button')?.addEventListener('click', () => document.getElementById('manual-modal').classList.add('hidden'));

            document.getElementById('notification-bell-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('notification-dropdown').classList.toggle('show');
            });
            document.getElementById('notification-dropdown')?.addEventListener('click', (e) => {
                if (e.target.id === 'mark-all-read-btn') {
                    notifications.forEach(n => n.read = true);
                    renderNotifications();
                } else {
                    handleNotificationClick(e);
                }
            });

            document.getElementById('dashboard-view')?.addEventListener('click', (e) => {
                const kpiCard = e.target.closest('.kpi-card');
                if (kpiCard) {
                    handleKpiClick(kpiCard.dataset.kpi);
                    return;
                }
                
                const groupItem = e.target.closest('.group-item-name');
                if (groupItem) {
                    const groupName = groupItem.dataset.groupName;
                    indiceSelectedGroup = groupName;
                    switchMainView('indice');
                }

                const criticalItemDetails = e.target.closest('.low-stock-item-details');
                if (criticalItemDetails) {
                    const itemId = criticalItemDetails.dataset.itemId;
                    selectedConsumptionItemId = itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }

                if (e.target.id === 'low-stock-favorites-filter-btn') {
                    showOnlyFavoriteCriticals = !showOnlyFavoriteCriticals;
                    renderCriticalItemsTable();
                }

                const favBtn = e.target.closest('.favorite-btn[data-btn-type="low-stock-fav"]');
                if(favBtn) {
                    e.stopPropagation();
                    handleToggleFavorite(favBtn.dataset.itemId);
                }
                
                if (e.target.closest('#close-kpi-detail-btn')) {
                    closeKpiDetailView();
                }

                const itemRow = e.target.closest('.kpi-detail-item-row');
                if (itemRow) {
                    const itemId = itemRow.dataset.itemId;
                    selectedConsumptionItemId = itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }

                const groupRow = e.target.closest('.kpi-detail-group-row');
                if (groupRow) {
                    const groupName = groupRow.dataset.groupName;
                    indiceSelectedGroup = groupName;
                    indiceShowFavorites = false;
                    indiceCoverageFilter = 'all';
                    indiceSearchTerm = '';
                    switchMainView('indice');
                }

                const solpedRow = e.target.closest('.kpi-detail-solped-row');
                if(solpedRow) {
                    const groupName = solpedRow.dataset.groupCompras;
                    document.getElementById('solpeds-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                    showOnlyDelayedSolpeds = true;
                    solpedsSelectedGroup = 'all';
                    solpedsSelectedYear = 'all';
                    solpedsSelectedMonths = [];
                    switchMainView('solpeds');
                }

                const ocRow = e.target.closest('.kpi-detail-oc-row');
                if(ocRow) {
                    const groupName = ocRow.dataset.groupCompras;
                    document.getElementById('ocs-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                    showOnlyDelayedOCs = true;
                    ocsSelectedGroup = 'all';
                    ocsSelectedStatus = 'all';
                    ocsSelectedYear = 'all';
                    ocsSelectedMonths = [];
                    switchMainView('ocs');
                }
            });

             document.getElementById('dashboard-view')?.addEventListener('input', (e) => {
                if (e.target.id === 'low-stock-search') {
                    renderCriticalItemsTable();
                }
            });

             document.getElementById('dashboard-view')?.addEventListener('change', (e) => {
                if (e.target.id === 'low-stock-group-filter') {
                    criticalsSelectedGroup = e.target.value;
                    renderCriticalItemsTable();
                }
            });

            document.getElementById('save-review-btn')?.addEventListener('click', handleSaveReview);
            document.getElementById('clear-review-btn')?.addEventListener('click', handleClearReview);
            document.getElementById('groups-review-list')?.addEventListener('change', handleReviewCheckboxChange);
            
            document.getElementById('revision-view')?.addEventListener('input', (e) => {
                if(e.target.id === 'history-search-input') { renderHistoryView(); }
            });
            document.getElementById('revision-view')?.addEventListener('click', (e) => {
                if(e.target.closest('#export-history-btn')) { 
                    handleExportHistory(); 
                    return;
                }
                
                const groupItemName = e.target.closest('.group-item-name');
                if (groupItemName) {
                    const groupName = groupItemName.dataset.groupName;
                    indiceSelectedGroup = groupName;
                    indiceShowFavorites = false;
                    indiceCoverageFilter = 'all';
                    indiceSearchTerm = '';
                    switchMainView('indice');
                }
            });

            document.getElementById('indice-view').addEventListener('input', (e) => {
                if(e.target.id === 'indice-search-input') {
                    indiceSearchTerm = e.target.value.toLowerCase();
                    renderIndiceView();
                }
                if(e.target.classList.contains('notes-input-indice')) {
                    handleNotesInput(e);
                }
            });
             document.getElementById('indice-view').addEventListener('change', (e) => {
                if(e.target.id === 'indice-group-filter') {
                    indiceSelectedGroup = e.target.value;
                    renderIndiceView();
                }
            });
            document.getElementById('indice-view').addEventListener('click', (e) => {
                const sortBtn = e.target.closest('.table-sort-button');
                if (sortBtn) {
                    const key = sortBtn.dataset.sort;
                    if (indiceSortConfig.key === key) {
                        indiceSortConfig.direction = indiceSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        indiceSortConfig.key = key;
                        indiceSortConfig.direction = 'asc';
                    }
                    renderIndiceView();
                }
                const coverageBtn = e.target.closest('#indice-coverage-filter-buttons button');
                if (coverageBtn) {
                    indiceCoverageFilter = coverageBtn.dataset.filter;
                    renderIndiceView();
                }
                if (e.target.closest('#export-indice-btn')) {
                    handleExportIndice();
                }
                const favoritesHeaderBtn = e.target.closest('#indice-favorites-header-filter-btn');
                if (favoritesHeaderBtn) {
                    indiceShowFavorites = !indiceShowFavorites;
                    renderIndiceView();
                }
                if (e.target.closest('#indice-clear-filters-btn')) {
                    handleClearIndiceFilters();
                }
                const favBtn = e.target.closest('.favorite-btn[data-btn-type="indice-fav"]');
                if(favBtn) {
                    e.stopPropagation();
                    handleToggleFavorite(favBtn.dataset.itemId);
                }
                const row = e.target.closest('.indice-item-details');
                if(row) {
                    const itemId = row.dataset.itemId;
                    selectedConsumptionItemId = itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const itemId = deleteBtn.dataset.itemId;
                    const itemName = deleteBtn.dataset.itemName;
                    handleDeleteItem(itemId, itemName);
                }
            });

            document.getElementById('consumos-view').addEventListener('input', (e) => {
                 if (e.target.matches('#consumo-search-input')) handleConsumosSearch(e, 'primary');
                 if (e.target.matches('#consumo-comparison-search-input')) handleConsumosSearch(e, 'comparison');
                 if (e.target.matches('[id^="consumo-description-notes-"]')) handleNotesInput(e);
            });
            document.getElementById('consumos-view')?.addEventListener('click', (e) => {
                if(e.target.closest('#consumo-search-results')) handleSelectConsumosItem(e);
                if(e.target.closest('#consumo-comparison-search-results')) handleSelectConsumosItem(e);
                
                const favFilterBtn = e.target.closest('#consumo-favorites-filter-btn, #consumo-comparison-favorites-filter-btn');
                if (favFilterBtn) {
                    handleConsumosFavoritesToggle(favFilterBtn);
                    return;
                }

                const clearPrimaryBtn = e.target.closest('#consumo-clear-primary-btn');
                if (clearPrimaryBtn) {
                    handleClearConsumoPanel('primary');
                    return;
                }
                const clearComparisonBtn = e.target.closest('#consumo-clear-comparison-btn');
                if (clearComparisonBtn) {
                    handleClearConsumoPanel('comparison');
                    return;
                }

                const clearTextBtn = e.target.closest('#consumo-clear-text-btn');
                if(clearTextBtn) {
                    const searchInput = document.getElementById('consumo-search-input');
                    searchInput.value = '';
                    handleConsumosSearch({ target: searchInput }, 'primary');
                    searchInput.focus();
                    return;
                }

                const nameLink = e.target.closest('.consumo-name-link');
                if (nameLink && nameLink.dataset.itemCode) {
                    indiceSearchTerm = nameLink.dataset.itemCode;
                    indiceSelectedGroup = 'all';
                    indiceShowFavorites = false;
                    indiceCoverageFilter = 'all';
                    switchMainView('indice');
                    return;
                }

                const groupLink = e.target.closest('.consumo-group-link');
                if (groupLink && groupLink.dataset.groupName) {
                    indiceSelectedGroup = groupLink.dataset.groupName;
                    indiceSearchTerm = '';
                    indiceShowFavorites = false;
                    indiceCoverageFilter = 'all';
                    switchMainView('indice');
                    return;
                }

                const favBtn = e.target.closest('.favorite-btn[data-item-id]');
                if (favBtn) {
                    handleToggleFavorite(favBtn.dataset.itemId);
                }
                const solpedLink = e.target.closest('.consumo-solped-link');
                if (solpedLink) {
                    const solpedId = solpedLink.dataset.solpedId;
                    if (solpedId) {
                        switchMainView('solpeds');
                        document.getElementById('solpeds-search-input').value = solpedId;
                        renderSolpedsView();
                    }
                }
                const ocLink = e.target.closest('.consumo-oc-link');
                if (ocLink) {
                    const ocId = ocLink.dataset.ocId;
                    if (ocId) {
                        switchMainView('ocs');
                        document.getElementById('ocs-search-input').value = ocId;
                        renderOCsView();
                    }
                }
            });
            document.getElementById('consumos-view').addEventListener('change', (e) => { if (e.target.matches('.consumo-group-filter')) { handleConsumosFilterChange(e); } });

            document.getElementById('solpeds-search-input')?.addEventListener('input', renderSolpedsView);
            document.getElementById('solpeds-view')?.addEventListener('click', (e) => { 
                const btn = e.target.closest('.table-sort-button'); 
                const row = e.target.closest('.solped-item-row');
                const yearBtn = e.target.closest('.solpeds-year-btn');
                const monthBtn = e.target.closest('#solpeds-month-filter-btn');

                if (btn) { handleSolpedsSort(btn.dataset.sort); }
                else if (e.target.id === 'solpeds-delayed-filter-btn') { showOnlyDelayedSolpeds = !showOnlyDelayedSolpeds; renderSolpedsView(); }
                else if (e.target.closest('#export-solpeds-btn')) { handleExportSolpeds(); }
                else if (e.target.closest('#solpeds-clear-filters-btn')) { handleClearSolpedsFilters(); }
                else if (row && row.dataset.itemId) {
                    selectedConsumptionItemId = row.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
                else if (yearBtn) {
                    solpedsSelectedYear = yearBtn.dataset.year;
                    solpedsSelectedMonths = [];
                    renderSolpedsView();
                }
                else if (monthBtn) {
                    e.stopPropagation();
                    document.getElementById('solpeds-month-filter-panel').classList.toggle('hidden');
                }
            });
            document.getElementById('solpeds-view')?.addEventListener('change', (e) => {
                if (e.target.id === 'solpeds-group-filter') {
                    solpedsSelectedGroup = e.target.value;
                    renderSolpedsView();
                }
                if (e.target.matches('.solpeds-month-checkbox')) {
                    const checkedMonths = Array.from(document.querySelectorAll('.solpeds-month-checkbox:checked')).map(cb => cb.value);
                    solpedsSelectedMonths = checkedMonths;
                    renderSolpedsView();
                }
            });
            
            document.getElementById('ocs-search-input')?.addEventListener('input', renderOCsView);
           document.getElementById('ocs-view')?.addEventListener('click', (e) => { 
                const btn = e.target.closest('.table-sort-button'); 
                const row = e.target.closest('.oc-item-row');
                const yearBtn = e.target.closest('.ocs-year-btn');
                const monthBtn = e.target.closest('#ocs-month-filter-btn');

                if (btn) { handleOCsSort(btn.dataset.sort); }
                else if (e.target.id === 'ocs-delayed-filter-btn') { showOnlyDelayedOCs = !showOnlyDelayedOCs; renderOCsView(); }
                else if (e.target.closest('#export-ocs-btn')) { handleExportOCs(); }
                else if (e.target.closest('#ocs-clear-filters-btn')) { handleClearOCsFilters(); }
                else if (yearBtn) {
                    ocsSelectedYear = yearBtn.dataset.year;
                    ocsSelectedMonths = [];
                    renderOCsView();
                }
                else if (monthBtn) {
                    e.stopPropagation();
                    document.getElementById('ocs-month-filter-panel').classList.toggle('hidden');
                }
                else if (row && row.dataset.itemId) {
                    selectedConsumptionItemId = row.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
            });
            document.getElementById('ocs-view')?.addEventListener('change', (e) => {
                if (e.target.id === 'ocs-group-filter') {
                    ocsSelectedGroup = e.target.value;
                    renderOCsView();
                }
                if (e.target.id === 'ocs-status-filter') {
                    ocsSelectedStatus = e.target.value;
                    renderOCsView();
                }
                if (e.target.matches('.ocs-month-checkbox')) {
                    const checkedMonths = Array.from(document.querySelectorAll('.ocs-month-checkbox:checked')).map(cb => cb.value);
                    ocsSelectedMonths = checkedMonths;
                    renderOCsView();
                }
            });

            document.getElementById('reportes-view')?.addEventListener('input', (e) => { 
                if (e.target.id === 'immobilized-search-input') renderImmobilizedStockReport();
            });
            document.getElementById('reportes-view')?.addEventListener('click', (e) => { 
                const sortBtn = e.target.closest('.table-sort-button');
                const row = e.target.closest('.report-item-row');
                
                if(e.target.closest('#export-immobilized-btn')) {
                    handleExportImmobilized();
                    return;
                }

                if (sortBtn) {
                    const key = sortBtn.dataset.sort;
                    if (immobilizedSortConfig.key === key) {
                        immobilizedSortConfig.direction = immobilizedSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        immobilizedSortConfig.key = key;
                        immobilizedSortConfig.direction = 'asc';
                    }
                    renderImmobilizedStockReport();
                } else if (row && row.dataset.itemId) {
                    selectedConsumptionItemId = row.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
            });


            document.getElementById('dashboard-preload-btn-dropdown')?.addEventListener('click', handleOpenPreloadModal);
            document.getElementById('dashboard-clear-btn-dropdown')?.addEventListener('click', handleClearAll);
            document.getElementById('close-preload-modal')?.addEventListener('click', handleClosePreloadModal);
            document.getElementById('process-preload-data')?.addEventListener('click', handleProcessPreloadData);
            document.getElementById('preload-file-input')?.addEventListener('change', handleFileInputChange);
            document.getElementById('cancel-clear-button')?.addEventListener('click', () => document.getElementById('confirm-clear-modal').classList.add('hidden'));
            
            document.getElementById('admin-tabs')?.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                if (!tab) return;
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('admin-content-permissions').classList.toggle('hidden', tab !== 'permissions');
                document.getElementById('admin-content-settings').classList.toggle('hidden', tab !== 'settings');
            });
            document.getElementById('admin-content-permissions')?.addEventListener('change', (e) => {
                if (e.target.matches('.role-select, .groups-input')) {
                    const userId = e.target.dataset.userid;
                    const row = e.target.closest('tr');
                    const role = row.querySelector('.role-select').value;
                    const groups = row.querySelector('.groups-input').value;
                    updateUserPermissions(userId, role, groups);
                }
            });
            document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
            document.getElementById('close-admin-modal-button')?.addEventListener('click', closeAdminModal);
            
            document.getElementById('record-consumption-modal')?.addEventListener('click', (e) => {
                const itemEl = e.target.closest('.record-consumption-item');
                if (itemEl) {
                    const itemId = itemEl.dataset.itemId;
                    switchMainView('consumos');
                    selectedConsumptionItemId = itemId;
                    renderConsumosView();
                    document.getElementById('record-consumption-modal').classList.add('hidden');
                }
            });
            document.getElementById('close-record-consumption-modal-button')?.addEventListener('click', () => document.getElementById('record-consumption-modal').classList.add('hidden'));

            document.getElementById('close-group-stats-modal-button')?.addEventListener('click', () => document.getElementById('group-stats-modal').classList.add('hidden'));

            document.getElementById('group-stats-modal')?.addEventListener('click', (e) => {
                 const row = e.target.closest('tr[data-group-name]');
                 if (row) {
                     const groupName = row.dataset.groupName;
                     indiceSelectedGroup = groupName;
                     indiceShowFavorites = false;
                     indiceCoverageFilter = 'all';
                     indiceSearchTerm = '';
                     document.getElementById('group-stats-modal').classList.add('hidden');
                     switchMainView('indice');
                 }
            });

            document.getElementById('close-delayed-solpeds-modal-button')?.addEventListener('click', () => document.getElementById('delayed-solpeds-modal').classList.add('hidden'));

            document.getElementById('delayed-solpeds-modal')?.addEventListener('click', (e) => {
                 const row = e.target.closest('tr[data-group-compras]');
                 if (row) {
                     const groupName = row.dataset.groupCompras;
                     document.getElementById('solpeds-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                     showOnlyDelayedSolpeds = true;
                     solpedsSelectedGroup = 'all';
                     solpedsSelectedYear = 'all';
                     solpedsSelectedMonths = [];
                     document.getElementById('delayed-solpeds-modal').classList.add('hidden');
                     switchMainView('solpeds');
                 }
            });

            document.getElementById('close-delayed-ocs-modal-button')?.addEventListener('click', () => document.getElementById('delayed-ocs-modal').classList.add('hidden'));

            document.getElementById('delayed-ocs-modal')?.addEventListener('click', (e) => {
                 const row = e.target.closest('tr[data-group-compras]');
                 if (row) {
                     const groupName = row.dataset.groupCompras;
                     document.getElementById('ocs-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                     showOnlyDelayedOCs = true;
                     ocsSelectedGroup = 'all';
                     ocsSelectedStatus = 'all';
                     ocsSelectedYear = 'all';
                     ocsSelectedMonths = [];
                     document.getElementById('delayed-ocs-modal').classList.add('hidden');
                     switchMainView('ocs');
                 }
            });

            document.getElementById('add-new-item-btn')?.addEventListener('click', handleOpenItemModal);
            document.getElementById('close-item-modal')?.addEventListener('click', handleCloseItemModal);
            document.getElementById('item-form')?.addEventListener('submit', handleSaveItem);

            window.addEventListener('click', (e) => {
                if (!e.target.closest('#notification-container') && !e.target.closest('#user-menu-container')) {
                    document.querySelectorAll('.dropdown-content.show').forEach(d => d.classList.remove('show'));
                }
                const ocsMonthFilterDropdown = document.getElementById('ocs-month-filter-dropdown');
                if (ocsMonthFilterDropdown && !ocsMonthFilterDropdown.contains(e.target)) {
                    const panel = document.getElementById('ocs-month-filter-panel');
                    if (panel) panel.classList.add('hidden');
                }
                const solpedsMonthFilterDropdown = document.getElementById('solpeds-month-filter-dropdown');
                if (solpedsMonthFilterDropdown && !solpedsMonthFilterDropdown.contains(e.target)) {
                    const panel = document.getElementById('solpeds-month-filter-panel');
                    if (panel) panel.classList.add('hidden');
                }
            });
        });

        function handleNotesInput(e) {
            if (currentUserRole === 'viewer') return;
            const itemId = e.target.dataset.itemId;
            if (itemId) {
                if (notesSaveTimeout) clearTimeout(notesSaveTimeout);

                const itemInState = items.find(i => i.id === itemId);
                if (itemInState) itemInState.description_notes = e.target.value;

                notesSaveTimeout = setTimeout(async () => {
                    const notes = e.target.value;
                    const itemRef = doc(inventoryCollectionRef, itemId);
                    try {
                        await updateDoc(itemRef, { description_notes: notes });
                        showToast('Nota guardada.', 'success');
                    } catch (error) {
                        console.error("Error al guardar la nota:", error);
                        showToast('Error al guardar la nota.', 'error');
                    }
                }, 1000); // Debounce for 1 second
            }
        }

        let editingItemId = null;

        function handleOpenItemModal() {
            editingItemId = null;
            document.getElementById('item-form').reset();
            document.getElementById('item-modal-title').textContent = 'Agregar Nuevo Insumo';
            
            const uniqueGroups = [...new Set(items.map(item => item.group))].sort();
            const datalist = document.getElementById('group-datalist');
            datalist.innerHTML = uniqueGroups.map(g => `<option value="${g}">`).join('');

            document.getElementById('item-modal').classList.remove('hidden');
        }

        function handleCloseItemModal() {
            document.getElementById('item-modal').classList.add('hidden');
        }

        async function handleSaveItem(e) {
            e.preventDefault();
            if (currentUserRole !== 'owner' && currentUserRole !== 'editor') {
                showToast('No tienes permiso para realizar esta acción.', 'error');
                return;
            }

            const group = document.getElementById('item-group').value.trim();
            const code = document.getElementById('item-code').value.trim();
            const name = document.getElementById('item-name').value.trim();
            const stock = parseInt(document.getElementById('item-stock').value, 10);

            if (!group || !code || !name || isNaN(stock)) {
                showToast('Todos los campos son obligatorios.', 'error');
                return;
            }

            if (items.some(item => item.code === code)) {
                showToast('El código de insumo ya existe.', 'error');
                return;
            }

            const newItem = {
                group,
                code,
                name: `${code} ${name}`,
                stock,
                monthlyConsumption: 0,
                delayedQuantity: 0,
                leadTimeDays: 0,
                safetyStockDays: 0,
                orderQuantities: [],
                isModified: false,
                createdAt: new Date().toISOString(),
                isFavorite: false,
                description_notes: '',
                consumos: Array(12).fill(0)
            };

            try {
                await addDoc(inventoryCollectionRef, newItem);
                showToast('Insumo agregado correctamente.', 'success');
                handleCloseItemModal();
            } catch (error) {
                console.error("Error al agregar insumo:", error);
                showToast('Error al agregar el insumo.', 'error');
            }
        }

        function handleDeleteItem(itemId, itemName) {
            if (currentUserRole !== 'owner' && currentUserRole !== 'editor') {
                showToast('No tienes permiso para realizar esta acción.', 'error');
                return;
            }

            document.getElementById('confirm-modal-title').textContent = 'Eliminar Insumo';
            document.getElementById('confirm-modal-text').textContent = `¿Estás seguro de que quieres eliminar "${itemName}"? Esta acción no se puede deshacer.`;
            document.getElementById('confirm-clear-modal').classList.remove('hidden');
            document.getElementById('confirm-clear-button').onclick = async () => {
                try {
                    await deleteDoc(doc(inventoryCollectionRef, itemId));
                    showToast('Insumo eliminado.', 'success');
                } catch (error) {
                    console.error("Error al eliminar insumo:", error);
                    showToast('Error al eliminar el insumo.', 'error');
                } finally {
                    document.getElementById('confirm-clear-modal').classList.add('hidden');
                }
            };
        }
    </script>
</body>
</html>
