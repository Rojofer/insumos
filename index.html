<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Consultas de Inventario</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { 
            font-family: 'Aptos', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', sans-serif; 
        }
        
        .font-quicksand * {
            font-family: 'Quicksand', sans-serif !important;
        }
        #auth-container, #app-container { transition: opacity 0.5s ease-in-out; }
        .table-sort-button { background: none; border: none; cursor: pointer; font-weight: 700; width: 100%; text-align: inherit; display: flex; align-items: center; justify-content: inherit; gap: 4px; color: inherit; }
        .table-sort-button:hover { color: #4f46e5; }
        .table-sort-button.active { /* Color heredado del th */ }
        .sort-icon { width: 16px; height: 16px; transition: transform 0.2s ease-in-out; }
        .table-sort-button.active.asc .sort-icon { transform: rotate(180deg); }
        .table-sort-button.active.desc .sort-icon { transform: rotate(0deg); }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #38bdf8; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }
        .loader { border: 2px solid #f1f5f9; border-top: 2px solid #6366f1; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 240px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 20; border-radius: 8px; border: 1px solid #e2e8f0; padding: 8px 0; margin-top: 4px; }
        .dropdown-content.show { display: block; }
        .dropdown-content a, .dropdown-content button { color: #334155; padding: 10px 16px; text-decoration: none; display: flex; align-items:center; gap: 8px; font-size: 14px; font-weight: 500; transition: background-color 0.2s; width: 100%; text-align: left; background: none; border: none; cursor: pointer;}
        .dropdown-content a:hover, .dropdown-content button:hover { background-color: #f1f5f9; }
        .dropdown-divider { height: 1px; margin: 8px 0; overflow: hidden; background-color: #e2e8f0; }
        .query-result-row { cursor: pointer; transition: background-color 0.2s; }
        .query-result-row:hover { background-color: #f8fafc; }
        .admin-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .admin-tab.active { border-bottom-color: #4f46e5; color: #4f46e5; font-weight: 600; }
        .online-indicator { display: inline-block; width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; margin-right: 8px; }
        .btn-main-style {
            background-color: white;
            color: #334155;
            font-weight: 600;
            padding: 0 12px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border-radius: 0.375rem;
            border: 1px solid #cbd5e1;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 36px;
        }
        .btn-main-style:hover {
            background-color: #f8fafc;
            border-color: #94a3b8;
        }
        .nav-link {
            padding: 8px 16px;
            font-weight: 600;
            color: #475569;
            border-radius: 9999px;
            transition: all 0.2s ease-in-out;
        }
        .nav-link:hover {
            color: #1e293b;
            background-color: #f1f5f9;
        }
        .nav-link.active {
            color: #ffffff;
            background-color: #6366f1;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        .nav-link.active::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -16px; /* Se ajusta para que la línea toque el borde inferior de la barra de navegación */
            height: 4px;
            background-color: #6366f1;
        }
        #logo-container.active {
            transform: scale(1.05);
            text-shadow: 0 0 8px rgba(99, 102, 241, 0.5);
        }
        .kpi-card { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .favorite-btn {
            background: none;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .favorite-btn:hover {
            background-color: #fef9c3;
            border-color: #fde047;
        }
        .favorite-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .favorite-btn:disabled:hover {
            background-color: transparent;
        }
        .favorite-btn svg {
            width: 18px;
            height: 18px;
            stroke: #fde047;
            stroke-width: 2;
        }
        .favorite-btn.is-favorite {
            background-color: #16a34a; /* green-600 */
            border-color: #16a34a;
        }
        .favorite-btn.is-favorite:hover {
            background-color: #15803d; /* green-700 */
            border-color: #15803d;
        }
        .favorite-btn.is-favorite svg {
            fill: white;
            stroke: white;
        }
        .consumo-chart-wrapper { display: flex; height: 250px; padding-top: 20px; border-top: 1px solid #e2e8f0; margin-top: 1rem; padding-bottom: 25px; /* Espacio para etiquetas X */ }
        .consumo-y-axis { display: flex; flex-direction: column; justify-content: space-between; height: 100%; padding-right: 10px; text-align: right; font-size: 12px; color: #64748b; }
        .consumo-chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 100%; flex-grow: 1; border-left: 1px solid #e2e8f0; position: relative; }
        .consumo-chart-bar-wrapper { 
            position: relative; /* Clave para posicionar la etiqueta */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 8%;
            height: 100%; /* Clave para que la altura % de la barra funcione */
            justify-content: flex-end; /* Pone la barra en la parte inferior */
        }
        .consumo-chart-bar { width: 60%; border-radius: 4px 4px 0 0; position: relative; display: flex; justify-content: center; transition: height 0.3s ease-out, background-color 0.3s ease-out; }
        .consumo-chart-projected-line { position: absolute; width: 100%; border-top: 2px dashed #93c5fd; left: 0; z-index: 5; } /* Color de línea celeste tenue */
        .consumo-chart-projected-label { position: absolute; right: -4px; bottom: 5px; /* Posiciona la etiqueta por encima de la línea */ transform: none; background-color: #93c5fd; color: #1e40af; padding: 1px 4px; font-size: 10px; font-weight: bold; border-radius: 4px; } /* Etiqueta a juego */
        .consumo-chart-value {
            position: absolute;
            top: 6px; /* Vuelve a posicionar el número dentro de la barra */
            color: white; /* Texto blanco para contraste */
            font-weight: 600;
            font-size: 12px;
            z-index: 10;
        }
        .consumo-chart-label {
            position: absolute;
            bottom: -22px; /* La mueve debajo del eje 0 */
            font-size: 12px; 
            color: #64748b; 
        }
        .indice-coverage-btn {
            padding: 0 10px;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            color: #c7d2fe;
            height: 32px;
        }
        .indice-coverage-btn:not(.active):hover {
            background-color: #4f46e5;
            color: white;
        }
        .indice-coverage-btn.active {
            background-color: white;
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
            border-color: #cbd5e1;
            color: #1e293b;
        }
        .notification-item.unread { background-color: #eef2ff; }
        .notification-item:hover { background-color: #f8fafc; }
        .history-table thead th {
            position: sticky;
            top: 0;
            background-color: #f1f5f9; /* slate-100 */
            z-index: 10;
        }
        .history-table thead th:first-child {
            left: 0;
            z-index: 20;
            border-right: 1px solid #e2e8f0;
        }
        .history-table tbody td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 10;
            border-right: 1px solid #e2e8f0;
        }
        .history-table tbody tr:hover td:first-child {
            background-color: #f8fafc; /* slate-50 */
        }
        #global-search-container {
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        #matrix-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Behind everything */
            display: none; /* Hidden by default */
        }
        /* Custom scrollbar styles */
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* for Chrome, Safari, and Opera */
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* for IE and Edge */
            scrollbar-width: none;  /* for Firefox */
        }
        .calendar { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; text-align: center; }
        .calendar-day-name { font-weight: 600; font-size: 0.75rem; color: #64748b; padding-bottom: 0.5rem; }
        .calendar-day { display: flex; justify-content: center; align-items: center; height: 2.5rem; width: 2.5rem; margin: auto; border-radius: 50%; font-size: 0.875rem; color: #334155; }
        .calendar-day.other-month { color: #cbd5e1; }
        .calendar-day.today { background-color: #6366f1; color: white; font-weight: 700; }
        #incoming-items-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        #incoming-items-list.is-open {
            max-height: 1000px; /* Large enough value to not clip content */
            transition: max-height 0.5s ease-in;
        }
        #incoming-items-chevron.is-open {
            transform: rotate(180deg);
        }
        .calendar-week-row { cursor: pointer; }
        .calendar-week-row:hover .calendar-day:not(.other-month) { background-color: #eef2ff; }
        .calendar-day.has-income { position: relative; }
        .calendar-day.has-income::after {
            content: ''; position: absolute; bottom: 4px; left: 50%;
            transform: translateX(-50%); width: 5px; height: 5px;
            border-radius: 50%; background-color: #16a34a;
        }
        .calendar-week-row.selected-week .calendar-day:not(.other-month) {
            background-color: #6366f1; color: white; font-weight: bold;
        }
        .calendar-week-row.selected-week .calendar-day.today {
            background-color: #4338ca;
        }
        .calendar-week-row.selected-week .calendar-day.has-income::after { background-color: white; }
        .week-number-cell {
            font-size: 0.75rem; color: #94a3b8; font-weight: 500;
            vertical-align: middle; text-align: center;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip-text {
            visibility: hidden;
            width: max-content;
            max-width: 300px;
            background-color: white;
            color: #1e293b; /* slate-800 */
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 25;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* A slightly softer shadow */
            border: 1px solid #e2e8f0; /* slate-200 border */
            font-size: 12px;
            font-weight: 500; /* medium font weight */
            line-height: 1.5;
            pointer-events: none;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: white transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* Fix for tooltip on the first row of simulation table */
        #simulation-results-container tbody tr:first-child .tooltip-text {
            bottom: auto;
            top: 115%; /* Place it below the element */
        }
        #simulation-results-container tbody tr:first-child .tooltip-text::after {
            top: auto;
            bottom: 100%; /* Arrow points up */
            border-color: transparent transparent white transparent; /* Flip arrow direction */
        }
        .direct-edit-input {
            border: 1px solid transparent;
            border-radius: 0.375rem;
            transition: all 0.2s;
            padding-top: 0.25rem;
            padding-bottom: 0.25rem;
        }
        .direct-edit-input:not(:disabled):focus {
            outline: none;
            border-color: #818cf8; /* indigo-400 */
            background-color: white;
            box-shadow: 0 0 0 2px #c7d2fe; /* indigo-200 */
        }
        .direct-edit-input:disabled {
            background-color: transparent;
            cursor: not-allowed;
            color: inherit;
        }
        .input-status-indicator.saved .saved-icon { color: #16a34a; display: none; }
        .modified-indicator {
            color: #f59e0b; /* amber-500 */
            display: inline-block;
            margin-left: 6px;
        }
        .modified-input {
            background-color: #fef3c7 !important; /* amber-100 */
            border-color: #fcd34d !important; /* amber-300 */
        }
        .accordion-chevron.rotate-180, .record-consumption-chevron.rotate-180, .note-chevron.rotate-180 {
            transform: rotate(180deg);
        }

    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- 
    ======================================================================
    NOTAS DE DESARROLLO Y SIMULACIÓN
    ======================================================================
    Fernando, usemos esta sección para anotar las ideas sobre la 
    simulación y no perder el progreso.

    IDEAS ACTUALES:
    1.  Crear una nueva pestaña/vista llamada "Simulación".
    2.  Permitir al usuario seleccionar un producto.
    3.  Añadir controles para modificar variables (ej. "aumento de demanda %", "retraso en entrega de O/C en días").
    4.  Mostrar un gráfico o tabla con el stock proyectado a futuro basado en la simulación.
    
    ======================================================================
    -->

    <div id="auth-container" class="hidden min-h-screen bg-slate-100 flex flex-col justify-center items-center p-4">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="inline-block">
                    <svg width="64" height="64" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="50" fill="#6366f1"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M50 18L15 85H31L50 46L69 85H85L50 18ZM50 58L40 85H60L50 58Z" fill="white"/>
                    </svg>
                </div>
            </div>
            
            <div id="login-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-slate-800">ALMACEN</h2>
                <p class="text-center text-sm text-slate-500 mt-1 mb-6">v3.11 (18-10-2025)</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-slate-700">Email</label>
                        <input id="login-email" type="email" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-slate-700">Contraseña</label>
                        <input id="login-password" type="password" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm text-center h-5"></div>
                    <div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Iniciar Sesión</button></div>
                </form>
                <p class="mt-6 text-center text-sm text-slate-500">¿No tienes cuenta? <button id="show-register-view-btn" class="font-medium text-blue-600 hover:text-blue-500">Regístrate</button></p>
            </div>
            
            <div id="register-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-slate-800">Crear Cuenta</h2>
                <p id="register-subtitle" class="text-center text-sm text-slate-500 mt-1 mb-6">El primer usuario será Administrador.</p>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-email" class="text-sm font-medium text-slate-700">Email</label>
                        <input id="register-email" type="email" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-password" class="text-sm font-medium text-slate-700">Contraseña</label>
                        <input id="register-password" type="password" required class="mt-1 block w-full px-3 py-2 h-10 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="register-error" class="text-red-500 text-sm text-center h-5"></div>
                    <div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Registrar</button></div>
                </form>
                <p class="mt-6 text-center text-sm text-slate-500">¿Ya tienes cuenta? <button id="show-login-view-btn" class="font-medium text-blue-600 hover:text-blue-500">Inicia sesión</button></p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-14">
                    <div class="flex items-center">
                        <div id="logo-container" data-view="dashboard" class="flex-shrink-0 flex items-center gap-2 cursor-pointer transition-transform">
                            <svg width="32" height="32" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="50" fill="#6366f1"/>
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M50 18L15 85H31L50 46L69 85H85L50 18ZM50 58L40 85H60L50 58Z" fill="white"/>
                            </svg>
                            <span class="font-bold text-xl text-slate-800">ALMACEN</span>
                        </div>
                        <div class="hidden md:block">
                            <div id="main-nav-links" class="ml-10 flex items-center space-x-1">
                                <button data-view="consumos" class="nav-link uppercase">Análisis</button>
                                <button data-view="indice" class="nav-link uppercase">Insumos</button>
                                <button data-view="solpeds" class="nav-link uppercase">SOLPEDS</button>
                                <button data-view="ocs" class="nav-link uppercase">O/C</button>
                                <button data-view="ingresos" class="nav-link uppercase">INGRESOS</button>
                                <button data-view="revision" class="nav-link hidden uppercase">CHECK</button>
                                <button data-view="reportes" class="nav-link uppercase">EXTRAS</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center justify-center px-2 md:px-4 min-w-0">
                        <button id="open-global-search-btn" class="flex items-center gap-2 p-2 w-full max-w-xl sm:w-96 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-500 font-medium text-sm transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <span class="flex-1 text-left hidden sm:inline">Buscar...</span>
                            <kbd class="font-sans font-semibold text-slate-400 hidden sm:inline"><span class="text-xs">⌘</span>K</kbd>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <div id="db-info-container"></div>
                        <div id="notification-container" class="relative hidden">
                            <button id="notification-bell-btn" class="p-2 rounded-full hover:bg-slate-100 relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                                <span id="notification-count-badge" class="absolute top-0 right-0 block h-4 w-4 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center" style="font-size: 10px; display: none;"></span>
                            </button>
                            <div id="notification-dropdown" class="dropdown-content" style="min-width: 360px; max-height: 400px; overflow-y: auto;">
                            </div>
                        </div>
                        <div id="user-menu-container" class="relative">
                            <button id="user-menu-button" class="flex items-center gap-2 p-2 rounded-full hover:bg-slate-100 disabled:cursor-default disabled:hover:bg-transparent">
                                <div id="user-avatar" class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center"></div>
                                <span id="user-name" class="font-semibold text-sm hidden sm:block"></span>
                            </button>
                            <div id="user-dropdown-content" class="dropdown-content">
                                <div class="px-4 py-3 border-b border-slate-200">
                                    <p id="user-dropdown-email" class="text-sm font-semibold text-slate-800 truncate"></p>
                                    <p id="user-dropdown-role" class="text-xs font-medium text-indigo-600 uppercase"></p>
                                </div>

                                <div class="py-1">
                                    <button id="admin-button-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg><span class="uppercase">Configuración</span></button>
                                    <button id="manual-button-dropdown"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg><span class="uppercase">Guía Rápida</span></button>
                                </div>
                                
                                <div id="admin-actions-divider" class="dropdown-divider hidden"></div>
                                
                                <div class="py-1">
                                    <button id="dashboard-preload-btn-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><span class="uppercase">Precarga BD</span></button>
                                    <button id="dashboard-clear-btn-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span class="uppercase">Limpiar BD</span></button>
                                </div>
                                
                                <div id="links-divider" class="dropdown-divider hidden"></div>

                                <div class="py-1">
                                    <a id="iweb-sap-link-dropdown" href="#" target="_blank" rel="noopener noreferrer" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3L4 7l4 4"/><path d="M4 7h16"/><path d="M16 21l4-4-4-4"/><path d="M20 17H4"/></svg><span class="uppercase">IWEB vs SAP</span></a>
                                    <a id="depositos-externos-link-dropdown" href="#" target="_blank" rel="noopener noreferrer" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><span class="uppercase">DEPOSITOS EXTERNOS</span></a>
                                </div>

                                <div class="dropdown-divider"></div>
                                
                                <div class="py-1">
                                    <button id="logout-button-dropdown"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span class="uppercase">Cerrar Sesión</span></button>
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="px-4 py-2 text-center text-xs text-slate-400">
                                    Versión 3.11 (18-10-2025)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main>
            <div id="dashboard-view">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 p-4 sm:p-6 lg:p-8 items-start">
                    
                    <div class="flex flex-col gap-6 lg:col-span-8">
                        <div id="kpi-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4"></div>
                        <div id="kpi-detail-container" class="hidden"></div>
                    </div>
                    
                    <div class="lg:col-span-4">
                        <div id="dashboard-notes-container" class="hidden bg-white rounded-lg shadow flex flex-col">
                             <div class="p-4 bg-[#6366f1] rounded-t-lg flex justify-between items-center flex-shrink-0">
                                <h3 class="text-lg font-semibold text-white uppercase tracking-wider">INVENTARIOS</h3>
                                <div class="flex items-center gap-2">
                                    <button id="export-dashboard-notes-btn" title="Descargar Notas en Excel" class="w-9 h-9 flex items-center justify-center bg-white/20 hover:bg-white/40 text-white rounded-full transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 flex flex-col h-[450px]">
                                <div id="add-note-form-container" class="flex gap-2 mb-4 flex-shrink-0">
                                    <input type="text" id="new-note-title-input" placeholder="Título de la nueva nota..." class="flex-grow h-10 bg-white border border-slate-300 rounded-md shadow-sm px-3 text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <button id="add-new-note-btn" class="btn-main-style !h-10 !w-10 !p-0 !bg-indigo-600 !text-white hover:!bg-indigo-700 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                    </button>
                                </div>
                                <div id="inventory-notes-list" class="flex-grow overflow-y-auto pr-2 space-y-2">
                                    <!-- Dynamic notes list -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>

            <div id="indice-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full md:w-auto">
                            <div class="flex items-center gap-4 flex-shrink-0">
                                <h2 class="text-xl font-bold text-white">INSUMOS</h2>
                                <span id="indice-counter" class="text-sm font-medium text-indigo-200"></span>
                            </div>
                            <div id="indice-group-filter-container" class="min-w-[200px]"></div>
                            <div class="relative flex-grow">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="indice-search-input" placeholder="Buscar por nombre o código..." class="w-full p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                            </div>
                            <button id="indice-clear-filters-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-end gap-2 w-full md:w-auto flex-shrink-0">
                            <div id="indice-coverage-filter-buttons" class="flex items-center p-1 bg-indigo-600 rounded-lg overflow-x-auto">
                                <button data-filter="all" class="indice-coverage-btn active">Todos</button>
                                <button data-filter="red" class="indice-coverage-btn"></button>
                                <button data-filter="yellow" class="indice-coverage-btn"></button>
                                <button data-filter="green" class="indice-coverage-btn"></button>
                            </div>
                            <div class="h-6 border-l border-slate-200 mx-2"></div>
                            <button id="export-indice-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="indice-table-container" class="max-h-[calc(100vh-210px)] md:max-h-[calc(100vh-145px)] overflow-auto">
                    <!-- La tabla del indice se inyectará aquí -->
                </div>
            </div>

            <div id="consumos-view" class="hidden">
                <div class="flex flex-col h-[calc(100vh-56px)]">
                    <div class="bg-indigo-500 p-4 z-10 sticky top-14 shadow-md">
                        <div class="flex flex-col lg:flex-row items-center gap-4">
                            <div id="primary-search-wrapper" class="w-full lg:w-1/2">
                                <div class="flex items-center gap-2 w-full">
                                    <div id="consumo-group-filter-container"></div>
                                    <button id="consumo-favorites-filter-btn" data-type="primary" class="favorite-btn flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                                    </button>
                                    <div class="relative flex-grow">
                                        <input type="text" id="consumo-search-input" placeholder="Buscar producto 1..." class="w-full p-2 pl-10 pr-8 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <button id="consumo-clear-text-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 rounded-full hidden">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                        <div id="consumo-search-results" class="absolute top-full left-0 right-0 bg-white border mt-1 rounded-lg shadow-lg z-20 max-h-60 overflow-y-auto hidden"></div>
                                    </div>
                                    <button id="consumo-clear-primary-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                    </button>
                                </div>
                            </div>
                            <div class="h-px lg:h-6 w-full lg:w-px border-t lg:border-t-0 lg:border-l border-white/40 my-2 lg:my-0 lg:mx-2"></div>
                            <div id="comparison-search-wrapper" class="w-full lg:w-1/2">
                                <div class="flex items-center gap-2 w-full">
                                    <div id="consumo-comparison-group-filter-container"></div>
                                    <button id="consumo-comparison-favorites-filter-btn" data-type="comparison" class="favorite-btn flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                                    </button>
                                    <div class="relative flex-grow">
                                        <input type="text" id="consumo-comparison-search-input" placeholder="Buscar producto 2..." class="w-full p-2 pl-10 pr-8 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                        <button id="consumo-comparison-clear-text-btn" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-slate-600 rounded-full hidden">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                        <div id="consumo-comparison-search-results" class="absolute top-full left-0 right-0 bg-white border mt-1 rounded-lg shadow-lg z-20 max-h-60 overflow-y-auto hidden"></div>
                                    </div>
                                    <button id="consumo-clear-comparison-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="consumo-content-area" class="flex-grow flex flex-col lg:flex-row min-h-0">
                        <!-- Contenido dinámico (2 paneles) -->
                    </div>
                </div>
            </div>

            <div id="solpeds-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full md:w-auto">
                            <div class="flex items-center gap-4 flex-shrink-0">
                                <h2 class="text-xl font-bold text-white">SOLPEDS</h2>
                                <span id="solpeds-counter" class="text-sm font-medium text-indigo-200"></span>
                            </div>
                            <div id="solpeds-group-filter-container" class="mr-2"></div>
                            <div id="solpeds-date-filter-container" class="flex items-center gap-2"></div>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 w-full md:w-auto">
                            <div class="relative flex-grow">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="solpeds-search-input" placeholder="Buscar..." class="w-full p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                            </div>
                            <button id="solpeds-clear-filters-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                            </button>
                            <button id="solpeds-delayed-filter-btn" class="btn-main-style flex-shrink-0">Demoradas</button>
                            <div class="h-6 border-l border-slate-200 mx-2 hidden sm:block"></div>
                            <button id="export-solpeds-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="solpeds-table-container" class="max-h-[calc(100vh-210px)] md:max-h-[calc(100vh-145px)] overflow-auto">
                    <!-- La tabla de Solpeds se inyectará aquí -->
                </div>
            </div>
            
            <div id="ocs-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full md:w-auto">
                           <div class="flex items-center gap-4 flex-shrink-0">
                               <h2 class="text-xl font-bold text-white">O/C</h2>
                               <span id="ocs-counter" class="text-sm font-medium text-indigo-200"></span>
                           </div>
                           <div id="ocs-group-filter-container" class="mr-2"></div>
                           <div id="ocs-date-filter-container" class="flex items-center gap-2"></div>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 w-full md:w-auto">
                           <div id="ocs-status-filter-container" class="flex-grow"></div>
                           <div class="relative flex-grow">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="ocs-search-input" placeholder="Buscar..." class="w-full p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                           </div>
                           <button id="ocs-clear-filters-btn" class="btn-main-style w-9 h-9 !p-0 flex-shrink-0 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
                           </button>
                           <button id="ocs-delayed-filter-btn" class="btn-main-style flex-shrink-0">Demoradas</button>
                           <div class="h-6 border-l border-slate-200 mx-2 hidden sm:block"></div>
                           <button id="export-ocs-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700 flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="ocs-table-container" class="max-h-[calc(100vh-210px)] md:max-h-[calc(100vh-145px)] overflow-auto">
                    <!-- La tabla de OCs se inyectará aquí -->
                </div>
            </div>

            <div id="reportes-view" class="hidden">
                <div class="bg-indigo-500 p-4 border-b border-indigo-600">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <h2 class="text-xl md:text-2xl font-bold text-white">STOCK INMOVILIZADO</h2>
                             <span id="immobilized-counter" class="text-sm font-medium text-indigo-200 hidden sm:inline-block"></span>
                            <div class="relative flex-grow">
                               <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                               <input type="text" id="immobilized-search-input" placeholder="Buscar..." class="w-full p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                           </div>
                        </div>
                        <button id="export-immobilized-btn" class="btn-main-style hover:bg-indigo-50 hover:text-indigo-700 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                    </div>
                </div>
                
                <div id="immobilized-report-content">
                    <div id="immobilized-stock-table-container" class="max-h-[calc(100vh-145px)] overflow-auto"></div>
                </div>
            </div>

            <div id="revision-view" class="hidden">
            <div class="flex flex-col lg:flex-row lg:h-[calc(100vh-56px)]"> <!-- 56px is nav height -->
                <!-- Columna Izquierda: Revisión Semanal (20%) -->
                <div class="w-full lg:w-1/5 border-b lg:border-b-0 lg:border-r border-slate-200 flex flex-col">
                    <div id="review-container" class="bg-white overflow-hidden hidden flex-grow flex flex-col min-h-0">
                        <div class="bg-indigo-500 p-4 flex flex-col sm:flex-row justify-between items-center flex-shrink-0 gap-2 sm:gap-4 h-auto sm:h-20">
                            <span id="week-number-display" class="text-2xl font-bold text-white whitespace-nowrap"></span>
                            <div id="progress-bar-container" class="w-full sm:w-auto hidden flex items-center justify-center sm:justify-end gap-4 mt-2 sm:mt-0">
                                <span id="progress-bar-text" class="text-2xl font-bold text-white">0%</span>
                                <button id="save-review-btn" class="btn-main-style !bg-white/90 !text-indigo-700 hover:!bg-white flex-shrink-0">Guardar</button>
                            </div>
                        </div>
                        <div id="groups-review-list" class="flex-grow overflow-y-auto">
                        </div>
                    </div>
                </div>
                <!-- Columna Derecha: Log de Revisiones (80%) -->
                <div class="w-full lg:w-4/5 flex flex-col">
                    <div class="bg-white overflow-hidden flex-grow flex flex-col min-h-0">
                        <div class="bg-indigo-500 p-4 flex flex-col sm:flex-row justify-between items-center flex-shrink-0 h-auto sm:h-20 gap-2">
                            <h2 class="text-2xl font-bold text-white">LOG DE REVISIONES</h2>
                            <div class="flex items-center gap-4 w-full sm:w-auto">
                                <div class="relative flex-grow">
                                   <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    <input type="text" id="history-search-input" placeholder="Buscar grupo..." class="w-full p-2 pl-10 bg-white border border-slate-300 rounded-lg h-9" autocomplete="off">
                                </div>
                                <button id="export-history-btn" class="btn-main-style hover:bg-green-50 hover:text-green-700 flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                </button>
                            </div>
                        </div>
                        <div id="history-table-container" class="flex-grow overflow-auto no-scrollbar">
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <div id="ingresos-view" class="hidden">
                <div class="flex flex-col lg:flex-row h-[calc(100vh-56px)] bg-white">
                    <div class="w-full lg:w-1/3 p-6 border-b lg:border-b-0 lg:border-r border-slate-200 flex flex-col">
                        <div id="ingresos-calendar-container">
                            <!-- El calendario mensual se renderizará aquí -->
                        </div>
                        <div id="ingresos-kpi-container" class="mt-4 pt-4 border-t border-slate-200">
                            <!-- KPIs will be rendered here -->
                        </div>
                    </div>
                    <div class="w-full lg:w-2/3 flex flex-col bg-slate-50">
                        <div id="ingresos-header-container" class="p-4 border-b border-slate-200">
                            <!-- Header will be rendered here -->
                        </div>
                        <div id="ingresos-details-container" class="flex-grow overflow-y-auto p-4">
                             <!-- Los detalles de la semana se renderizarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
    </main>
    
        <!-- Modales -->
        <div id="preload-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Precarga masiva de datos</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-slate-500 mb-4"> Selecciona un archivo <code class="text-xs bg-slate-100 p-1 rounded">.xlsx</code>. Hojas requeridas:<br> <code class="text-xs bg-slate-100 p-1 rounded">Inventario</code>, <code class="text-xs bg-slate-100 p-1 rounded">Historial Consumo</code>, <code class="text-xs bg-slate-100 p-1 rounded">Solped</code>, <code class="text-xs bg-slate-100 p-1 rounded">OC</code></p>
                        <input type="file" id="preload-file-input" accept=".xlsx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                        <div id="preload-feedback" class="mt-4 text-sm h-5"></div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="process-preload-data" class="flex items-center justify-center px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50"> <span id="process-preload-text">Procesar y Sincronizar Datos</span> <span id="process-preload-loader" class="loader hidden"></span> </button>
                        <button id="close-preload-modal" class="mt-2 px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400"> Cerrar </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="confirm-clear-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"> <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /> </svg> </div>
                    <h3 id="confirm-modal-title" class="text-lg leading-6 font-medium text-slate-900 mt-4"></h3>
                    <div class="mt-2 px-7 py-3"> <p id="confirm-modal-text" class="text-sm text-slate-500"></p> </div>
                    <div class="items-center px-4 py-3 flex justify-center gap-4"> <button id="cancel-clear-button" class="px-4 py-2 bg-slate-200 text-slate-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400"> Cancelar </button> <button id="confirm-clear-button" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Sí, Continuar</button> </div>
                </div>
            </div>
        </div>
        <div id="admin-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-800">Panel de Administración</h2>
                    <button id="close-admin-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div class="border-b border-slate-200">
                    <nav class="flex -mb-px" id="admin-tabs">
                        <button data-tab="permissions" class="admin-tab active">Usuarios y Permisos</button>
                        <button data-tab="settings" class="admin-tab">Configuración</button>
                    </nav>
                </div>
                <div id="admin-content-permissions" class="py-4">
                    <p class="text-sm text-slate-600 mb-4">Gestiona los roles de los usuarios registrados. El rol "Propietario" no puede ser modificado.</p>
                    <div id="permissions-list" class="max-h-[50vh] overflow-y-auto"></div>
                </div>
                <div id="admin-content-settings" class="py-4 hidden">
                     <div class="space-y-4">
                        <div class="p-4 rounded-lg bg-slate-50 border">
                            <h3 class="text-base font-semibold text-slate-900">Umbrales de Cobertura (Días)</h3>
                            <p class="text-sm text-slate-500 mt-1 mb-4">Define los rangos para los indicadores de color en toda la aplicación.</p>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <label for="setting-red-threshold" class="text-sm font-medium text-slate-700">Rojo (Crítico) - Límite superior</label>
                                    <input type="number" id="setting-red-threshold" class="block w-24 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div class="flex justify-between items-center">
                                    <label for="setting-yellow-threshold" class="text-sm font-medium text-slate-700">Amarillo (Precaución) - Límite superior</label>
                                    <input type="number" id="setting-yellow-threshold" class="block w-24 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-4 rounded-lg bg-slate-50 border">
                             <h3 class="text-base font-semibold text-slate-900">Notificaciones</h3>
                             <p class="text-sm text-slate-500 mt-1 mb-4">Define cuándo se deben generar las notificaciones de stock bajo.</p>
                             <div class="flex justify-between items-center">
                                 <label for="setting-notification-threshold" class="text-sm font-medium text-slate-700">Alertar insumos con cobertura menor a (días)</label>
                                 <input type="number" id="setting-notification-threshold" class="block w-24 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             </div>
                        </div>

                         <div class="p-4 rounded-lg bg-slate-50 border">
                             <h3 class="text-base font-semibold text-slate-900">Análisis de Reportes</h3>
                             <p class="text-sm text-slate-500 mt-1 mb-4">Configuraciones para los reportes generados.</p>
                             <div class="flex justify-between items-center">
                                 <label for="setting-immobilization-months" class="text-sm font-medium text-slate-700">Meses para análisis de stock inmovilizado</label>
                                 <input type="number" id="setting-immobilization-months" class="block w-24 bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             </div>
                         </div>

                        <div class="p-4 rounded-lg bg-slate-50 border">
                            <h3 class="text-base font-semibold text-slate-900">Enlaces Externos</h3>
                            <p class="text-sm text-slate-500 mt-1 mb-4">Configura URLs para enlaces en el menú de usuario.</p>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center gap-4">
                                    <label for="setting-iweb-sap-url" class="text-sm font-medium text-slate-700 flex-shrink-0">URL para "IWEB vs SAP"</label>
                                    <input type="url" id="setting-iweb-sap-url" placeholder="https://ejemplo.com" class="block w-full max-w-md bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div class="flex justify-between items-center gap-4">
                                    <label for="setting-depositos-externos-url" class="text-sm font-medium text-slate-700 flex-shrink-0">URL para "DEPOSITOS EXTERNOS"</label>
                                    <input type="url" id="setting-depositos-externos-url" placeholder="https://ejemplo.com" class="block w-full max-w-md bg-white border border-slate-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>

                         <div class="p-4 rounded-lg bg-slate-50 border">
                             <h3 class="text-base font-semibold text-slate-900">Visualización de Consumos</h3>
                             <p class="text-sm text-slate-500 mt-1">Selecciona los meses del historial de consumo que se mostrarán en el gráfico.</p>
                             <div id="consumption-months-checkboxes" class="mt-4 grid grid-cols-4 sm:grid-cols-6 gap-x-6 gap-y-3">
                                <!-- Checkboxes will be dynamically inserted here -->
                             </div>
                        </div>
                     </div>
                     <div class="mt-8 flex justify-end">
                        <button id="save-settings-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Guardar Cambios</button>
                     </div>
                </div>
            </div>
        </div>
        <div id="record-consumption-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Insumos con Consumo Récord</h3>
                    <button id="close-record-consumption-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <p class="text-sm text-slate-500 mb-4">Este reporte muestra los insumos cuyo consumo en el último mes ha superado su pico histórico registrado.</p>
                <div id="record-consumption-item-list" class="max-h-60 overflow-y-auto">
                    <!-- Item list will be injected here -->
                </div>
            </div>
        </div>
        <div id="group-stats-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Estadísticas por Grupo</h3>
                    <button id="close-group-stats-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div id="group-stats-list" class="max-h-[60vh] overflow-y-auto">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
        <div id="delayed-solpeds-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">Solpeds Vencidas por Grupo de Compras</h3>
                    <button id="close-delayed-solpeds-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <p class="text-sm text-slate-500 mb-4">Este reporte desglosa las Solicitudes de Pedido cuya fecha de liberación ya ha pasado, agrupadas por responsable de compras.</p>
                <div id="delayed-solpeds-list" class="max-h-[60vh] overflow-y-auto">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
        <div id="delayed-ocs-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg leading-6 font-medium text-slate-900">O/C Vencidas por Grupo de Compras</h3>
                    <button id="close-delayed-ocs-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <p class="text-sm text-slate-500 mb-4">Este reporte desglosa las Órdenes de Compra cuya fecha de entrega ya ha pasado, agrupadas por responsable de compras.</p>
                <div id="delayed-ocs-list" class="max-h-[60vh] overflow-y-auto">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
        <div id="manual-modal" class="fixed inset-0 bg-slate-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 font-quicksand">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                 <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h2 class="text-2xl font-semibold text-slate-800">Guía Rápida - Insumos Almacén</h2>
                    <button id="close-manual-modal-button" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div class="prose max-w-none max-h-[75vh] overflow-y-auto pr-4 text-slate-600">
                    
                    <h3 class="font-semibold text-slate-900 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Roles y Permisos</h3>
                    <p>La aplicación tiene 3 roles con distintos niveles de acceso:</p>
                    <div class="not-prose mt-4 grid grid-cols-1 md:grid-cols-3 gap-6 text-sm">
                        <!-- Rol Propietario -->
                        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                                <svg viewBox="0 0 100 100" class="w-6 h-6"><circle cx="50" cy="50" r="50" fill="#6366f1"/><path fill-rule="evenodd" clip-rule="evenodd" d="M50 18L15 85H31L50 46L69 85H85L50 18ZM50 58L40 85H60L50 58Z" fill="white"/></svg>
                                <span>Propietario</span>
                            </h4>
                            <p class="text-indigo-600 mt-1 mb-4 h-10">Control total sobre la aplicación, datos y usuarios.</p>
                            <ul class="space-y-1 text-xs">
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Administra usuarios.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Accede a Configuración.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Realiza la revisión semanal.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Ve el historial de revisiones.</span></li>
                            </ul>
                        </div>
                        <!-- Rol Editor -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-lg font-bold text-green-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                <span>Editor</span>
                            </h4>
                            <p class="text-green-600 mt-1 mb-4 h-10">Gestión de datos del inventario.</p>
                             <ul class="space-y-1 text-xs">
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Agrega, edita y elimina insumos.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Marca favoritos y edita notas.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Precarga y limpia la base de datos.</span></li>
                            </ul>
                        </div>
                        <!-- Rol Visor -->
                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-6 shadow-sm">
                            <h4 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                <span>Visor</span>
                            </h4>
                            <p class="text-slate-600 mt-1 mb-4 h-10">Acceso de solo lectura.</p>
                             <ul class="space-y-1 text-xs">
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg><span>Visualiza todos los datos.</span></li>
                                <li class="flex items-center gap-2"><svg class="w-4 h-4 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path></svg><span>No puede realizar ninguna modificación.</span></li>
                            </ul>
                        </div>
                    </div>

                    <div id="quick-guide-accordion" class="mt-8 pt-6 border-t space-y-2">
                        <!-- Consumo Récord -->
                        <div class="accordion-item border rounded-lg overflow-hidden">
                            <button class="accordion-header flex justify-between items-center w-full p-4 text-left font-semibold text-slate-900 text-lg hover:bg-slate-50 transition-colors">
                                <span class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                                    Consumo Récord
                                </span>
                                <svg class="accordion-chevron w-6 h-6 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </button>
                            <div class="accordion-content hidden">
                                <div class="not-prose p-4 border-t bg-slate-50/50">
                                    <div class="grid md:grid-cols-2 gap-8 items-center">
                                        <div class="flex-shrink-0 text-center">
                                            <p class="text-sm font-semibold text-slate-500 mb-2">KPI en el Dashboard:</p>
                                            <div class="kpi-card relative pt-6 text-center border-2 border-red-400 w-48 mx-auto">
                                                <div class="absolute -top-2 -left-2 p-2 rounded-lg shadow-md bg-red-100 text-red-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg></div>
                                                <p class="text-3xl font-bold text-slate-900">12</p>
                                                <p class="text-xs font-medium text-slate-500 mt-1 uppercase truncate">Consumo Récord</p>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <p>Este indicador resalta los insumos cuyo consumo en el <strong>último mes</strong> ha sido el <strong>más alto de su historia</strong> registrada en la base de datos.</p>
                                            <p class="mt-2 text-sm">Al hacer clic en este KPI, se despliega un reporte detallado que te permite analizar estos casos de alta demanda.</p>
                                            <div class="mt-4 p-3 bg-red-50 text-red-800 border-l-4 border-red-400 text-sm rounded">
                                                <strong>Alerta de Favoritos:</strong> Si un insumo marcado como favorito tiene un consumo récord, la caja del reporte se resaltará en rojo para una rápida identificación.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Análisis -->
                        <div class="accordion-item border rounded-lg overflow-hidden">
                             <button class="accordion-header flex justify-between items-center w-full p-4 text-left font-semibold text-slate-900 text-lg hover:bg-slate-50 transition-colors">
                                <span class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                    Análisis (Edición Manual)
                                </span>
                                <svg class="accordion-chevron w-6 h-6 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </button>
                            <div class="accordion-content hidden">
                                <div class="not-prose p-4 border-t bg-slate-50/50">
                                    <p class="mb-4">En la vista de <strong>Análisis</strong>, los roles con permisos pueden modificar directamente el <strong>Stock</strong> y el <strong>Consumo Mensual</strong>. El sistema te avisará visualmente de estos cambios:</p>
                                    <div class="grid md:grid-cols-2 gap-8 items-center">
                                         <div class="flex-1">
                                            <ol class="list-decimal pl-5 space-y-4 text-sm">
                                                <li>
                                                    <strong>Campos Resaltados:</strong><br>
                                                    Los valores de Stock y Consumo Mensual modificados se mostrarán con un fondo <span class="bg-amber-100 px-1 rounded">ámbar</span>.
                                                </li>
                                                <li>
                                                    <strong>Ícono de Edición:</strong><br>
                                                    Aparecerá un lápiz <span class="text-amber-500 font-bold">✏️</span> junto al nombre del insumo.
                                                </li>
                                                <li>
                                                    <strong>Registro de Cambios:</strong><br>
                                                    Al pasar el mouse sobre el lápiz, un tooltip te informará <strong>quién</strong> realizó el último cambio y <strong>cuándo</strong>.
                                                </li>
                                            </ol>
                                            <p class="mt-4 text-xs font-semibold bg-indigo-100 text-indigo-800 p-2 rounded-md"><strong>Importante:</strong> Todas las modificaciones manuales se resetearán en la próxima precarga masiva de datos desde un archivo Excel.</p>
                                         </div>
                                         <div class="flex-shrink-0 w-full md:w-auto">
                                            <p class="text-sm font-semibold text-slate-500 mb-2 text-center mt-4">Ejemplo Visual:</p>
                                            <div class="bg-white p-4 rounded-lg shadow-lg border">
                                                <div class="flex justify-between items-center">
                                                    <h3 class="text-lg font-bold text-[#6366f1]">BOLSAS PRO CRISTAL <span class="tooltip-container modified-indicator inline-block"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg><span class="tooltip-text !opacity-100 !visible">Modificado por FERNANDO el 25/09/2025 - 17:49</span></div></h3>
                                                </div>
                                                 <div class="grid grid-cols-2 gap-3 mt-4">
                                                    <div class="text-center"><input type="text" value="45.000" class="direct-edit-input text-center w-full bg-transparent text-2xl font-bold text-slate-900 h-9 modified-input" disabled><p class="text-xs font-medium text-slate-500 mt-0.5 uppercase">Stock</p></div>
                                                    <div class="text-center"><input type="text" value="6.530" class="direct-edit-input text-center w-full bg-transparent text-2xl font-bold text-slate-900 h-9 modified-input" disabled><p class="text-xs font-medium text-slate-500 mt-0.5 uppercase">Cons. Mensual</p></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Simulación -->
                        <div class="accordion-item border rounded-lg overflow-hidden">
                            <button class="accordion-header flex justify-between items-center w-full p-4 text-left font-semibold text-slate-900 text-lg hover:bg-slate-50 transition-colors">
                                <span class="flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                                    Simulación de Stock
                                </span>
                                <svg class="accordion-chevron w-6 h-6 transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                            </button>
                            <div class="accordion-content hidden">
                                <div class="not-prose p-4 border-t bg-slate-50/50">
                                    <div>
                                        <p class="mb-4 text-base">Esta herramienta te permite proyectar el stock futuro de un insumo. Se activa desde la vista de <strong>Análisis</strong> con el botón <strong>"Simular"</strong>.</p>
                                        <ol class="list-decimal pl-5 space-y-4 text-base">
                                            <li>
                                                <strong>Ajusta las variables:</strong> Modifica el <strong>Stock Actual</strong> y el <strong>Consumo Mensual</strong> para ver diferentes escenarios.
                                                <div class="mt-2 p-3 bg-white rounded border border-slate-200 text-sm">Puedes usar los botones `+` y `-` o escribir directamente en los campos.</div>
                                            </li>
                                            <li>
                                                <strong>Simula Ingresos/Egresos:</strong>
                                                <ul class="list-disc pl-5 mt-2 space-y-2 text-sm">
                                                    <li><strong>Ingreso Manual:</strong> Añade una cantidad y selecciona la semana de entrega para simular una O/C nueva o un ingreso no registrado.</li>
                                                    <li><strong>Cancelar O/C existente:</strong> Para anular un ingreso futuro de una O/C, introduce su cantidad en <strong>negativo</strong> en la misma semana. Esto la restará de la proyección.</li>
                                                </ul>
                                            </li>
                                            <li>
                                                <strong>Analiza los resultados:</strong> La tabla de proyección muestra el stock semana a semana. La columna <strong>"Cobertura"</strong> se coloreará de <span class="text-red-600 font-semibold">rojo</span> o <span class="text-yellow-600 font-semibold">amarillo</span> para alertarte sobre posibles quiebres de stock.
                                            </li>
                                            <li>
                                                <strong>Interpreta los Ingresos:</strong> La columna "Ingresos" se colorea para identificar el origen de las entradas. Al pasar el mouse sobre la cantidad, verás el detalle:
                                                <ul class="list-none pl-2 mt-2 space-y-1 text-sm">
                                                    <li class="flex items-center gap-2"><span class="h-3 w-3 rounded-full bg-green-500"></span><strong class="text-green-700">Verde:</strong> O/C Aprobadas.</li>
                                                    <li class="flex items-center gap-2"><span class="h-3 w-3 rounded-full bg-yellow-400"></span><strong class="text-yellow-700">Amarillo:</strong> O/C Pendientes de aprobación.</li>
                                                    <li class="flex items-center gap-2"><span class="h-3 w-3 rounded-full bg-indigo-500"></span><strong class="text-indigo-700">Azul:</strong> Ingresos manuales simulados por ti.</li>
                                                </ul>
                                                <div class="mt-2 p-2 bg-white rounded border border-slate-200 text-sm">
                                                    <strong>Nota:</strong> Las O/C con estado "Rechazada" no se incluyen en la proyección.
                                                </div>
                                            </li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <!-- Global Search Modal -->
    <div id="global-search-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-start justify-center pt-20">
        <div id="global-search-container" class="relative w-full max-w-2xl bg-white rounded-xl shadow-2xl transform transition-all" style="opacity: 0; transform: translateY(-20px);">
            <div class="p-4 border-b">
                <div class="relative">
                    <svg class="w-6 h-6 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="global-search-input" placeholder="Buscar insumos, solpeds, o/c..." class="w-full text-lg p-3 pl-12 bg-transparent border-none focus:outline-none focus:ring-0" autocomplete="off">
                     <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                        <button id="download-search-modal-btn" class="text-slate-400 hover:text-slate-600 p-2" title="Descargar como imagen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                        <button id="close-global-search-modal-btn" class="text-slate-400 hover:text-slate-600 p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="global-search-results" class="max-h-[60vh] overflow-y-auto">
                <!-- Search results will be injected here -->
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <canvas id="matrix-canvas"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ESTADO DE LA APLICACIÓN ---
        let items = [];
        let processedItemsCache = [];
        let solpeds = [];
        let ocs = [];
        let notifications = [];
        let appSettings = {
            coverageThresholds: { red: 30, yellow: 60 },
            notificationThreshold: 15,
            consumptionMonths: [true, true, true, true, true, true, true, true, true, true, true, true],
            consumptionMonthLabels: [],
            immobilizationMonths: 6,
            iwebSapUrl: '',
            depositosExternosUrl: '',
            inventoryNotes: []
        };
        let solpedsSortConfig = { key: 'fechaSolicitud', direction: 'desc' };
        let ocsSortConfig = { key: 'proxFechaEntrega', direction: 'asc' };
        let indiceSortConfig = { key: 'group', direction: 'asc' };
        let immobilizedSortConfig = { key: 'monthsWithoutConsumption', direction: 'desc' };
        let allUserPermissions = new Map();
        let currentView = 'dashboard';
        let isAuthReady = false;
        let selectedConsumptionItemId = null;
        let comparisonItemId = null;
        let isSimulationModeActive = false;
        let simulatedIncomes = [];
        let simulatedIncomeCounter = 1;
        let editingSimulatedIncomeWeekId = null;
        let simulationShowAllWeeks = false;
        let consumoSelectedGroup = 'all';
        let consumoShowOnlyFavorites = false;
        let consumoComparisonSelectedGroup = 'all';
        let consumoComparisonShowOnlyFavorites = false;
        let showOnlyDelayedOCs = false;
        let ocsSelectedGroup = 'all';
        let ocsSelectedStatus = 'all';
        let ocsSelectedYear = 'all';
        let ocsSelectedMonths = [];
        let showOnlyDelayedSolpeds = false;
        let solpedsSelectedGroup = 'all';
        let solpedsSelectedYear = 'all';
        let solpedsSelectedMonths = [];
        let indiceSearchTerm = '';
        let indiceSelectedGroup = 'all';
        let indiceFavoriteFilter = 'all'; // Can be 'all', 'favorites', 'non-favorites'
        let indiceCoverageFilter = 'all';
        let notesSaveTimeout;
        let notesSaveTimeoutReview;
        let updateDebounceTimers = new Map();
        let noteUpdateDebounceTimers = new Map();
        let noteTitleUpdateDebounceTimers = new Map();
let groupNotes = new Map();
let activeKpi = null;
let isInitialLoad = true;
let currentUserTag = '';
let calendarCurrentDate = new Date();
let ingresosSelectedGroup = 'all';
let ingresosSearchTerm = '';
        let currentIngresosWeek = { start: null, end: null };
        
        // --- VARIABLES DE FIREBASE Y USUARIO ---
        let app, db, auth, userId, appId;
        let inventoryCollectionRef, permissionsCollectionRef, metadataDocRef, reviewHistoryCollectionRef, solpedsCollectionRef, ocsCollectionRef, appConfigDocRef;
        let unsubscribeInventory, unsubscribePermissions, unsubscribeMetadata, unsubscribeSolpeds, unsubscribeOCs, unsubscribeAppConfig;
        let currentUserRole = 'viewer';
        
        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCpEzBrL-Yi6kwPshw63UgwqnNOXWHH9eU",
          authDomain: "gestion-inventario-app-a11d6.firebaseapp.com",
          projectId: "gestion-inventario-app-a11d6",
          storageBucket: "gestion-inventario-app-a11d6.appspot.com",
          messagingSenderId: "817333595251",
          appId: "1:817333595251:web:437b7b2f91bdae506f4e06"
        };

        // --- FUNCIONES DE UTILIDAD ---
        function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => { toast.remove(); }, 5000); }
        
        function getCurrentDateString() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0!
            const year = today.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function handleCopyText(textToCopy, buttonElement) {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = `<span class="text-xs font-bold text-green-600">Copiado!</span>`;
                setTimeout(() => {
                    buttonElement.innerHTML = originalContent;
                }, 2000);
            } catch (err) {
                console.error('Error al copiar texto: ', err);
                showToast('No se pudo copiar el texto.', 'error');
            }
            document.body.removeChild(tempTextArea);
        }

        function handleExportDashboardNotes() {
            const notes = appSettings.inventoryNotes || [];
            if (notes.length === 0) {
                showToast('No hay notas para exportar.', 'info');
                return;
            }
            
            const dataToExport = notes.map(note => ({
                'Título': note.title,
                'Contenido': note.content
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);

            if(!worksheet['!cols']) worksheet['!cols'] = [];
            worksheet['!cols'][0] = { wch: 40 }; 
            worksheet['!cols'][1] = { wch: 100 }; 

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Notas de Inventario');
            
            const filename = `${getCurrentDateString()}_Notas_Inventarios.xlsx`;
            XLSX.writeFile(workbook, filename);
            showToast(`Notas exportadas como ${filename}`, 'success');
        }

        async function handleAddInventoryNote() {
            if (currentUserRole !== 'owner') {
                showToast('No tienes permiso para añadir notas.', 'error');
                return;
            }
            const titleInput = document.getElementById('new-note-title-input');
            const title = titleInput.value.trim();
            if (!title) {
                showToast('Por favor, introduce un título para la nota.', 'error');
                return;
            }

            const newNote = {
                id: new Date().getTime().toString(), // Simple unique ID
                title: title,
                content: ''
            };

            const newNotesArray = [...(appSettings.inventoryNotes || []), newNote];

            try {
                await updateDoc(appConfigDocRef, { "settings.inventoryNotes": newNotesArray });
                titleInput.value = '';
                showToast('Nota añadida.', 'success');
                // The onSnapshot listener will handle re-rendering
            } catch (error) {
                console.error("Error al añadir nota:", error);
                showToast('Error al añadir la nota.', 'error');
            }
        }

        async function handleUpdateInventoryNoteTitle(noteId, newTitle) {
            if (currentUserRole !== 'owner') return;

            if (!newTitle || newTitle.trim() === '') {
                showToast('El título no puede estar vacío.', 'error');
                renderInventoryNotesList(); // Re-render to show the old title from state
                return;
            }

            const currentNotes = appSettings.inventoryNotes || [];
            const noteIndex = currentNotes.findIndex(note => note.id === noteId);

            if (noteIndex === -1) return;

            const updatedNotes = [...currentNotes];
            updatedNotes[noteIndex] = { ...updatedNotes[noteIndex], title: newTitle.trim() };
            
            try {
                await updateDoc(appConfigDocRef, { "settings.inventoryNotes": updatedNotes });
                showToast('Título actualizado.', 'success');
            } catch (error) {
                console.error("Error al actualizar el título:", error);
                showToast('Error al actualizar el título.', 'error');
            }
        }

        async function handleUpdateInventoryNoteContent(noteId, content) {
            if (currentUserRole !== 'owner') return;
            const currentNotes = appSettings.inventoryNotes || [];
            const noteIndex = currentNotes.findIndex(note => note.id === noteId);

            if (noteIndex === -1) return;

            const updatedNotes = [...currentNotes];
            updatedNotes[noteIndex] = { ...updatedNotes[noteIndex], content: content };
            
            try {
                await updateDoc(appConfigDocRef, { "settings.inventoryNotes": updatedNotes });
                showToast('Nota guardada.', 'success');
            } catch (error) {
                console.error("Error al guardar la nota:", error);
                showToast('Error al guardar la nota.', 'error');
            }
        }

        async function handleDeleteInventoryNote(noteId) {
            if (currentUserRole !== 'owner') {
                showToast('No tienes permiso para eliminar notas.', 'error');
                return;
            }
            const updatedNotes = (appSettings.inventoryNotes || []).filter(note => note.id !== noteId);
             try {
                await updateDoc(appConfigDocRef, { "settings.inventoryNotes": updatedNotes });
                showToast('Nota eliminada.', 'success');
            } catch (error)
                {
                console.error("Error al eliminar la nota:", error);
                showToast('Error al eliminar la nota.', 'error');
            }
        }

        function formatDate(isoDateString, separator = '-') {
            if (!isoDateString) return '';
            const date = parseDateString(isoDateString);
            if (!date) return isoDateString;

            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            
            return [day, month, year].join(separator);
        }

        function formatDateTime(isoDateString) {
            if (!isoDateString) return '';
            const date = new Date(isoDateString);
            if (isNaN(date.getTime())) return isoDateString;

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');

            return `${day}/${month}/${year} - ${hours}:${minutes}`;
        }

        function parseDateString(dateStr) {
            if (!dateStr || (typeof dateStr !== 'string' && typeof dateStr !== 'number') || String(dateStr).trim() === '') return null;
            
            if(typeof dateStr === 'number' && dateStr > 1) {
                const d = new Date((dateStr - 25569) * 86400000);
                 if (d instanceof Date && !isNaN(d)) {
                     d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                     return d;
                 }
            }

            const trimmedStr = String(dateStr).trim();
            
            const matchDMY = trimmedStr.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{4})$/);
            if (matchDMY) {
                const day = parseInt(matchDMY[1], 10);
                const month = parseInt(matchDMY[2], 10) - 1;
                const year = parseInt(matchDMY[3], 10);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    const d = new Date(Date.UTC(year, month, day));
                    if (d.getUTCFullYear() === year && d.getUTCMonth() === month && d.getUTCDate() === day) {
                        return d;
                    }
                }
            }

            const isoDate = new Date(trimmedStr + 'T00:00:00Z');
            if (!isNaN(isoDate.getTime())) {
                return isoDate;
            }

            return null;
        }

        const parseAndFormatDateToISO = (val) => {
            if (!val) return '';
            const d = parseDateString(val);
            if (d) return d.toISOString().split('T')[0];
            return '';
        };

        function getWeekId(d) {
            // Create a new UTC date to avoid modifying the original date object
            const date = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
            // ISO 8601 week number logic
            date.setUTCDate(date.getUTCDate() + 4 - (date.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            return `${date.getUTCFullYear()}-${String(weekNo).padStart(2, '0')}`;
        }
        function daysBetween(date1, date2) { return Math.round((new Date(date2) - new Date(date1)) / (1000 * 60 * 60 * 24)); }
        function formatNumber(num) { return new Intl.NumberFormat('es-AR').format(num); }

        function exportToExcel(data, filename) {
            if (!data || data.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }
            try {
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Datos');
                XLSX.writeFile(workbook, filename);
                showToast(`Exportado como ${filename}`, 'success');
            } catch (error) {
                console.error("Error al exportar a Excel:", error);
                showToast('Hubo un error al exportar el archivo.', 'error');
            }
        }

        function syncReviewRowHeights() {
            requestAnimationFrame(() => {
                const groups = [...new Set(Array.from(document.querySelectorAll('.history-table tbody tr[data-group-name]')).map(row => row.dataset.groupName))];

                groups.forEach(groupName => {
                    const historyInfoRow = document.querySelector(`.history-table .group-info-row[data-group-name="${groupName}"]`);
                    const reviewInfoRow = document.querySelector(`.review-table .group-info-row[data-group-name="${groupName}"]`);
                    const historyNotesRow = document.querySelector(`.history-table .group-notes-row[data-group-name="${groupName}"]`);
                    const reviewNotesRow = document.querySelector(`.review-table .group-notes-row[data-group-name="${groupName}"]`);
                    
                    // Sync info rows
                    if (historyInfoRow && reviewInfoRow) {
                        historyInfoRow.style.height = 'auto';
                        reviewInfoRow.style.height = 'auto';
                        const infoHeight = Math.max(historyInfoRow.offsetHeight, reviewInfoRow.offsetHeight);
                        historyInfoRow.style.height = `${infoHeight}px`;
                        reviewInfoRow.style.height = `${infoHeight}px`;
                    }

                    // Sync notes rows (based on textarea content)
                    if (historyNotesRow && reviewNotesRow) {
                        const notesTextarea = historyNotesRow.querySelector('textarea');
                        historyNotesRow.style.height = 'auto';
                        reviewNotesRow.style.height = 'auto';
                        
                        let notesHeight = 34; // Minimum height for the row (approx p-1 + textarea height)
                        if (notesTextarea) {
                            notesTextarea.style.height = 'auto'; // Temporarily shrink to get scrollHeight
                            notesHeight = Math.max(notesTextarea.scrollHeight + 4, 34); // Add a little padding
                            notesTextarea.style.height = `${notesTextarea.scrollHeight}px`; // Expand back
                        }

                        const finalHeight = Math.max(historyNotesRow.offsetHeight, reviewNotesRow.offsetHeight, notesHeight);
                        historyNotesRow.style.height = `${finalHeight}px`;
                        reviewNotesRow.style.height = `${finalHeight}px`;
                    }
                });
            });
        }

        function renderDateAndWeek() {
            const container = document.getElementById('date-week-container');
            if (!container) return;

            const today = new Date();
            const weekId = getWeekId(today);
            const weekNumber = parseInt(weekId.split('-')[1], 10);

            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            let formattedDate = today.toLocaleDateString('es-AR', dateOptions);
            formattedDate = formattedDate.toUpperCase();

            container.innerHTML = `
                <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
                     <div>
                        <p class="text-lg font-bold text-[#6366f1]">${formattedDate}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-medium text-slate-500 uppercase">SEMANA</p>
                        <p class="text-3xl font-bold text-[#6366f1]">${weekNumber}</p>
                    </div>
                </div>
            `;
        }

        function transformOCStatus(status) {
            if (!status) return '';
            const lowerStatus = status.toLowerCase();
            if (lowerStatus.includes('enviados') || lowerStatus.includes('docum.subsiguientes')) return 'Aprobada';
            if (lowerStatus.includes('en proceso de autorización')) return 'Pendiente';
            if (lowerStatus.includes('rechazado')) return 'Rechazada';
            return status;
        }

        function extractGroupCode(groupName) {
            if (!groupName || typeof groupName !== 'string') return '';
            // Elimina el texto entre paréntesis (ej. "GRUPO (COMPRADOR)") para quedarse solo con "GRUPO"
            return groupName.replace(/\s*\([^)]*\)/g, '').trim();
        }

        function extractGroupCodeAbbr(groupName) {
            if (!groupName || typeof groupName !== 'string') return '';
            const match = groupName.match(/\(([^)]+)\)/);
            if (match && match[1]) {
                return match[1].trim();
            }
            return groupName.trim();
        }

        // --- LÓGICA DE AUTENTICACIÓN Y UI INICIAL ---
        function handleAuthError(error, elementId) { const errorEl = document.getElementById(elementId); let message = "Ocurrió un error."; switch (error.code) { case 'auth/user-not-found': case 'auth/invalid-credential': message = "Credenciales incorrectas."; break; case 'auth/wrong-password': message = "Contraseña incorrecta."; break; case 'auth/email-already-in-use': message = "El email ya está registrado."; break; case 'auth/weak-password': message = "La contraseña debe tener al menos 6 caracteres."; break; case 'auth/invalid-email': message = "El formato del email no es válido."; break; } errorEl.textContent = message; }
        async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { handleAuthError(error, 'login-error'); } }
        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast('Cuenta creada. Serás redirigido.', 'success');
            } catch (error) {
                handleAuthError(error, 'register-error');
            }
        }
        async function handleLogout() { try { await signOut(auth); window.location.reload(); } catch (error) { console.error("Error al cerrar sesión:", error); showToast('Error al cerrar sesión.', 'error'); } }
        function switchAuthView(view) { document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.add('hidden'); if (document.getElementById(view)) { document.getElementById(view).classList.remove('hidden'); } }

        function adaptUiToRole(role, user, tag) {
    currentUserTag = tag || user.email.split('@')[0];
    const userAvatar = document.getElementById('user-avatar');
    const userNameEl = document.getElementById('user-name');
    const userEmailEl = document.getElementById('user-dropdown-email');
            const userRoleEl = document.getElementById('user-dropdown-role');
            const adminButton = document.getElementById('admin-button-dropdown');
            const preloadButton = document.getElementById('dashboard-preload-btn-dropdown');
            const clearButton = document.getElementById('dashboard-clear-btn-dropdown');
            const adminDivider = document.getElementById('admin-actions-divider');
            const addItemBtn = document.getElementById('add-new-item-btn');
            const checkNavlink = document.querySelector('button[data-view="revision"]');
            const notificationContainer = document.getElementById('notification-container');

            // Update user info in dropdown
            const displayTag = tag || user.email.split('@')[0];
            
            if (userAvatar) {
                userAvatar.innerHTML = ''; // Clear previous content
                let iconSVG = '';
                switch(role) {
                    case 'owner':
                        iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`;
                        break;
                    case 'editor':
                        iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
                        break;
                    case 'viewer':
                        iconSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
                        break;
                    default:
                        userAvatar.textContent = displayTag.charAt(0).toUpperCase();
                }
                if (iconSVG) {
                    userAvatar.innerHTML = iconSVG;
                }
            }

            if (userNameEl) userNameEl.textContent = displayTag.toUpperCase();
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userRoleEl) userRoleEl.textContent = role.toUpperCase();
            
            // Show/hide based on roles
            const isOwner = role === 'owner';
            const isEditor = role === 'editor';

            if (adminButton) adminButton.classList.toggle('hidden', !isOwner);
            if (adminDivider) adminDivider.classList.toggle('hidden', !isOwner && !isEditor);
            if (preloadButton) preloadButton.classList.toggle('hidden', !isOwner && !isEditor);
            if (clearButton) clearButton.classList.toggle('hidden', !isOwner && !isEditor);
            if (addItemBtn) addItemBtn.classList.toggle('hidden', !isOwner && !isEditor);
            if (checkNavlink) checkNavlink.classList.toggle('hidden', !isOwner);
            if (notificationContainer) notificationContainer.classList.toggle('hidden', !isOwner);
            
            const userMenuButton = document.getElementById('user-menu-button');
            if (userMenuButton) userMenuButton.disabled = !user;
        }

        // --- LÓGICA DE NAVEGACIÓN Y VISTAS ---
        function switchMainView(view) {
            if (currentView === 'consumos' && view !== 'consumos') {
                isSimulationModeActive = false;
            }
            currentView = view;
            document.getElementById('dashboard-view').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('indice-view').classList.toggle('hidden', view !== 'indice');
            document.getElementById('consumos-view').classList.toggle('hidden', view !== 'consumos');
            document.getElementById('solpeds-view').classList.toggle('hidden', view !== 'solpeds');
            document.getElementById('ocs-view').classList.toggle('hidden', view !== 'ocs');
            document.getElementById('ingresos-view').classList.toggle('hidden', view !== 'ingresos');
            document.getElementById('reportes-view').classList.toggle('hidden', view !== 'reportes');
            document.getElementById('revision-view').classList.toggle('hidden', view !== 'revision');
            
            if (view !== 'dashboard') {
                closeKpiDetailView();
            }

            document.querySelectorAll('#main-nav-links .nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === view);
            });
            
            document.getElementById('logo-container').classList.toggle('active', view === 'dashboard');

            if (view === 'indice') {
                renderIndiceView();
            } else if (view === 'consumos') {
                renderConsumosView();
            } else if (view === 'solpeds') {
                renderSolpedsView();
            } else if (view === 'ocs') {
                renderOCsView();
            } else if (view === 'ingresos') {
                renderIngresosView();
            } else if (view === 'reportes') {
                renderReportesView();
            } else if (view === 'revision') {
                renderHistoryView();
                if(currentUserRole === 'owner') {
                    renderReviewTable();
                }
            }
        }

        function renderIngresosView() {
            renderMonthlyCalendar(calendarCurrentDate);

            // Automatically select and render details for the current week on first load of this view
            const todayRaw = new Date();
            const today = new Date(Date.UTC(todayRaw.getFullYear(), todayRaw.getMonth(), todayRaw.getDate()));

            const startOfWeek = new Date(today);
            const dayOfWeek = (startOfWeek.getUTCDay() + 6) % 7; // Monday = 0
            startOfWeek.setUTCDate(startOfWeek.getUTCDate() - dayOfWeek);

            const weekId = getWeekId(startOfWeek);
            const selectedWeekRow = document.querySelector(`.calendar-week-row[data-week-id="${weekId}"]`);
            if (selectedWeekRow) {
                selectedWeekRow.classList.add('selected-week');
            }
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setUTCDate(endOfWeek.getUTCDate() + 6);
            renderIncomingItemsForWeek(startOfWeek, endOfWeek);
        }

        function renderMonthlyCalendar(date) {
            const container = document.getElementById('ingresos-calendar-container');
            if (!container) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const year = date.getFullYear();
            const month = date.getMonth();

            const firstDay = new Date(Date.UTC(year, month, 1));
            const lastDay = new Date(Date.UTC(year, month + 1, 0));

            const monthName = firstDay.toLocaleString('es-AR', { month: 'long', timeZone: 'UTC' });
            const capitalizedMonthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            const incomeDates = new Set(ocs.map(oc => oc.proxFechaEntrega).filter(Boolean));

            let html = `
                <div class="calendar">
                    <div class="calendar-header">
                        <div class="flex items-center gap-2">
                            <button id="calendar-prev-month" class="p-2 rounded-full hover:bg-slate-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                            <button id="calendar-next-month" class="p-2 rounded-full hover:bg-slate-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">${capitalizedMonthName} ${year}</h3>
                        <button id="calendar-today-btn" class="btn-main-style !text-xs !h-8 !px-3">Semana Actual</button>
                    </div>
                    <div class="flex items-center">
                        <div class="week-number-cell w-8 flex-shrink-0"></div> <!-- Empty cell for week number header -->
                        <div class="calendar-grid flex-grow">
                            ${['Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sá', 'Do'].map(day => `<div class="calendar-day-name">${day}</div>`).join('')}
                        </div>
                    </div>
                    <div id="calendar-body"></div>
                </div>`;
            container.innerHTML = html;

            const calendarBody = document.getElementById('calendar-body');
            let calendarHtml = '';
            
            const startDate = new Date(firstDay);
            const startDayOfWeek = (firstDay.getUTCDay() + 6) % 7; // Monday = 0
            startDate.setUTCDate(startDate.getUTCDate() - startDayOfWeek);

            for (let i = 0; i < 6; i++) { // Render up to 6 weeks
                const weekId = getWeekId(startDate);
                const weekNumber = parseInt(weekId.split('-')[1], 10);
                
                calendarHtml += `<div class="calendar-week-row flex items-center" data-week-id="${weekId}">
                                    <div class="week-number-cell w-8 flex-shrink-0">${weekNumber}</div>
                                    <div class="calendar-grid flex-grow">`;
                
                for (let j = 0; j < 7; j++) {
                    const currentDate = new Date(startDate);
                    const isOtherMonth = currentDate.getUTCMonth() !== month;
                    const isToday = currentDate.getTime() === today.getTime();
                    const dateISO = currentDate.toISOString().split('T')[0];
                    const hasIncome = incomeDates.has(dateISO);

                    let dayClasses = 'calendar-day';
                    if (isOtherMonth) dayClasses += ' other-month';
                    if (isToday) dayClasses += ' today';
                    if (hasIncome) dayClasses += ' has-income';
                    
                    calendarHtml += `<div class="${dayClasses}" data-date="${currentDate.getUTCFullYear()}-${currentDate.getUTCMonth()+1}-${currentDate.getUTCDate()}" data-week-id="${weekId}">${currentDate.getUTCDate()}</div>`;
                    startDate.setUTCDate(startDate.getUTCDate() + 1);
                }
                calendarHtml += `</div></div>`;

                if (startDate > lastDay && i > 3) break;
            }

            calendarBody.innerHTML = calendarHtml;
        }

        function renderIncomingItemsForWeek(startOfWeek, endOfWeek, renderHeader = true) {
            currentIngresosWeek.start = startOfWeek;
            currentIngresosWeek.end = endOfWeek;
            const headerContainer = document.getElementById('ingresos-header-container');
            const detailsContainer = document.getElementById('ingresos-details-container');
            const kpiContainer = document.getElementById('ingresos-kpi-container');
            if (!headerContainer || !detailsContainer || !kpiContainer) return;

            const incomingOCs = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate >= startOfWeek && deliveryDate <= endOfWeek;
            });
            
            // --- KPI Calculation & Rendering ---
            // Dynamic group KPI calculation
            const groupKpis = incomingOCs.reduce((acc, oc) => {
                const group = extractGroupCode(oc.grupoDeArticulos);
                if (group) {
                    if (!acc[group]) {
                        acc[group] = new Set();
                    }
                    acc[group].add(oc.codigo);
                }
                return acc;
            }, {});

            const sortedGroupKpis = Object.entries(groupKpis)
                .map(([group, itemsSet]) => ({ group, count: itemsSet.size }))
                .sort((a, b) => b.count - a.count); // Sort by count descending

            let kpiHtml = '';
            if (sortedGroupKpis.length > 0) {
                kpiHtml = `
                <div class="grid grid-cols-4 gap-2">
                    ${sortedGroupKpis.map(kpi => {
                        const isSelected = kpi.group === ingresosSelectedGroup;
                        const selectedClass = isSelected ? 'border-2 border-indigo-500 ring-2 ring-indigo-300' : 'border-slate-200/80';
                        return `
                        <div class="bg-white ${selectedClass} rounded-lg overflow-hidden shadow-sm transition hover:shadow-lg hover:-translate-y-1 cursor-pointer ingresos-kpi-card" data-group-name="${kpi.group}">
                            <div class="p-2 bg-slate-50/70 border-b border-slate-200/80">
                                <p class="text-xs font-semibold text-slate-600 uppercase truncate" title="${kpi.group}">${kpi.group}</p>
                            </div>
                            <div class="p-2 text-right">
                                <p class="text-2xl font-bold text-indigo-600">${kpi.count}</p>
                            </div>
                        </div>
                        `
                    }).join('')}
                </div>
                `;
            }

            kpiContainer.innerHTML = kpiHtml;
            
            const weekId = getWeekId(startOfWeek);
            const weekNumber = parseInt(weekId.split('-')[1], 10);

            // Filter logic
            let filteredOCs = incomingOCs;
            if (ingresosSelectedGroup !== 'all') {
                filteredOCs = filteredOCs.filter(oc => extractGroupCode(oc.grupoDeArticulos) === ingresosSelectedGroup);
            }

            if (ingresosSearchTerm) {
                const searchWords = ingresosSearchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredOCs = filteredOCs.filter(oc => {
                    const item = items.find(i => i.code === oc.codigo);
                    const itemName = item ? item.name : oc.denominacion;
                    const textToSearch = `${itemName} ${oc.ordenDeCompra || ''} ${oc.codigo || ''}`.toLowerCase();
                    return searchWords.every(word => textToSearch.includes(word));
                });
            }

            if (renderHeader) {
                // Generate group filter dropdown HTML
                const uniqueGroups = [...new Set(incomingOCs.map(oc => extractGroupCode(oc.grupoDeArticulos)).filter(Boolean))].sort();
                let groupFilterHTML = '';
                if (uniqueGroups.length > 1) { // Only show filter if there's more than one group
                    const totalCountInGroups = incomingOCs.filter(oc => uniqueGroups.includes(extractGroupCode(oc.grupoDeArticulos))).length;
                    groupFilterHTML = `
                        <select id="ingresos-group-filter" class="w-full max-w-xs bg-white/90 border-2 border-transparent text-slate-900 text-sm rounded-lg focus:ring-indigo-300 focus:border-indigo-300 block p-2 h-9 transition">
                            <option value="all">TODOS LOS GRUPOS (${totalCountInGroups})</option>
                            ${uniqueGroups.map(group => {
                                const groupCount = incomingOCs.filter(oc => extractGroupCode(oc.grupoDeArticulos) === group).length;
                                return `<option value="${group}" ${ingresosSelectedGroup === group ? 'selected' : ''}>${group} (${groupCount})</option>`
                            }).join('')}
                        </select>`;
                }

                // Header HTML
                const exportButtonHTML = incomingOCs.length > 0 ? `<button id="export-incoming-items-btn" title="Exportar a Excel" class="btn-main-style !bg-white/90 !text-indigo-700 hover:!bg-white flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            </button>` : '';

                let headerHTML = `
                    <div class="bg-indigo-500 p-4 -m-4 border-b border-indigo-600 flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div class="flex items-center gap-4 w-full sm:w-auto">
                            <h3 class="text-2xl font-bold text-white whitespace-nowrap">Semana ${weekNumber}</h3>
                            <span class="text-sm font-medium text-indigo-200">(${filteredOCs.length} de ${incomingOCs.length})</span>
                        </div>
                        <div class="flex items-center gap-2 w-full sm:w-auto">
                           ${groupFilterHTML}
                           <div class="relative flex-grow">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 pointer-events-none" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="http://www.w3.org/2000/svg" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="ingresos-search-input" placeholder="Buscar..." class="w-full p-2 pl-10 bg-white/90 text-slate-800 border-2 border-transparent focus:border-indigo-300 focus:bg-white rounded-lg h-9 transition" autocomplete="off" value="${ingresosSearchTerm}">
                           </div>
                           ${exportButtonHTML}
                        </div>
                    </div>`;
                headerContainer.innerHTML = headerHTML;
            }
            

            // List or empty state HTML
            let contentHTML;
            if (incomingOCs.length === 0) {
                contentHTML = '<p class="text-center text-slate-500 py-4">No hay ingresos programados para esta semana.</p>';
            } else if (filteredOCs.length === 0) {
                 contentHTML = '<p class="text-center text-slate-500 py-4">No hay ingresos que coincidan con los filtros.</p>';
            } else {
                const groupedByDate = filteredOCs.reduce((acc, oc) => {
                    const dateStr = formatDate(oc.proxFechaEntrega);
                    if (!acc[dateStr]) { acc[dateStr] = []; }
                    acc[dateStr].push(oc);
                    return acc;
                }, {});

                const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                    const dateA = a.split('-').reverse().join('-');
                    const dateB = b.split('-').reverse().join('-');
                    return new Date(dateA) - new Date(dateB);
                });
                
                let listHtml = '<div class="space-y-3">';
                sortedDates.forEach(dateStr => {
                    const date = parseDateString(dateStr);
                    const dayName = date.toLocaleDateString('es-AR', { weekday: 'long', timeZone: 'UTC' });
                    
                    listHtml += `<div>
                        <p class="font-bold text-indigo-600">${dayName.charAt(0).toUpperCase() + dayName.slice(1)} ${date.getUTCDate()}</p>
                        <ul class="divide-y divide-slate-200 border rounded-md mt-1 shadow-sm bg-white">`;
                    
                    groupedByDate[dateStr].forEach(oc => {
                        const item = items.find(i => i.code === oc.codigo);
                        const cleanItemName = item ? item.name.replace(new RegExp(`^${item.code}\\s*`), '') : oc.denominacion;
                        const displayName = `${oc.codigo || ''} - ${cleanItemName}`;
                        const itemGroup = extractGroupCode(oc.grupoDeArticulos || 'Sin Grupo');
                        const itemId = item ? item.id : null;
                        const cursorClass = itemId ? 'cursor-pointer' : '';
                        const dataAttr = itemId ? `data-item-id="${itemId}"` : '';

                        listHtml += `<li class="px-4 py-3 hover:bg-slate-50 incoming-item-row ${cursorClass}" ${dataAttr}>
                            <div class="flex justify-between items-center">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-semibold text-indigo-600">${itemGroup}</p>
                                    <p class="font-medium text-slate-800 truncate" title="${displayName}">${displayName}</p>
                                    <p class="text-xs text-slate-500 mt-1">O/C: ${oc.ordenDeCompra || 'N/A'} - ${oc.posicion || ''}</p>
                                </div>
                                <div class="ml-4 flex-shrink-0">
                                    <span class="text-2xl font-bold text-slate-800">${formatNumber(oc.cantEntregaSiguiente)}</span>
                                </div>
                            </div>
                        </li>`;
                    });
                    listHtml += `</ul></div>`;
                });
                listHtml += '</div>';
                contentHTML = listHtml;
            }

            detailsContainer.innerHTML = contentHTML;
        }

        function goToCurrentWeek() {
            calendarCurrentDate = new Date();
            renderMonthlyCalendar(calendarCurrentDate);

            const todayRaw = new Date();
            const today = new Date(Date.UTC(todayRaw.getFullYear(), todayRaw.getMonth(), todayRaw.getDate()));
            
            const startOfWeek = new Date(today);
            const dayOfWeek = (startOfWeek.getUTCDay() + 6) % 7; // Monday = 0
            startOfWeek.setUTCDate(startOfWeek.getUTCDate() - dayOfWeek);

            const weekId = getWeekId(startOfWeek);
            
            document.querySelectorAll('.calendar-week-row.selected-week').forEach(row => row.classList.remove('selected-week'));
            const selectedWeekRow = document.querySelector(`.calendar-week-row[data-week-id="${weekId}"]`);
            if (selectedWeekRow) {
                selectedWeekRow.classList.add('selected-week');
            }
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setUTCDate(endOfWeek.getUTCDate() + 6);
            renderIncomingItemsForWeek(startOfWeek, endOfWeek);
        }

        function generateNotifications() {
            if (!items.length) return;
            const processed = getProcessedItems();
            notifications = []; // Reset notifications

            const lowStockItems = processed.filter(item => 
                item.isFavorite && item.coverageDays < appSettings.notificationThreshold && item.coverageDays !== Infinity
            );

            lowStockItems.forEach(item => {
                notifications.push({
                    id: `low_stock_${item.id}`,
                    type: 'low_stock',
                    targetId: item.id,
                    read: false, // Default to unread
                    text: `Stock bajo para <strong>${item.name.toUpperCase()}</strong>. Cobertura: ${Math.round(item.coverageDays)} días.`
                });
            });
            
            // Can add other notification types here later (e.g., delayed OCs)

            notifications.sort((a, b) => a.text.localeCompare(b.text)); // Sort for consistent order
            renderNotifications();
        }

        function renderNotifications() {
            const badge = document.getElementById('notification-count-badge');
            const dropdown = document.getElementById('notification-dropdown');
            const unreadCount = notifications.filter(n => !n.read).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
            
            let dropdownHTML = `
                <div class="p-3 border-b flex justify-between items-center">
                    <h4 class="font-semibold text-slate-800">Notificaciones</h4>
                    ${unreadCount > 0 ? '<button id="mark-all-read-btn" class="text-xs font-medium text-indigo-600 hover:underline">Marcar todas como leídas</button>' : ''}
                </div>
            `;
            
            if (notifications.length === 0) {
                dropdownHTML += '<p class="p-4 text-sm text-center text-slate-500">No hay notificaciones.</p>';
            } else {
                dropdownHTML += notifications.map(n => `
                    <div class="p-3 border-b text-sm notification-item ${!n.read ? 'unread' : ''}" data-id="${n.id}" data-type="${n.type}" data-target-id="${n.targetId}">
                        <div class="flex items-start gap-3">
                           <div class="flex-shrink-0 mt-1">
                                <svg class="w-5 h-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                           </div>
                           <div>${n.text}</div>
                        </div>
                    </div>
                `).join('');
            }
            dropdown.innerHTML = dropdownHTML;
        }

        function handleNotificationClick(e) {
            const item = e.target.closest('.notification-item');
            if (!item) return;
            
            const { id, type, targetId } = item.dataset;
            
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
            }
            renderNotifications();
            document.getElementById('notification-dropdown').classList.remove('show');
            
            if (type === 'low_stock') {
                selectedConsumptionItemId = targetId;
                comparisonItemId = null;
                switchMainView('consumos');
            }
        }

        // --- FUNCIONES DE FIREBASE ---
        async function handleToggleFavorite(itemId) {
            if (currentUserRole === 'viewer') {
                showToast('No tienes permiso para cambiar favoritos.', 'error');
                return;
            }
            const itemRef = doc(inventoryCollectionRef, itemId);
            const currentItem = items.find(i => i.id === itemId);
            if (!currentItem) return;
            const newFavoriteStatus = !currentItem.isFavorite;
            try {
                await updateDoc(itemRef, { isFavorite: newFavoriteStatus });
                showToast(newFavoriteStatus ? 'Añadido a favoritos.' : 'Quitado de favoritos.', 'success');
            } catch (error) {
                console.error("Error al actualizar favorito:", error);
                showToast('Error al cambiar estado de favorito.', 'error');
            }
        }
        function handleClearAll() { 
            document.getElementById('confirm-modal-title').textContent = 'Limpiar datos de inventario';
            document.getElementById('confirm-modal-text').textContent = 'Se borrarán todos los insumos que no sean favoritos y no tengan notas. Los favoritos y los insumos con notas se conservarán, pero su stock y pedidos se reiniciarán. ¿Continuar?';
            document.getElementById('confirm-clear-modal').classList.remove('hidden');
            document.getElementById('confirm-clear-button').onclick = executeClearAll;
        }
        async function executeClearAll() { 
            if (!db) return; 
            showToast('Limpiando datos...', 'info'); 
            try { 
                const batch = writeBatch(db); 
                const querySnapshot = await getDocs(inventoryCollectionRef); 
                let itemsKept = 0; 
                let itemsDeleted = 0; 
                querySnapshot.forEach((doc) => { 
                    const data = doc.data();
                    const hasNotes = data.description_notes && data.description_notes.trim() !== '';
                    if (data.isFavorite || hasNotes) { 
                        batch.update(doc.ref, { 
                            stock: 0, 
                            monthlyConsumption: 0, 
                            delayedQuantity: 0, 
                            orderQuantities: [], 
                            isModified: false, 
                            consumos: [],
                            lastModifiedBy: null,
                            lastModifiedAt: null
                        }); 
                        itemsKept++; 
                    } else { 
                        batch.delete(doc.ref); 
                        itemsDeleted++; 
                    } 
                }); 
                
                const solpedsSnapshot = await getDocs(solpedsCollectionRef);
                solpedsSnapshot.forEach(doc => batch.delete(doc.ref));
                const ocsSnapshot = await getDocs(ocsCollectionRef);
                ocsSnapshot.forEach(doc => batch.delete(doc.ref));
                
                batch.delete(metadataDocRef); 
                await batch.commit(); 
                showToast(`Limpieza completa: ${itemsDeleted} borrados, ${itemsKept} conservados.`, 'success'); 
            } catch (error) { 
                console.error("Error al limpiar:", error); 
                showToast('Error al limpiar los datos.', 'error'); 
            } finally { 
                document.getElementById('confirm-clear-modal').classList.add('hidden'); 
            } 
        }
        
        // --- LÓGICA DE PRECARGA Y MODALES ---
        function handleOpenPreloadModal() { document.getElementById('preload-modal').classList.remove('hidden'); document.getElementById('preload-feedback').textContent = ''; document.getElementById('preload-file-input').value = ''; }
        function handleClosePreloadModal() { document.getElementById('preload-modal').classList.add('hidden'); }
        function handleFileInputChange() { const fileInput = document.getElementById('preload-file-input'); const feedbackEl = document.getElementById('preload-feedback'); if (fileInput.files.length > 0) { feedbackEl.textContent = `Archivo: ${fileInput.files[0].name}`; } else { feedbackEl.textContent = ''; } }
        async function handleProcessPreloadData() {
            const processButton = document.getElementById('process-preload-data'), buttonText = document.getElementById('process-preload-text'), loader = document.getElementById('process-preload-loader'), fileInput = document.getElementById('preload-file-input');
            if (fileInput.files.length === 0) { showToast('Selecciona un archivo.', 'error'); return; }
            processButton.disabled = true; buttonText.classList.add('hidden'); loader.classList.remove('hidden');
            
            const persistentDataMap = new Map();
            const currentInventorySnapshot = await getDocs(inventoryCollectionRef);
            currentInventorySnapshot.forEach(doc => {
                const data = doc.data();
                const hasNotes = data.description_notes && data.description_notes.trim() !== '';
                if (data.isFavorite || hasNotes) {
                    persistentDataMap.set(data.code, { 
                        isFavorite: data.isFavorite || false, 
                        description_notes: data.description_notes || '' 
                    });
                }
            });

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array', cellDates: true });
                    
                    const { inventoryItems: newItemsFromExcel } = processInventorySheet(workbook);
                    const { historyMap, monthLabels } = processHistorySheet(workbook);
                    const { solpedsData } = processSolpedsSheet(workbook);
                    const { ocsData } = processOCSheet(workbook);

                    newItemsFromExcel.forEach(item => {
                        item.consumos = historyMap.get(item.code) || [];
                        if (persistentDataMap.has(item.code)) {
                            const persistentData = persistentDataMap.get(item.code);
                            item.isFavorite = persistentData.isFavorite;
                            item.description_notes = persistentData.description_notes;
                        }
                    });

                    const batch = writeBatch(db);
                    
                    currentInventorySnapshot.forEach(doc => batch.delete(doc.ref));
                    newItemsFromExcel.forEach(item => batch.set(doc(inventoryCollectionRef), item));

                    const oldSolpedsSnapshot = await getDocs(solpedsCollectionRef);
                    oldSolpedsSnapshot.forEach(doc => batch.delete(doc.ref));
                    solpedsData.forEach(item => batch.set(doc(solpedsCollectionRef), item));

                    const oldOCsSnapshot = await getDocs(ocsCollectionRef);
                    oldOCsSnapshot.forEach(doc => batch.delete(doc.ref));
                    ocsData.forEach(item => batch.set(doc(ocsCollectionRef), item));

                    batch.set(metadataDocRef, { filename: file.name, lastUpdated: new Date().toISOString() });

                    if (monthLabels && monthLabels.length > 0) {
                        const newSettings = { ...appSettings, consumptionMonthLabels: monthLabels };
                        batch.set(appConfigDocRef, { settings: newSettings }, { merge: true });
                    }

                    await batch.commit();
                    showToast(`Sincronización completa.`, 'success');
                    setTimeout(handleClosePreloadModal, 2500);
                } catch (e) { 
                    console.error("Error procesando archivo:", e); 
                    showToast('Error al procesar el archivo.', 'error');
                } finally { 
                    processButton.disabled = false; 
                    buttonText.classList.remove('hidden'); 
                    loader.classList.add('hidden'); 
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        
        function processInventorySheet(workbook) {
            const sheetName = workbook.SheetNames[0];
            if (!sheetName) return { inventoryItems: [], inventoryReport: { processedCount: 0, ignoredCount: 0 } };
            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });
            const itemsMap = new Map();
            const report = { processedCount: 0, ignoredCount: 0, reasons: {} };
            const headerRow = rows[0].map(h => String(h).trim().toLowerCase().replace(/[\s_]+/g, ''));
            const colMap = {
                group: headerRow.indexOf('grupo'),
                code: headerRow.indexOf('código') !== -1 ? headerRow.indexOf('código') : headerRow.indexOf('cod'),
                name: headerRow.indexOf('nombre'),
                stock: headerRow.indexOf('stock'),
                monthlyConsumption: headerRow.indexOf('consumomensual'),
                delayedQuantity: headerRow.indexOf('demorados'),
                pedido: headerRow.indexOf('pedido'),
                fecha: headerRow.indexOf('fecha'),
                leadTimeDays: headerRow.indexOf('leadtime'),
                safetyStockDays: headerRow.indexOf('díasseguridad')
            };
            const parseNumeric = (val) => {
                if (val === null || val === undefined || typeof val === 'string' && val.trim() === '' || val === '-') return 0;
                const cleanVal = String(val).replace(/\./g, '').replace(',', '.');
                const num = parseFloat(cleanVal);
                return isNaN(num) ? 0 : num;
            };
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 2 || row.every(cell => cell === null || cell === '')) continue;
                const code = String(row[colMap.code] || '').trim();
                const name = String(row[colMap.name] || '').trim();
                if (!code || !name) {
                    report.ignoredCount++;
                    report.reasons['Falta Código/Nombre'] = (report.reasons['Falta Código/Nombre'] || 0) + 1;
                    continue;
                }
                let existingItem = itemsMap.get(code);
                if (!existingItem) {
                    existingItem = {
                        code: code,
                        group: String(row[colMap.group] || 'General').trim(),
                        name: `${code} ${name}`.toUpperCase(),
                        stock: parseNumeric(row[colMap.stock]),
                        monthlyConsumption: parseNumeric(row[colMap.monthlyConsumption]),
                        delayedQuantity: parseNumeric(row[colMap.delayedQuantity]),
                        leadTimeDays: parseNumeric(row[colMap.leadTimeDays]),
                        safetyStockDays: parseNumeric(row[colMap.safetyStockDays]),
                        orderQuantities: [],
                        isModified: false,
                        createdAt: new Date().toISOString(),
                        isFavorite: false,
                        description_notes: ''
                    };
                    itemsMap.set(code, existingItem);
                }
                const pedido = parseNumeric(row[colMap.pedido]);
                const fecha = parseAndFormatDateToISO(row[colMap.fecha]);
                if (pedido > 0) {
                    if (fecha) {
                        existingItem.orderQuantities.push({ quantity: pedido, date: fecha });
                    } else {
                        report.ignoredCount++;
                        report.reasons['Pedido sin Fecha'] = (report.reasons['Pedido sin Fecha'] || 0) + 1;
                    }
                }
            }
            report.processedCount = itemsMap.size;
            return { inventoryItems: Array.from(itemsMap.values()), inventoryReport: report };
        }
        function processHistorySheet(workbook) {
            const sheetName = workbook.SheetNames[1];
            if (!sheetName) return { historyMap: new Map(), historyReport: { processedCount: 0, ignoredCount: 0 }, monthLabels: [] };
            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });
            const historyMap = new Map();
            const report = { processedCount: 0, ignoredCount: 0 };
            const headerRow = rows[0].map(h => String(h).trim().toLowerCase());
            const codeIndex = headerRow.indexOf('material') !== -1 ? headerRow.indexOf('material') : headerRow.indexOf('cod');
            
            const monthLabels = rows[0].slice(2).map(h => String(h).trim());

            if (codeIndex === -1) {
                console.error("No se encontró la columna 'material' o 'cod' en la Hoja2.");
                return { historyMap, historyReport: report, monthLabels: [] };
            }
            const parseNumeric = (val) => {
                if (val === null || val === undefined || typeof val === 'string' && val.trim() === '' || val === '-') return 0;
                const cleanVal = String(val).replace(/\./g, '').replace(',', '.');
                const num = parseFloat(cleanVal);
                return isNaN(num) ? 0 : num;
            };
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[codeIndex]) continue;
                const code = String(row[codeIndex]).trim();
                const consumos = row.slice(2).map(parseNumeric);
                if (code) {
                    historyMap.set(code, consumos);
                } else {
                    report.ignoredCount++;
                }
            }
            report.processedCount = historyMap.size;
            return { historyMap, historyReport: report, monthLabels };
        }
        function processSolpedsSheet(workbook) {
            const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('solped'));
            if (!sheetName) {
                console.warn("No se encontró la hoja 'Solped' en el archivo.");
                return { solpedsData: [] };
            }
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
            const solpedsData = jsonData.map(row => ({
                solicitud: row['Solicitud de pedido'] || '',
                cod: row['Cod'] || '',
                descripcion: row['Texto breve'] || '',
                cantidad: parseFloat(String(row['Cantidad solicitada']).replace(',', '.')) || 0,
                fechaSolicitud: parseAndFormatDateToISO(row['Fecha de solicitud']),
                creadoPor: row['Creado por'] || '',
                status: row['Status'] || '',
                fechaLiberacion: parseAndFormatDateToISO(row['Fecha de liberación']),
                grupoDeCompras: row['Grupo de compras'] || '',
                grupoDeArticulos: row['Grupo de artículos'] || ''
            }));
            return { solpedsData };
        }
        function processOCSheet(workbook) {
            const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('oc'));
            if (!sheetName) {
                console.warn("No se encontró la hoja 'OC' en el archivo.");
                return { ocsData: [] };
            }
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
            const ocsData = jsonData.map(row => ({
                solped: row['Solped'] || '',
                ordenDeCompra: row['Orden de compra'] || '',
                posicion: row['Posición'] || '',
                proxFechaEntrega: parseAndFormatDateToISO(row['Próxima fecha de entrega']),
                cantEntregaSiguiente: parseFloat(String(row['Cantidad de entrega siguiente']).replace(',', '.')) || 0,
                codigo: row['Codigo'] || '',
                denominacion: row['Denominación de material'] || '',
                grupoDeArticulos: row['Grupo de artículos'] || '',
                grupoDeCompras: row['Grupo de compras'] || '',
                status: row['Status de la orden'] || ''
            }));
            return { ocsData };
        }
        
        // --- LÓGICA DEL PANEL DE ADMINISTRACIÓN ---
        async function openAdminModal() {
            document.getElementById('admin-modal').classList.remove('hidden');
            
            const permissionsTab = document.querySelector('.admin-tab[data-tab="permissions"]');
            const settingsTab = document.querySelector('.admin-tab[data-tab="settings"]');
            const permissionsContent = document.getElementById('admin-content-permissions');
            const settingsContent = document.getElementById('admin-content-settings');

            // Solo el 'owner' puede acceder a este modal
            if (currentUserRole === 'owner') {
                permissionsTab.classList.remove('hidden');
                permissionsTab.classList.add('active');
                settingsTab.classList.remove('active');
                permissionsContent.classList.remove('hidden');
                settingsContent.classList.add('hidden');
                
                allUserPermissions.clear();
                const querySnapshot = await getDocs(permissionsCollectionRef);
                querySnapshot.forEach(doc => { allUserPermissions.set(doc.id, doc.data().email || doc.id); });
                renderPermissionsList();
            }
            
            document.getElementById('setting-red-threshold').value = appSettings.coverageThresholds.red;
            document.getElementById('setting-yellow-threshold').value = appSettings.coverageThresholds.yellow;
            document.getElementById('setting-notification-threshold').value = appSettings.notificationThreshold;
            document.getElementById('setting-immobilization-months').value = appSettings.immobilizationMonths;
            document.getElementById('setting-iweb-sap-url').value = appSettings.iwebSapUrl || '';
            document.getElementById('setting-depositos-externos-url').value = appSettings.depositosExternosUrl || '';
            
            const consumptionMonthsContainer = document.getElementById('consumption-months-checkboxes');
            const selectedMonths = appSettings.consumptionMonths || Array(12).fill(true);
            const defaultMonthNames = Array.from({ length: 12 }, (_, i) => `M${i + 1}`);
            const monthLabels = (appSettings.consumptionMonthLabels && appSettings.consumptionMonthLabels.length > 0)
                ? appSettings.consumptionMonthLabels
                : defaultMonthNames;

            let checkboxesHTML = '';
            for (let i = 0; i < 12; i++) {
                const label = monthLabels[i] || defaultMonthNames[i]; // Fallback if labels array is short
                const isChecked = selectedMonths[i];
                checkboxesHTML += `
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" data-month-index="${i}" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
                        <span class="text-sm font-medium text-slate-700">${label}</span>
                    </label>
                `;
            }
            consumptionMonthsContainer.innerHTML = checkboxesHTML;
        }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
        async function renderPermissionsList() {
            const listEl = document.getElementById('permissions-list');
            listEl.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>';
            const querySnapshot = await getDocs(permissionsCollectionRef);
            const permissions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            listEl.innerHTML = `<div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-sm text-slate-700 uppercase bg-slate-100/75">
                        <tr>
                            <th scope="col" class="px-6 py-4 w-[30%] font-semibold">Usuario</th>
                            <th scope="col" class="px-6 py-4 w-[20%] font-semibold">Etiqueta</th>
                            <th scope="col" class="px-6 py-4 w-[15%] font-semibold">Rol</th>
                            <th scope="col" class="px-6 py-4 w-[35%] font-semibold">Grupos Editables</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${permissions.map(p => `
                            <tr class="bg-white border-b hover:bg-slate-50">
                                <td class="px-6 py-4 font-medium text-slate-800 align-middle">
                                    <div class="text-sm break-all">${p.email || p.id}</div>
                                    ${p.id === userId ? '<span class="mt-1 inline-block bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Tú</span>' : ''}
                                </td>
                                <td class="px-6 py-4">
                                    <input type="text" data-userid="${p.id}" class="tag-input w-full text-sm p-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" value="${p.tag || ''}" ${currentUserRole !== 'owner' ? 'disabled' : ''} placeholder="Nombre a mostrar">
                                </td>
                                <td class="px-6 py-4">
                                    <select data-userid="${p.id}" class="role-select w-full p-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" ${p.role === 'owner' ? 'disabled' : ''}>
                                        <option value="owner" ${p.role === 'owner' ? 'selected' : ''} disabled>Propietario</option>
                                        <option value="editor" ${p.role === 'editor' ? 'selected' : ''}>Editor</option>
                                        <option value="viewer" ${p.role === 'viewer' ? 'selected' : ''}>Visor</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4">
                                    <input type="text" data-userid="${p.id}" class="groups-input w-full text-sm p-2 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" value="${(p.editableGroups || []).join(',')}" ${p.role !== 'editor' || currentUserRole !== 'owner' ? 'disabled' : ''} placeholder="grupo1,grupo2,...">
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>`;
        }
        async function updateUserPermissions(targetUserId, role, groups, tag) {
            const userPermRef = doc(permissionsCollectionRef, targetUserId);
            const editableGroups = groups.split(',').map(g => g.trim()).filter(Boolean);
            try {
                await updateDoc(userPermRef, { role, editableGroups, tag: tag || '' });
                showToast(`Permisos actualizados.`, 'success');
            } catch (error) {
                showToast('Error al actualizar permisos.', 'error');
                console.error(error);
            }
        }
        async function handleSaveSettings() {
            const red = parseInt(document.getElementById('setting-red-threshold').value, 10);
            const yellow = parseInt(document.getElementById('setting-yellow-threshold').value, 10);
            const notification = parseInt(document.getElementById('setting-notification-threshold').value, 10);
            const immobilization = parseInt(document.getElementById('setting-immobilization-months').value, 10);
            const iwebSapUrl = document.getElementById('setting-iweb-sap-url').value.trim();
            const depositosExternosUrl = document.getElementById('setting-depositos-externos-url').value.trim();
            
            const monthCheckboxes = document.querySelectorAll('#consumption-months-checkboxes input[type="checkbox"]');
            const selectedMonths = Array.from(monthCheckboxes).map(cb => cb.checked);

            if (isNaN(red) || isNaN(yellow) || isNaN(notification) || isNaN(immobilization)) {
                showToast('Todos los valores deben ser números.', 'error');
                return;
            }
            if (red >= yellow) {
                showToast('El umbral rojo debe ser menor que el amarillo.', 'error');
                return;
            }
            if (red <= 0 || yellow <= 0 || notification <= 0 || immobilization <= 0) {
                showToast('Los valores deben ser mayores a cero.', 'error');
                return;
            }
            if (!selectedMonths.some(m => m)) {
                showToast('Debes seleccionar al menos un mes.', 'error');
                return;
            }

            const newSettings = {
                coverageThresholds: { red, yellow },
                notificationThreshold: notification,
                consumptionMonths: selectedMonths,
                immobilizationMonths: immobilization,
                iwebSapUrl: iwebSapUrl,
                depositosExternosUrl: depositosExternosUrl
            };

            try {
                await setDoc(appConfigDocRef, { settings: newSettings }, { merge: true });
                showToast('Configuración guardada correctamente.', 'success');
                closeAdminModal();
            } catch (error) {
                console.error("Error al guardar configuración:", error);
                showToast('Error al guardar la configuración.', 'error');
            }
        }

        // --- LÓGICA DE RENDERIZADO PRINCIPAL ---
        function renderApp() {
            if (!isAuthReady) return;
            
            switch (currentView) {
                case 'dashboard': renderDashboard(); break;
                case 'indice': renderIndiceView(); break;
                case 'consumos': renderConsumosView(); break;
                case 'reportes': renderReportesView(); break;
                case 'revision': 
                    renderHistoryView(); 
                    if(currentUserRole === 'owner') renderReviewTable(); 
                    break;
            }
        }
        function updateProcessedItemsCache() {
            processedItemsCache = items.map(item => {
                const dailyConsumption = item.monthlyConsumption > 0 ? item.monthlyConsumption / 30 : 0;
                const coverageDays = dailyConsumption > 0 ? Math.floor(item.stock / dailyConsumption) : Infinity;
                const leadTimeDays = item.leadTimeDays || 0;
                const safetyStockDays = item.safetyStockDays || 0;
                const reorderPointDays = leadTimeDays + safetyStockDays;
                return { ...item, dailyConsumption, coverageDays, leadTimeDays, safetyStockDays, reorderPointDays };
            });
        }
        function getProcessedItems() {
            return [...processedItemsCache];
        }
        function updateExternalLinks() {
            const iwebLink = document.getElementById('iweb-sap-link-dropdown');
            if (iwebLink) {
                if (appSettings.iwebSapUrl && appSettings.iwebSapUrl.trim() !== '') {
                    iwebLink.href = appSettings.iwebSapUrl;
                    iwebLink.classList.remove('hidden');
                } else {
                    iwebLink.classList.add('hidden');
                }
            }

            const depositosLink = document.getElementById('depositos-externos-link-dropdown');
            if (depositosLink) {
                if (appSettings.depositosExternosUrl && appSettings.depositosExternosUrl.trim() !== '') {
                    depositosLink.href = appSettings.depositosExternosUrl;
                    depositosLink.classList.remove('hidden');
                } else {
                    depositosLink.classList.add('hidden');
                }
            }
        }
        function renderDashboard() {
            const kpiContainer = document.getElementById('kpi-container');
            if (!kpiContainer) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const weekId = getWeekId(today);
            const weekNumber = parseInt(weekId.split('-')[1], 10);

            const processedItems = getProcessedItems(true);
            const totalProducts = processedItems.length;
            const favoriteCount = processedItems.filter(item => item.isFavorite).length;
            const uniqueGroups = [...new Set(processedItems.map(item => item.group))].length;
            
            const recordConsumptionCount = processedItems.filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            }).length;

            const solpedsVencidasCount = solpeds.filter(s => {
                const releaseDate = parseDateString(s.fechaLiberacion);
                return releaseDate && releaseDate < today;
            }).length;

            const ocsVencidasCount = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate < today;
            }).length;

            const kpis = [
                { type: 'total', title: 'Productos Totales', value: formatNumber(totalProducts), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>', color: 'indigo' },
                { type: 'favorites', title: 'Favoritos', value: favoriteCount, subtitle: 'Insumos destacados', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>', color: 'yellow' },
                { type: 'groups', title: 'Total de Grupos', value: uniqueGroups, subtitle: 'Categorías activas', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>', color: 'green' },
                { type: 'consumption-peak', title: 'Consumo Récord', value: recordConsumptionCount, subtitle: 'Superando pico histórico', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>', color: 'red' },
                { type: 'solpeds-vencidas', title: 'Solpeds Vencidas', value: solpedsVencidasCount, subtitle: 'Liberación pasada', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M12 22a2 2 0 0 0 2-2V7H10v13a2 2 0 0 0 2 2z"/><path d="M16 10h4l-4-4v4z"/><path d="M16 10h4l-4-4v4z"/></svg>', color: 'red' },
                { type: 'ocs-vencidas', title: 'O/C Vencidas', value: ocsVencidasCount, subtitle: 'Entrega demorada', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>', color: 'red' },
            ];
            
            kpiContainer.innerHTML = kpis.map(kpi => {
                let iconClass = 'bg-indigo-100 text-indigo-600';
                let cardClass = '';

                if ((kpi.type === 'consumption-peak' || kpi.type === 'solpeds-vencidas' || kpi.type === 'ocs-vencidas') && kpi.value > 0) {
                    iconClass = 'bg-red-100 text-red-600';
                    cardClass = 'border-2 border-red-400';
                }

                return `
                <div class="kpi-card relative pt-6 text-center ${cardClass}" data-kpi="${kpi.type}">
                    <div class="absolute -top-2 -left-2 p-2 rounded-lg shadow-md ${iconClass}">${kpi.icon}</div>
                    <p class="text-2xl font-bold text-slate-900">${kpi.value}</p>
                    <p class="text-xs font-medium text-slate-500 mt-1 uppercase truncate">${kpi.title}</p>
                </div>`;
            }).join('');
            
            const notesContainer = document.getElementById('dashboard-notes-container');
            if (notesContainer) {
                notesContainer.classList.remove('hidden');

                const addNoteFormContainer = document.getElementById('add-note-form-container');
                if (addNoteFormContainer) {
                    addNoteFormContainer.style.display = currentUserRole === 'owner' ? 'flex' : 'none';
                }

                renderInventoryNotesList();
            }
            
            if (isInitialLoad && items.length > 0) {
                handleKpiClick('consumption-peak');
                isInitialLoad = false;
            }
        }

        function renderInventoryNotesList() {
            const listContainer = document.getElementById('inventory-notes-list');
            if (!listContainer) return;

            const notes = appSettings.inventoryNotes || [];

            if (notes.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-400 pt-10">No hay notas guardadas.</p>';
                return;
            }

            // Sort notes alphabetically by title
            notes.sort((a, b) => a.title.localeCompare(b.title));

            const isOwner = currentUserRole === 'owner';

            listContainer.innerHTML = notes.map(note => `
                <div class="border rounded-lg overflow-hidden bg-white shadow-sm" data-note-id="${note.id}">
                    <div class="p-3 flex items-center justify-between hover:bg-slate-50 cursor-pointer note-header">
                        <div class="flex-1 min-w-0 pr-2">
                            ${isOwner 
                                ? `<input type="text" value="${note.title}" class="note-title-input font-semibold text-indigo-700 truncate bg-transparent w-full focus:outline-none focus:ring-1 focus:ring-indigo-300 focus:bg-white rounded px-1 py-0.5" placeholder="Título...">`
                                : `<p class="font-semibold text-indigo-700 truncate px-1 py-0.5">${note.title}</p>`
                            }
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${isOwner ? `
                            <button class="delete-note-btn p-1 text-red-400 hover:text-red-600 rounded-full hover:bg-red-100">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                            ` : ''}
                            <svg class="w-5 h-5 text-slate-400 transition-transform duration-200 note-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                    </div>
                    <div class="hidden note-content">
                        <div class="p-2 border-t">
                            <textarea class="note-content-textarea w-full h-24 p-2 border border-slate-200 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500 resize-y" placeholder="Escribe los detalles aquí..." ${!isOwner ? 'disabled' : ''}>${note.content || ''}</textarea>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function renderReviewTable() {
            const reviewContainer = document.getElementById('review-container');
            const groupsReviewContainer = document.getElementById('groups-review-list');
            if (!groupsReviewContainer || !reviewContainer) return;

            reviewContainer.classList.remove('hidden');
            groupsReviewContainer.innerHTML = '<div class="p-6 text-center text-slate-500"><div class="loader inline-block"></div> Cargando...</div>';

            const today = new Date();
            const weekId = getWeekId(today);
            const weekNumber = parseInt(weekId.split('-')[1], 10);
            
            const weekNumberDisplay = document.getElementById('week-number-display');
            if (weekNumberDisplay) {
                weekNumberDisplay.textContent = `SEMANA ${weekNumber}`;
            }

            const prevWeekDate = new Date();
            prevWeekDate.setDate(today.getDate() - 7);
            const prevWeekId = getWeekId(prevWeekDate);
            const prevWeekReviewDocRef = doc(reviewHistoryCollectionRef, prevWeekId);
            let reviewedGroupsLastWeek = new Set();

            try {
                const docSnap = await getDoc(prevWeekReviewDocRef);
                if (docSnap.exists()) {
                    reviewedGroupsLastWeek = new Set(docSnap.data().reviewedGroups || []);
                }
            } catch (e) {
                console.error("Could not fetch last week's review status", e);
            }
            
            const groups = items.reduce((acc, item) => {
                const group = item.group || 'General';
                acc[group] = (acc[group] || 0) + 1;
                return acc;
            }, {});
            const sortedGroups = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));

            if (sortedGroups.length > 0) {
                document.getElementById('progress-bar-container').classList.remove('hidden');
                groupsReviewContainer.innerHTML = `<table class="w-full text-sm text-left text-slate-500 review-table">
                    <thead class="text-xs text-slate-700 uppercase invisible">
                        <tr>
                            <th class="px-4 py-3 font-bold">Grupo</th>
                            <th class="px-4 py-3 font-bold w-16 text-center">OK</th>
                        </tr>
                    </thead>
                    <tbody>${sortedGroups.map(([groupName, count]) => {
                    const wasReviewedLastWeek = reviewedGroupsLastWeek.has(groupName);
                    const rowClass = !wasReviewedLastWeek ? 'bg-red-50' : '';
                    return `
                    <tr class="group-info-row ${rowClass}" data-group-name="${groupName}">
                        <td class="px-4 py-1 group-item-name cursor-pointer align-middle" data-group-name="${groupName}">
                            <p class="text-base font-medium text-indigo-600 truncate">${groupName}</p>
                            <p class="text-xs text-slate-500">${count} insumos</p>
                        </td>
                        <td class="w-16 text-center align-middle px-4">
                            <input type="checkbox" data-group-name="${groupName}" class="review-checkbox h-5 w-5 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        </td>
                    </tr>
                    <tr class="group-notes-row ${rowClass} border-b" data-group-name="${groupName}">
                        <td colspan="2" class="py-1 px-2 h-full"></td>
                    </tr>`;
                }).join('')}</tbody></table>`;
                loadCurrentWeekReview();
            } else {
                groupsReviewContainer.innerHTML = `<div class="p-6 text-center text-slate-500">No hay grupos para mostrar.</div>`;
            }
            syncReviewRowHeights();
        }

        function handleKpiClick(kpiType) {
            const previouslyActiveKpi = activeKpi;
            closeKpiDetailView(); // Close any open detail view first

            if (previouslyActiveKpi === kpiType) {
                // If the same KPI was clicked again, it's now closed, so we're done.
                return;
            }
            
            activeKpi = kpiType;
            const detailContainer = document.getElementById('kpi-detail-container');
            if (!detailContainer) return;

            const kpiCard = document.querySelector(`.kpi-card[data-kpi="${kpiType}"]`);
            const kpiValue = kpiCard ? kpiCard.querySelector('p.text-2xl').textContent : '';

            if(kpiCard) {
                kpiCard.classList.add('border-2', 'border-indigo-500', 'shadow-xl');
            }

            let contentHTML = '';
            let title = '';

            switch (kpiType) {
                case 'favorites':
                    title = 'Insumos Favoritos';
                    contentHTML = generateFavoriteItemsTableHTML();
                    break;
                case 'consumption-peak':
                    title = 'Insumos con Consumo Récord';
                    contentHTML = generateRecordConsumptionHTML();
                    break;
                case 'groups':
                    title = 'Estadísticas por Grupo';
                    contentHTML = generateGroupStatsHTML();
                    break;
                case 'solpeds-vencidas':
                     title = 'Solpeds Vencidas por Grupo de Compras';
                     contentHTML = generateDelayedSolpedsHTML();
                    break;
                case 'ocs-vencidas':
                    title = 'O/C Vencidas por Grupo de Compras';
                    contentHTML = generateDelayedOCsHTML();
                    break;
                case 'total':
                    closeKpiDetailView();
                    switchMainView('indice'); // Navigate for the 'total' KPI
                    return;
                default:
                    closeKpiDetailView();
                    return;
            }

            if(contentHTML) {
                detailContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow">
                         <div class="p-4 border-b bg-[#6366f1] rounded-t-lg flex justify-between items-center flex-shrink-0">
                            <div class="flex items-center gap-4">
                                <span class="text-3xl font-bold text-white">${kpiValue}</span>
                                <h3 class="text-lg font-semibold text-white uppercase tracking-wider">${title}</h3>
                            </div>
                            <div class="flex items-center gap-2">
                                ${kpiType === 'consumption-peak' && kpiValue > 0 ? `
                                <button id="export-record-consumption-btn" title="Exportar a Excel" class="btn-main-style !h-8 !w-8 !p-0 !bg-white/90 !text-indigo-700 hover:!bg-white flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                </button>
                                ` : ''}
                                <button id="close-kpi-detail-btn" class="text-white/70 hover:text-white">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                        </div>
                        <div class="p-4 overflow-y-auto" style="max-height: 580px;">
                            ${contentHTML}
                        </div>
                    </div>
                `;
                detailContainer.classList.remove('hidden');
                // Se eliminó la línea scrollIntoView que causaba el salto de pantalla.
            }
        }
        
        function closeKpiDetailView() {
            const detailContainer = document.getElementById('kpi-detail-container');
            if (detailContainer) {
                detailContainer.innerHTML = '';
                detailContainer.classList.add('hidden');
            }
            document.querySelectorAll('.kpi-card.border-2').forEach(card => {
                card.classList.remove('border-2', 'border-indigo-500', 'shadow-xl');
            });
            activeKpi = null;
        }

        function generateFavoriteItemsTableHTML() {
            const favoriteItems = getProcessedItems().filter(item => item.isFavorite);
            if (favoriteItems.length === 0) {
                return '<p class="text-center text-slate-500 py-4">No has marcado ningún insumo como favorito.</p>';
            }

            const groupedItems = favoriteItems.reduce((acc, item) => {
                const group = item.group || 'Sin Grupo';
                if (!acc[group]) {
                    acc[group] = [];
                }
                acc[group].push(item);
                return acc;
            }, {});

            const sortedGroups = Object.entries(groupedItems)
                .map(([groupName, items]) => ({ groupName, items }))
                .sort((a, b) => a.groupName.localeCompare(b.groupName));

            let html = '<div class="space-y-2">';
            sortedGroups.forEach(group => {
                html += `
                <div class="border rounded-lg overflow-hidden bg-white shadow-sm">
                    <div class="p-3 flex items-center justify-between hover:bg-slate-50 cursor-pointer favorite-group-header" data-group-name="${group.groupName}">
                        <div>
                            <p class="font-semibold text-indigo-700">${group.groupName}</p>
                            <p class="text-sm text-slate-500">${group.items.length} insumos favoritos</p>
                        </div>
                        <svg class="w-5 h-5 text-slate-400 transition-transform duration-200 accordion-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                    <div class="hidden favorite-item-list" data-group-list="${group.groupName}">
                        <ul class="divide-y divide-slate-200 border-t">
                        ${group.items.sort((a, b) => a.coverageDays - b.coverageDays).map(item => {
                            const { red, yellow } = appSettings.coverageThresholds;
                            let coverageClass = '';
                            if (item.coverageDays !== Infinity) {
                                if (item.coverageDays < red) coverageClass = 'text-red-600';
                                else if (item.coverageDays <= yellow) coverageClass = 'text-yellow-600';
                                else coverageClass = 'text-green-600';
                            } else {
                                coverageClass = 'text-green-600';
                            }

                            return `
                            <li class="p-3 pl-6 flex items-center justify-between hover:bg-slate-50 cursor-pointer kpi-detail-item-row" data-item-id="${item.id}">
                                <div>
                                    <p class="font-medium text-slate-800">${item.name.toUpperCase()}</p>
                                    <p class="text-xs text-slate-500">${item.code}</p>
                                </div>
                                <div class="text-right ml-4">
                                    <p class="font-bold text-lg ${coverageClass}">${item.coverageDays === Infinity ? '∞' : Math.round(item.coverageDays)}</p>
                                    <p class="text-xs text-slate-500 -mt-1">días</p>
                                </div>
                            </li>`;
                        }).join('')}
                        </ul>
                    </div>
                </div>`;
            });
            html += '</div>';
            return html;
        }

        function generateRecordConsumptionHTML() {
            const recordConsumptionItems = getProcessedItems(true).filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            });

            if (recordConsumptionItems.length === 0) {
                return '<p class="text-center text-slate-500 py-4">No hay insumos con consumo récord este mes.</p>';
            }

            const groupedItems = recordConsumptionItems.reduce((acc, item) => {
                const group = item.group || 'Sin Grupo';
                if (!acc[group]) {
                    acc[group] = { items: [], favoriteCount: 0 };
                }
                acc[group].items.push(item);
                if (item.isFavorite) {
                    acc[group].favoriteCount++;
                }
                return acc;
            }, {});

            const sortedGroups = Object.entries(groupedItems)
                .map(([groupName, data]) => ({ groupName, ...data }))
                .sort((a, b) => a.groupName.localeCompare(b.groupName));

            let html = '<div class="space-y-2">';
            sortedGroups.forEach(group => {
                const highlightClass = group.favoriteCount > 0 ? 'border-2 border-red-400 ring-1 ring-red-200' : 'border';
                html += `
                <div class="${highlightClass} rounded-lg overflow-hidden bg-white shadow-sm">
                    <div class="p-3 flex items-center justify-between hover:bg-slate-50 cursor-pointer record-consumption-group-header" data-group-name="${group.groupName}">
                        <div>
                            <p class="font-semibold text-indigo-700">${group.groupName}</p>
                            <p class="text-sm text-slate-500">${group.items.length} insumos (${group.favoriteCount} favoritos)</p>
                        </div>
                        <svg class="w-5 h-5 text-slate-400 transition-transform duration-200 record-consumption-chevron" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                    <div class="hidden record-consumption-item-list" data-group-list="${group.groupName}">
                        <ul class="divide-y divide-slate-200 border-t">
                        ${group.items.sort((a, b) => a.name.localeCompare(b.name)).map(item => {
                            const currentConsumption = item.consumos[item.consumos.length - 1];
                            return `
                            <li class="p-3 pl-6 flex items-center justify-between hover:bg-slate-50 cursor-pointer kpi-detail-item-row" data-item-id="${item.id}">
                                <div>
                                    <p class="font-medium text-slate-800">${item.name.toUpperCase()}</p>
                                    <p class="text-xs text-slate-500">${item.isFavorite ? '★ Favorito' : ''}</p>
                                </div>
                                <div class="text-right ml-4">
                                    <p class="font-bold text-green-600">${formatNumber(currentConsumption)}</p>
                                    <p class="text-xs text-slate-500">Cons. Actual</p>
                                </div>
                            </li>`;
                        }).join('')}
                        </ul>
                    </div>
                </div>`;
            });
            html += '</div>';
            return html;
        }
        
        function generateGroupStatsHTML() {
            const stats = calculateGroupStats();
            if (!stats || stats.length === 0) {
                return '<p class="text-center text-slate-500 p-8">No hay grupos para mostrar.</p>';
            }

            let listHTML = '';
            stats.forEach(group => {
                listHTML += `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-group-row" data-group-name="${group.name}">
                    <div>
                        <p class="font-semibold text-lg text-slate-800">${group.name}</p>
                        <p class="text-sm text-slate-500">${group.totalItems} insumos en total</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-2xl text-yellow-600">${group.favoriteItems}</p>
                        <p class="text-sm text-slate-500">Favoritos (${group.percentage}%)</p>
                    </div>
                </div>`;
            });
            return listHTML;
        }

        function generateDelayedSolpedsHTML() {
            const stats = calculateDelayedSolpedsStats();
            if (!stats || stats.length === 0) {
                return '<p class="text-center text-slate-500 p-8">No hay Solpeds vencidas para mostrar.</p>';
            }

            let listHTML = '';
            stats.forEach(group => {
                listHTML += `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-solped-row" data-group-compras="${group.name}">
                    <div>
                        <p class="font-semibold text-slate-800">${group.name.toUpperCase()}</p>
                        <p class="text-sm text-slate-500">${group.percentage}% del total vencido</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl text-red-600">${group.count}</p>
                        <p class="text-xs text-slate-500 -mt-1">Solpeds</p>
                    </div>
                </div>`;
            });
            return listHTML;
        }
        
        function generateDelayedOCsHTML() {
            const stats = calculateDelayedOCsStats();
            if (!stats || stats.length === 0) {
                return '<p class="text-center text-slate-500 p-8">No hay O/C vencidas para mostrar.</p>';
            }

            let listHTML = '';
            stats.forEach(group => {
                listHTML += `
                <div class="p-4 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer kpi-detail-oc-row" data-group-compras="${group.name}">
                    <div>
                        <p class="font-semibold text-slate-800">${group.name.toUpperCase()}</p>
                        <p class="text-sm text-slate-500">${group.percentage}% del total vencido</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl text-red-600">${group.count}</p>
                        <p class="text-xs text-slate-500 -mt-1">O/C</p>
                    </div>
                </div>`;
            });
            return listHTML;
        }

        function openRecordConsumptionModal() {
            const recordConsumptionItems = getProcessedItems(true).filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            });

            if (recordConsumptionItems.length === 0) {
                showToast('No hay insumos con consumo récord este mes.', 'info');
                return;
            }
            
            const modal = document.getElementById('record-consumption-modal');
            const listContainer = document.getElementById('record-consumption-item-list');

            listContainer.innerHTML = recordConsumptionItems.map(item => {
                const currentConsumption = item.consumos[item.consumos.length - 1];
                return `
                <div class="p-3 flex items-center justify-between hover:bg-slate-50 border-b cursor-pointer record-consumption-item" data-item-id="${item.id}">
                    <div>
                        <p class="font-semibold text-slate-800">${item.name}</p>
                        <p class="text-sm text-slate-500">Grupo: ${item.group}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">${formatNumber(currentConsumption)}</p>
                        <p class="text-xs text-slate-500">Cons. Actual</p>
                    </div>
                </div>
            `}).join('');

            modal.classList.remove('hidden');
        }

        function openGroupStatsModal() {
            const stats = calculateGroupStats();
            renderGroupStatsModal(stats);
            document.getElementById('group-stats-modal').classList.remove('hidden');
        }

        function openDelayedSolpedsModal() {
            const stats = calculateDelayedSolpedsStats();
            renderDelayedSolpedsModal(stats);
            document.getElementById('delayed-solpeds-modal').classList.remove('hidden');
        }

        function openDelayedOCsModal() {
            const stats = calculateDelayedOCsStats();
            renderDelayedOCsModal(stats);
            document.getElementById('delayed-ocs-modal').classList.remove('hidden');
        }

        function calculateDelayedSolpedsStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const delayed = solpeds.filter(s => {
                const releaseDate = parseDateString(s.fechaLiberacion);
                return releaseDate && releaseDate < today;
            });

            if (delayed.length === 0) {
                return [];
            }

            const groupData = {};
            delayed.forEach(s => {
                const groupName = s.grupoDeCompras || 'Sin Grupo';
                groupData[groupName] = (groupData[groupName] || 0) + 1;
            });
            
            const totalDelayed = delayed.length;

            return Object.entries(groupData).map(([name, count]) => {
                const percentage = totalDelayed > 0 ? (count / totalDelayed) * 100 : 0;
                return { name, count, percentage: percentage.toFixed(1) };
            }).sort((a, b) => b.count - a.count);
        }

        function renderDelayedSolpedsModal(stats) {
            const listContainer = document.getElementById('delayed-solpeds-list');
            if (!stats || stats.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-500 p-8">No hay Solpeds vencidas para mostrar.</p>';
                return;
            }

            let tableHTML = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Grupo de Compras</th>
                            <th class="px-4 py-2 text-right">Cantidad Vencidas</th>
                            <th class="px-4 py-2 text-right">% del Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;

            stats.forEach(group => {
                tableHTML += `
                    <tr class="hover:bg-slate-50 cursor-pointer" data-group-compras="${group.name}">
                        <td class="px-4 py-2 font-medium text-slate-900">${group.name}</td>
                        <td class="px-4 py-2 text-right font-bold text-red-600">${group.count}</td>
                        <td class="px-4 py-2 text-right">${group.percentage}%</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;
        }

        function calculateDelayedOCsStats() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const delayed = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate < today;
            });

            if (delayed.length === 0) {
                return [];
            }

            const groupData = {};
            delayed.forEach(oc => {
                const groupName = extractGroupCode(oc.grupoDeCompras || 'Sin Grupo');
                groupData[groupName] = (groupData[groupName] || 0) + 1;
            });
            
            const totalDelayed = delayed.length;

            return Object.entries(groupData).map(([name, count]) => {
                const percentage = totalDelayed > 0 ? (count / totalDelayed) * 100 : 0;
                return { name, count, percentage: percentage.toFixed(1) };
            }).sort((a, b) => b.count - a.count);
        }

        function renderDelayedOCsModal(stats) {
            const listContainer = document.getElementById('delayed-ocs-list');
            if (!stats || stats.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-500 p-8">No hay O/C vencidas para mostrar.</p>';
                return;
            }

            let tableHTML = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Grupo de Compras</th>
                            <th class="px-4 py-2 text-right">Cantidad Vencidas</th>
                            <th class="px-4 py-2 text-right">% del Total</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;

            stats.forEach(group => {
                tableHTML += `
                    <tr class="hover:bg-slate-50 cursor-pointer" data-group-compras="${group.name}">
                        <td class="px-4 py-2 font-medium text-slate-900">${group.name}</td>
                        <td class="px-4 py-2 text-right font-bold text-red-600">${group.count}</td>
                        <td class="px-4 py-2 text-right">${group.percentage}%</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;
        }

        function calculateGroupStats() {
            const groupData = {};

            items.forEach(item => {
                const groupName = item.group || 'General';
                if (!groupData[groupName]) {
                    groupData[groupName] = { totalItems: 0, favoriteItems: 0 };
                }
                groupData[groupName].totalItems++;
                if (item.isFavorite) {
                    groupData[groupName].favoriteItems++;
                }
            });

            return Object.entries(groupData).map(([name, data]) => {
                const percentage = data.totalItems > 0 ? (data.favoriteItems / data.totalItems) * 100 : 0;
                return { name, ...data, percentage: percentage.toFixed(1) };
            }).sort((a, b) => a.name.localeCompare(b.name));
        }

        function renderGroupStatsModal(stats) {
            const listContainer = document.getElementById('group-stats-list');
            if (!stats || stats.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-slate-500 p-8">No hay grupos para mostrar.</p>';
                return;
            }

            let tableHTML = `
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-2">Grupo</th>
                            <th class="px-4 py-2 text-right">Total Insumos</th>
                            <th class="px-4 py-2 text-right">Favoritos</th>
                            <th class="px-4 py-2 text-right">% Favoritos</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;

            stats.forEach(group => {
                tableHTML += `
                    <tr class="hover:bg-slate-50 cursor-pointer" data-group-name="${group.name}">
                        <td class="px-4 py-2 font-medium text-slate-900">${group.name}</td>
                        <td class="px-4 py-2 text-right">${group.totalItems}</td>
                        <td class="px-4 py-2 text-right text-yellow-600 font-semibold">${group.favoriteItems}</td>
                        <td class="px-4 py-2 text-right">${group.percentage}%</td>
                    </tr>`;
            });

            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;
        }

        // --- LÓGICA DE REVISIÓN SEMANAL (FIRESTORE) ---
        async function handleSaveReview() {
            if (!userId || !reviewHistoryCollectionRef) return;
            const reviewedGroups = Array.from(document.querySelectorAll('.review-checkbox:checked')).map(cb => cb.dataset.groupName);
            
            const weekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, weekId);
            try {
                await setDoc(reviewDocRef, { 
                    reviewedGroups, 
                    lastUpdatedBy: userId, 
                    weekId, 
                    updatedAt: serverTimestamp()
                }, { merge: true });
                showToast('Revisión guardada en la base de datos.', 'success');

                // Clean up reviews older than 8 weeks
                const today = new Date();
                const cutoffDate = new Date(today);
                cutoffDate.setDate(today.getDate() - (8 * 7)); // 8 weeks ago
                const cutoffWeekId = getWeekId(cutoffDate);

                const oldReviewsQuery = query(reviewHistoryCollectionRef, where("weekId", "<", cutoffWeekId));
                const oldReviewsSnapshot = await getDocs(oldReviewsQuery);
                
                if (!oldReviewsSnapshot.empty) {
                    const batch = writeBatch(db);
                    oldReviewsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                }

            } catch (error) {
                console.error("Error al guardar la revisión o limpiar datos antiguos: ", error);
                showToast('Error al guardar o limpiar datos.', 'error');
            }
        }

        function handleReviewCheckboxChange(event) {
            if (!event.target.matches('.review-checkbox')) return;
            updateReviewProgressBar();
        }

        function updateReviewProgressBar() {
            const checkboxes = document.querySelectorAll('.review-checkbox');
            const total = checkboxes.length;
            if (total === 0) return;
            
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percentage = Math.round((checkedCount / total) * 100);
            
            const progressBarText = document.getElementById('progress-bar-text');
            
            progressBarText.textContent = `${percentage}%`;
        }

        async function loadCurrentWeekReview() {
            if (!reviewHistoryCollectionRef) return;
            const currentWeekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, currentWeekId);
            
            try {
                const docSnap = await getDoc(reviewDocRef);
                if (docSnap.exists()) {
                    const { reviewedGroups } = docSnap.data();
                    if (reviewedGroups && Array.isArray(reviewedGroups)) {
                        reviewedGroups.forEach(groupName => {
                            const checkbox = document.querySelector(`.review-checkbox[data-group-name="${groupName}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            } catch (error) {
                console.error("Error al cargar la revisión semanal:", error);
            } finally {
                updateReviewProgressBar();
            }
        }

        let isExportingHistory = false;
        async function handleExportHistory() {
            if (isExportingHistory) return; // Prevent re-entrant calls
            isExportingHistory = true;

            if (!reviewHistoryCollectionRef) {
                showToast('No se pudo acceder al historial de revisiones.', 'error');
                isExportingHistory = false;
                return;
            }

            try {
                const querySnapshot = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/reviewHistory`)));
                const history = querySnapshot.docs.map(doc => doc.data());
                
                if (history.length === 0) {
                    showToast('No hay historial de revisiones para exportar.', 'info');
                    return; // Return directly if no history
                }

                const allGroups = [...new Set(items.map(item => item.group || 'General'))].sort();
                
                const historyMap = new Map();
                history.forEach(record => {
                    historyMap.set(record.weekId, new Set(record.reviewedGroups));
                });

                const allWeeks = [...historyMap.keys()].sort().reverse();
                const visibleWeeks = allWeeks.slice(0, 8); // Limit export to the last 8 weeks
                const dataToExport = [];
                
                allGroups.forEach(groupName => {
                    const row = {
                        'Notas': groupNotes.get(groupName) || '',
                        'Grupo': groupName
                    };
                    visibleWeeks.forEach(weekId => {
                         row[weekId] = historyMap.get(weekId)?.has(groupName) ? 'Sí' : 'No';
                    });
                    dataToExport.push(row);
                });
                
                if (dataToExport.length > 0) {
                    const filename = `${getCurrentDateString()}_Historial_Revision.xlsx`;
                    exportToExcel(dataToExport, filename);
                } else {
                    showToast('No se encontraron datos para exportar.', 'info');
                }

            } catch (error) {
                console.error("Error al exportar historial de revisiones:", error);
                showToast('Error al exportar el historial.', 'error');
            } finally {
                setTimeout(() => { isExportingHistory = false; }, 1000); // Reset flag after 1 sec
            }
        }


        // --- LÓGICA DE LA PESTAÑA INSUMOS ---
        function handleClearIndiceFilters() {
            indiceSearchTerm = '';
            indiceSelectedGroup = 'all';
            indiceFavoriteFilter = 'all';
            indiceCoverageFilter = 'all';
            renderIndiceView();
        }

        function handleClearSolpedsFilters() {
            showOnlyDelayedSolpeds = false;
            solpedsSelectedGroup = 'all';
            solpedsSelectedYear = 'all';
            solpedsSelectedMonths = [];
            document.getElementById('solpeds-search-input').value = '';
            renderSolpedsView();
        }

        function handleClearOCsFilters() {
            showOnlyDelayedOCs = false;
            ocsSelectedGroup = 'all';
            ocsSelectedStatus = 'all';
            ocsSelectedYear = 'all';
            ocsSelectedMonths = [];
            document.getElementById('ocs-search-input').value = '';
            renderOCsView();
        }

        function renderIndiceView() {
            const container = document.getElementById('indice-table-container');
            const searchInput = document.getElementById('indice-search-input');
            const groupFilterContainer = document.getElementById('indice-group-filter-container');
            const clearFiltersBtn = document.getElementById('indice-clear-filters-btn');
            const { red, yellow } = appSettings.coverageThresholds;
            
            const isAnyFilterActive = indiceCoverageFilter !== 'all' || indiceSelectedGroup !== 'all' || indiceFavoriteFilter !== 'all' || indiceSearchTerm !== '';
            if (clearFiltersBtn) {
                clearFiltersBtn.classList.toggle('hidden', !isAnyFilterActive);
                if (isAnyFilterActive) {
                    clearFiltersBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                } else {
                    clearFiltersBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                }
            }
            
            searchInput.value = indiceSearchTerm;
            
            const filterButtonsContainer = document.getElementById('indice-coverage-filter-buttons');
            filterButtonsContainer.querySelector('[data-filter="red"]').textContent = `Crítico`;
            filterButtonsContainer.querySelector('[data-filter="yellow"]').textContent = `Precaución`;
            filterButtonsContainer.querySelector('[data-filter="green"]').textContent = `OK`;
            
            document.querySelectorAll('#indice-coverage-filter-buttons button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === indiceCoverageFilter);
            });
            
            const uniqueGroups = [...new Set(items.map(item => item.group))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="indice-group-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS LOS GRUPOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === indiceSelectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
                document.getElementById('indice-group-filter').value = indiceSelectedGroup;
            } else {
                groupFilterContainer.innerHTML = '';
            }

            if (items.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No hay datos de insumos.</p>';
                return;
            }

            let filteredItems = getProcessedItems();

            if (indiceCoverageFilter !== 'all') {
                filteredItems = filteredItems.filter(item => {
                    const days = item.coverageDays;
                    if (indiceCoverageFilter === 'red') return days < red;
                    if (indiceCoverageFilter === 'yellow') return days >= red && days <= yellow;
                    if (indiceCoverageFilter === 'green') return days > yellow || days === Infinity;
                    return false;
                });
            }
            if (indiceSelectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === indiceSelectedGroup);
            }
            if (indiceFavoriteFilter === 'favorites') {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            } else if (indiceFavoriteFilter === 'non-favorites') {
                filteredItems = filteredItems.filter(item => !item.isFavorite);
            }
            if (indiceSearchTerm) {
                const searchWords = indiceSearchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredItems = filteredItems.filter(item => {
                    const itemText = `${item.name} ${item.description_notes || ''}`.toLowerCase();
                    return searchWords.every(word => itemText.includes(word));
                });
            }

            const counterEl = document.getElementById('indice-counter');
            if (counterEl) {
                counterEl.textContent = `(${filteredItems.length} de ${items.length})`;
            }

            filteredItems.sort((a, b) => {
                const key = indiceSortConfig.key;
                const dir = indiceSortConfig.direction === 'asc' ? 1 : -1;

                if (key === 'name') {
                    const nameA = a.name.replace(new RegExp(`^${a.code}\\s*`), '').toLowerCase();
                    const nameB = b.name.replace(new RegExp(`^${b.code}\\s*`), '').toLowerCase();
                    return nameA.localeCompare(nameB) * dir;
                }
                
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                
                if (key === 'stock' || key === 'coverageDays' || key === 'monthlyConsumption') {
                    valA = valA === Infinity ? Number.MAX_SAFE_INTEGER : parseFloat(valA) || 0;
                    valB = valB === Infinity ? Number.MAX_SAFE_INTEGER : parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });

            if (filteredItems.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No se encontraron resultados.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'isFavorite', label: '★', noSort: true, width: 'w-[4%]' },
                { key: 'group', label: 'GRUPO', width: 'w-[8%]' },
                { key: 'code', label: 'CÓDIGO', width: 'w-[8%]' },
                { key: 'name', label: 'MATERIAL', width: 'w-[27%]' },
                { key: 'stock', label: 'STOCK ACTUAL', class: 'justify-end border-l border-r border-slate-300', width: 'w-[10%]' },
                { key: 'monthlyConsumption', label: 'CONS. MENSUAL', class: 'justify-end', width: 'w-[10%]' },
                { key: 'coverageDays', label: 'COBERTURA (DÍAS)', class: 'justify-end', width: 'w-[10%]' },
                { key: 'description_notes', label: 'NOTAS', noSort: true, width: 'w-[20%]' }
            ];

            let tableHTML = `<table class="w-full text-sm text-left text-slate-500 table-fixed"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = !h.noSort && indiceSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                
                let thBaseClass = `px-4 py-1 text-center ${headerClasses}`;
                if (h.class && (h.class.includes('border-l') || h.class.includes('border-r'))) {
                    thBaseClass += ' border-l border-r border-slate-300';
                }

                const widthClass = h.width || '';

                if (h.key === 'isFavorite') {
                    let favButtonClasses = 'bg-transparent text-slate-400 border-slate-300 hover:bg-slate-100';
                    let favButtonIcon = '<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
                    let title = "Mostrar todos";

                    if (indiceFavoriteFilter === 'favorites') {
                        favButtonClasses = 'bg-yellow-100 text-yellow-500 border-yellow-300';
                        favButtonIcon = '<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>';
                        title = "Mostrar solo favoritos";
                    } else if (indiceFavoriteFilter === 'non-favorites') {
                        favButtonClasses = 'bg-red-100 text-red-500 border-red-300';
                        favButtonIcon = `
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                <line x1="4" y1="20" x2="20" y2="4" stroke-width="2.5" stroke-linecap="round"/>
                            </svg>`;
                        title = "Mostrar no favoritos";
                    }
                    
                    tableHTML += `<th scope="col" class="px-4 py-1 w-[4%] text-center">
                        <button id="indice-favorites-header-filter-btn" title="${title}" class="w-7 h-7 rounded-full flex items-center justify-center transition-colors border ${favButtonClasses}">
                            ${favButtonIcon}
                        </button>
                    </th>`;
                } else if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thBaseClass} ${widthClass}">${h.label}</th>`;
                } else {
                    const buttonClasses = `table-sort-button justify-center ${isSortingKey ? 'active ' + indiceSortConfig.direction : ''}`;
                    const sortIcon = isSortingKey ? sortIconSVG : '';
                    tableHTML += `<th scope="col" class="${thBaseClass} ${widthClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredItems.forEach(item => {
                let coverageClass = '';
                let coverageText = item.coverageDays === Infinity ? '∞' : Math.round(item.coverageDays);
                if (item.coverageDays !== Infinity) {
                    if (item.coverageDays < red) coverageClass = 'text-red-600 font-bold';
                    else if (item.coverageDays >= red && item.coverageDays <= yellow) coverageClass = 'text-yellow-500 font-bold';
                    else if (item.coverageDays > yellow) coverageClass = 'text-green-600 font-bold';
                } else {
                     coverageClass = 'text-green-600 font-bold';
                }

                const modifiedBy = item.lastModifiedBy || '';
                const modifiedAt = item.lastModifiedAt ? `el ${formatDateTime(item.lastModifiedAt)}` : '';

                const modifiedIndicatorHTML = item.isModified ? `
                    <div class="tooltip-container modified-indicator">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                        <span class="tooltip-text">Modificado por ${modifiedBy} ${modifiedAt}</span>
                    </div>` : '';

                tableHTML += `<tr class="border-b hover:bg-slate-100 even:bg-slate-50">
                    <td class="px-4 py-2 text-center">
                        <button class="favorite-btn ${item.isFavorite ? 'is-favorite' : ''}" data-item-id="${item.id}" data-btn-type="indice-fav" ${currentUserRole === 'viewer' ? 'disabled' : ''}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </button>
                    </td>
                    <td class="px-4 py-1 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.group}</td>
                    <td class="px-4 py-1 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-slate-900 indice-item-details cursor-pointer relative" data-item-id="${item.id}">
                        <div class="flex items-center justify-between">
                            <span class="truncate pr-2">${item.name.replace(new RegExp(`^${item.code}\\s*`), '').toUpperCase()}</span>
                            ${modifiedIndicatorHTML}
                        </div>
                    </td>
                    <td class="px-2 py-1 text-right relative border-l border-r border-slate-300">
                        <input type="text" value="${formatNumber(item.stock)}" data-item-id="${item.id}" data-field="stock" class="direct-edit-input text-right w-full bg-transparent text-xl font-bold" ${currentUserRole === 'viewer' ? 'disabled' : ''}>
                    </td>
                    <td class="px-2 py-1 text-right relative">
                        <input type="text" value="${formatNumber(item.monthlyConsumption)}" data-item-id="${item.id}" data-field="monthlyConsumption" class="direct-edit-input text-right w-full bg-transparent text-base" ${currentUserRole === 'viewer' ? 'disabled' : ''}>
                    </td>
                    <td class="px-4 py-2 text-right ${coverageClass} text-base">${coverageText}</td>
                    <td class="px-4 py-2">
                        <input type="text" value="${item.description_notes || ''}" data-item-id="${item.id}" class="w-full bg-transparent text-xs text-slate-600 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white rounded p-1 notes-input-indice placeholder:text-center placeholder:text-slate-400 placeholder:text-lg" placeholder="+" ${currentUserRole === 'viewer' ? 'disabled' : ''}>
                    </td>
                `;

                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
        }


        // --- LÓGICA DE LA PESTAÑA CONSUMOS ---
        function renderConsumosView() {
            const searchInput = document.getElementById('consumo-search-input');
            const clearTextBtn = document.getElementById('consumo-clear-text-btn');
            if (searchInput) {
                const selectedItem = items.find(i => i.id === selectedConsumptionItemId);
                const hasValue = selectedItem ? selectedItem.name : '';
                searchInput.value = hasValue;
                if (clearTextBtn) {
                    clearTextBtn.classList.toggle('hidden', !hasValue);
                }
            }
            
            const comparisonSearchInput = document.getElementById('consumo-comparison-search-input');
            const comparisonClearTextBtn = document.getElementById('consumo-comparison-clear-text-btn');
            if (comparisonSearchInput) {
                const selectedComparisonItem = items.find(i => i.id === comparisonItemId);
                const hasValue = selectedComparisonItem ? selectedComparisonItem.name : '';
                comparisonSearchInput.value = hasValue;
                if (comparisonClearTextBtn) {
                    comparisonClearTextBtn.classList.toggle('hidden', !hasValue);
                }
            }
            
            renderConsumoFilters('primary');
            renderConsumoFilters('comparison');
            renderConsumosContent();
        }

        function renderConsumoFilters(type) {
            const prefix = type === 'primary' ? '' : '-comparison';
            const groupFilterContainer = document.getElementById(`consumo${prefix}-group-filter-container`);
            const favoritesBtn = document.getElementById(`consumo${prefix}-favorites-filter-btn`);
            const selectedGroup = type === 'primary' ? consumoSelectedGroup : consumoComparisonSelectedGroup;
            const showFavorites = type === 'primary' ? consumoShowOnlyFavorites : consumoComparisonShowOnlyFavorites;

            const uniqueGroups = [...new Set(items.map(item => item.group))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="consumo${prefix}-group-filter" data-type="${type}" class="consumo-group-filter bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === selectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
            } else {
                groupFilterContainer.innerHTML = '';
            }
            
            favoritesBtn.classList.toggle('is-favorite', showFavorites);
        }
        
        function renderConsumosContent() {
            const contentArea = document.getElementById('consumo-content-area');
            contentArea.innerHTML = `
                <div id="consumo-panel-primary" class="w-full lg:w-1/2 bg-white lg:overflow-y-auto"></div>
                <div class="w-full lg:w-px h-px lg:h-full bg-slate-300"></div>
                <div id="consumo-panel-comparison" class="w-full lg:w-1/2 bg-white lg:overflow-y-auto"></div>
            `;
            renderSingleConsumoPanel(selectedConsumptionItemId, 'primary');
            renderSingleConsumoPanel(comparisonItemId, 'comparison');
        }

        function renderSingleConsumoPanel(itemId, type) {
            const panel = document.getElementById(`consumo-panel-${type}`);
            if (!panel) return;

            if (type === 'comparison') {
                if (isSimulationModeActive && selectedConsumptionItemId) {
                    renderSimulationPanel();
                    return;
                }
                if (!itemId && selectedConsumptionItemId) {
                    panel.innerHTML = `
                        <div class="p-6 h-full flex flex-col items-center justify-start pt-20 text-center bg-slate-50">
                            <svg class="w-16 h-16 text-slate-300 mb-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                            <h3 class="text-lg font-semibold text-slate-700">Simulación y Comparación</h3>
                            <p class="text-slate-500 mt-1 max-w-sm">
                                Usa la barra de búsqueda superior para seleccionar un segundo insumo y compararlo, o haz clic en el botón <strong>"Simular"</strong> para proyectar el stock futuro.
                            </p>
                            <button class="btn-main-style !h-10 mt-6 !text-sm !bg-indigo-500 !text-white hover:!bg-indigo-600 show-simulation-trigger">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                                <span class="ml-2">Simular Insumo Principal</span>
                            </button>
                        </div>
                    `;
                    return;
                }
            }

            const notesDisabledAttr = currentUserRole === 'viewer' ? 'disabled' : '';
            let notesAndSimulateSection;
            if (type === 'primary' && itemId) {
                const canSimulate = true; // Habilitado para todos los roles
                const simulateButtonHTML = canSimulate ? `
                    <button id="show-simulation-btn" class="btn-main-style !h-8 !text-xs !bg-indigo-500 !text-white hover:!bg-indigo-600 show-simulation-trigger">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                        <span class="ml-2">Simular</span>
                    </button>
                ` : '';

                notesAndSimulateSection = `
                <div class="mt-4 pt-4 border-t">
                    <div class="flex justify-between items-center mb-1">
                        <label for="consumo-description-notes-${type}" class="font-medium text-sm text-slate-700 whitespace-nowrap">Notas:</label>
                        ${simulateButtonHTML}
                    </div>
                    <textarea id="consumo-description-notes-${type}" rows="1" class="py-1 px-2 bg-white border border-slate-300 rounded-md w-full focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition text-sm resize-none" placeholder="Añadir una descripción..." ${notesDisabledAttr}></textarea>
                </div>
                `;
            } else {
                notesAndSimulateSection = `
                 <div class="mt-4 pt-4 border-t flex items-center gap-4">
                    <label for="consumo-description-notes-${type}" class="font-medium text-sm text-slate-700 whitespace-nowrap">Notas:</label>
                    <textarea id="consumo-description-notes-${type}" rows="1" class="py-1 px-2 bg-white border border-slate-300 rounded-md w-full focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition text-sm resize-none" placeholder="Añadir una descripción..." ${notesDisabledAttr}></textarea>
                </div>
                `;
            }

            panel.innerHTML = `
            <div class="p-4">
                <div class="flex justify-between items-start gap-2">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                         <div id="consumo-favorite-btn-container-${type}" class="flex-shrink-0"></div>
                         <div>
                            <div class="flex items-center gap-2">
                                <h3 id="consumo-kpi-name-${type}" class="text-lg font-bold text-[#6366f1] consumo-name-link cursor-pointer hover:underline">-</h3>
                                <button id="copy-consumo-name-${type}" class="btn-main-style !p-1.5 !h-auto flex-shrink-0 hidden" title="Copiar al portapapeles">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                            </div>
                            <p id="consumo-kpi-code-${type}" class="text-sm text-slate-500"></p>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-xs font-medium text-slate-500 uppercase">Grupo</p>
                        <p id="consumo-kpi-group-${type}" class="text-base font-semibold text-[#6366f1] consumo-group-link cursor-pointer hover:underline">-</p>
                    </div>
                </div>
                <div class="grid grid-cols-5 gap-2 mt-4">
                    <div class="bg-slate-50 border border-slate-200 p-1 rounded-lg flex flex-col justify-center items-center h-20">
                        <input type="text" id="consumo-kpi-stock-${type}" class="direct-edit-input text-center w-full bg-transparent text-xl font-bold text-slate-800" ${notesDisabledAttr}>
                        <p class="text-xs font-medium text-slate-500 uppercase mt-1">Stock</p>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 p-1 rounded-lg flex flex-col justify-center items-center h-20">
                        <p id="consumo-kpi-avg-${type}" class="text-xl font-bold text-indigo-600">-</p>
                        <p class="text-xs font-medium text-slate-500 uppercase mt-1">Promedio</p>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 p-1 rounded-lg flex flex-col justify-center items-center h-20">
                        <p id="consumo-kpi-peak-${type}" class="text-xl font-bold text-green-600">-</p>
                        <p class="text-xs font-medium text-slate-500 uppercase truncate mt-1">Pico <span id="consumo-kpi-peak-month-${type}" class="font-normal"></span></p>
                    </div>
                    <div class="bg-white border-2 border-indigo-300 p-1 rounded-lg flex flex-col justify-center items-center h-20">
                        <input type="text" id="consumo-kpi-monthly-consumption-${type}" class="direct-edit-input text-center w-full bg-transparent text-xl font-bold text-slate-800" ${notesDisabledAttr}>
                        <p class="text-xs font-medium text-slate-500 uppercase mt-1">Cons. Mensual</p>
                    </div>
                    <div class="bg-white border-2 border-indigo-300 p-1 rounded-lg flex flex-col justify-center items-center h-20">
                        <p id="consumo-kpi-coverage-today-${type}" class="text-xl font-bold text-slate-800">-</p>
                        <p class="text-xs font-medium text-slate-500 uppercase mt-1">Cobertura</p>
                    </div>
                </div>
                <div id="consumo-chart-wrapper-${type}" class="consumo-chart-wrapper">
                    <p class="text-slate-500 m-auto">Seleccione un producto para ver su historial.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mt-4">
                    <div id="consumo-solpeds-container-${type}" class="md:col-span-2"></div>
                    <div id="consumo-ocs-container-${type}" class="md:col-span-3"></div>
                </div>
                ${notesAndSimulateSection}
            </div>
            `;
            
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const processedItem = getProcessedItems().find(i => i.id === itemId);

            const modifiedBy = item.lastModifiedBy || '';
            const modifiedAt = item.lastModifiedAt ? `el ${formatDateTime(item.lastModifiedAt)}` : '';

            const modifiedIndicatorHTML = item.isModified ? `
                <div class="tooltip-container modified-indicator">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
                    <span class="tooltip-text">Modificado por ${modifiedBy} ${modifiedAt}</span>
                </div>` : '';

            const favoriteBtnContainer = document.getElementById(`consumo-favorite-btn-container-${type}`);
            const favoriteBtn = document.createElement('button');
            favoriteBtn.className = `favorite-btn ${item.isFavorite ? 'is-favorite' : ''}`;
            favoriteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>`;
            favoriteBtn.dataset.itemId = itemId;
            if (currentUserRole === 'viewer') {
                favoriteBtn.disabled = true;
            }
            favoriteBtnContainer.innerHTML = '';
            favoriteBtnContainer.appendChild(favoriteBtn);

            const nameEl = document.getElementById(`consumo-kpi-name-${type}`);
            nameEl.innerHTML = item.name.replace(new RegExp(`^${item.code}\\s*`), '').toUpperCase() + modifiedIndicatorHTML;
            nameEl.dataset.itemCode = item.code;

            const groupEl = document.getElementById(`consumo-kpi-group-${type}`);
            groupEl.textContent = item.group || 'N/A';
            groupEl.dataset.groupName = item.group;

            const textToCopy = `${item.code} - ${item.name.replace(new RegExp(`^${item.code}\\s*`), '').toUpperCase()}`;
            document.getElementById(`consumo-kpi-code-${type}`).textContent = item.code;
            

            const copyBtn = document.getElementById(`copy-consumo-name-${type}`);
            if (copyBtn) {
                copyBtn.classList.remove('hidden');
                copyBtn.onclick = () => handleCopyText(textToCopy, copyBtn);
            }

            const stockInputEl = document.getElementById(`consumo-kpi-stock-${type}`);
            stockInputEl.value = formatNumber(item.stock);
            stockInputEl.dataset.itemId = itemId;
            stockInputEl.dataset.field = 'stock';
            stockInputEl.classList.toggle('modified-input', !!item.isModified);
            
            const consumptionInputEl = document.getElementById(`consumo-kpi-monthly-consumption-${type}`);
            consumptionInputEl.value = formatNumber(Math.round(item.monthlyConsumption));
            consumptionInputEl.dataset.itemId = itemId;
            consumptionInputEl.dataset.field = 'monthlyConsumption';
            consumptionInputEl.classList.toggle('modified-input', !!item.isModified);
            
            const allConsumos = item.consumos || [];
            const selectedMonths = appSettings.consumptionMonths || Array(12).fill(true);
            const defaultMonthNames = ["M1", "M2", "M3", "M4", "M5", "M6", "M7", "M8", "M9", "M10", "M11", "M12"];
            const allMonthNames = (appSettings.consumptionMonthLabels && appSettings.consumptionMonthLabels.length > 0) 
                ? appSettings.consumptionMonthLabels 
                : defaultMonthNames;
            
            const consumos = [];
            const monthLabels = [];

            selectedMonths.forEach((isSelected, index) => {
                if (isSelected && index < allConsumos.length) {
                    consumos.push(allConsumos[index]);
                    monthLabels.push(allMonthNames[index]);
                }
            });

            const avgConsumption = consumos.length > 0 ? consumos.reduce((a, b) => a + b, 0) / consumos.length : 0;
            const peakConsumption = consumos.length > 0 ? Math.max(...consumos) : 0;
            let peakMonths = [];
            if (peakConsumption > 0) {
                consumos.forEach((consumo, index) => {
                    if (consumo === peakConsumption) {
                        peakMonths.push(monthLabels[index]);
                    }
                });
            }

            document.getElementById(`consumo-kpi-avg-${type}`).textContent = formatNumber(Math.round(avgConsumption));
            document.getElementById(`consumo-kpi-peak-${type}`).textContent = formatNumber(Math.round(peakConsumption));
            const peakMonthEl = document.getElementById(`consumo-kpi-peak-month-${type}`);
            if(peakMonthEl) {
               peakMonthEl.textContent = peakMonths.join(', ');
            }
            
            document.getElementById(`consumo-kpi-coverage-today-${type}`).textContent = (processedItem.coverageDays === Infinity) ? '∞' : Math.round(processedItem.coverageDays);
            
            const notesTextarea = document.getElementById(`consumo-description-notes-${type}`);
            notesTextarea.value = item.description_notes || '';
            notesTextarea.dataset.itemId = itemId;
            
            const chartWrapper = document.getElementById(`consumo-chart-wrapper-${type}`);
            if (!consumos || consumos.length === 0) {
                chartWrapper.innerHTML = '<p class="text-slate-500 m-auto">Este producto no tiene historial de consumo.</p>';
            } else {
                
                const nonZeroConsumos = consumos.filter(c => c > 0);
                const minValue = nonZeroConsumos.length > 0 ? Math.min(...nonZeroConsumos) : 0;
                const peakConsumption = Math.max(...consumos, item.monthlyConsumption);
                const uniqueValues = [...new Set(nonZeroConsumos)];
                
                const maxValue = peakConsumption > 0 ? peakConsumption : 10;
                const yAxisLabels = [0, maxValue * 0.25, maxValue * 0.5, maxValue * 0.75, maxValue];
                let yAxisHtml = '<div class="consumo-y-axis">';
                yAxisLabels.reverse().forEach(label => { yAxisHtml += `<span>${formatNumber(Math.round(label))}</span>`; });
                yAxisHtml += '</div>';

                
                let barsHtml = '<div class="consumo-chart-container">';

                if (item.monthlyConsumption > 0 && maxValue > 0) {
                    const projectedLinePosition = Math.min((item.monthlyConsumption / maxValue) * 100, 100);
                    // Usamos calc() para un ajuste preciso de 1px (la mitad del grosor del borde) y eliminamos el transform que causaba problemas.
                    barsHtml += `<div class="consumo-chart-projected-line" style="bottom: calc(${projectedLinePosition}% - 1px);"><span class="consumo-chart-projected-label">${formatNumber(Math.round(item.monthlyConsumption))}</span></div>`;
                }

                barsHtml += consumos.map((value, index) => {
                    const barHeight = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    const displayValue = value > 9999 ? (value/1000).toFixed(0) + 'k' : formatNumber(Math.round(value));
                    
                    let barClass = 'bg-indigo-500'; // Azul por defecto
                    if (value > 0 && uniqueValues.length > 1) {
                        if (value === Math.max(...nonZeroConsumos)) barClass = 'bg-green-600'; // Verde más intenso pero apagado
                        else if (value === minValue) barClass = 'bg-red-600'; // Rojo más intenso pero apagado
                    }

                    const exactValueTitle = `${formatNumber(Math.round(value))}`;

                    return `<div class="consumo-chart-bar-wrapper" title="${exactValueTitle}"><div class="consumo-chart-bar ${barClass}" style="height: ${barHeight}%;"><div class="consumo-chart-value">${displayValue}</div></div><div class="consumo-chart-label">${monthLabels[index]}</div></div>`;
                }).join('');
                barsHtml += '</div>';
                chartWrapper.innerHTML = yAxisHtml + barsHtml;
            }

            const solpedsContainer = document.getElementById(`consumo-solpeds-container-${type}`);
            const ocsContainer = document.getElementById(`consumo-ocs-container-${type}`);

            let itemSolpeds = solpeds.filter(s => String(s.cod).trim() == String(item.code).trim());
            itemSolpeds.sort((a,b) => {
                const dateA = parseDateString(a.fechaLiberacion);
                const dateB = parseDateString(b.fechaLiberacion);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });
            let solpedsTableHTML = `<h4 class="font-bold text-slate-700 mb-2">Solicitudes de Pedido</h4>`;
            if(itemSolpeds.length > 0) {
                const today = new Date();
                today.setHours(0,0,0,0);
                solpedsTableHTML += `<div class="max-h-60 overflow-y-auto rounded-lg border border-slate-200"><table class="w-full text-sm table-fixed">
                    <thead class="bg-slate-50 sticky top-0"><tr class="border-b border-slate-200"><th class="px-3 py-2 text-left w-[30%] font-semibold text-slate-600">N° Solped</th><th class="px-3 py-2 text-right w-[25%] font-semibold text-slate-600">Cantidad</th><th class="px-3 py-2 text-left w-[30%] font-semibold text-slate-600">F. Lib.</th><th class="px-3 py-2 text-center w-[15%] font-semibold text-slate-600">Sem</th></tr></thead><tbody class="divide-y divide-slate-100">`;
                itemSolpeds.forEach(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    let weekNumber = '';
                    if (releaseDate) {
                        weekNumber = getWeekId(releaseDate).split('-')[1].replace(/^0+/, '');
                    }
                    const isDelayed = releaseDate && releaseDate < today;
                    const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                    solpedsTableHTML += `<tr class="consumo-solped-link cursor-pointer hover:bg-slate-50" data-solped-id="${s.solicitud}"><td class="px-3 py-2 truncate font-medium text-slate-800">${s.solicitud}</td><td class="px-3 py-2 text-right">${formatNumber(s.cantidad)}</td><td class="px-3 py-2 whitespace-nowrap ${dateClass}">${formatDate(s.fechaLiberacion)}</td><td class="px-3 py-2 text-center ${dateClass}">${weekNumber}</td></tr>`;
                });
                solpedsTableHTML += `</tbody></table></div>`;
            } else {
                solpedsTableHTML += `<p class="text-sm text-slate-500">No hay Solpeds para este insumo.</p>`;
            }
            solpedsContainer.innerHTML = solpedsTableHTML;

            let itemOCs = ocs.filter(oc => String(oc.codigo).trim() == String(item.code).trim());

            itemOCs.sort((a,b) => {
                const dateA = parseDateString(a.proxFechaEntrega);
                const dateB = parseDateString(b.proxFechaEntrega);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            let ocsTableHTML = `<h4 class="font-bold text-slate-700 mb-2">Órdenes de Compra</h4>`;
            if(itemOCs.length > 0) {
                const today = new Date();
                today.setHours(0,0,0,0);
                ocsTableHTML += `<div class="max-h-60 overflow-y-auto rounded-lg border border-slate-200"><table class="w-full text-sm table-fixed">
                    <thead class="bg-slate-50 sticky top-0"><tr class="border-b border-slate-200"><th class="px-3 py-2 text-left w-[25%] font-semibold text-slate-600">N° O/C</th><th class="px-3 py-2 text-left w-[20%] font-semibold text-slate-600">Status</th><th class="px-3 py-2 text-right w-[15%] font-semibold text-slate-600">Cant.</th><th class="px-3 py-2 text-left w-[25%] font-semibold text-slate-600">Entrega</th><th class="px-3 py-2 text-center w-[15%] font-semibold text-slate-600">Sem</th></tr></thead><tbody class="divide-y divide-slate-100">`;
                itemOCs.forEach(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    let weekNumber = '';
                    if (deliveryDate) {
                        // Extraer solo el número de la semana y quitar ceros a la izquierda
                        weekNumber = getWeekId(deliveryDate).split('-')[1].replace(/^0+/, '');
                    }
                    const isDelayed = deliveryDate && deliveryDate < today;
                    const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                    const weekClass = isDelayed ? 'text-red-600 font-bold' : '';
                    const transformedStatus = transformOCStatus(oc.status);
                    
                    let rowClass = 'consumo-oc-link cursor-pointer hover:bg-slate-50';
                     if (oc.status && oc.status.toLowerCase().includes('en proceso de autorización')) {
                        rowClass += ' bg-yellow-50 hover:bg-yellow-100';
                    }
                    if (oc.status && oc.status.toLowerCase().includes('rechazado')) {
                        rowClass += ' bg-red-50 hover:bg-red-100';
                    }

                    ocsTableHTML += `<tr class="${rowClass}" data-oc-id="${oc.ordenDeCompra}"><td class="px-3 py-2 truncate font-medium text-slate-800">${oc.ordenDeCompra}</td><td class="px-3 py-2 text-xs truncate">${transformedStatus}</td><td class="px-3 py-2 text-right">${formatNumber(oc.cantEntregaSiguiente)}</td><td class="px-3 py-2 whitespace-nowrap ${dateClass}">${formatDate(oc.proxFechaEntrega)}</td><td class="px-3 py-2 text-center ${weekClass}">${weekNumber}</td></tr>`;
                });
                ocsTableHTML += `</tbody></table></div>`;
            } else {
                ocsTableHTML += `<p class="text-sm text-slate-500">No hay O/Cs para este insumo.</p>`;
            }
            ocsContainer.innerHTML = ocsTableHTML;
        }

        function handleConsumosFilterChange(event) {
            const type = event.target.dataset.type;
            if (type === 'primary') {
                consumoSelectedGroup = event.target.value;
            } else {
                consumoComparisonSelectedGroup = event.target.value;
            }
            handleConsumosSearch({ target: { value: document.getElementById(`consumo${type === 'primary' ? '' : '-comparison'}-search-input`).value } }, type);
        }

        function handleConsumosFavoritesToggle(buttonElement) {
            const type = buttonElement.dataset.type;
            if (type === 'primary') {
                consumoShowOnlyFavorites = !consumoShowOnlyFavorites;
            } else {
                consumoComparisonShowOnlyFavorites = !consumoComparisonShowOnlyFavorites;
            }
            renderConsumoFilters(type);
            handleConsumosSearch({ target: { value: document.getElementById(`consumo${type === 'primary' ? '' : '-comparison'}-search-input`).value } }, type);
        }

        function handleClearConsumoPanel(type) {
            const prefix = type === 'primary' ? '' : '-comparison';
            
            if (type === 'primary') {
                selectedConsumptionItemId = null;
                comparisonItemId = null; // Also clear comparison if primary is cleared
                isSimulationModeActive = false;
                consumoSelectedGroup = 'all';
                consumoShowOnlyFavorites = false;
                consumoComparisonSelectedGroup = 'all';
                consumoComparisonShowOnlyFavorites = false;
                
                // Clear both search inputs and their clear buttons
                const primarySearch = document.getElementById('consumo-search-input');
                const comparisonSearch = document.getElementById('consumo-comparison-search-input');
                if(primarySearch) primarySearch.value = '';
                if(comparisonSearch) comparisonSearch.value = '';
                const primaryClear = document.getElementById('consumo-clear-text-btn');
                const comparisonClear = document.getElementById('consumo-comparison-clear-text-btn');
                if(primaryClear) primaryClear.classList.add('hidden');
                if(comparisonClear) comparisonClear.classList.add('hidden');
            } else { // comparison
                comparisonItemId = null;
                isSimulationModeActive = false;
                consumoComparisonSelectedGroup = 'all';
                consumoComparisonShowOnlyFavorites = false;
                const searchInput = document.getElementById('consumo-comparison-search-input');
                if(searchInput) searchInput.value = '';
                const clearBtn = document.getElementById('consumo-comparison-clear-text-btn');
                if(clearBtn) clearBtn.classList.add('hidden');
            }
            
            // Re-render everything
            renderConsumosView();
        }

        function handleConsumosSearch(event, type) {
            const searchTerm = event.target.value.toLowerCase();
            const prefix = type === 'primary' ? '' : '-comparison';
            const resultsContainer = document.getElementById(`consumo${prefix}-search-results`);
            const selectedGroup = type === 'primary' ? consumoSelectedGroup : consumoComparisonSelectedGroup;
            const showFavorites = type === 'primary' ? consumoShowOnlyFavorites : consumoComparisonShowOnlyFavorites;
            const clearTextBtn = document.getElementById(`consumo${prefix}-clear-text-btn`);

            if (clearTextBtn) {
                clearTextBtn.classList.toggle('hidden', !searchTerm);
            }
            
            let filteredItems = items;

            if (selectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === selectedGroup);
            }
            if (showFavorites) {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            }
            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredItems = filteredItems.filter(item => {
                    const itemText = item.name.toLowerCase();
                    return searchWords.every(word => itemText.includes(word));
                });
            }

            if (!searchTerm && selectedGroup === 'all' && !showFavorites) {
                 resultsContainer.innerHTML = '';
                 resultsContainer.classList.add('hidden');
                 return;
            }
            
            resultsContainer.classList.remove('hidden');

            if (filteredItems.length > 0) {
                resultsContainer.innerHTML = filteredItems
                    .map(item => `<div class="p-2 hover:bg-slate-100 cursor-pointer" data-item-id="${item.id}" data-type="${type}">${item.name.toUpperCase()}</div>`)
                    .join('');
            } else {
                resultsContainer.innerHTML = '<div class="p-2 text-slate-500">No se encontraron productos.</div>';
            }
        }

        function handleSelectConsumosItem(event) {
            const target = event.target.closest('[data-item-id]');
            if (target) {
                const { itemId, type } = target.dataset;
                const prefix = type === 'primary' ? '' : '-comparison';

                if (type === 'primary') {
                    selectedConsumptionItemId = itemId;
                    renderSingleConsumoPanel(itemId, 'primary'); // Always update the left panel

                    if (isSimulationModeActive) {
                        isSimulationModeActive = false; // Turn off simulation
                        comparisonItemId = null; // Clear the item for the right panel
                        renderSingleConsumoPanel(null, 'comparison'); // Re-render right panel as empty welcome screen
                    }
                    // If not in simulation mode, the right panel (comparison) is left untouched.

                } else { // type === 'comparison'
                    comparisonItemId = itemId;
                    isSimulationModeActive = false; // Selecting a comparison item always turns off simulation mode
                    renderSingleConsumoPanel(itemId, 'comparison');
                }

                // Common logic to update search input and hide results
                document.getElementById(`consumo${prefix}-search-input`).value = target.textContent;
                const resultsContainer = document.getElementById(`consumo${prefix}-search-results`);
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');

                const clearTextBtn = document.getElementById(`consumo${prefix}-clear-text-btn`);
                if(clearTextBtn) {
                    clearTextBtn.classList.remove('hidden');
                }
            }
        }

        function handleClearSelectedItem(type) {
            const prefix = type === 'primary' ? '' : '-comparison';
            const searchInput = document.getElementById(`consumo${prefix}-search-input`);
            const clearBtn = document.getElementById(`consumo${prefix}-clear-text-btn`);
            const resultsContainer = document.getElementById(`consumo${prefix}-search-results`);

            if (searchInput) searchInput.value = '';
            if (clearBtn) clearBtn.classList.add('hidden');
            if (resultsContainer) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
            }
            
            if (type === 'primary') {
                selectedConsumptionItemId = null;
            } else {
                comparisonItemId = null;
            }
            
            // Re-render only the affected panel to its initial state
            renderSingleConsumoPanel(null, type);
        }

        function handleNumericInputFormatting(e) {
            const input = e.target;
            const allowNegative = input.id === 'sim-income-qty'; // Habilitar negativos solo para este input

            const cursorPosition = input.selectionStart;
            const originalLength = input.value.length;
            const originalValue = input.value;

            // 1. Extraer el signo y los dígitos
            let sign = '';
            if (allowNegative && originalValue.trim().startsWith('-')) {
                sign = '-';
            }
            const digits = originalValue.replace(/[^\d]/g, '');

            // 2. Si no hay dígitos, limpiar o mostrar solo el signo
            if (digits === '') {
                input.value = sign;
                // Colocar cursor al final
                if(sign) input.setSelectionRange(1, 1);
                return;
            }
            
            // 3. Formatear el número
            const numericValue = parseInt(digits, 10);
            const formattedNumber = new Intl.NumberFormat('es-AR').format(numericValue);
            
            const finalValue = sign + formattedNumber;

            // 4. Actualizar el input y la posición del cursor
            input.value = finalValue;
            const newLength = input.value.length;
            // Ajustar el cursor de manera más predecible
            const diff = newLength - originalLength;
            const newCursorPosition = Math.max(0, cursorPosition + diff);
            input.setSelectionRange(newCursorPosition, newCursorPosition);
        }

        function updateSimulationCoverageIndicator() {
            const stockInput = document.getElementById('sim-stock');
            const consumptionInput = document.getElementById('sim-consumption');
            const coverageContainer = document.getElementById('sim-coverage-indicator');
            if (!stockInput || !consumptionInput || !coverageContainer) return;

            const stock = parseInt(String(stockInput.value).replace(/\./g, ''), 10) || 0;
            const monthlyConsumption = parseInt(String(consumptionInput.value).replace(/\./g, ''), 10) || 0;
            const dailyConsumption = monthlyConsumption > 0 ? monthlyConsumption / 30 : 0;
            const coverageDays = dailyConsumption > 0 ? Math.floor(stock / dailyConsumption) : Infinity;

            const { red, yellow } = appSettings.coverageThresholds;
            let coverageClass = 'text-slate-700';
            if (coverageDays !== Infinity) {
                if (coverageDays < red) coverageClass = 'text-red-600';
                else if (coverageDays <= yellow) coverageClass = 'text-yellow-600';
                else coverageClass = 'text-green-600';
            } else {
                coverageClass = 'text-green-600';
            }

            coverageContainer.innerHTML = `<span class="font-bold text-lg ${coverageClass}">${coverageDays === Infinity ? '∞' : Math.round(coverageDays)}</span>`;
        }

        function renderSimulationPanel() {
            simulatedIncomes = []; // Resetear ingresos simulados al cambiar de producto
            simulatedIncomeCounter = 1;
            simulationShowAllWeeks = false; // Resetear vista de semanas
            const panel = document.getElementById('consumo-panel-comparison');
            if (!panel) return;
            const primaryItem = items.find(i => i.id === selectedConsumptionItemId);
            if (!primaryItem) {
                panel.innerHTML = '<p class="p-6 text-center text-slate-500">Seleccione un producto principal para iniciar la simulación.</p>';
                return;
            }

            panel.innerHTML = `
            <div class="p-4 h-full flex flex-col">
                <div class="flex-shrink-0">
                    <div class="flex justify-between items-center gap-2 pb-2 border-b">
                        <div class="flex items-center gap-2 min-w-0">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-500 flex-shrink-0"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
                            <h3 class="text-lg font-bold text-slate-800 truncate">Simulación: <span class="text-[#6366f1]">${primaryItem.name.toUpperCase()}</span></h3>
                        </div>
                        <button id="export-simulation-btn" title="Exportar Simulación" class="btn-main-style !w-9 !h-9 !p-0 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row items-start gap-4 mt-4 flex-shrink-0">
                    <!-- Controles de Stock y Consumo -->
                    <div class="w-full md:flex-1">
                         <div class="flex gap-2">
                             <div class="flex-1">
                                <label for="sim-stock" class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1 text-center">Stock Actual</label>
                                <div class="relative flex items-center">
                                    <button data-target="sim-stock" data-step="-100" class="sim-adjust-btn absolute left-2 p-1 text-slate-500 hover:text-indigo-600 font-bold">-</button>
                                    <input id="sim-stock" type="text" inputmode="numeric" value="${formatNumber(Math.round(primaryItem.stock))}" class="w-full h-10 bg-white border border-slate-300 rounded-md shadow-sm text-center font-bold focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <button data-target="sim-stock" data-step="100" class="sim-adjust-btn absolute right-2 p-1 text-slate-500 hover:text-indigo-600 font-bold">+</button>
                                </div>
                            </div>
                            <div class="flex-1">
                                 <label for="sim-consumption" class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1 text-center">CONS.MENS</label>
                                <div class="relative flex items-center">
                                    <button data-target="sim-consumption" data-step="-50" class="sim-adjust-btn absolute left-2 p-1 text-slate-500 hover:text-indigo-600 font-bold">-</button>
                                    <input id="sim-consumption" type="text" inputmode="numeric" value="${formatNumber(Math.round(primaryItem.monthlyConsumption))}" class="w-full h-10 bg-white border border-slate-300 rounded-md shadow-sm text-center font-bold focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    <button data-target="sim-consumption" data-step="50" class="sim-adjust-btn absolute right-2 p-1 text-slate-500 hover:text-indigo-600 font-bold">+</button>
                                </div>
                            </div>
                            <div class="w-24">
                                <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1 text-center">COB.DIAS</label>
                                <div id="sim-coverage-indicator" class="w-full h-10 bg-slate-50 border border-slate-200 rounded-md flex items-center justify-center">
                                    <span class="font-bold text-lg text-slate-700">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-px bg-slate-200 self-stretch mx-2"></div>

                    <!-- Simular Ingreso -->
                    <div class="flex-1">
                        <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider block mb-1 text-center">Simular Ingreso Manual</p>
                        <div class="flex gap-2 items-center">
                            <input id="sim-income-name" type="text" placeholder="Nombre (Opcional)" class="w-1/3 h-10 bg-white border border-slate-300 rounded-md shadow-sm px-3 text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <input id="sim-income-qty" type="text" inputmode="numeric" placeholder="Cantidad" class="w-1/3 h-10 bg-white border border-slate-300 rounded-md shadow-sm text-center font-bold focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="w-1/3 flex gap-2">
                                <select id="sim-income-week" class="flex-grow h-10 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm font-semibold">
                                    <!-- Options will be populated dynamically -->
                                </select>
                                <button id="add-sim-income-btn" class="btn-main-style !h-10 !w-10 !p-0 !bg-indigo-600 !text-white hover:!bg-indigo-700 flex-shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="simulated-incomes-list" class="mt-2 text-sm flex-shrink-0"></div>

                <div id="overdue-ocs-container" class="mt-4 flex-shrink-0"></div>

                <div id="simulation-results-container" class="mt-4 flex-grow overflow-y-auto">
                    <!-- Results will be injected here by runAndRenderSimulation() -->
                </div>
            </div>
            `;

            const weekSelect = panel.querySelector('#sim-income-week');
            if (weekSelect) {
                const todayRaw = new Date();
                const today = new Date(Date.UTC(todayRaw.getFullYear(), todayRaw.getMonth(), todayRaw.getDate()));

                const startOfCurrentWeek = new Date(today);
                const dayOfWeek = (startOfCurrentWeek.getUTCDay() + 6) % 7; // Monday = 0
                startOfCurrentWeek.setUTCDate(startOfCurrentWeek.getUTCDate() - dayOfWeek);

                let optionsHTML = '';
                for (let i = 0; i < 24; i++) {
                    const weekStartDate = new Date(startOfCurrentWeek);
                    weekStartDate.setUTCDate(startOfCurrentWeek.getUTCDate() + i * 7);
                    const weekId = getWeekId(weekStartDate);
                    const weekNumber = parseInt(weekId.split('-')[1], 10);
                    const day = String(weekStartDate.getUTCDate()).padStart(2, '0');
                    const month = String(weekStartDate.getUTCMonth() + 1).padStart(2, '0');
                    optionsHTML += `<option value="${weekId}">${weekNumber} (${day}/${month})</option>`;
                }
                weekSelect.innerHTML = optionsHTML;
            }
            
            const simulationInputHandler = (e) => {
                handleNumericInputFormatting(e);
                runAndRenderSimulation();
                updateSimulationCoverageIndicator();
            };

            document.getElementById('sim-stock').addEventListener('input', simulationInputHandler);
            document.getElementById('sim-consumption').addEventListener('input', simulationInputHandler);
            document.getElementById('sim-income-qty').addEventListener('input', handleNumericInputFormatting);
            panel.querySelectorAll('.sim-adjust-btn').forEach(btn => btn.addEventListener('click', handleSimAdjust));
            document.getElementById('add-sim-income-btn').addEventListener('click', handleAddSimulatedIncome);
            document.getElementById('export-simulation-btn')?.addEventListener('click', handleExportSimulation);

            runAndRenderSimulation(); // Run initial simulation
            updateSimulationCoverageIndicator();
        }

        function handleSimAdjust(e) {
            const btn = e.currentTarget;
            const targetInput = document.getElementById(btn.dataset.target);
            const step = parseInt(btn.dataset.step, 10);
            if (targetInput) {
                const currentValue = parseInt(targetInput.value.replace(/\./g, ''), 10) || 0;
                targetInput.value = formatNumber(Math.max(0, currentValue + step));
                runAndRenderSimulation();
                updateSimulationCoverageIndicator();
            }
        }
        
        function runSimulation() {
            if (!selectedConsumptionItemId) return [];

            const primaryItem = getProcessedItems().find(i => i.id === selectedConsumptionItemId);
            if (!primaryItem) return [];
            
            const stockInput = document.getElementById('sim-stock');
            const consumptionInput = document.getElementById('sim-consumption');
            if (!stockInput || !consumptionInput) return [];

            let currentStock = parseInt(String(stockInput.value).replace(/\./g, ''), 10) || 0;
            const simulatedMonthlyConsumption = parseInt(String(consumptionInput.value).replace(/\./g, ''), 10) || 0;

            const simulatedDailyConsumption = simulatedMonthlyConsumption > 0 ? simulatedMonthlyConsumption / 30 : 0;
            const simulatedWeeklyConsumption = simulatedDailyConsumption * 7;
            
            const simulationWeeks = 24;
            const todayRaw = new Date();
            const today = new Date(Date.UTC(todayRaw.getFullYear(), todayRaw.getMonth(), todayRaw.getDate()));

            const startOfSimulationWeek = new Date(today);
            const dayOfWeek = (startOfSimulationWeek.getUTCDay() + 6) % 7; // Monday = 0
            startOfSimulationWeek.setUTCDate(startOfSimulationWeek.getUTCDate() - dayOfWeek);

            const itemOcs = ocs.filter(oc => oc.codigo === primaryItem.code);
            const results = [];

            for (let i = 0; i < simulationWeeks; i++) {
                const weekStartDate = new Date(startOfSimulationWeek);
                weekStartDate.setUTCDate(startOfSimulationWeek.getUTCDate() + i * 7);
                const weekEndDate = new Date(weekStartDate);
                weekEndDate.setUTCDate(weekStartDate.getUTCDate() + 6);
                
                const incomingSources = [];
                let incomingThisWeek = 0;

                itemOcs.forEach(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    if (deliveryDate) {
                        if (deliveryDate >= weekStartDate && deliveryDate <= weekEndDate) {
                            const status = transformOCStatus(oc.status);
                            if (status !== 'Rechazada') {
                                incomingSources.push({
                                    type: 'oc',
                                    number: oc.ordenDeCompra,
                                    quantity: oc.cantEntregaSiguiente,
                                    status: status
                                });
                                incomingThisWeek += oc.cantEntregaSiguiente;
                            }
                        }
                    }
                });

                const weekId = getWeekId(weekStartDate);
                
                const simulatedIncomeForWeek = simulatedIncomes.find(inc => inc.weekId === weekId);
                if (simulatedIncomeForWeek) {
                    const displayName = simulatedIncomeForWeek.name || `SIM-${simulatedIncomeForWeek.seqNumber}`;
                    incomingSources.push({
                        type: 'manual',
                        number: displayName,
                        quantity: simulatedIncomeForWeek.quantity,
                        status: 'Simulacion'
                    });
                    incomingThisWeek += simulatedIncomeForWeek.quantity;
                }

                let weeklyConsumptionToApply = simulatedWeeklyConsumption;
                if (i === 0) { // Cálculo especial para la semana actual
                    const endOfCurrentWeek = new Date(weekStartDate);
                    endOfCurrentWeek.setUTCDate(endOfCurrentWeek.getUTCDate() + 6);

                    let remainingDays = 0;
                    if (today <= endOfCurrentWeek) {
                         // +1 para incluir el día de hoy en la cuenta
                        remainingDays = daysBetween(today, endOfCurrentWeek) + 1;
                    }
                    
                    weeklyConsumptionToApply = simulatedDailyConsumption * remainingDays;
                }

                const stockAfterArrivals = currentStock + incomingThisWeek;
                const endOfWeekStock = Math.max(0, stockAfterArrivals - weeklyConsumptionToApply);
                const coverageAtEnd = simulatedDailyConsumption > 0 ? Math.floor(endOfWeekStock / simulatedDailyConsumption) : Infinity;

                const weekNumber = parseInt(weekId.split('-')[1], 10);
                const day = String(weekStartDate.getUTCDate()).padStart(2, '0');
                const month = String(weekStartDate.getUTCMonth() + 1).padStart(2, '0');

                results.push({
                    week: `${weekNumber} (${day}/${month})`,
                    startStock: currentStock,
                    incoming: incomingThisWeek,
                    incomingSources: incomingSources,
                    consumption: weeklyConsumptionToApply,
                    endStock: endOfWeekStock,
                    coverage: coverageAtEnd
                });

                currentStock = endOfWeekStock;
            }
            return results;
        }

        function runAndRenderSimulation() {
            const resultsContainer = document.getElementById('simulation-results-container');
            if (!resultsContainer) return;
            
            const primaryItem = getProcessedItems().find(i => i.id === selectedConsumptionItemId);
            if (!primaryItem) {
                 resultsContainer.innerHTML = '<p class="text-center text-slate-500 p-4">No hay datos para simular.</p>';
                 return;
            }
           
            const todayRaw = new Date();
            const today = new Date(Date.UTC(todayRaw.getFullYear(), todayRaw.getMonth(), todayRaw.getDate()));

            const startOfSimulationWeek = new Date(today);
            const dayOfWeek = (startOfSimulationWeek.getUTCDay() + 6) % 7; // Monday = 0
            startOfSimulationWeek.setUTCDate(startOfSimulationWeek.getUTCDate() - dayOfWeek);

            const allItemOcs = ocs.filter(oc => oc.codigo === primaryItem.code);
            const overdueOcs = allItemOcs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                const status = transformOCStatus(oc.status);
                return deliveryDate && deliveryDate < startOfSimulationWeek && status !== 'Rechazada';
            });
            overdueOcs.sort((a,b) => (parseDateString(a.proxFechaEntrega) || 0) - (parseDateString(b.proxFechaEntrega) || 0));

            const overdueOcsContainer = document.getElementById('overdue-ocs-container');
            if (overdueOcsContainer) {
                if (overdueOcs.length > 0) {
                    let overdueHtml = `
                        <div class="mb-4 p-3 bg-red-50 border-l-4 border-red-400 rounded-lg shadow-sm">
                            <div class="flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 flex-shrink-0"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                                <h4 class="font-bold text-red-800">Órdenes de Compra Vencidas (No simuladas)</h4>
                            </div>
                            <ul class="mt-2 pl-7 space-y-1 text-sm text-red-700">`;
                    
                    overdueOcs.forEach(oc => {
                        const deliveryDate = parseDateString(oc.proxFechaEntrega);
                        let weekNumberText = '';
                        if (deliveryDate) {
                            const weekId = getWeekId(deliveryDate);
                            const weekNumber = parseInt(weekId.split('-')[1], 10);
                            weekNumberText = ` (Sem. ${weekNumber})`;
                        }
                        overdueHtml += `<li><strong>O/C ${oc.ordenDeCompra}:</strong> ${formatNumber(oc.cantEntregaSiguiente)} unidades - Vencida el ${formatDate(oc.proxFechaEntrega)}${weekNumberText}</li>`;
                    });
                    
                    overdueHtml += `</ul></div>`;
                    overdueOcsContainer.innerHTML = overdueHtml;
                } else {
                    overdueOcsContainer.innerHTML = ''; // Clear if no overdue OCs
                }
            }

            // Render results
            const results = runSimulation();
            if (results.length === 0) {
                 resultsContainer.innerHTML = '<p class="text-center text-slate-500 p-4">No hay datos para simular.</p>';
                 return;
            }
           
            const weeksToRender = simulationShowAllWeeks ? results : results.slice(0, 12);

            let tableHTML = `
            <div class="border rounded-lg overflow-hidden">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                        <tr>
                            <th scope="col" class="px-3 py-2 w-[8%] text-center">Semana</th>
                            <th scope="col" class="px-3 py-2 text-center">Stock Inicial</th>
                            <th scope="col" class="px-3 py-2 text-center">Ingresos</th>
                            <th scope="col" class="px-3 py-2 text-center">Consumo</th>
                            <th scope="col" class="px-3 py-2 text-center">Stock Final</th>
                            <th scope="col" class="px-3 py-2 text-center w-[8%]">COB.(dias)</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">`;

            weeksToRender.forEach(res => {
                const { red, yellow } = appSettings.coverageThresholds;
                let coverageClass = '';
                 if (res.coverage !== Infinity) {
                    if (res.coverage < red) coverageClass = 'text-red-600 font-bold';
                    else if (res.coverage <= yellow) coverageClass = 'text-yellow-600 font-bold';
                }
                
                let tooltipContent = '';
                let incomeCellClass = 'text-slate-500'; // Gris por defecto si no hay ingresos

                if (res.incomingSources.length > 0) {
                    // Determinar el color principal de la celda
                    if (res.incomingSources.some(s => s.status === 'Simulacion')) {
                        incomeCellClass = 'text-indigo-600 font-bold';
                    } else if (res.incomingSources.some(s => s.status === 'Pendiente')) {
                        incomeCellClass = 'text-yellow-600 font-bold';
                    } else if (res.incomingSources.some(s => s.status === 'Aprobada')) {
                        incomeCellClass = 'text-green-600 font-bold';
                    }

                    // Construir el contenido del tooltip con colores individuales
                    tooltipContent = res.incomingSources.map(source => {
                        let statusClass = '';
                        switch(source.status) {
                            case 'Aprobada': statusClass = 'text-green-600'; break;
                            case 'Pendiente': statusClass = 'text-yellow-600'; break;
                            case 'Simulacion': statusClass = 'text-indigo-600'; break;
                            default: statusClass = 'text-slate-700';
                        }
                        // Usamos flexbox para alinear el nombre a la izquierda y la cantidad a la derecha.
                        return `<div class="${statusClass} flex justify-between items-center gap-4">
                                    <span class="font-semibold truncate">${source.number}:</span>
                                    <span class="font-bold flex-shrink-0">${formatNumber(source.quantity)}</span>
                                </div>`;
                    }).join('');
                } else {
                    tooltipContent = 'Sin ingresos esta semana';
                }


                const incomeCellContent = res.incoming > 0 ? `+${formatNumber(Math.round(res.incoming))}` : '0';

                tableHTML += `
                    <tr class="bg-white even:bg-slate-50">
                        <td class="px-3 py-2 font-medium text-slate-900 whitespace-nowrap text-center">${res.week}</td>
                        <td class="px-3 py-2 text-center">${formatNumber(Math.round(res.startStock))}</td>
                        <td class="px-3 py-2 text-center ${incomeCellClass}">
                            <div class="tooltip-container">
                                ${incomeCellContent}
                                <span class="tooltip-text">${tooltipContent}</span>
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center text-red-600 font-medium">-${formatNumber(Math.round(res.consumption))}</td>
                        <td class="px-3 py-2 text-center font-bold">${formatNumber(Math.round(res.endStock))}</td>
                        <td class="px-3 py-2 text-center ${coverageClass}">${res.coverage === Infinity ? '∞' : Math.round(res.coverage)}</td>
                    </tr>`;
            });

            tableHTML += '</tbody></table></div>';
            
            if (!simulationShowAllWeeks && results.length > 12) {
                tableHTML += `
                <div class="text-center mt-4">
                    <button id="show-all-sim-weeks-btn" class="btn-main-style !text-indigo-600 hover:!bg-indigo-50 !border-indigo-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m6 9 6 6 6-6"/></svg>
                        Ver más semanas
                    </button>
                </div>`;
            }

            resultsContainer.innerHTML = tableHTML;
            renderSimulatedIncomesList();

            const showMoreBtn = document.getElementById('show-all-sim-weeks-btn');
            if (showMoreBtn) {
                showMoreBtn.addEventListener('click', () => {
                    simulationShowAllWeeks = true;
                    runAndRenderSimulation();
                });
            }
        }

        function handleExportSimulation() {
            const results = runSimulation();
            if (results.length === 0) {
                showToast('No hay datos de simulación para exportar.', 'error');
                return;
            }

            const primaryItem = getProcessedItems().find(i => i.id === selectedConsumptionItemId);
            if (!primaryItem) return;

            const cleanItemName = primaryItem.name.replace(new RegExp(`^${primaryItem.code}\\s*`), '');

            // --- Datos para la tabla principal (lado izquierdo) ---
            const mainTable = [];
            mainTable.push([
                'Semana',
                'Stock Inicial',
                'Ingresos Detallados',
                'Consumo Proyectado',
                'Stock Final',
                'Cobertura Final (días)'
            ]);

            results.forEach(res => {
                const incomeDetails = res.incomingSources.length > 0
                    ? res.incomingSources.map(s => `${s.number}: ${formatNumber(s.quantity)}`).join('; ')
                    : '0';
                mainTable.push([
                    res.week,
                    Math.round(res.startStock),
                    incomeDetails,
                    Math.round(res.consumption),
                    Math.round(res.endStock),
                    res.coverage === Infinity ? '∞' : Math.round(res.coverage)
                ]);
            });

            // --- Datos para el panel de detalles (lado derecho) ---
            const sidePanel = [];
            sidePanel.push(['Fecha de Generación:', getCurrentDateString()]);
            sidePanel.push([]); // Fila vacía
            sidePanel.push(['Detalles del Insumo']);
            sidePanel.push(['Código:', primaryItem.code]);
            sidePanel.push(['Nombre:', cleanItemName]);
            sidePanel.push(['Stock Actual (Simulado):', document.getElementById('sim-stock').value]);
            sidePanel.push(['Consumo Mensual (Simulado):', document.getElementById('sim-consumption').value]);

            const todayRaw = new Date();
            const today = new Date(Date.UTC(todayRaw.getFullYear(), todayRaw.getMonth(), todayRaw.getDate()));
            const allItemOcs = ocs.filter(oc => oc.codigo === primaryItem.code);
            const overdueOcs = allItemOcs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                const status = transformOCStatus(oc.status);
                return deliveryDate && deliveryDate < today && status !== 'Rechazada';
            });

            if (overdueOcs.length > 0) {
                sidePanel.push([]); // Fila vacía para separar
                sidePanel.push(['ÓRDENES DE COMPRA VENCIDAS (NO SIMULADAS)']);
                sidePanel.push(['O/C', 'Cantidad', 'Fecha Vencimiento']);
                overdueOcs.forEach(oc => {
                    sidePanel.push([
                        oc.ordenDeCompra,
                        oc.cantEntregaSiguiente,
                        formatDate(oc.proxFechaEntrega)
                    ]);
                });
            }

            // --- Combinar tabla principal y panel lateral en una sola hoja ---
            const combinedData = [];
            const maxRows = Math.max(mainTable.length, sidePanel.length);

            for (let i = 0; i < maxRows; i++) {
                const mainRow = mainTable[i] || Array(6).fill(''); // 6 columnas para la tabla principal
                const sideRow = sidePanel[i] || [];
                // Añadir una columna vacía como separador
                combinedData.push([...mainRow, '', ...sideRow]);
            }

            const worksheet = XLSX.utils.aoa_to_sheet(combinedData);

            // Añadir merge para el título de las O/C vencidas si existe
            const overdueTitleRowIndex = sidePanel.findIndex(row => row[0] === 'ÓRDENES DE COMPRA VENCIDAS (NO SIMULADAS)');
            if (overdueTitleRowIndex !== -1) {
                if (!worksheet['!merges']) worksheet['!merges'] = [];
                // El merge será desde la columna H (7) hasta la J (9) en la fila correspondiente
                worksheet['!merges'].push({
                    s: { r: overdueTitleRowIndex, c: 7 }, // Start cell (col H)
                    e: { r: overdueTitleRowIndex, c: 9 }  // End cell (col J)
                });
            }

            // Anchos de columna
            worksheet['!cols'] = [
                { wch: 15 }, // A: Semana
                { wch: 15 }, // B: Stock Inicial
                { wch: 45 }, // C: Ingresos Detallados
                { wch: 20 }, // D: Consumo
                { wch: 15 }, // E: Stock Final
                { wch: 25 }, // F: Cobertura
                { wch: 5 },  // G: Separador
                { wch: 30 }, // H: Etiquetas panel / O/C
                { wch: 15 }, // I: Valores panel / Cantidad
                { wch: 20 }  // J: (vacío) / Fecha Vencimiento
            ];

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Simulacion');
            
            const materialName = cleanItemName.replace(/[\s/]+/g, '_').toLowerCase();
            const filename = `Simulacion_${primaryItem.code}_${materialName}_${getCurrentDateString()}.xlsx`;
            XLSX.writeFile(workbook, filename);
            showToast(`Simulación exportada como ${filename}`, 'success');
        }

        function renderSimulatedIncomesList() {
            const listContainer = document.getElementById('simulated-incomes-list');
            if (!listContainer) return;

            if (simulatedIncomes.length === 0) {
                listContainer.innerHTML = '';
                return;
            }

            simulatedIncomes.sort((a,b) => a.weekId.localeCompare(b.weekId));

            listContainer.innerHTML = `
                <ul class="space-y-1 mt-2">
                    ${simulatedIncomes.map(income => {
                        const weekNumber = parseInt(income.weekId.split('-')[1], 10);
                        const displayName = income.name ? `<strong>${income.name}</strong>` : `Ingreso <strong>SIM-${income.seqNumber}</strong>`;
                        return `
                        <li class="flex justify-between items-center p-2 bg-indigo-50 rounded-md cursor-pointer hover:bg-indigo-100 sim-income-item transition-colors" data-week-id="${income.weekId}">
                            <span>${displayName} de <strong>${formatNumber(income.quantity)}</strong> en Semana <strong>${weekNumber}</strong></span>
                            <button class="remove-sim-income-btn p-1 text-red-400 hover:text-red-600 rounded-full hover:bg-red-100" data-week-id="${income.weekId}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </li>
                        `
                    }).join('')}
                </ul>
            `;
            
            document.querySelectorAll('.remove-sim-income-btn').forEach(btn => {
                btn.addEventListener('click', handleRemoveSimulatedIncome);
            });
            document.querySelectorAll('.sim-income-item').forEach(item => {
                item.addEventListener('click', handleEditSimulatedIncome);
            });
        }

        function handleEditSimulatedIncome(e) {
            // No activar edición si se hizo clic en el botón de eliminar
            if (e.target.closest('.remove-sim-income-btn')) {
                return;
            }

            const weekIdToEdit = e.currentTarget.dataset.weekId;
            const incomeToEdit = simulatedIncomes.find(inc => inc.weekId === weekIdToEdit);

            if (!incomeToEdit) return;

            editingSimulatedIncomeWeekId = weekIdToEdit;

            document.getElementById('sim-income-name').value = incomeToEdit.name || '';
            document.getElementById('sim-income-qty').value = formatNumber(incomeToEdit.quantity);
            document.getElementById('sim-income-week').value = incomeToEdit.weekId;

            const addButton = document.getElementById('add-sim-income-btn');
            addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`; // Icono de Check
            addButton.classList.remove('!bg-indigo-600', 'hover:!bg-indigo-700');
            addButton.classList.add('!bg-green-600', 'hover:!bg-green-700');
            document.getElementById('sim-income-qty').focus();
        }

        function resetSimulatedIncomeForm() {
            editingSimulatedIncomeWeekId = null;
            document.getElementById('sim-income-qty').value = '';
            document.getElementById('sim-income-name').value = '';
            
            const addButton = document.getElementById('add-sim-income-btn');
            addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`; // Icono de Más
            addButton.classList.remove('!bg-green-600', 'hover:!bg-green-700');
            addButton.classList.add('!bg-indigo-600', 'hover:!bg-indigo-700');
        }

        function handleAddSimulatedIncome() {
            const qtyInput = document.getElementById('sim-income-qty');
            const weekSelect = document.getElementById('sim-income-week');
            const nameInput = document.getElementById('sim-income-name');
            
            const quantity = parseInt(String(qtyInput.value).replace(/\./g, ''), 10);
            const newWeekId = weekSelect.value;
            const name = nameInput.value.trim();

            if (isNaN(quantity) || quantity === 0 || !newWeekId) {
                showToast('Por favor, ingrese una cantidad válida (distinta de cero) y seleccione una semana.', 'error');
                return;
            }
            
            let seqNumberToUse;

            // Si estamos en modo edición, buscamos el número de secuencia original
            if (editingSimulatedIncomeWeekId) {
                const originalIncome = simulatedIncomes.find(inc => inc.weekId === editingSimulatedIncomeWeekId);
                if (originalIncome) {
                    seqNumberToUse = originalIncome.seqNumber;
                } else {
                    // Como fallback, si no lo encuentra, usa el contador
                    seqNumberToUse = simulatedIncomeCounter++;
                }
                // Eliminamos el registro original
                simulatedIncomes = simulatedIncomes.filter(inc => inc.weekId !== editingSimulatedIncomeWeekId);
            } else {
                // Si no es edición, usamos el contador y lo incrementamos
                seqNumberToUse = simulatedIncomeCounter++;
            }
            
            // También eliminamos cualquier registro existente para la *nueva* semana, para evitar duplicados.
            // Esto es importante si el usuario cambia la semana de un ingreso existente.
            simulatedIncomes = simulatedIncomes.filter(inc => inc.weekId !== newWeekId);
            
            // Añadimos el registro nuevo/actualizado con el número de secuencia correcto
            simulatedIncomes.push({ weekId: newWeekId, quantity, name, seqNumber: seqNumberToUse });

            resetSimulatedIncomeForm();
            runAndRenderSimulation();
        }

        function handleRemoveSimulatedIncome(e) {
            e.stopPropagation(); // Prevenir que el evento active la edición del elemento padre (li)
            const weekIdToRemove = e.currentTarget.dataset.weekId;
            simulatedIncomes = simulatedIncomes.filter(inc => inc.weekId !== weekIdToRemove);
            
            if(editingSimulatedIncomeWeekId === weekIdToRemove) {
                resetSimulatedIncomeForm();
            }

            runAndRenderSimulation();
        }

        // --- LÓGICA DE LA PESTAÑA SOLPEDS Y OCs ---
        function handleSolpedsSort(key) {
            if (solpedsSortConfig.key === key) {
                solpedsSortConfig.direction = solpedsSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                solpedsSortConfig.key = key;
                solpedsSortConfig.direction = 'asc';
            }
            renderSolpedsView();
        }
        function handleOCsSort(key) {
            if (ocsSortConfig.key === key) {
                ocsSortConfig.direction = ocsSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                ocsSortConfig.key = key;
                ocsSortConfig.direction = 'asc';
            }
            renderOCsView();
        }
        function renderSolpedsView() {
            const container = document.getElementById('solpeds-table-container');
            const searchInput = document.getElementById('solpeds-search-input');
            const delayedFilterBtn = document.getElementById('solpeds-delayed-filter-btn');
            const searchTerm = searchInput.value.toLowerCase();
            const groupFilterContainer = document.getElementById('solpeds-group-filter-container');
            const dateFilterContainer = document.getElementById('solpeds-date-filter-container');
            const clearFiltersBtn = document.getElementById('solpeds-clear-filters-btn');

            const isAnyFilterActive = showOnlyDelayedSolpeds || solpedsSelectedGroup !== 'all' || solpedsSelectedYear !== 'all' || solpedsSelectedMonths.length > 0 || searchTerm !== '';
            if (clearFiltersBtn) {
                clearFiltersBtn.classList.toggle('hidden', !isAnyFilterActive);
                if (isAnyFilterActive) {
                    clearFiltersBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                } else {
                    clearFiltersBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                }
            }

            delayedFilterBtn.classList.toggle('bg-red-200', showOnlyDelayedSolpeds);
            delayedFilterBtn.classList.toggle('border-red-400', showOnlyDelayedSolpeds);
            delayedFilterBtn.classList.toggle('text-red-800', showOnlyDelayedSolpeds);

            if (solpeds.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No hay datos de Solpeds. Precarga un archivo para visualizarlos.</p>';
                dateFilterContainer.innerHTML = '';
                groupFilterContainer.innerHTML = '';
                return;
            }

            const uniqueGroups = [...new Set(solpeds.map(s => s.grupoDeArticulos).filter(Boolean))].sort();
            if (uniqueGroups.length > 0) {
                let groupFilterHTML = `<select id="solpeds-group-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === solpedsSelectedGroup ? 'selected' : '';
                    groupFilterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                groupFilterHTML += `</select>`;
                groupFilterContainer.innerHTML = groupFilterHTML;
            } else {
                groupFilterContainer.innerHTML = '';
            }

            const allYears = [...new Set(solpeds.map(s => s.fechaLiberacion ? s.fechaLiberacion.substring(0, 4) : null).filter(Boolean))].sort((a, b) => b - a);

            let yearButtonsHTML = '<div class="flex items-center p-0.5 bg-indigo-600 rounded-lg">';
            yearButtonsHTML += `<button class="solpeds-year-btn indice-coverage-btn ${solpedsSelectedYear === 'all' ? 'active' : ''}" data-year="all">Todos</button>`;
            allYears.forEach(year => {
                yearButtonsHTML += `<button class="solpeds-year-btn indice-coverage-btn ${solpedsSelectedYear === year ? 'active' : ''}" data-year="${year}">${year}</button>`;
            });
            yearButtonsHTML += '</div>';

            let monthDropdownHTML = '<div id="solpeds-month-filter-dropdown" class="relative ml-2">';
            let monthButtonText = 'Seleccione Año';
            let monthButtonDisabled = 'disabled';
            let monthPanelContent = '';

            if (solpedsSelectedYear !== 'all') {
                monthButtonDisabled = '';
                const monthsInYear = [...new Set(solpeds
                    .filter(s => s.fechaLiberacion && s.fechaLiberacion.startsWith(solpedsSelectedYear))
                    .map(s => s.fechaLiberacion.substring(5, 7))
                )].sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

                if (monthsInYear.length > 0) {
                    if (solpedsSelectedMonths.length === 0 || solpedsSelectedMonths.length === monthsInYear.length) {
                        monthButtonText = 'Todos los Meses';
                    } else {
                        monthButtonText = `${solpedsSelectedMonths.length} Mes(es) Seleccionado(s)`;
                    }

                    monthPanelContent = monthsInYear.map(monthNum => {
                        const date = new Date(solpedsSelectedYear, parseInt(monthNum, 10) - 1);
                        let monthName = date.toLocaleString('es-AR', { month: 'long', timeZone: 'UTC' });
                        monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                        const isChecked = solpedsSelectedMonths.includes(monthNum);
                        return `
                            <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-100">
                                <input type="checkbox" class="solpeds-month-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="${monthNum}" ${isChecked ? 'checked' : ''}>
                                <span class="text-sm">${monthNum} - ${monthName}</span>
                            </label>`;
                    }).join('');
                } else {
                     monthButtonText = 'Sin Meses';
                     monthButtonDisabled = 'disabled';
                }
            }

            monthDropdownHTML += `<button id="solpeds-month-filter-btn" class="btn-main-style w-48 text-left justify-start" ${monthButtonDisabled}>${monthButtonText}</button>`;
            monthDropdownHTML += `<div id="solpeds-month-filter-panel" class="hidden absolute top-full left-0 mt-1 bg-white border rounded-lg shadow-lg z-30 p-2 space-y-1 w-48 max-h-60 overflow-y-auto">${monthPanelContent}</div>`;
            monthDropdownHTML += `</div>`;
            
            dateFilterContainer.innerHTML = yearButtonsHTML + monthDropdownHTML;


            const itemsByCode = new Map(items.map(item => [item.code, item.id]));

            let filteredSolpeds = solpeds;

            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredSolpeds = filteredSolpeds.filter(s => {
                    const searchableText = [
                        s.solicitud, s.cod, s.descripcion, s.creadoPor, s.grupoDeCompras, s.grupoDeArticulos
                    ].join(' ').toLowerCase();
                    return searchWords.every(word => searchableText.includes(word));
                });
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (showOnlyDelayedSolpeds) {
                filteredSolpeds = filteredSolpeds.filter(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    return releaseDate && releaseDate <= today;
                });
            }

            if (solpedsSelectedGroup !== 'all') {
                filteredSolpeds = filteredSolpeds.filter(s => s.grupoDeArticulos === solpedsSelectedGroup);
            }

            if (solpedsSelectedYear !== 'all') {
                filteredSolpeds = filteredSolpeds.filter(s => s.fechaLiberacion && s.fechaLiberacion.startsWith(solpedsSelectedYear));
                if (solpedsSelectedMonths.length > 0) {
                    filteredSolpeds = filteredSolpeds.filter(s => {
                        if (!s.fechaLiberacion) return false;
                        const month = s.fechaLiberacion.substring(5, 7);
                        return solpedsSelectedMonths.includes(month);
                    });
                }
            }

            const solpedsCounterEl = document.getElementById('solpeds-counter');
            if (solpedsCounterEl) {
                solpedsCounterEl.textContent = `(${filteredSolpeds.length} de ${solpeds.length})`;
            }

            filteredSolpeds.sort((a, b) => {
                const key = solpedsSortConfig.key;
                const dir = solpedsSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                if (key === 'cantidad') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else if (key === 'fechaSolicitud' || key === 'fechaLiberacion') {
                    valA = parseDateString(valA)?.getTime() || 0;
                    valB = parseDateString(valB)?.getTime() || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });

            if (filteredSolpeds.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No se encontraron resultados para tu búsqueda.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'diasDesdeCreacion', label: 'DÍAS ACTIVA', noSort: true, class: 'text-center' },
                { key: 'creadoPor', label: 'CREADO POR' }, { key: 'solicitud', label: 'SOLICITUD' },
                { key: 'fechaSolicitud', label: 'FECHA SOL.' }, { key: 'status', label: 'STATUS', noSort: true, class: 'text-center' },
                { key: 'grupoDeArticulos', label: 'GRUPO ARTÍCULOS' },
                { key: 'cod', label: 'CÓDIGO' }, { key: 'descripcion', label: 'DESCRIPCIÓN' },
                { key: 'cantidad', label: 'CANTIDAD', class: 'justify-end' },
                { key: 'grupoDeCompras', label: 'GRUPO COMPRAS' },
                { key: 'fechaLiberacion', label: 'FECHA LIBERACIÓN' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = !h.noSort && solpedsSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                const thClass = `px-4 py-3 ${h.class && !h.noSort ? 'text-left' : h.class || ''} ${headerClasses}`;

                if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thClass}">${h.label}</th>`;
                } else {
                    const buttonClasses = `table-sort-button ${h.class || ''} ${isSortingKey ? 'active ' + solpedsSortConfig.direction : ''}`;
                    const sortIcon = isSortingKey ? sortIconSVG : '';
                    tableHTML += `<th scope="col" class="${thClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredSolpeds.forEach(s => {
                const itemId = itemsByCode.get(s.cod);
                
                const creationDate = parseDateString(s.fechaSolicitud);
                let daysActive = '';
                if (creationDate) {
                    daysActive = daysBetween(creationDate, today);
                }
                
                const releaseDate = parseDateString(s.fechaLiberacion);
                const isDelayed = releaseDate && releaseDate <= today;
                let rowClass = isDelayed ? 'bg-red-100 hover:bg-red-200 text-red-900' : 'hover:bg-indigo-50 even:bg-slate-50';
                if (itemId) rowClass += ' cursor-pointer solped-item-row';
                const dateClass = isDelayed ? 'font-bold' : '';

                tableHTML += `<tr class="border-b ${rowClass}" ${itemId ? `data-item-id="${itemId}"` : ''}>
                    <td class="px-4 py-3 text-center font-bold">${daysActive}</td>
                    <td class="px-4 py-3">${s.creadoPor}</td>
                    <td class="px-4 py-3 font-medium text-slate-900">${s.solicitud}</td>
                    <td class="px-4 py-3">${formatDate(s.fechaSolicitud)}</td>
                    <td class="px-4 py-3 text-center">${s.status}</td>
                    <td class="px-4 py-3">${extractGroupCode(s.grupoDeArticulos) || ''}</td>
                    <td class="px-4 py-3">${s.cod}</td>
                    <td class="px-4 py-3">${s.descripcion}</td>
                    <td class="px-4 py-3 text-right">${formatNumber(s.cantidad)}</td>
                    <td class="px-4 py-3">${s.grupoDeCompras || ''}</td>
                    <td class="px-4 py-3 ${dateClass}">${formatDate(s.fechaLiberacion)}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
        }

        function renderOCsView() {
            const container = document.getElementById('ocs-table-container');
            const searchInput = document.getElementById('ocs-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const delayedFilterBtn = document.getElementById('ocs-delayed-filter-btn');
            const groupFilterContainer = document.getElementById('ocs-group-filter-container');
            const statusFilterContainer = document.getElementById('ocs-status-filter-container');
            const dateFilterContainer = document.getElementById('ocs-date-filter-container');
            const clearFiltersBtn = document.getElementById('ocs-clear-filters-btn');

            const isAnyFilterActive = showOnlyDelayedOCs || ocsSelectedGroup !== 'all' || ocsSelectedStatus !== 'all' || ocsSelectedYear !== 'all' || ocsSelectedMonths.length > 0 || searchTerm !== '';
            if (clearFiltersBtn) {
                clearFiltersBtn.classList.toggle('hidden', !isAnyFilterActive);
                if (isAnyFilterActive) {
                    clearFiltersBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                } else {
                    clearFiltersBtn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-200');
                }
            }

            delayedFilterBtn.classList.toggle('bg-red-200', showOnlyDelayedOCs);
            delayedFilterBtn.classList.toggle('border-red-400', showOnlyDelayedOCs);
            delayedFilterBtn.classList.toggle('text-red-800', showOnlyDelayedOCs);

            if (ocs.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No hay datos de O/C. Precarga un archivo para visualizarlos.</p>';
                dateFilterContainer.innerHTML = '';
                groupFilterContainer.innerHTML = '';
                statusFilterContainer.innerHTML = '';
                return;
            }

            const uniqueGroups = [...new Set(ocs.map(oc => extractGroupCodeAbbr(oc.grupoDeArticulos)).filter(Boolean))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="ocs-group-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === ocsSelectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
            } else {
                groupFilterContainer.innerHTML = '';
            }

            // --- Lógica del filtro de Fecha (Año y Mes) ---
            const allYears = [...new Set(ocs.map(oc => oc.proxFechaEntrega ? oc.proxFechaEntrega.substring(0, 4) : null).filter(Boolean))].sort((a, b) => b - a);

            let yearButtonsHTML = '<div class="flex items-center p-0.5 bg-indigo-600 rounded-lg">';
            yearButtonsHTML += `<button class="ocs-year-btn indice-coverage-btn ${ocsSelectedYear === 'all' ? 'active' : ''}" data-year="all">Todos</button>`;
            allYears.forEach(year => {
                yearButtonsHTML += `<button class="ocs-year-btn indice-coverage-btn ${ocsSelectedYear === year ? 'active' : ''}" data-year="${year}">${year}</button>`;
            });
            yearButtonsHTML += '</div>';

            let monthDropdownHTML = '<div id="ocs-month-filter-dropdown" class="relative ml-2">';
            let monthButtonText = 'Seleccione Año';
            let monthButtonDisabled = 'disabled';
            let monthPanelContent = '';

            if (ocsSelectedYear !== 'all') {
                monthButtonDisabled = '';
                const monthsInYear = [...new Set(ocs
                    .filter(oc => oc.proxFechaEntrega && oc.proxFechaEntrega.startsWith(ocsSelectedYear))
                    .map(oc => oc.proxFechaEntrega.substring(5, 7))
                )].sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

                if (monthsInYear.length > 0) {
                    if (ocsSelectedMonths.length === 0 || ocsSelectedMonths.length === monthsInYear.length) {
                        monthButtonText = 'Todos los Meses';
                    } else {
                        monthButtonText = `${ocsSelectedMonths.length} Mes(es) Seleccionado(s)`;
                    }

                    monthPanelContent = monthsInYear.map(monthNum => {
                        const date = new Date(ocsSelectedYear, parseInt(monthNum, 10) - 1);
                        let monthName = date.toLocaleString('es-AR', { month: 'long', timeZone: 'UTC' });
                        monthName = monthName.charAt(0).toUpperCase() + monthName.slice(1);
                        const isChecked = ocsSelectedMonths.includes(monthNum);
                        return `
                            <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-slate-100">
                                <input type="checkbox" class="ocs-month-checkbox h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" value="${monthNum}" ${isChecked ? 'checked' : ''}>
                                <span class="text-sm">${monthNum} - ${monthName}</span>
                            </label>`;
                    }).join('');
                } else {
                     monthButtonText = 'Sin Meses';
                     monthButtonDisabled = 'disabled';
                }
            }

            monthDropdownHTML += `<button id="ocs-month-filter-btn" class="btn-main-style w-48 text-left justify-start" ${monthButtonDisabled}>${monthButtonText}</button>`;
            monthDropdownHTML += `<div id="ocs-month-filter-panel" class="hidden absolute top-full left-0 mt-1 bg-white border rounded-lg shadow-lg z-30 p-2 space-y-1 w-48 max-h-60 overflow-y-auto">${monthPanelContent}</div>`;
            monthDropdownHTML += `</div>`;
            
            dateFilterContainer.innerHTML = yearButtonsHTML + monthDropdownHTML;


            const uniqueStatuses = [...new Set(ocs.map(oc => transformOCStatus(oc.status)).filter(Boolean))].sort();
            if (uniqueStatuses.length > 0) {
                let statusFilterHTML = `<select id="ocs-status-filter" class="bg-white border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 h-9"><option value="all">TODOS LOS STATUS</option>`;
                uniqueStatuses.forEach(status => {
                    const selected = status === ocsSelectedStatus ? 'selected' : '';
                    statusFilterHTML += `<option value="${status}" ${selected}>${status}</option>`;
                });
                statusFilterHTML += `</select>`;
                statusFilterContainer.innerHTML = statusFilterHTML;
            } else {
                statusFilterContainer.innerHTML = '';
            }

            const itemsByCode = new Map(items.map(item => [item.code, item.id]));

            let filteredOCs = ocs;

            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredOCs = filteredOCs.filter(oc => {
                    const searchableText = [
                        oc.solped, oc.ordenDeCompra, oc.codigo, oc.denominacion, oc.grupoDeArticulos, oc.grupoDeCompras, oc.status
                    ].join(' ').toLowerCase();
                    return searchWords.every(word => searchableText.includes(word));
                });
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (showOnlyDelayedOCs) {
                filteredOCs = filteredOCs.filter(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    return deliveryDate && deliveryDate < today;
                });
            }

            if (ocsSelectedGroup !== 'all') {
                filteredOCs = filteredOCs.filter(oc => extractGroupCodeAbbr(oc.grupoDeArticulos) === ocsSelectedGroup);
            }
            
            if (ocsSelectedStatus !== 'all') {
                filteredOCs = filteredOCs.filter(oc => transformOCStatus(oc.status) === ocsSelectedStatus);
            }

            if (ocsSelectedYear !== 'all') {
                filteredOCs = filteredOCs.filter(oc => oc.proxFechaEntrega && oc.proxFechaEntrega.startsWith(ocsSelectedYear));
                if (ocsSelectedMonths.length > 0) {
                    filteredOCs = filteredOCs.filter(oc => {
                        if (!oc.proxFechaEntrega) return false;
                        const month = oc.proxFechaEntrega.substring(5, 7);
                        return ocsSelectedMonths.includes(month);
                    });
                }
            }

            const ocsCounterEl = document.getElementById('ocs-counter');
            if (ocsCounterEl) {
                ocsCounterEl.textContent = `(${filteredOCs.length} de ${ocs.length})`;
            }

            filteredOCs.sort((a, b) => {
                const key = ocsSortConfig.key;
                const dir = ocsSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';

                if (['cantEntregaSiguiente', 'posicion'].includes(key)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else if (key === 'proxFechaEntrega') {
                    valA = parseDateString(valA)?.getTime() || 0;
                    valB = parseDateString(valB)?.getTime() || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });


            if (filteredOCs.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-10">No se encontraron resultados para tu búsqueda.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24" 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'diasParaEntrega', label: 'DÍAS ENTREGA', noSort: true, class: 'text-center' },
                { key: 'solped', label: 'SOLPED' }, 
                { key: 'ordenDeCompra', label: 'O/C' },
                { key: 'posicion', label: 'POS.' }, 
                { key: 'proxFechaEntrega', label: 'PRÓX. ENTREGA' },
                { key: 'semanaEntrega', label: 'SEMANA', noSort: true, class: 'text-center' },
                { key: 'grupoDeArticulos', label: 'GRUPO ARTÍCULOS' },
                { key: 'codigo', label: 'CÓDIGO' },
                { key: 'denominacion', label: 'DENOMINACIÓN' }, 
                { key: 'cantEntregaSiguiente', label: 'CANT. ENTREGA', class: 'justify-end' },
                { key: 'grupoDeCompras', label: 'GRUPO COMPRAS' }, 
                { key: 'status', label: 'STATUS' }
            ];

            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = !h.noSort && ocsSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                const thClass = `px-4 py-3 ${h.class && !h.noSort ? 'text-left' : h.class || ''} ${headerClasses}`;

                if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thClass}">${h.label}</th>`;
                } else {
                    const buttonClasses = `table-sort-button ${h.class || ''} ${isSortingKey ? 'active ' + ocsSortConfig.direction : ''}`;
                    const sortIcon = isSortingKey ? sortIconSVG : '';
                    tableHTML += `<th scope="col" class="${thClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredOCs.forEach(oc => {
                const itemId = itemsByCode.get(oc.codigo);
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                let weekNumber = '';
                if (deliveryDate) {
                    // Extraer solo el número de la semana y quitar ceros a la izquierda
                    weekNumber = getWeekId(deliveryDate).split('-')[1].replace(/^0+/, '');
                }
                let daysToDelivery = '';
                let daysClass = '';
                 if (deliveryDate) {
                       const diff = daysBetween(today, deliveryDate);
                       daysToDelivery = diff;
                       if (diff < 0) {
                             daysClass = 'text-red-600'; // Delayed
                       } else if (diff <= 7) {
                             daysClass = 'text-yellow-600'; // Upcoming
                       }
                 }
                const isDelayed = deliveryDate && deliveryDate < today;
                const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                const transformedStatus = transformOCStatus(oc.status);

                let rowClass = 'border-b hover:bg-indigo-50 even:bg-slate-50';
                if (itemId) rowClass += ' cursor-pointer oc-item-row';
                if (oc.status && oc.status.toLowerCase().includes('en proceso de autorización')) {
                    rowClass += ' bg-yellow-100 hover:bg-yellow-200';
                }
                if (oc.status && oc.status.toLowerCase().includes('rechazado')) {
                    rowClass += ' bg-red-100 hover:bg-red-200 text-red-900';
                }

                tableHTML += `<tr class="${rowClass}" ${itemId ? `data-item-id="${itemId}"` : ''}>
                    <td class="px-4 py-3 text-center font-bold ${daysClass}">${daysToDelivery}</td>
                    <td class="px-4 py-3">${oc.solped}</td>
                    <td class="px-4 py-3 font-medium">${oc.ordenDeCompra}</td>
                    <td class="px-4 py-3">${oc.posicion}</td>
                    <td class="px-4 py-3 ${dateClass}">${formatDate(oc.proxFechaEntrega)}</td>
                    <td class="px-4 py-3 text-center">${weekNumber}</td>
                    <td class="px-4 py-3">${extractGroupCodeAbbr(oc.grupoDeArticulos)}</td>
                    <td class="px-4 py-3">${oc.codigo}</td>
                    <td class="px-4 py-3">${oc.denominacion}</td>
                    <td class="px-4 py-3 text-right font-bold">${formatNumber(oc.cantEntregaSiguiente)}</td>
                    <td class="px-4 py-3">${extractGroupCode(oc.grupoDeCompras)}</td>
                    <td class="px-4 py-3">${transformedStatus}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
        }

        // --- LÓGICA DE LA PESTAÑA REPORTES ---
        function renderReportesView() {
            renderImmobilizedStockReport();
        }

        function renderImmobilizedStockReport() {
            const container = document.getElementById('immobilized-stock-table-container');
            const searchInput = document.getElementById('immobilized-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const immobilizationMonths = appSettings.immobilizationMonths;

            let processedItems = getProcessedItems().map(item => {
                let monthsWithoutConsumption = 0;
                if (item.consumos) {
                    for (let i = item.consumos.length - 1; i >= 0; i--) {
                        if (item.consumos[i] === 0) {
                            monthsWithoutConsumption++;
                        } else {
                            break;
                        }
                    }
                }
                return { ...item, monthsWithoutConsumption };
            });
            
            let immobilizedItems = processedItems.filter(item => 
                item.stock > 0 && item.monthsWithoutConsumption >= immobilizationMonths
            );
            
            if(searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                immobilizedItems = immobilizedItems.filter(item => {
                    const textToSearch = `${item.name} ${item.group}`.toLowerCase();
                    return searchWords.every(word => textToSearch.includes(word));
                });
            }

            const immobilizedCounterEl = document.getElementById('immobilized-counter');
            if (immobilizedCounterEl) {
                immobilizedCounterEl.textContent = `(${immobilizedItems.length} items encontrados)`;
            }

            immobilizedItems.sort((a, b) => {
                const key = immobilizedSortConfig.key;
                const dir = immobilizedSortConfig.direction === 'asc' ? 1 : -1;

                if (key === 'name') {
                    const nameA = a.name.replace(new RegExp(`^${a.code}\\s*`), '').toLowerCase();
                    const nameB = b.name.replace(new RegExp(`^${b.code}\\s*`), '').toLowerCase();
                    return nameA.localeCompare(nameB) * dir;
                }
                
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                
                if (key === 'stock' || key === 'monthsWithoutConsumption') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return (valA - valB) * dir;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                    return valA.localeCompare(valB) * dir;
                }
            });
            
            if (immobilizedItems.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-10">No se encontraron insumos con stock inmovilizado por ${immobilizationMonths} o más meses.</p>`;
                return;
            }

            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'group', label: 'GRUPO' },
                { key: 'code', label: 'CÓDIGO' },
                { key: 'name', label: 'MATERIAL' },
                { key: 'stock', label: 'STOCK ACTUAL', class: 'justify-end' },
                { key: 'monthsWithoutConsumption', label: 'MESES SIN CONSUMO', class: 'justify-end' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0 z-10" style="box-shadow: 0 2px 0 #a5b4fc;"><tr>`;
            headers.forEach(h => {
                const isSortingKey = immobilizedSortConfig.key === h.key;
                const headerClasses = isSortingKey ? 'bg-indigo-500 text-white' : '';
                const thClass = `px-4 py-2 ${h.class || ''} ${headerClasses}`;
                const buttonClasses = `table-sort-button ${h.class || ''} ${isSortingKey ? 'active ' + immobilizedSortConfig.direction : ''}`;
                const sortIcon = isSortingKey ? sortIconSVG : '';
                tableHTML += `<th scope="col" class="${thClass}"><button class="${buttonClasses}" data-sort="${h.key}">${h.label}${sortIcon}</button></th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            immobilizedItems.forEach(item => {
                 tableHTML += `<tr class="border-b hover:bg-slate-100 even:bg-slate-50 cursor-pointer report-item-row" data-item-id="${item.id}">
                    <td class="px-4 py-2">${item.group}</td>
                    <td class="px-4 py-2">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-slate-900">${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatNumber(item.stock)}</td>
                    <td class="px-4 py-2 text-right font-bold text-red-600">${item.monthsWithoutConsumption}</td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;

        }
        
        function renderPeakConsumptionReport() {
            const container = document.getElementById('peak-consumption-table-container');
            const searchInput = document.getElementById('peak-consumption-search-input');
            const searchTerm = searchInput.value.toLowerCase();

            let peakItems = getProcessedItems().filter(item => {
                if (!item.consumos || item.consumos.length < 12) return false;
                
                const previousMonthConsumption = item.consumos[10]; // M11
                if (previousMonthConsumption <= 0) return false;

                const peakInHistory = Math.max(...item.consumos);
                
                return previousMonthConsumption === peakInHistory;

            }).map(item => ({
                ...item,
                peakConsumption: item.consumos[10],
                currentConsumption: item.consumos[11]
            }));

            if(searchTerm) {
                 peakItems = peakItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.group.toLowerCase().includes(searchTerm)
                );
            }

            const counterEl = document.getElementById('peak-consumption-counter');
            if (counterEl) {
                counterEl.textContent = `(${peakItems.length} items encontrados)`;
            }

            peakItems.sort((a, b) => {
                const key = peakConsumptionSortConfig.key;
                const dir = peakConsumptionSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? 0;
                let valB = b[key] ?? 0;
                
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });
            
            if (peakItems.length === 0) {
                container.innerHTML = `<p class="text-center text-slate-500 py-10">No se encontraron insumos con pico de consumo el mes anterior (M11).</p>`;
                return;
            }

            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'group', label: 'Grupo' },
                { key: 'code', label: 'Código' },
                { key: 'name', label: 'Material' },
                { key: 'peakConsumption', label: 'Consumo Pico (Mes Anterior)', class: 'justify-end' },
                { key: 'currentConsumption', label: 'Consumo Mes Actual', class: 'justify-end' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0"><tr>`;
            headers.forEach(h => {
                const thClass = `px-4 py-2 ${h.class || ''}`;
                tableHTML += `<th scope="col" class="${thClass}"><button class="table-sort-button ${h.class || ''}" data-sort="${h.key}">${h.label}</button></th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            peakItems.forEach(item => {
                 tableHTML += `<tr class="border-b hover:bg-slate-100 even:bg-slate-50 cursor-pointer report-item-row" data-item-id="${item.id}">
                    <td class="px-4 py-2">${item.group}</td>
                    <td class="px-4 py-2">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-slate-900">${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}</td>
                    <td class="px-4 py-2 text-right font-bold text-green-600">${formatNumber(item.peakConsumption)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(item.currentConsumption)}</td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;

            const activeButton = container.querySelector(`.table-sort-button[data-sort="${peakConsumptionSortConfig.key}"]`);
            if (activeButton) {
                activeButton.classList.add('active', peakConsumptionSortConfig.direction);
                activeButton.innerHTML += sortIconSVG;
            }
        }
        
        function handleExportImmobilized() {
            const searchInput = document.getElementById('immobilized-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const immobilizationMonths = appSettings.immobilizationMonths;

            let processedItems = getProcessedItems().map(item => {
                let monthsWithoutConsumption = 0;
                if (item.consumos) {
                    for (let i = item.consumos.length - 1; i >= 0; i--) {
                        if (item.consumos[i] === 0) {
                            monthsWithoutConsumption++;
                        } else {
                            break;
                        }
                    }
                }
                return { ...item, monthsWithoutConsumption };
            });
            
            let immobilizedItems = processedItems.filter(item => item.stock > 0 && item.monthsWithoutConsumption >= immobilizationMonths);
            if (searchTerm) {
                immobilizedItems = immobilizedItems.filter(item => item.name.toLowerCase().includes(searchTerm) || item.group.toLowerCase().includes(searchTerm));
            }
            if (immobilizedItems.length === 0) { showToast('No hay datos para exportar.', 'info'); return; }

            const formattedData = immobilizedItems.map(item => ({
                'Grupo': item.group,
                'Código': item.code,
                'Material': item.name.replace(new RegExp(`^${item.code}\\s*`), ''),
                'Stock Actual': item.stock,
                'Meses sin Consumo': item.monthsWithoutConsumption
            }));
            const filename = `${getCurrentDateString()}_Reporte_Inmovilizado.xlsx`;
            exportToExcel(formattedData, filename);
        }

        function handleExportIndice() {
            const { red, yellow } = appSettings.coverageThresholds;
            let filteredItems = getProcessedItems();

            // Re-apply filters
            if (indiceCoverageFilter !== 'all') {
                filteredItems = filteredItems.filter(item => {
                    const days = item.coverageDays;
                    if (indiceCoverageFilter === 'red') return days < red;
                    if (indiceCoverageFilter === 'yellow') return days >= red && days <= yellow;
                    if (indiceCoverageFilter === 'green') return days > yellow || days === Infinity;
                    return false;
                });
            }
            if (indiceSelectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === indiceSelectedGroup);
            }
            if (indiceFavoriteFilter === 'favorites') {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            } else if (indiceFavoriteFilter === 'non-favorites') {
                filteredItems = filteredItems.filter(item => !item.isFavorite);
            }
            if (indiceSearchTerm) {
                const searchWords = indiceSearchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredItems = filteredItems.filter(item => {
                    const itemText = `${item.name} ${item.description_notes || ''}`.toLowerCase();
                    return searchWords.every(word => itemText.includes(word));
                });
            }

            if (filteredItems.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }
            
            const formattedData = filteredItems.map(item => ({
                'Grupo': item.group,
                'Código': item.code,
                'Material': item.name.replace(new RegExp(`^${item.code}\\s*`), ''),
                'Stock Actual': item.stock,
                'Consumo Mensual': item.monthlyConsumption,
                'Cobertura (Días)': item.coverageDays === Infinity ? '∞' : Math.round(item.coverageDays),
                'Favorito': item.isFavorite ? 'Sí' : 'No',
                'Notas': item.description_notes || ''
            }));
            
            const filename = `${getCurrentDateString()}_Reporte_Insumos.xlsx`;
            exportToExcel(formattedData, filename);
        }

        function handleExportSolpeds() {
            let filteredSolpeds = solpeds;
            const searchTerm = document.getElementById('solpeds-search-input').value.toLowerCase();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Re-apply filters
            if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredSolpeds = filteredSolpeds.filter(s => {
                    const searchableText = [
                        s.solicitud, s.cod, s.descripcion, s.creadoPor, s.grupoDeCompras, s.grupoDeArticulos
                    ].join(' ').toLowerCase();
                    return searchWords.every(word => searchableText.includes(word));
                });
            }
            if (showOnlyDelayedSolpeds) {
                filteredSolpeds = filteredSolpeds.filter(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    return releaseDate && releaseDate <= today;
                });
            }
            if (solpedsSelectedGroup !== 'all') {
                filteredSolpeds = filteredSolpeds.filter(s => s.grupoDeArticulos === solpedsSelectedGroup);
            }
            if (solpedsSelectedYear !== 'all') {
                filteredSolpeds = filteredSolpeds.filter(s => s.fechaLiberacion && s.fechaLiberacion.startsWith(solpedsSelectedYear));
                if (solpedsSelectedMonths.length > 0) {
                    filteredSolpeds = filteredSolpeds.filter(s => {
                        if (!s.fechaLiberacion) return false;
                        const month = s.fechaLiberacion.substring(5, 7);
                        return solpedsSelectedMonths.includes(month);
                    });
                }
            }

            if (filteredSolpeds.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }

            const formattedData = filteredSolpeds.map(s => ({
                'Solicitud': s.solicitud,
                'Código': s.cod,
                'Descripción': s.descripcion,
                'Cantidad': s.cantidad,
                'Fecha Solicitud': formatDate(s.fechaSolicitud),
                'Creado Por': s.creadoPor,
                'Status': s.status,
                'Fecha Liberación': formatDate(s.fechaLiberacion),
                'Grupo Compras': s.grupoDeCompras,
                'Grupo Artículos': s.grupoDeArticulos
            }));
            
            const filename = `${getCurrentDateString()}_Reporte_Solpeds.xlsx`;
            exportToExcel(formattedData, filename);
        }
        
        function handleExportOCs() {
            let filteredOCs = ocs;
            const searchTerm = document.getElementById('ocs-search-input').value.toLowerCase();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Re-apply filters
             if (searchTerm) {
                const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                filteredOCs = filteredOCs.filter(oc => {
                    const searchableText = [
                        oc.solped, oc.ordenDeCompra, oc.codigo, oc.denominacion, oc.grupoDeArticulos, oc.grupoDeCompras, oc.status
                    ].join(' ').toLowerCase();
                    return searchWords.every(word => searchableText.includes(word));
                });
            }
            if (showOnlyDelayedOCs) {
                filteredOCs = filteredOCs.filter(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    return deliveryDate && deliveryDate < today;
                });
            }
            if (ocsSelectedGroup !== 'all') {
                filteredOCs = filteredOCs.filter(oc => extractGroupCodeAbbr(oc.grupoDeArticulos) === ocsSelectedGroup);
            }
            if (ocsSelectedStatus !== 'all') {
                filteredOCs = filteredOCs.filter(oc => transformOCStatus(oc.status) === ocsSelectedStatus);
            }
            if (ocsSelectedYear !== 'all') {
                filteredOCs = filteredOCs.filter(oc => oc.proxFechaEntrega && oc.proxFechaEntrega.startsWith(ocsSelectedYear));
                if (ocsSelectedMonths.length > 0) {
                    filteredOCs = filteredOCs.filter(oc => {
                        if (!oc.proxFechaEntrega) return false;
                        const month = oc.proxFechaEntrega.substring(5, 7);
                        return ocsSelectedMonths.includes(month);
                    });
                }
            }

            if (filteredOCs.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }
            
            const formattedData = filteredOCs.map(oc => ({
                'Solped': oc.solped,
                'Orden de Compra': oc.ordenDeCompra,
                'Posición': oc.posicion,
                'Próxima Entrega': formatDate(oc.proxFechaEntrega),
                'Cantidad Entrega': oc.cantEntregaSiguiente,
                'Código': oc.codigo,
                'Denominación': oc.denominacion,
                'Grupo Artículos': oc.grupoDeArticulos,
                'Grupo Compras': oc.grupoDeCompras,
                'Status': transformOCStatus(oc.status)
            }));
            
            const filename = `${getCurrentDateString()}_Reporte_OCs.xlsx`;
            exportToExcel(formattedData, filename);
        }

        function handleExportRecordConsumption() {
            const recordConsumptionItems = getProcessedItems(true).filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            });

            if (recordConsumptionItems.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }

            const formattedData = recordConsumptionItems.map(item => {
                const historicalConsumptions = item.consumos.slice(0, -1);
                const peakHistoricalConsumption = historicalConsumptions.length > 0 ? Math.max(...historicalConsumptions) : 0;
                return {
                    'Grupo': item.group,
                    'Código': item.code,
                    'Material': item.name.replace(new RegExp(`^${item.code}\\s*`), ''),
                    'Consumo Mes Actual': item.consumos[item.consumos.length - 1],
                    'Pico Histórico': peakHistoricalConsumption,
                    'Favorito': item.isFavorite ? 'Sí' : 'No'
                };
            });
            
            const filename = `${getCurrentDateString()}_Reporte_Consumo_Record.xlsx`;
            exportToExcel(formattedData, filename);
        }

        // --- INICIALIZACIÓN ---
        async function initializeAppFlow() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                appId = firebaseConfig.projectId;

                permissionsCollectionRef = collection(db, `artifacts/${appId}/public/data/permissions`);
                
                onAuthStateChanged(auth, async (user) => {
                    if (unsubscribeInventory) unsubscribeInventory();
                    if (unsubscribePermissions) unsubscribePermissions();
                    if (unsubscribeMetadata) unsubscribeMetadata();
                    if (unsubscribeSolpeds) unsubscribeSolpeds();
                    if (unsubscribeOCs) unsubscribeOCs();
                    if (unsubscribeAppConfig) unsubscribeAppConfig();
                    isAuthReady = false;

                    if (user) {
                        userId = user.uid;
                        await checkUserPermissions(user);
                    } else {
                        document.getElementById('app-container').classList.add('hidden');
                        document.getElementById('auth-container').classList.remove('hidden');
                        switchAuthView('login-view');
                    }
                });
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                showToast("No se pudo conectar a la base de datos.", "error");
            }
        }

        async function checkUserPermissions(user) {
            const permissionsDocRef = doc(permissionsCollectionRef, user.uid);
            try {
                const docSnap = await getDoc(permissionsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentUserRole = data.role || 'viewer';
                    const currentUserTag = data.tag || '';
                    isAuthReady = true;
                    
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    adaptUiToRole(currentUserRole, user, currentUserTag);
                    activateDataListeners();
                } else {
                    await createInitialPermissions(user);
                    await checkUserPermissions(user);
                }
            } catch (error) {
                console.error("FirebaseError checking permissions:", error);
                showToast("No se pudieron verificar sus permisos de acceso.", "error");
                await signOut(auth);
            }
        }

        async function createInitialPermissions(user) {
            appConfigDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'appConfig');
            const userPermRef = doc(permissionsCollectionRef, user.uid);
            try {
                await runTransaction(db, async (transaction) => {
                    const appConfigDoc = await transaction.get(appConfigDocRef);
                    let role = 'viewer';
                    if (!appConfigDoc.exists() || !appConfigDoc.data().ownerAssigned) {
                        role = 'owner';
                        transaction.set(appConfigDocRef, { ownerAssigned: true, settings: appSettings }, { merge: true });
                    }
                    transaction.set(userPermRef, { 
                        email: user.email, 
                        role: role, 
                        editableGroups: role === 'owner' ? ['*'] : [],
                        tag: user.email.split('@')[0]
                    });
                });
            } catch (error) {
                 console.error("Error creating initial permissions:", error);
                 throw error;
            }
        }

        function activateDataListeners() {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to activate data listeners before auth was ready. Aborting.");
                return;
            }
            if (unsubscribeInventory) unsubscribeInventory();
            if (unsubscribeMetadata) unsubscribeMetadata();
            if (unsubscribeSolpeds) unsubscribeSolpeds();
            if (unsubscribeOCs) unsubscribeOCs();
            if (unsubscribeAppConfig) unsubscribeAppConfig();

            inventoryCollectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            reviewHistoryCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/reviewHistory`);
            metadataDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'dataSource');
            solpedsCollectionRef = collection(db, `artifacts/${appId}/public/data/solpeds`);
            ocsCollectionRef = collection(db, `artifacts/${appId}/public/data/ocs`);
            appConfigDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'appConfig');
            
            unsubscribeAppConfig = onSnapshot(appConfigDocRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    if (data.settings) {
                        appSettings = { ...appSettings, ...data.settings };
                    }
                    groupNotes.clear();
                    if (data.groupNotes) {
                        for (const [groupName, note] of Object.entries(data.groupNotes)) {
                            groupNotes.set(groupName, note || '');
                        }
                    }
                }
                updateExternalLinks();
                renderApp(); 
            });

            unsubscribeInventory = onSnapshot(inventoryCollectionRef, (snap) => {
                items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateProcessedItemsCache(); // <-- El cálculo se hace aquí, una sola vez.
                generateNotifications();
                renderApp();
            }, (error) => { console.error("Error de permisos:", error); showToast('No tienes permiso para ver el inventario.', 'error'); });
            
            unsubscribeSolpeds = onSnapshot(solpedsCollectionRef, (snap) => {
                solpeds = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'solpeds' || currentView === 'dashboard') {
                    renderApp(); 
                }
            }, (error) => { console.error("Error de permisos en Solpeds:", error); showToast('No tienes permiso para ver las Solpeds.', 'error'); });

            unsubscribeOCs = onSnapshot(ocsCollectionRef, (snap) => {
                ocs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateNotifications();
                if (currentView === 'ocs' || currentView === 'dashboard') {
                    renderApp();
                }
            }, (error) => { console.error("Error de permisos en OCs:", error); showToast('No tienes permiso para ver las O/C.', 'error'); });

            unsubscribeMetadata = onSnapshot(metadataDocRef, (docSnap) => {
                const dbInfoContainer = document.getElementById('db-info-container');
                if (dbInfoContainer) {
                    let dbName = "Sin Datos";
                    if (docSnap.exists()) { dbName = docSnap.data().filename.split('.').slice(0, -1).join('.') || docSnap.data().filename; }
                    dbInfoContainer.innerHTML = `<div class="btn-main-style bg-green-100 text-green-800 border-green-200 font-bold text-xs">DB: ${dbName}</div>`;
                }
            });
        }
        
        async function renderHistoryView() {
            const container = document.getElementById('history-table-container');
            const searchInput = document.getElementById('history-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            container.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';

            try {
                const querySnapshot = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/reviewHistory`)));
                const history = querySnapshot.docs.map(doc => doc.data());
                
                let allGroups = [...new Set(items.map(item => item.group || 'General'))].sort();
                const allWeeksSorted = [...new Set(history.map(h => h.weekId))].sort().reverse();
                const visibleWeeks = allWeeksSorted.slice(0, 8); // Only show the last 8 weeks

                if (history.length === 0 && allGroups.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 p-8">No hay grupos de insumos ni historial de revisiones.</p>';
                    return;
                }
                
                if (searchTerm) {
                    const searchWords = searchTerm.toLowerCase().split(' ').filter(Boolean);
                    allGroups = allGroups.filter(group => {
                        const note = groupNotes.get(group) || '';
                        const textToSearch = `${group} ${note}`.toLowerCase();
                        return searchWords.every(word => textToSearch.includes(word));
                    });
                }

                if (allGroups.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-500 p-8">No se encontraron grupos.</p>';
                    return;
                }

                const historyMatrix = {};
                history.forEach(record => {
                    historyMatrix[record.weekId] = new Set(record.reviewedGroups);
                });

                const groupCounts = items.reduce((acc, item) => {
                    const group = item.group || 'General';
                    acc[group] = (acc[group] || 0) + 1;
                    return acc;
                }, {});

                let tableHTML = `<table class="w-full text-sm text-left text-slate-500 history-table table-fixed"><thead class="text-xs text-slate-700 uppercase"><tr><th class="px-4 py-3 font-bold w-40">Grupo</th>`;
                visibleWeeks.forEach(weekId => {
                    const weekNum = weekId.split('-')[1];
                    tableHTML += `<th class="px-1 py-3 text-center">${weekNum}</th>`;
                });
                tableHTML += `</tr></thead><tbody>`;

                allGroups.forEach(groupName => {
                    const count = groupCounts[groupName] || 0;
                    tableHTML += `<tr class="group-info-row" data-group-name="${groupName}">
                        <td class="px-4 py-1 align-middle whitespace-nowrap">
                            <p class="text-base font-medium text-indigo-600">${groupName}</p>
                            <p class="text-xs text-slate-500">${count} insumos</p>
                        </td>`;
                    visibleWeeks.forEach(weekId => {
                        const isChecked = historyMatrix[weekId] && historyMatrix[weekId].has(groupName);
                        tableHTML += `<td class="px-1 py-1 text-center text-green-500 font-bold align-middle">${isChecked ? '✓' : ''}</td>`;
                    });
                    tableHTML += `</tr>`;
                    
                    const note = groupNotes.get(groupName) || '';
                    tableHTML += `
                        <tr class="border-b bg-slate-50/50 group-notes-row" data-group-name="${groupName}">
                            <td class="px-2 py-1 align-top">
                                <textarea
                                    class="w-full bg-transparent text-xs text-slate-600 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:bg-white rounded p-1 resize-none placeholder:italic review-notes-input"
                                    rows="1"
                                    data-group-name="${groupName}"
                                    placeholder="Añadir nota para el grupo..."
                                    ${currentUserRole !== 'owner' ? 'disabled' : ''}
                                >${note}</textarea>
                            </td>
                            <td colspan="${visibleWeeks.length}"></td>
                        </tr>`;
                });

                tableHTML += `</tbody></table>`;
                container.innerHTML = tableHTML;
                syncReviewRowHeights();

            } catch (error) {
                console.error("Error fetching review history:", error);
                container.innerHTML = '<p class="text-center text-red-500 p-8">No se pudo cargar el historial.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeAppFlow();
            
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            document.getElementById('show-register-view-btn')?.addEventListener('click', () => switchAuthView('register-view'));
            document.getElementById('show-login-view-btn')?.addEventListener('click', () => switchAuthView('login-view'));
            document.getElementById('main-nav-links')?.addEventListener('click', (e) => { if (e.target.matches('.nav-link')) { switchMainView(e.target.dataset.view); } });
            document.getElementById('logo-container')?.addEventListener('click', () => switchMainView('dashboard'));
            
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown-content');
            userMenuButton?.addEventListener('click', (e) => { 
                if (!userMenuButton.disabled) {
                    e.stopPropagation(); 
                    userDropdown.classList.toggle('show'); 
                }
            });
            document.getElementById('logout-button-dropdown')?.addEventListener('click', handleLogout);
            document.getElementById('admin-button-dropdown')?.addEventListener('click', openAdminModal);
            document.getElementById('manual-button-dropdown')?.addEventListener('click', () => document.getElementById('manual-modal').classList.remove('hidden'));
            document.getElementById('close-manual-modal-button')?.addEventListener('click', () => document.getElementById('manual-modal').classList.add('hidden'));

            const notificationBellBtn = document.getElementById('notification-bell-btn');
            const notificationDropdown = document.getElementById('notification-dropdown');

            notificationBellBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                notificationDropdown.classList.toggle('show');
            });

            notificationDropdown?.addEventListener('click', (e) => {
                if (e.target.closest('#mark-all-read-btn')) {
                    e.stopPropagation();
                    notifications.forEach(n => n.read = true);
                    renderNotifications();
                } else if (e.target.closest('.notification-item')) {
                     handleNotificationClick(e);
                }
            });

            document.getElementById('manual-modal')?.addEventListener('click', (e) => {
                const header = e.target.closest('.accordion-header');
                if (header) {
                    const content = header.nextElementSibling;
                    const chevron = header.querySelector('.accordion-chevron');
                    if (content && chevron) {
                        content.classList.toggle('hidden');
                        chevron.classList.toggle('rotate-180');
                    }
                }
            });

            document.getElementById('dashboard-view')?.addEventListener('click', (e) => {
                const addNoteBtn = e.target.closest('#add-new-note-btn');
                if (addNoteBtn) {
                    handleAddInventoryNote();
                    return;
                }

                const deleteNoteBtn = e.target.closest('.delete-note-btn');
                if (deleteNoteBtn) {
                    e.stopPropagation(); // Prevent accordion from toggling
                    const noteId = deleteNoteBtn.closest('[data-note-id]').dataset.noteId;
                    handleDeleteInventoryNote(noteId);
                    return;
                }

                const noteHeader = e.target.closest('.note-header');
                if (noteHeader) {
                    // Do not toggle if the user is interacting with the title input.
                    if (e.target.closest('.note-title-input')) {
                        return;
                    }
                    const content = noteHeader.nextElementSibling;
                    const chevron = noteHeader.querySelector('.note-chevron');
                    if (content && chevron) {
                        content.classList.toggle('hidden');
                        chevron.classList.toggle('rotate-180');
                    }
                    return;
                }

                const exportNotesBtn = e.target.closest('#export-dashboard-notes-btn');
                if(exportNotesBtn) {
                    handleExportDashboardNotes();
                    return;
                }

                const kpiCard = e.target.closest('.kpi-card');
                if (kpiCard) {
                    handleKpiClick(kpiCard.dataset.kpi);
                    return;
                }

                const favoriteGroupHeader = e.target.closest('.favorite-group-header');
                if (favoriteGroupHeader) {
                    const groupName = favoriteGroupHeader.dataset.groupName;
                    const content = document.querySelector(`.favorite-item-list[data-group-list="${groupName}"]`);
                    const chevron = favoriteGroupHeader.querySelector('.accordion-chevron');
                    if (content && chevron) {
                        content.classList.toggle('hidden');
                        chevron.classList.toggle('rotate-180');
                    }
                    return;
                }

                // Handler for clicking on items within KPI detail views (Favorites, Record Consumption)
                const detailItem = e.target.closest('.kpi-detail-item-row');
                if (detailItem && detailItem.dataset.itemId) {
                    selectedConsumptionItemId = detailItem.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                    return;
                }
                
                const groupStatsRow = e.target.closest('.kpi-detail-group-row');
                if (groupStatsRow && groupStatsRow.dataset.groupName) {
                    const groupName = groupStatsRow.dataset.groupName;
                    handleClearIndiceFilters();
                    indiceSelectedGroup = groupName;
                    switchMainView('indice');
                    return;
                }
                
                const solpedGroupRow = e.target.closest('.kpi-detail-solped-row');
                if (solpedGroupRow && solpedGroupRow.dataset.groupCompras) {
                    const groupName = solpedGroupRow.dataset.groupCompras;
                    handleClearSolpedsFilters();
                    showOnlyDelayedSolpeds = true;
                    document.getElementById('solpeds-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                    switchMainView('solpeds');
                    return;
                }

                const ocGroupRow = e.target.closest('.kpi-detail-oc-row');
                if (ocGroupRow && ocGroupRow.dataset.groupCompras) {
                    const groupName = ocGroupRow.dataset.groupCompras;
                    handleClearOCsFilters();
                    showOnlyDelayedOCs = true;
                    document.getElementById('ocs-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                    switchMainView('ocs');
                    return;
                }
                
                if (e.target.closest('#export-record-consumption-btn')) {
                    handleExportRecordConsumption();
                    return;
                }

                const incomingItemRow = e.target.closest('.incoming-item-row');
                if (incomingItemRow && incomingItemRow.dataset.itemId) {
                    selectedConsumptionItemId = incomingItemRow.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                    return;
                }

                const recordConsumptionHeader = e.target.closest('.record-consumption-group-header');
                if (recordConsumptionHeader) {
                    const groupName = recordConsumptionHeader.dataset.groupName;
                    const content = document.querySelector(`.record-consumption-item-list[data-group-list="${groupName}"]`);
                    const chevron = recordConsumptionHeader.querySelector('.record-consumption-chevron');
                    if (content && chevron) {
                        content.classList.toggle('hidden');
                        chevron.classList.toggle('rotate-180');
                    }
                    return;
                }
            });

            document.getElementById('dashboard-view')?.addEventListener('input', (e) => {
                if (e.target.matches('.note-title-input')) {
                    const noteId = e.target.closest('[data-note-id]').dataset.noteId;
                    const newTitle = e.target.value;

                    if (noteTitleUpdateDebounceTimers.has(noteId)) {
                        clearTimeout(noteTitleUpdateDebounceTimers.get(noteId));
                    }

                    const timer = setTimeout(() => {
                        handleUpdateInventoryNoteTitle(noteId, newTitle);
                        noteTitleUpdateDebounceTimers.delete(noteId);
                    }, 1500); // 1.5 second debounce

                    noteTitleUpdateDebounceTimers.set(noteId, timer);
                }
                
                if (e.target.matches('.note-content-textarea')) {
                    const noteId = e.target.closest('[data-note-id]').dataset.noteId;
                    const content = e.target.value;

                    if (noteUpdateDebounceTimers.has(noteId)) {
                        clearTimeout(noteUpdateDebounceTimers.get(noteId));
                    }

                    const timer = setTimeout(() => {
                        handleUpdateInventoryNoteContent(noteId, content);
                        noteUpdateDebounceTimers.delete(noteId);
                    }, 1500); // 1.5 second debounce

                    noteUpdateDebounceTimers.set(noteId, timer);
                }
            });

            // --- Consumos View Listeners ---
            document.getElementById('consumos-view')?.addEventListener('click', (e) => {
                const searchResult = e.target.closest('#consumo-search-results > div, #consumo-comparison-search-results > div');
                const favoritesFilterBtn = e.target.closest('#consumo-favorites-filter-btn, #consumo-comparison-favorites-filter-btn');
                const panelFavoriteBtn = e.target.closest('.favorite-btn[data-item-id]');
                const clearPrimaryBtn = e.target.closest('#consumo-clear-primary-btn');
                const clearComparisonBtn = e.target.closest('#consumo-clear-comparison-btn');
                const clearTextBtn = e.target.closest('#consumo-clear-text-btn');
                const clearComparisonTextBtn = e.target.closest('#consumo-comparison-clear-text-btn');
                const nameLink = e.target.closest('.consumo-name-link');
                const groupLink = e.target.closest('.consumo-group-link');
                const solpedLink = e.target.closest('.consumo-solped-link');
                const ocLink = e.target.closest('.consumo-oc-link');
                const simulationBtn = e.target.closest('.show-simulation-trigger');

                if (searchResult) { handleSelectConsumosItem(e); }
                else if (favoritesFilterBtn) { handleConsumosFavoritesToggle(favoritesFilterBtn); }
                else if (panelFavoriteBtn) { handleToggleFavorite(panelFavoriteBtn.dataset.itemId); }
                else if (clearPrimaryBtn) { handleClearConsumoPanel('primary'); }
                else if (clearComparisonBtn) { handleClearConsumoPanel('comparison'); }
                else if (clearTextBtn) { handleClearSelectedItem('primary'); }
                else if (clearComparisonTextBtn) { handleClearSelectedItem('comparison'); }
                else if (nameLink && nameLink.dataset.itemCode) {
                    indiceSearchTerm = nameLink.dataset.itemCode;
                    indiceSelectedGroup = 'all';
                    indiceFavoriteFilter = 'all';
                    indiceCoverageFilter = 'all';
                    switchMainView('indice');
                }
                else if (groupLink && groupLink.dataset.groupName) {
                    indiceSelectedGroup = groupLink.dataset.groupName;
                    indiceSearchTerm = '';
                    indiceFavoriteFilter = 'all';
                    indiceCoverageFilter = 'all';
                    switchMainView('indice');
                }
                else if (solpedLink && solpedLink.dataset.solpedId) {
                    handleClearSolpedsFilters();
                    document.getElementById('solpeds-search-input').value = solpedLink.dataset.solpedId;
                    switchMainView('solpeds');
                }
                else if (ocLink && ocLink.dataset.ocId) {
                    handleClearOCsFilters();
                    document.getElementById('ocs-search-input').value = ocLink.dataset.ocId;
                    switchMainView('ocs');
                }
                else if (simulationBtn) {
                    isSimulationModeActive = true;
                    comparisonItemId = null;
                    const comparisonSearchInput = document.getElementById('consumo-comparison-search-input');
                    if(comparisonSearchInput) comparisonSearchInput.value = '';
                    const comparisonClearBtn = document.getElementById('consumo-comparison-clear-text-btn');
                    if(comparisonClearBtn) comparisonClearBtn.classList.add('hidden');
                    renderConsumosView();
                }
            });
            document.getElementById('consumos-view')?.addEventListener('input', (e) => {
                if (e.target.id === 'consumo-search-input') {
                    handleConsumosSearch(e, 'primary');
                } else if (e.target.id === 'consumo-comparison-search-input') {
                    handleConsumosSearch(e, 'comparison');
                } else if (e.target.matches('[id^="consumo-description-notes-"]')) {
                    handleNotesInput(e);
                }
            });
            document.getElementById('consumos-view')?.addEventListener('change', (e) => {
                if (e.target.matches('.consumo-group-filter')) {
                    handleConsumosFilterChange(e);
                }
            });

            document.getElementById('solpeds-search-input')?.addEventListener('input', renderSolpedsView);
            document.getElementById('solpeds-view')?.addEventListener('click', (e) => { 
                const btn = e.target.closest('.table-sort-button'); 
                const row = e.target.closest('.solped-item-row');
                const yearBtn = e.target.closest('.solpeds-year-btn');
                const monthBtn = e.target.closest('#solpeds-month-filter-btn');

                if (btn) { handleSolpedsSort(btn.dataset.sort); }
                else if (e.target.id === 'solpeds-delayed-filter-btn') { showOnlyDelayedSolpeds = !showOnlyDelayedSolpeds; renderSolpedsView(); }
                else if (e.target.closest('#export-solpeds-btn')) { handleExportSolpeds(); }
                else if (e.target.closest('#solpeds-clear-filters-btn')) { handleClearSolpedsFilters(); }
                else if (row && row.dataset.itemId) {
                    selectedConsumptionItemId = row.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
                else if (yearBtn) {
                    solpedsSelectedYear = yearBtn.dataset.year;
                    solpedsSelectedMonths = [];
                    renderSolpedsView();
                }
                else if (monthBtn) {
                    e.stopPropagation();
                    document.getElementById('solpeds-month-filter-panel').classList.toggle('hidden');
                }
            });
            document.getElementById('solpeds-view')?.addEventListener('change', (e) => {
                if (e.target.id === 'solpeds-group-filter') {
                    solpedsSelectedGroup = e.target.value;
                    renderSolpedsView();
                }
                if (e.target.matches('.solpeds-month-checkbox')) {
                    const checkedMonths = Array.from(document.querySelectorAll('.solpeds-month-checkbox:checked')).map(cb => cb.value);
                    solpedsSelectedMonths = checkedMonths;
                    renderSolpedsView();
                }
            });
            
            document.getElementById('ocs-search-input')?.addEventListener('input', renderOCsView);
           document.getElementById('ocs-view')?.addEventListener('click', (e) => { 
                const btn = e.target.closest('.table-sort-button'); 
                const row = e.target.closest('.oc-item-row');
                const yearBtn = e.target.closest('.ocs-year-btn');
                const monthBtn = e.target.closest('#ocs-month-filter-btn');

                if (btn) { handleOCsSort(btn.dataset.sort); }
                else if (e.target.id === 'ocs-delayed-filter-btn') { showOnlyDelayedOCs = !showOnlyDelayedOCs; renderOCsView(); }
                else if (e.target.closest('#export-ocs-btn')) { handleExportOCs(); }
                else if (e.target.closest('#ocs-clear-filters-btn')) { handleClearOCsFilters(); }
                else if (yearBtn) {
                    ocsSelectedYear = yearBtn.dataset.year;
                    ocsSelectedMonths = [];
                    renderOCsView();
                }
                else if (monthBtn) {
                    e.stopPropagation();
                    document.getElementById('ocs-month-filter-panel').classList.toggle('hidden');
                }
                else if (row && row.dataset.itemId) {
                    selectedConsumptionItemId = row.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
            });
            document.getElementById('ocs-view')?.addEventListener('change', (e) => {
                if (e.target.id === 'ocs-group-filter') {
                    ocsSelectedGroup = e.target.value;
                    renderOCsView();
                }
                if (e.target.id === 'ocs-status-filter') {
                    ocsSelectedStatus = e.target.value;
                    renderOCsView();
                }
                if (e.target.matches('.ocs-month-checkbox')) {
                    const checkedMonths = Array.from(document.querySelectorAll('.ocs-month-checkbox:checked')).map(cb => cb.value);
                    ocsSelectedMonths = checkedMonths;
                    renderOCsView();
                }
            });

            document.getElementById('reportes-view')?.addEventListener('input', (e) => { 
                if (e.target.id === 'immobilized-search-input') renderImmobilizedStockReport();
            });
            document.getElementById('reportes-view')?.addEventListener('click', (e) => { 
                const sortBtn = e.target.closest('.table-sort-button');
                const row = e.target.closest('.report-item-row');
                
                if(e.target.closest('#export-immobilized-btn')) {
                    handleExportImmobilized();
                    return;
                }

                if (sortBtn) {
                    const key = sortBtn.dataset.sort;
                    if (immobilizedSortConfig.key === key) {
                        immobilizedSortConfig.direction = immobilizedSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        immobilizedSortConfig.key = key;
                        immobilizedSortConfig.direction = 'asc';
                    }
                    renderImmobilizedStockReport();
                } else if (row && row.dataset.itemId) {
                    selectedConsumptionItemId = row.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
            });

            document.getElementById('indice-view')?.addEventListener('click', (e) => {
                const sortBtn = e.target.closest('.table-sort-button');
                const favBtn = e.target.closest('.favorite-btn');
                const itemDetails = e.target.closest('.indice-item-details');
                const exportBtn = e.target.closest('#export-indice-btn');
                const clearFiltersBtn = e.target.closest('#indice-clear-filters-btn');
                const favHeaderBtn = e.target.closest('#indice-favorites-header-filter-btn');
                const coverageBtn = e.target.closest('.indice-coverage-btn');

                if (sortBtn) {
                    const key = sortBtn.dataset.sort;
                    if (indiceSortConfig.key === key) {
                        indiceSortConfig.direction = indiceSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        indiceSortConfig.key = key;
                        indiceSortConfig.direction = 'asc';
                    }
                    renderIndiceView();
                } else if (favBtn) {
                    handleToggleFavorite(favBtn.dataset.itemId);
                } else if (itemDetails) {
                    selectedConsumptionItemId = itemDetails.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                } else if (exportBtn) {
                    handleExportIndice();
                } else if (clearFiltersBtn) {
                    handleClearIndiceFilters();
                } else if (favHeaderBtn) {
                    if (indiceFavoriteFilter === 'all') indiceFavoriteFilter = 'favorites';
                    else if (indiceFavoriteFilter === 'favorites') indiceFavoriteFilter = 'non-favorites';
                    else indiceFavoriteFilter = 'all';
                    renderIndiceView();
                } else if (coverageBtn) {
                    indiceCoverageFilter = coverageBtn.dataset.filter;
                    renderIndiceView();
                }
            });
            document.getElementById('indice-view')?.addEventListener('input', (e) => {
                if (e.target.id === 'indice-search-input') {
                    indiceSearchTerm = e.target.value;
                    renderIndiceView();
                } else if (e.target.matches('.notes-input-indice')) {
                    handleNotesInput(e);
                }
            });
             document.getElementById('indice-view')?.addEventListener('change', (e) => {
                if (e.target.id === 'indice-group-filter') {
                    indiceSelectedGroup = e.target.value;
                    renderIndiceView();
                }
            });

            document.getElementById('dashboard-preload-btn-dropdown')?.addEventListener('click', handleOpenPreloadModal);
            document.getElementById('dashboard-clear-btn-dropdown')?.addEventListener('click', handleClearAll);
            document.getElementById('close-preload-modal')?.addEventListener('click', handleClosePreloadModal);
            document.getElementById('process-preload-data')?.addEventListener('click', handleProcessPreloadData);
            document.getElementById('preload-file-input')?.addEventListener('change', handleFileInputChange);
            document.getElementById('cancel-clear-button')?.addEventListener('click', () => document.getElementById('confirm-clear-modal').classList.add('hidden'));
            
            document.getElementById('admin-tabs')?.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                if (!tab) return;
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('admin-content-permissions').classList.toggle('hidden', tab !== 'permissions');
                document.getElementById('admin-content-settings').classList.toggle('hidden', tab !== 'settings');
            });
            document.getElementById('admin-content-permissions')?.addEventListener('change', (e) => {
                if (e.target.matches('.role-select, .groups-input, .tag-input')) {
                    const userId = e.target.dataset.userid;
                    const row = e.target.closest('tr');
                    const role = row.querySelector('.role-select').value;
                    const groups = row.querySelector('.groups-input').value;
                    const tag = row.querySelector('.tag-input').value;
                    updateUserPermissions(userId, role, groups, tag);
                }
            });
            document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
            document.getElementById('close-admin-modal-button')?.addEventListener('click', closeAdminModal);
            
            document.getElementById('record-consumption-modal')?.addEventListener('click', (e) => {
                const itemEl = e.target.closest('.record-consumption-item');
                if (itemEl) {
                    const itemId = itemEl.dataset.itemId;
                    switchMainView('consumos');
                    selectedConsumptionItemId = itemId;
                    renderConsumosView();
                    document.getElementById('record-consumption-modal').classList.add('hidden');
                }
            });
            document.getElementById('close-record-consumption-modal-button')?.addEventListener('click', () => document.getElementById('record-consumption-modal').classList.add('hidden'));

            document.getElementById('close-group-stats-modal-button')?.addEventListener('click', () => document.getElementById('group-stats-modal').classList.add('hidden'));

            document.getElementById('group-stats-modal')?.addEventListener('click', (e) => {
                 const row = e.target.closest('tr[data-group-name]');
                 if (row) {
                     const groupName = row.dataset.groupName;
                     indiceSelectedGroup = groupName;
                     indiceShowFavorites = false;
                     indiceCoverageFilter = 'all';
                     indiceSearchTerm = '';
                     document.getElementById('group-stats-modal').classList.add('hidden');
                     switchMainView('indice');
                 }
            });

            document.getElementById('save-review-btn')?.addEventListener('click', handleSaveReview);
            document.getElementById('groups-review-list')?.addEventListener('change', handleReviewCheckboxChange);
            
            document.getElementById('revision-view')?.addEventListener('input', (e) => {
                if(e.target.id === 'history-search-input') { renderHistoryView(); }
                if(e.target.matches('.review-notes-input')) { handleReviewNotesInput(e); }
            });
            
            document.getElementById('revision-view')?.addEventListener('click', (e) => {
                if(e.target.closest('#export-history-btn')) { 
                    handleExportHistory(); 
                    return;
                }
                
                const groupItemName = e.target.closest('.group-item-name');
                if (groupItemName) {
                    const groupName = groupItemName.dataset.groupName;
                    indiceSelectedGroup = groupName;
                    indiceFavoriteFilter = 'all';
                    indiceCoverageFilter = 'all';
                    indiceSearchTerm = '';
                    switchMainView('indice');
                }
            });

            document.getElementById('save-review-btn')?.addEventListener('click', handleSaveReview);
            document.getElementById('groups-review-list')?.addEventListener('change', handleReviewCheckboxChange);
            
            // Sincronización de scroll para la vista de CHECK
            const logContainer = document.getElementById('history-table-container');
            const reviewListContainer = document.getElementById('groups-review-list');
            if(logContainer && reviewListContainer) {
                let activeScroller = null;

                logContainer.addEventListener('mouseenter', () => activeScroller = logContainer);
                reviewListContainer.addEventListener('mouseenter', () => activeScroller = reviewListContainer);
                
                logContainer.addEventListener('scroll', () => {
                    if (activeScroller !== logContainer) return;
                    reviewListContainer.scrollTop = logContainer.scrollTop;
                });

                reviewListContainer.addEventListener('scroll', () => {
                    if (activeScroller !== reviewListContainer) return;
                    logContainer.scrollTop = reviewListContainer.scrollTop;
                });
            }

            document.getElementById('close-delayed-solpeds-modal-button')?.addEventListener('click', () => document.getElementById('delayed-solpeds-modal').classList.add('hidden'));

            document.getElementById('delayed-solpeds-modal')?.addEventListener('click', (e) => {
                 const row = e.target.closest('tr[data-group-compras]');
                 if (row) {
                     const groupName = row.dataset.groupCompras;
                     document.getElementById('solpeds-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                     showOnlyDelayedSolpeds = true;
                     solpedsSelectedGroup = 'all';
                     solpedsSelectedYear = 'all';
                     solpedsSelectedMonths = [];
                     document.getElementById('delayed-solpeds-modal').classList.add('hidden');
                     switchMainView('solpeds');
                 }
            });

            document.getElementById('close-delayed-ocs-modal-button')?.addEventListener('click', () => document.getElementById('delayed-ocs-modal').classList.add('hidden'));

            document.getElementById('delayed-ocs-modal')?.addEventListener('click', (e) => {
                 const row = e.target.closest('tr[data-group-compras]');
                 if (row) {
                     const groupName = row.dataset.groupCompras;
                     document.getElementById('ocs-search-input').value = groupName === 'Sin Grupo' ? '' : groupName;
                     showOnlyDelayedOCs = true;
                     ocsSelectedGroup = 'all';
                     ocsSelectedStatus = 'all';
                     ocsSelectedYear = 'all';
                     ocsSelectedMonths = [];
                     document.getElementById('delayed-ocs-modal').classList.add('hidden');
                     switchMainView('ocs');
                 }
            });

            document.getElementById('add-new-item-btn')?.addEventListener('click', handleOpenItemModal);
            document.getElementById('close-item-modal')?.addEventListener('click', handleCloseItemModal);
            document.getElementById('item-form')?.addEventListener('submit', handleSaveItem);

            // --- Ingresos View Listeners ---
            document.getElementById('ingresos-view')?.addEventListener('click', (e) => {
                const prevBtn = e.target.closest('#calendar-prev-month');
                const nextBtn = e.target.closest('#calendar-next-month');
                const todayBtn = e.target.closest('#calendar-today-btn');
                const weekRow = e.target.closest('.calendar-week-row');
                const kpiCard = e.target.closest('.ingresos-kpi-card');
                const itemRow = e.target.closest('.incoming-item-row');
                const exportBtn = e.target.closest('#export-incoming-items-btn');

                if (prevBtn) {
                    calendarCurrentDate.setUTCMonth(calendarCurrentDate.getUTCMonth() - 1);
                    renderMonthlyCalendar(calendarCurrentDate);
                } else if (nextBtn) {
                    calendarCurrentDate.setUTCMonth(calendarCurrentDate.getUTCMonth() + 1);
                    renderMonthlyCalendar(calendarCurrentDate);
                } else if (todayBtn) {
                    goToCurrentWeek();
                } else if (weekRow) {
                    // Recalculate start date from weekId to be safe
                    const weekId = weekRow.dataset.weekId;
                    const year = parseInt(weekId.substring(0, 4), 10);
                    const weekNum = parseInt(weekId.substring(5), 10);
                    
                    const firstDayOfYear = new Date(Date.UTC(year, 0, 1));
                    const daysOffset = (weekNum - 1) * 7;
                    let weekStartDate = new Date(firstDayOfYear.getTime() + daysOffset * 86400000);
                    
                    const dayOfWeek = (weekStartDate.getUTCDay() + 6) % 7; // Monday = 0
                    weekStartDate.setUTCDate(weekStartDate.getUTCDate() - dayOfWeek);

                    const weekEndDate = new Date(weekStartDate);
                    weekEndDate.setUTCDate(weekStartDate.getUTCDate() + 6);

                    document.querySelectorAll('.calendar-week-row.selected-week').forEach(row => row.classList.remove('selected-week'));
                    weekRow.classList.add('selected-week');
                    
                    ingresosSelectedGroup = 'all';
                    ingresosSearchTerm = '';
                    renderIncomingItemsForWeek(weekStartDate, weekEndDate);
                } else if (kpiCard) {
                    const groupName = kpiCard.dataset.groupName;
                    ingresosSelectedGroup = (ingresosSelectedGroup === groupName) ? 'all' : groupName;
                    // Re-render details only, not the whole header
                    renderIncomingItemsForWeek(currentIngresosWeek.start, currentIngresosWeek.end, true);
                } else if (itemRow && itemRow.dataset.itemId) {
                    selectedConsumptionItemId = itemRow.dataset.itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                } else if (exportBtn) {
                    handleExportIncomingItems();
                }
            });

            document.getElementById('ingresos-view')?.addEventListener('change', (e) => {
                if(e.target.id === 'ingresos-group-filter') {
                    ingresosSelectedGroup = e.target.value;
                    renderIncomingItemsForWeek(currentIngresosWeek.start, currentIngresosWeek.end, true);
                }
            });
             document.getElementById('ingresos-view')?.addEventListener('input', (e) => {
                if(e.target.id === 'ingresos-search-input') {
                    ingresosSearchTerm = e.target.value;
                    renderIncomingItemsForWeek(currentIngresosWeek.start, currentIngresosWeek.end, true);
                }
            });


            // --- Global Search Listeners ---
            document.getElementById('open-global-search-btn')?.addEventListener('click', openGlobalSearch);
            document.getElementById('close-global-search-modal-btn')?.addEventListener('click', closeGlobalSearch);
            document.getElementById('download-search-modal-btn')?.addEventListener('click', downloadSearchModalAsImage);
            document.getElementById('global-search-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'global-search-modal') {
                    closeGlobalSearch();
                }
            });
            document.getElementById('global-search-input')?.addEventListener('input', handleGlobalSearch);
            document.getElementById('global-search-results')?.addEventListener('click', (e) => {
                const resultItem = e.target.closest('.search-result-item');
                if (!resultItem) return;

                const { type, id } = resultItem.dataset;

                switch(type) {
                    case 'insumo':
                        selectedConsumptionItemId = id;
                        comparisonItemId = null;
                        switchMainView('consumos');
                        break;
                    case 'solped':
                        switchMainView('solpeds');
                        handleClearSolpedsFilters();
                        document.getElementById('solpeds-search-input').value = id;
                        renderSolpedsView();
                        break;
                    case 'oc':
                        switchMainView('ocs');
                        handleClearOCsFilters();
                        document.getElementById('ocs-search-input').value = id;
                        renderOCsView();
                        break;
                }
                closeGlobalSearch();
            });

            document.body.addEventListener('input', (e) => {
                if (e.target.matches('.direct-edit-input')) {
                    handleDirectEditInput(e);
                }
            });


            // --- Easter Egg ---
            const logoContainer = document.getElementById('logo-container');
            if (logoContainer) {
                let logoClickCount = 0;
                let matrixActive = false;
                let matrixInterval;
                let clickResetTimeout;

                logoContainer.addEventListener('click', () => {
                    logoClickCount++;
                    
                    if (clickResetTimeout) clearTimeout(clickResetTimeout);
                    clickResetTimeout = setTimeout(() => {
                        logoClickCount = 0;
                    }, 2000);

                    if (logoClickCount >= 7) {
                        matrixActive = !matrixActive;
                        if (matrixActive) {
                            startMatrixEffect();
                        } else {
                            stopMatrixEffect();
                        }
                        logoClickCount = 0;
                        clearTimeout(clickResetTimeout);
                    }
                });

                function startMatrixEffect() {
                    const canvas = document.getElementById('matrix-canvas');
                    if (!canvas) return;
                    canvas.style.display = 'block';
                    const ctx = canvas.getContext('2d');
                    
                    canvas.height = window.innerHeight;
                    canvas.width = window.innerWidth;

                    const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
                    const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    const nums = '0123456789';
                    const characters = katakana + latin + nums;

                    const fontSize = 16;
                    const columns = Math.floor(canvas.width / fontSize);

                    let drops = [];
                    for (let x = 0; x < columns; x++) {
                        drops[x] = 1;
                    }

                    const draw = () => {
                        ctx.fillStyle = 'rgba(241, 245, 249, 0.05)'; // bg-slate-100 with opacity
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        ctx.fillStyle = '#6366f1'; // indigo-500
                        ctx.font = fontSize + 'px arial';

                        for (let i = 0; i < drops.length; i++) {
                            const text = characters[Math.floor(Math.random() * characters.length)];
                            ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                                drops[i] = 0;
                            }
                            drops[i]++;
                        }
                    };
                    
                    matrixInterval = setInterval(draw, 45);

                    window.addEventListener('resize', () => {
                        if (!matrixActive) return;
                        canvas.height = window.innerHeight;
                        canvas.width = window.innerWidth;
                        const newColumns = Math.floor(canvas.width / fontSize);
                        drops = [];
                        for (let x = 0; x < newColumns; x++) {
                            drops[x] = 1;
                        }
                    });
                }

                function stopMatrixEffect() {
                    if (matrixInterval) clearInterval(matrixInterval);
                    const canvas = document.getElementById('matrix-canvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        canvas.style.display = 'none';
                    }
                }
            }

            window.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    openGlobalSearch();
                }
                 if (e.key === 'Escape' && !document.getElementById('global-search-modal').classList.contains('hidden')) {
                    closeGlobalSearch();
                }
            });

            window.addEventListener('click', (e) => {
                if (!e.target.closest('#notification-container') && !e.target.closest('#user-menu-container')) {
                    document.querySelectorAll('.dropdown-content.show').forEach(d => d.classList.remove('show'));
                }
                const ocsMonthFilterDropdown = document.getElementById('ocs-month-filter-dropdown');
                if (ocsMonthFilterDropdown && !ocsMonthFilterDropdown.contains(e.target)) {
                    const panel = document.getElementById('ocs-month-filter-panel');
                    if (panel) panel.classList.add('hidden');
                }
                const solpedsMonthFilterDropdown = document.getElementById('solpeds-month-filter-dropdown');
                if (solpedsMonthFilterDropdown && !solpedsMonthFilterDropdown.contains(e.target)) {
                    const panel = document.getElementById('solpeds-month-filter-panel');
                    if (panel) panel.classList.add('hidden');
                }
            });
        });

        function handleNotesInput(e) {
            if (currentUserRole === 'viewer') return;
            const itemId = e.target.dataset.itemId;
            if (itemId) {
                if (notesSaveTimeout) clearTimeout(notesSaveTimeout);

                const itemInState = items.find(i => i.id === itemId);
                if (itemInState) itemInState.description_notes = e.target.value;

                notesSaveTimeout = setTimeout(async () => {
                    const notes = e.target.value;
                    const itemRef = doc(inventoryCollectionRef, itemId);
                    try {
                        await updateDoc(itemRef, { description_notes: notes });
                        showToast('Nota guardada.', 'success');
                    } catch (error) {
                        console.error("Error al guardar la nota:", error);
                        showToast('Error al guardar la nota.', 'error');
                    }
                }, 1000); // Debounce for 1 second
            }
        }

        async function saveDirectItemUpdate(itemId, field, value, inputElement) {
            if (currentUserRole === 'viewer') {
                return;
            }

            const itemRef = doc(inventoryCollectionRef, itemId);
            const parentCell = inputElement.parentElement;
            let statusIndicator = parentCell.querySelector('.input-status-indicator');
            
            if (!statusIndicator) {
                statusIndicator = document.createElement('span');
                statusIndicator.className = 'input-status-indicator';
                statusIndicator.innerHTML = `<div class="loader"></div><svg class="saved-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                parentCell.appendChild(statusIndicator);
            }

            statusIndicator.style.display = 'block';
            statusIndicator.classList.add('saving');
            statusIndicator.classList.remove('saved');

            try {
                await updateDoc(itemRef, { 
                    [field]: value, 
                    isModified: true,
                    lastModifiedBy: currentUserTag,
                    lastModifiedAt: new Date().toISOString()
                });
                
                statusIndicator.classList.remove('saving');
                statusIndicator.classList.add('saved');

                setTimeout(() => {
                    statusIndicator.style.display = 'none';
                    statusIndicator.classList.remove('saved');
                }, 2000);

            } catch (error) {
                console.error(`Error actualizando ${field}:`, error);
                showToast(`Error al guardar ${field}.`, 'error');
                statusIndicator.style.display = 'none';
            }
        }

        function handleDirectEditInput(e) {
            const input = e.target;
            if (input.disabled) return;
            
            const { itemId, field } = input.dataset;
            const key = `${itemId}-${field}`;

            if (updateDebounceTimers.has(key)) {
                clearTimeout(updateDebounceTimers.get(key));
            }
            
            handleNumericInputFormatting(e);

            const timer = setTimeout(() => {
                const rawValue = input.value;
                const numericValue = parseInt(String(rawValue).replace(/\./g, ''), 10);
                
                if (!isNaN(numericValue)) {
                    const itemInState = items.find(i => i.id === itemId);
                    if (itemInState && itemInState[field] !== numericValue) {
                        saveDirectItemUpdate(itemId, field, numericValue, input);
                    }
                }
                updateDebounceTimers.delete(key);
            }, 1200);

            updateDebounceTimers.set(key, timer);
        }

        function handleReviewNotesInput(e) {
            if (currentUserRole !== 'owner') return;
            const groupName = e.target.dataset.groupName;
            if (groupName) {
                if (notesSaveTimeoutReview) clearTimeout(notesSaveTimeoutReview);
                
                groupNotes.set(groupName, e.target.value);

                notesSaveTimeoutReview = setTimeout(async () => {
                    const notesObject = Object.fromEntries(groupNotes);
                    try {
                        // Usamos set con merge:true para crear o actualizar el campo de forma segura
                        await setDoc(appConfigDocRef, { groupNotes: notesObject }, { merge: true });
                    } catch (error) {
                        console.error("Error al guardar la nota de revisión:", error);
                        showToast('Error al guardar la nota.', 'error');
                    }
                }, 1000); 
            }
        }

        // --- Global Search Functions ---
        function openGlobalSearch() {
            const modal = document.getElementById('global-search-modal');
            const container = document.getElementById('global-search-container');
            modal.classList.remove('hidden');
            setTimeout(() => {
                container.style.opacity = '1';
                container.style.transform = 'translateY(0)';
                document.getElementById('global-search-input').focus();
            }, 10);
        }

        function closeGlobalSearch() {
            const modal = document.getElementById('global-search-modal');
            const container = document.getElementById('global-search-container');
            container.style.opacity = '0';
            container.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('global-search-input').value = '';
                document.getElementById('global-search-results').innerHTML = '<p class="p-6 text-center text-slate-400 uppercase">Comienza a escribir para buscar...</p>';
            }, 200);
        }

        function handleGlobalSearch(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('global-search-results');

            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<p class="p-6 text-center text-slate-400 uppercase">Escribe al menos 2 caracteres...</p>';
                return;
            }
            
            const searchWords = searchTerm.split(' ').filter(Boolean);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const insumosResults = items.filter(item => {
                const itemText = `${item.name} ${item.code}`.toLowerCase();
                return searchWords.every(word => itemText.includes(word));
            }).slice(0, 5);

            const solpedsResults = solpeds.filter(s => {
                const solpedText = `${s.solicitud} ${s.cod} ${s.descripcion}`.toLowerCase();
                return searchWords.every(word => solpedText.includes(word));
            }).map(s => ({
                ...s,
                isDelayed: parseDateString(s.fechaLiberacion) && parseDateString(s.fechaLiberacion) < today
            })).sort((a, b) => {
                const dateA = parseDateString(a.fechaLiberacion);
                const dateB = parseDateString(b.fechaLiberacion);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            }).slice(0, 5);

            const ocsResults = ocs.filter(oc => {
                const ocText = `${oc.ordenDeCompra} ${oc.solped} ${oc.codigo} ${oc.denominacion}`.toLowerCase();
                return searchWords.every(word => ocText.includes(word));
            }).map(oc => ({
                ...oc,
                isDelayed: parseDateString(oc.proxFechaEntrega) && parseDateString(oc.proxFechaEntrega) < today
            })).sort((a, b) => {
                const dateA = parseDateString(a.proxFechaEntrega);
                const dateB = parseDateString(b.proxFechaEntrega);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            }).slice(0, 5);

            renderGlobalSearchResults({ insumos: insumosResults, solpeds: solpedsResults, ocs: ocsResults });
        }

        function renderGlobalSearchResults({ insumos, solpeds, ocs }) {
            const resultsContainer = document.getElementById('global-search-results');
            let html = '';

            if (insumos.length === 0 && solpeds.length === 0 && ocs.length === 0) {
                resultsContainer.innerHTML = '<p class="p-6 text-center text-slate-500 uppercase">No se encontraron resultados.</p>';
                return;
            }

            if (insumos.length > 0) {
                html += '<h3 class="px-4 pt-4 pb-2 text-sm font-bold text-indigo-500 uppercase border-b border-indigo-500">Insumos</h3>';
                html += '<ul class="divide-y divide-slate-100">';
                insumos.forEach(item => {
                    html += `
                        <li class="p-4 hover:bg-indigo-50 cursor-pointer search-result-item" data-type="insumo" data-id="${item.id}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium text-slate-800 uppercase">${item.name.toUpperCase()}</p>
                                    <p class="text-sm text-slate-500 uppercase">Código: ${item.code} | Grupo: ${item.group}</p>
                                </div>
                                <div class="text-right ml-4 flex-shrink-0">
                                    <p class="font-bold text-lg text-slate-700">${formatNumber(item.stock)}</p>
                                    <p class="text-xs text-slate-500 -mt-1 uppercase">Stock</p>
                                </div>
                            </div>
                        </li>`;
                });
                html += '</ul>';
            }

            if (solpeds.length > 0) {
                html += '<h3 class="px-4 pt-4 pb-2 text-sm font-bold text-indigo-500 uppercase border-b border-indigo-500">Solpeds</h3>';
                html += '<ul class="divide-y divide-slate-100">';
                solpeds.forEach(s => {
                    const delayedClass = s.isDelayed ? 'text-red-600' : 'text-slate-800';
                    const delayedIndicator = s.isDelayed ? '<span class="ml-2 text-xs font-bold">(VENCIDA)</span>' : '';
                    const qtyClass = s.isDelayed ? 'text-red-600' : 'text-slate-700';
                    html += `
                        <li class="p-4 hover:bg-indigo-50 cursor-pointer search-result-item" data-type="solped" data-id="${s.solicitud}">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium ${delayedClass} uppercase">SOLPED: ${s.solicitud} ${delayedIndicator}</p>
                                    <p class="text-sm text-slate-500 uppercase">${s.descripcion}</p>
                                    <p class="text-xs text-slate-400 mt-1 uppercase">F. LIBERACIÓN: ${formatDate(s.fechaLiberacion) || 'N/A'}</p>
                                </div>
                                <div class="text-right ml-4 flex-shrink-0">
                                    <p class="font-bold text-lg ${qtyClass}">${formatNumber(s.cantidad)}</p>
                                    <p class="text-xs text-slate-500 -mt-1 uppercase">Cant.</p>
                                </div>
                            </div>
                        </li>`;
                });
                html += '</ul>';
            }

            if (ocs.length > 0) {
                html += '<h3 class="px-4 pt-4 pb-2 text-sm font-bold text-indigo-500 uppercase border-b border-indigo-500">Órdenes de Compra (O/C)</h3>';
                html += '<ul class="divide-y divide-slate-100">';
                ocs.forEach(oc => {
                    const delayedClass = oc.isDelayed ? 'text-red-600' : 'text-slate-800';
                    const delayedIndicator = oc.isDelayed ? '<span class="ml-2 text-xs font-bold">(VENCIDA)</span>' : '';
                    const qtyClass = oc.isDelayed ? 'text-red-600' : 'text-slate-700';
                    html += `
                        <li class="p-4 hover:bg-indigo-50 cursor-pointer search-result-item" data-type="oc" data-id="${oc.ordenDeCompra}">
                           <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium ${delayedClass} uppercase">O/C: ${oc.ordenDeCompra} ${delayedIndicator}</p>
                                    <p class="text-sm text-slate-500 uppercase">${oc.denominacion}</p>
                                    <p class="text-xs text-slate-400 mt-1 uppercase">PRÓX. ENTREGA: ${formatDate(oc.proxFechaEntrega) || 'N/A'}</p>
                                </div>
                                <div class="text-right ml-4 flex-shrink-0">
                                    <p class="font-bold text-lg ${qtyClass}">${formatNumber(oc.cantEntregaSiguiente)}</p>
                                    <p class="text-xs text-slate-500 -mt-1 uppercase">Cant.</p>
                                </div>
                            </div>
                        </li>`;
                });
                html += '</ul>';
            }

            resultsContainer.innerHTML = html;
        }

        async function downloadSearchModalAsImage() {
            const searchContainer = document.getElementById('global-search-container');
            if (!searchContainer) {
                showToast('No se encontró el contenedor de búsqueda.', 'error');
                return;
            }

            try {
                showToast('Generando imagen para descargar...', 'info');
                const canvas = await html2canvas(searchContainer, {
                    allowTaint: true,
                    useCORS: true,
                    backgroundColor: '#ffffff', // Use white background for download
                    scale: 2 // Higher resolution
                });
                
                const link = document.createElement('a');
                link.download = `captura_busqueda_${getCurrentDateString()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast('La descarga de la imagen ha comenzado.', 'success');

            } catch (error) {
                console.error('Error al generar la imagen:', error);
                showToast('Error al generar la imagen.', 'error');
            }
        }

        function handleExportIncomingItems() {
            const incomingOCs = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate >= currentIngresosWeek.start && deliveryDate <= currentIngresosWeek.end;
            });

            if (incomingOCs.length === 0) {
                showToast('No hay ingresos para exportar en la semana seleccionada.', 'info');
                return;
            }
            
            const formattedData = incomingOCs.map(oc => {
                 const item = items.find(i => i.code === oc.codigo);
                 const cleanItemName = item ? item.name.replace(new RegExp(`^${item.code}\\s*`), '') : oc.denominacion;
                 return {
                    'Fecha de Entrega': formatDate(oc.proxFechaEntrega),
                    'Grupo de Artículos': extractGroupCode(oc.grupoDeArticulos),
                    'Código': oc.codigo,
                    'Denominación': cleanItemName,
                    'O/C': oc.ordenDeCompra,
                    'Posición': oc.posicion,
                    'Cantidad': oc.cantEntregaSiguiente,
                    'Status': transformOCStatus(oc.status)
                 };
            });

            const weekId = getWeekId(currentIngresosWeek.start);
            const weekNumber = parseInt(weekId.split('-')[1], 10);
            const year = weekId.split('-')[0];
            const filename = `Ingresos_Semana_${weekNumber}_${year}_${getCurrentDateString()}.xlsx`;
            exportToExcel(formattedData, filename);
        }
    </script>
</body>
</html>










































































































