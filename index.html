<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Consultas de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', -ms-sans-serif, sans-serif; }
        #auth-container, #app-container { transition: opacity 0.5s ease-in-out; }
        .table-sort-button { background: none; border: none; cursor: pointer; font-weight: 700; width: 100%; text-align: inherit; display: flex; align-items: center; justify-content: inherit; gap: 4px;}
        .table-sort-button:hover { color: #2563eb; }
        .table-sort-button.active { color: #2563eb; }
        .sort-icon { width: 16px; height: 16px; transition: transform 0.2s ease-in-out; }
        .table-sort-button.active.asc .sort-icon { transform: rotate(180deg); }
        .table-sort-button.active.desc .sort-icon { transform: rotate(0deg); }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(100%); } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #3498db; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: white; min-width: 240px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 20; border-radius: 8px; border: 1px solid #e5e7eb; padding: 8px 0; margin-top: 4px; }
        .dropdown-content.show { display: block; }
        .dropdown-content a, .dropdown-content button { color: #374151; padding: 10px 16px; text-decoration: none; display: flex; align-items:center; gap: 8px; font-size: 14px; font-weight: 500; transition: background-color 0.2s; width: 100%; text-align: left; background: none; border: none; cursor: pointer;}
        .dropdown-content a:hover, .dropdown-content button:hover { background-color: #f3f4f6; }
        .dropdown-divider { height: 1px; margin: 8px 0; overflow: hidden; background-color: #e5e7eb; }
        .query-result-row { cursor: pointer; transition: background-color 0.2s; }
        .query-result-row:hover { background-color: #f9fafb; }
        .admin-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .admin-tab.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .online-indicator { display: inline-block; width: 8px; height: 8px; background-color: #22c55e; border-radius: 50%; margin-right: 8px; }
        .btn-main-style {
            background-color: white;
            color: #374151;
            font-weight: 600;
            padding: 4px 12px;
            font-size: 0.875rem;
            line-height: 1.25rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-main-style:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }
        .nav-link { padding: 6px 12px; font-weight: 500; color: #4b5563; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-link:hover { color: #111827; }
        .nav-link.active { color: #1d4ed8; border-bottom-color: #1d4ed8; }
        .kpi-card { background-color: white; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; justify-content: space-between; transition: all 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .consumo-kpi-card { background-color: #f9fafb; border-radius: 0.75rem; padding: 1rem; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .favorite-btn:hover {
            background-color: rgba(252, 211, 77, 0.3);
        }
        .favorite-btn svg {
            width: 24px;
            height: 24px;
            stroke: #f59e0b;
            stroke-width: 1.5;
        }
        .favorite-btn.is-favorite svg {
            fill: #f59e0b;
        }
        .consumo-chart-wrapper { display: flex; height: 250px; padding-top: 20px; border-top: 1px solid #e5e7eb; margin-top: 1rem; }
        .consumo-y-axis { display: flex; flex-direction: column; justify-content: space-between; height: 100%; padding-right: 10px; text-align: right; font-size: 12px; color: #6b7280; }
        .consumo-chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 100%; flex-grow: 1; border-left: 1px solid #e5e7eb; position: relative; }
        .consumo-chart-bar-wrapper { display: flex; flex-direction: column; align-items: center; width: 8%; height: 100%; justify-content: flex-end; }
        .consumo-chart-bar { width: 60%; border-radius: 4px 4px 0 0; position: relative; display: flex; justify-content: center; align-items: flex-start; transition: height 0.3s ease-out, background-color 0.3s ease-out; }
        .consumo-chart-projected-line { position: absolute; width: 100%; border-top: 2px dashed #ef4444; left: 0; z-index: 5; }
        .consumo-chart-projected-label { position: absolute; right: -4px; top: 0; transform: translateY(-50%); background-color: #ef4444; color: white; padding: 1px 4px; font-size: 10px; font-weight: bold; border-radius: 4px; }
        .consumo-chart-value { padding-top: 8px; color: white; font-weight: 600; font-size: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        .consumo-chart-label { margin-top: 8px; font-size: 12px; color: #6b7280; }
        .indice-coverage-btn { padding: 4px 12px; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; display: inline-flex; align-items: center; }
        .indice-coverage-btn.active { background-color: white; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); border-color: #d1d5db; }
        .notification-item.unread { background-color: #eff6ff; }
        .notification-item:hover { background-color: #f9fafb; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="auth-container" class="hidden min-h-screen bg-gray-100 flex flex-col justify-center items-center p-4">
        <div class="w-full max-w-sm">
            <div class="text-center mb-8">
                <div class="inline-block bg-white p-4 rounded-full shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path><path d="M20 9H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V11a2 2 0 0 0-2-2z"></path></svg>
                </div>
            </div>
            
            <div id="login-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800">Insumos</h2>
                <p class="text-center text-sm text-gray-500 mt-1 mb-6">v4.10 - 31/08/2025</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="text-sm font-medium text-gray-700">Email</label>
                        <input id="login-email" type="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="login-password" class="text-sm font-medium text-gray-700">Contraseña</label>
                        <input id="login-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm text-center h-5"></div>
                    <div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Iniciar Sesión</button></div>
                </form>
                <p class="mt-6 text-center text-sm text-gray-500">¿No tienes cuenta? <button id="show-register-view-btn" class="font-medium text-blue-600 hover:text-blue-500">Regístrate</button></p>
            </div>
            
            <div id="register-view" class="bg-white p-8 rounded-2xl shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800">Crear Cuenta</h2>
                <p id="register-subtitle" class="text-center text-sm text-gray-500 mt-1 mb-6">El primer usuario será Administrador.</p>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-email" class="text-sm font-medium text-gray-700">Email</label>
                        <input id="register-email" type="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="register-password" class="text-sm font-medium text-gray-700">Contraseña</label>
                        <input id="register-password" type="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="register-error" class="text-red-500 text-sm text-center h-5"></div>
                    <div><button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Registrar</button></div>
                </form>
                <p class="mt-6 text-center text-sm text-gray-500">¿Ya tienes cuenta? <button id="show-login-view-btn" class="font-medium text-blue-600 hover:text-blue-500">Inicia sesión</button></p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <nav class="bg-white shadow-sm sticky top-0 z-20">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center gap-2">
                             <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path><path d="M20 9H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V11a2 2 0 0 0-2-2z"></path></svg>
                            <span class="font-bold text-xl text-gray-800">INSUMOS ALMACEN</span>
                            <span class="ml-2 text-xs font-semibold text-gray-400">v4.10</span>
                        </div>
                        <div class="hidden md:block">
                            <div id="main-nav-links" class="ml-10 flex items-baseline space-x-4">
                                <button data-view="dashboard" class="nav-link active">Dashboard</button>
                                <button data-view="indice" class="nav-link">Insumos</button>
                                <button data-view="consumos" class="nav-link">Consumos</button>
                                <button data-view="solpeds" class="nav-link">Solpeds</button>
                                <button data-view="ocs" class="nav-link">Orden de Compra</button>
                                <button data-view="reportes" class="nav-link hidden">Reportes</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="db-info-container"></div>
                        <div id="notification-container" class="relative hidden">
                            <button id="notification-bell-btn" class="p-2 rounded-full hover:bg-gray-100 relative">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                                <span id="notification-count-badge" class="absolute top-0 right-0 block h-4 w-4 rounded-full bg-red-500 text-white text-xs font-bold flex items-center justify-center" style="font-size: 10px; display: none;"></span>
                            </button>
                            <div id="notification-dropdown" class="dropdown-content" style="min-width: 360px; max-height: 400px; overflow-y: auto;">
                            </div>
                        </div>
                        <div id="user-menu-container" class="relative">
                            <button id="user-menu-button" class="flex items-center gap-2 p-2 rounded-full hover:bg-gray-100 disabled:cursor-default disabled:hover:bg-transparent">
                                <div id="user-avatar" class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold"></div>
                                <span id="user-name" class="font-semibold text-sm hidden sm:block"></span>
                            </button>
                            <div id="user-dropdown-content" class="dropdown-content">
                                <button id="admin-button-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg><span>Configuración</span></button>
                                <button id="manual-button-dropdown"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg><span>Manual de Usuario</span></button>
                                <div class="dropdown-divider hidden" id="admin-actions-divider"></div>
                                <button id="dashboard-preload-btn-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg><span>Precarga BD</span></button>
                                <button id="dashboard-clear-btn-dropdown" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span>Limpiar BD</span></button>
                                <div class="dropdown-divider"></div>
                                <button id="logout-button-dropdown"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg><span>Cerrar Sesión</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main>
            <div id="dashboard-view">
                 <div class="grid grid-cols-1 lg:grid-cols-2 lg:items-start gap-6 p-4 sm:p-6 lg:p-8">
                    <div class="flex flex-col gap-6">
                        <div id="kpi-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                         <div id="progress-bar-container" class="w-full hidden flex items-center gap-4">
                            <span id="week-number-display" class="text-2xl font-bold text-blue-700 whitespace-nowrap"></span>
                            <div class="w-full bg-gray-200 rounded-full h-8 relative">
                                <div id="progress-bar" class="bg-blue-600 h-8 rounded-full transition-all duration-500" style="width: 0%"></div>
                                <span id="progress-bar-text" class="absolute inset-0 flex items-center justify-center text-xl font-bold text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">0%</span>
                            </div>
                        </div>
                        <div id="review-container" class="bg-white rounded-lg shadow overflow-hidden hidden">
                            <div class="p-4 flex justify-between items-center border-b">
                                <div class="flex items-center gap-4">
                                    <h2 class="text-xl font-bold text-gray-900">Revisión Semanal</h2>
                                    <button id="show-history-btn" class="btn-main-style text-xs py-1">Historial</button>
                                    <button id="export-review-btn" class="btn-main-style text-xs py-1">Exportar</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="save-review-btn" class="btn-main-style bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100">Guardar</button>
                                    <button id="clear-review-btn" class="btn-main-style bg-red-50 text-red-700 border-red-200 hover:bg-red-100">Limpiar</button>
                                </div>
                            </div>
                            <div id="groups-review-list" class="max-h-96 overflow-y-auto">
                                <!-- La lista de grupos se inyecta aquí -->
                            </div>
                        </div>
                    </div>
                     <div id="low-stock-container" class="bg-white rounded-lg shadow">
                        <!-- Content will be injected by JS -->
                    </div>
                </div>
            </div>

            <div id="indice-view" class="hidden">
                <div class="bg-white p-6 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-bold text-gray-900">INSUMOS</h2>
                            <div id="indice-group-filter-container" class="mr-4"></div>
                            <div class="relative">
                                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                <input type="text" id="indice-search-input" placeholder="Buscar insumos..." class="w-80 p-2 pl-10 bg-white border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div id="indice-coverage-filter-buttons" class="flex items-center p-1 bg-gray-100 rounded-lg">
                                <button data-filter="all" class="indice-coverage-btn active">Todos</button>
                                <button data-filter="red" class="indice-coverage-btn"><span class="w-2 h-2 mr-2 bg-red-500 rounded-full inline-block"></span></button>
                                <button data-filter="yellow" class="indice-coverage-btn"><span class="w-2 h-2 mr-2 bg-yellow-400 rounded-full inline-block"></span></button>
                                <button data-filter="green" class="indice-coverage-btn"><span class="w-2 h-2 mr-2 bg-green-500 rounded-full inline-block"></span></button>
                            </div>
                            <div class="h-6 border-l border-gray-300 mx-2"></div>
                            <button id="indice-favorites-filter-btn" class="btn-main-style">Favoritos</button>
                            <button id="export-indice-btn" class="btn-main-style">Exportar</button>
                        </div>
                    </div>
                    <div id="indice-table-container" class="max-h-[85vh] overflow-y-auto">
                        <!-- La tabla del indice se inyectará aquí -->
                    </div>
                </div>
            </div>

            <div id="consumos-view" class="hidden">
                <div class="flex flex-col h-full">
                    <div class="bg-white p-4 shadow-md z-10">
                        <div class="flex items-start gap-4">
                            <div id="primary-search-wrapper" class="flex-1">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        <div id="consumo-group-filter-container"></div>
                                        <button id="consumo-favorites-filter-btn" data-type="primary" class="btn-main-style">Favoritos</button>
                                    </div>
                                    <button id="consumo-clear-filters-btn" class="btn-main-style">Limpiar Todo</button>
                                </div>
                                <div class="relative mt-2">
                                    <input type="text" id="consumo-search-input" placeholder="Buscar producto 1..." class="w-full p-2 pl-10 bg-white border border-gray-300 rounded-lg">
                                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    <div id="consumo-search-results" class="absolute top-full left-0 right-0 bg-white border mt-1 rounded-lg shadow-lg z-20 max-h-60 overflow-y-auto"></div>
                                </div>
                            </div>
                            <div id="comparison-search-wrapper" class="flex-1">
                                <div class="flex items-center gap-2">
                                    <div id="consumo-comparison-group-filter-container"></div>
                                    <button id="consumo-comparison-favorites-filter-btn" data-type="comparison" class="btn-main-style">Favoritos</button>
                                </div>
                                <div class="relative mt-2">
                                    <input type="text" id="consumo-comparison-search-input" placeholder="Buscar producto 2..." class="w-full p-2 pl-10 bg-white border border-gray-300 rounded-lg">
                                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    <div id="consumo-comparison-search-results" class="absolute top-full left-0 right-0 bg-white border mt-1 rounded-lg shadow-lg z-20 max-h-60 overflow-y-auto"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="consumo-content-area" class="flex-grow flex">
                        <!-- Contenido dinámico (2 paneles) -->
                    </div>
                </div>
            </div>

            <div id="solpeds-view" class="hidden">
                <div class="bg-white p-6 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-gray-900">Solicitudes de Pedido (Solpeds)</h2>
                            <input type="text" id="solpeds-search-input" placeholder="Buscar en Solpeds..." class="w-80 p-2 bg-white border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex items-center gap-4">
                            <button id="solpeds-delayed-filter-btn" class="btn-main-style">SP Demoradas</button>
                            <button id="export-solpeds-btn" class="btn-main-style">Exportar</button>
                        </div>
                    </div>
                    <div id="solpeds-table-container" class="max-h-[85vh] overflow-y-auto">
                        <!-- La tabla de Solpeds se inyectará aquí -->
                    </div>
                </div>
            </div>
            
            <div id="ocs-view" class="hidden">
                <div class="bg-white p-6 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                           <h2 class="text-xl font-bold text-gray-900">Órdenes de Compra (OC)</h2>
                           <input type="text" id="ocs-search-input" placeholder="Buscar en Órdenes de Compra..." class="w-80 p-2 bg-white border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex items-center gap-4">
                           <button id="ocs-delayed-filter-btn" class="btn-main-style">OC Demoradas</button>
                           <button id="export-ocs-btn" class="btn-main-style">Exportar</button>
                        </div>
                    </div>
                    <div id="ocs-table-container" class="max-h-[85vh] overflow-y-auto">
                        <!-- La tabla de OCs se inyectará aquí -->
                    </div>
                </div>
            </div>

            <div id="reportes-view" class="hidden">
                 <div class="bg-white p-6 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-4">
                           <h2 class="text-xl font-bold text-gray-900">Reporte: Stock Inmovilizado</h2>
                           <input type="text" id="immobilized-search-input" placeholder="Buscar en reporte..." class="w-80 p-2 bg-white border border-gray-300 rounded-lg">
                        </div>
                         <button id="export-immobilized-btn" class="btn-main-style">Exportar</button>
                    </div>
                    <div id="immobilized-stock-table-container" class="max-h-[85vh] overflow-y-auto">
                        <!-- La tabla de Stock Inmovilizado se inyectará aquí -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Modales -->
        <div id="preload-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Precarga masiva de datos</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500 mb-4"> Selecciona un archivo <code class="text-xs bg-gray-100 p-1 rounded">.xlsx</code>. Hojas requeridas:<br> <code class="text-xs bg-gray-100 p-1 rounded">Inventario</code>, <code class="text-xs bg-gray-100 p-1 rounded">Historial Consumo</code>, <code class="text-xs bg-gray-100 p-1 rounded">Solped</code>, <code class="text-xs bg-gray-100 p-1 rounded">OC</code></p>
                        <input type="file" id="preload-file-input" accept=".xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                        <div id="preload-feedback" class="mt-4 text-sm h-5"></div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="process-preload-data" class="flex items-center justify-center px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"> <span id="process-preload-text">Procesar y Sincronizar Datos</span> <span id="process-preload-loader" class="loader hidden"></span> </button>
                        <button id="close-preload-modal" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400"> Cerrar </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="confirm-clear-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"> <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /> </svg> </div>
                    <h3 id="confirm-modal-title" class="text-lg leading-6 font-medium text-gray-900 mt-4"></h3>
                    <div class="mt-2 px-7 py-3"> <p id="confirm-modal-text" class="text-sm text-gray-500"></p> </div>
                    <div class="items-center px-4 py-3 flex justify-center gap-4"> <button id="cancel-clear-button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400"> Cancelar </button> <button id="confirm-clear-button" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Sí, Continuar</button> </div>
                </div>
            </div>
        </div>
        <div id="admin-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-5xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Panel de Administración</h2>
                    <button id="close-admin-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px" id="admin-tabs">
                        <button data-tab="permissions" class="admin-tab active">Usuarios y Permisos</button>
                        <button data-tab="settings" class="admin-tab">Configuración</button>
                    </nav>
                </div>
                <div id="admin-content-permissions" class="py-4">
                    <p class="text-sm text-gray-600 mb-4">Gestiona los roles y etiquetas de los usuarios registrados. El rol "Propietario" no puede ser modificado.</p>
                    <div id="permissions-list" class="max-h-[50vh] overflow-y-auto"></div>
                </div>
                <div id="admin-content-settings" class="py-4 hidden">
                     <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900">Umbrales de Cobertura (Días)</h3>
                            <p class="text-sm text-gray-500 mt-1">Define los rangos para los indicadores de color en toda la aplicación.</p>
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="setting-red-threshold" class="block text-sm font-medium text-gray-700">Rojo (Crítico) - Límite superior</label>
                                    <input type="number" id="setting-red-threshold" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="setting-yellow-threshold" class="block text-sm font-medium text-gray-700">Amarillo (Precaución) - Límite superior</label>
                                    <input type="number" id="setting-yellow-threshold" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 pt-6">
                             <h3 class="text-lg font-medium text-gray-900">Notificaciones</h3>
                             <p class="text-sm text-gray-500 mt-1">Define cuándo se deben generar las notificaciones de stock bajo.</p>
                             <div class="mt-4">
                                 <label for="setting-notification-threshold" class="block text-sm font-medium text-gray-700">Alertar insumos con cobertura menor a (días)</label>
                                 <input type="number" id="setting-notification-threshold" class="mt-1 block w-full md:w-1/2 bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                             </div>
                        </div>
                         <div class="border-t border-gray-200 pt-6">
                             <h3 class="text-lg font-medium text-gray-900">Análisis de Reportes</h3>
                             <p class="text-sm text-gray-500 mt-1">Configuraciones para los reportes generados.</p>
                             <div class="mt-4">
                                 <label for="setting-immobilization-months" class="block text-sm font-medium text-gray-700">Meses para análisis de stock inmovilizado</label>
                                 <input type="number" id="setting-immobilization-months" class="mt-1 block w-full md:w-1/2 bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                             </div>
                         </div>
                        <div class="border-t border-gray-200 pt-6">
                             <h3 class="text-lg font-medium text-gray-900">Visualización de Consumos</h3>
                             <p class="text-sm text-gray-500 mt-1">Selecciona los meses del historial de consumo que se mostrarán en el gráfico.</p>
                             <div id="consumption-months-checkboxes" class="mt-4 grid grid-cols-4 sm:grid-cols-6 gap-x-6 gap-y-3">
                                <!-- Checkboxes for months -->
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="0" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M1</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="1" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M2</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="2" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M3</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="3" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M4</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="4" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M5</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="5" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M6</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="6" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M7</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="7" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M8</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="8" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M9</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="9" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M10</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="10" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M11</span></label>
                                <label class="flex items-center space-x-2"><input type="checkbox" data-month-index="11" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"> <span class="text-sm font-medium text-gray-700">M12</span></label>
                             </div>
                        </div>
                     </div>
                     <div class="mt-8 flex justify-end">
                        <button id="save-settings-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Guardar Cambios</button>
                     </div>
                </div>
            </div>
        </div>
        <div id="review-history-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Historial de Revisiones Semanales</h2>
                    <button id="close-history-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <div id="history-modal-content" class="history-table-container"></div>
            </div>
        </div>
        <div id="favorites-group-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Seleccionar Grupo de Favoritos</h3>
                    <button id="close-favorites-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <div id="favorites-group-list" class="max-h-60 overflow-y-auto">
                    <!-- Group list will be injected here -->
                </div>
            </div>
        </div>
        <div id="record-consumption-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-xl shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Insumos con Consumo Récord</h3>
                    <button id="close-record-consumption-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <div id="record-consumption-item-list" class="max-h-60 overflow-y-auto">
                    <!-- Item list will be injected here -->
                </div>
            </div>
        </div>
        <div id="manual-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
                 <div class="flex justify-between items-center mb-4 pb-4 border-b">
                    <h2 class="text-2xl font-semibold text-gray-800">Manual de Usuario - Insumos Almacén v4.10</h2>
                    <button id="close-manual-modal-button" class="text-gray-400 hover:text-gray-600 text-3xl">&times;</button>
                </div>
                <div class="prose max-w-none max-h-[75vh] overflow-y-auto pr-4 text-gray-600">
                    <h3 class="font-semibold text-gray-900">1. Introducción</h3>
                    <p>Bienvenido al Panel de Consultas de Inventario. Esta herramienta está diseñada para proporcionar una visión clara y actualizada de la gestión de insumos, ayudándole a tomar decisiones informadas sobre el stock, los pedidos y los consumos.</p>

                    <h3 class="font-semibold text-gray-900 mt-4">2. Dashboard (Vista Principal)</h3>
                    <p>Es la pantalla inicial y ofrece un resumen general del estado del inventario.</p>
                    <ul>
                        <li><strong>Indicadores Clave (KPIs):</strong> Tarjetas que muestran datos importantes como el total de productos, la cantidad de favoritos, el número de grupos, y alertas sobre consumos récord o pedidos vencidos. Al hacer clic en el KPI de 'Favoritos', se le redirigirá a la pestaña de Insumos con todos sus productos favoritos ya filtrados.</li>
                        <li><strong>Revisión Semanal:</strong> Permite llevar un control de los grupos de insumos que han sido revisados durante la semana actual. Marque un grupo como revisado para seguir el progreso. Esta función está disponible para roles de Editor y Propietario.</li>
                        <li><strong>Insumos Críticos:</strong> Una tabla que muestra automáticamente los productos cuya cobertura de stock está por debajo del umbral crítico (definido en la configuración, por defecto 30 días). Permite un acceso rápido a los items que requieren atención inmediata.</li>
                    </ul>

                    <h3 class="font-semibold text-gray-900 mt-4">3. Pestaña Insumos</h3>
                    <p>Ofrece una vista detallada y personalizable de todos los productos del inventario.</p>
                    <ul>
                        <li><strong>Búsqueda y Filtros:</strong> La barra de búsqueda permite encontrar insumos por nombre o código instantáneamente. Use los filtros para acotar la lista:
                            <ul>
                                <li><strong>Filtro de Cobertura:</strong> Botones para ver solo insumos en estado crítico (rojo), de precaución (amarillo) o con stock suficiente (verde).</li>
                                <li><strong>Filtro de Grupos:</strong> Un menú desplegable para aislar un grupo específico de productos.</li>
                                <li><strong>Filtro de Favoritos:</strong> Al hacer clic en el botón "Favoritos", la tabla mostrará únicamente los insumos que haya marcado con una estrella. Esta es una forma rápida de acceder a los productos más importantes para usted.</li>
                            </ul>
                        </li>
                        <li><strong>Tabla de Insumos:</strong> Muestra la lista de productos con su grupo, código, stock, consumo mensual, cobertura en días y notas. Puede ordenar la tabla haciendo clic en los encabezados. Hacer clic en una fila lo llevará a la vista de Consumos para ese item.</li>
                        <li><strong>Marcar como Favorito:</strong> Haga clic en el ícono de estrella (★) en la primera columna de la tabla para marcar o desmarcar un insumo como favorito. Los insumos favoritos se conservan incluso si se realiza una limpieza de la base de datos y son un filtro útil en toda la aplicación.</li>
                    </ul>

                    <h3 class="font-semibold text-gray-900 mt-4">4. Pestaña Consumos</h3>
                    <p>El centro de análisis para cada producto. Permite visualizar y comparar el historial de consumo.</p>
                    <ul>
                        <li><strong>Panel de Análisis y Comparación:</strong> Puede seleccionar un producto principal y, opcionalmente, un segundo producto para comparar sus datos.</li>
                        <li><strong>Gráfico de Historial de Consumo:</strong> Muestra el consumo mensual histórico del producto seleccionado. Una línea punteada roja indica el "Consumo Mensual" proyectado para facilitar la comparación. Puede configurar qué meses se visualizan desde el panel de administración.</li>
                        <li><strong>Pedidos y Notas:</strong> Debajo del gráfico, encontrará tablas con las Solpeds y Órdenes de Compra asociadas al producto. También hay un campo para añadir notas o descripciones importantes.</li>
                    </ul>

                    <h3 class="font-semibold text-gray-900 mt-4">5. Pestañas Solpeds y Órdenes de Compra (OC)</h3>
                    <p>Estas secciones contienen tablas detalladas con todas las Solicitudes de Pedido y Órdenes de Compra cargadas en el sistema. Puede buscar, filtrar por pedidos demorados y ordenar la información haciendo clic en los encabezados.</p>

                    <h3 class="font-semibold text-gray-900 mt-4">6. Funciones Generales</h3>
                    <ul>
                        <li><strong>Menú de Usuario:</strong> Al hacer clic en su inicial, se despliega un menú.</li>
                        <li><strong>Notificaciones:</strong> El ícono de la campana le alertará sobre insumos con bajo stock u órdenes de compra demoradas.</li>
                    </ul>
                    
                    <h3 class="font-semibold text-gray-900 mt-4">7. Panel de Administración (Solo Propietarios)</h3>
                    <p>Accesible desde el menú de usuario para el rol de "Propietario".</p>
                    <ul>
                        <li><strong>Precarga y Limpieza de Datos:</strong> Permite cargar masivamente todos los datos desde un archivo Excel o limpiar la base de datos (conservando favoritos).</li>
                        <li><strong>Gestión de Permisos:</strong> Asigne roles (Editor, Visor) a otros usuarios.</li>
                        <li><strong>Configuración de la Aplicación:</strong>
                            <ul>
                                <li><strong>Umbrales de Cobertura:</strong> Defina los días para los estados rojo y amarillo.</li>
                                <li><strong>Notificaciones:</strong> Establezca el umbral de días para generar alertas de stock bajo.</li>
                                <li><strong>Visualización de Consumos:</strong> Seleccione los meses específicos (M1-M12) que desea ver en el gráfico de historial de consumo.</li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch, getDocs, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ESTADO DE LA APLICACIÓN ---
        let items = [];
        let solpeds = [];
        let ocs = [];
        let notifications = [];
        let appSettings = {
            coverageThresholds: { red: 30, yellow: 60 },
            notificationThreshold: 15,
            consumptionMonths: [true, true, true, true, true, true, true, true, true, true, true, true],
            immobilizationMonths: 6
        };
        let solpedsSortConfig = { key: 'fechaSolicitud', direction: 'desc' };
        let ocsSortConfig = { key: 'proxFechaEntrega', direction: 'asc' };
        let indiceSortConfig = { key: 'group', direction: 'asc' };
        let immobilizedSortConfig = { key: 'monthsWithoutConsumption', direction: 'desc' };
        let allUserPermissions = new Map();
        let currentView = 'dashboard';
        let isAuthReady = false;
        let selectedConsumptionItemId = null;
        let comparisonItemId = null;
        let consumoSelectedGroup = 'all';
        let consumoShowOnlyFavorites = false;
        let consumoComparisonSelectedGroup = 'all';
        let consumoComparisonShowOnlyFavorites = false;
        let showOnlyDelayedOCs = false;
        let showOnlyDelayedSolpeds = false;
        let showOnlyFavoriteCriticals = false;
        let criticalsSelectedGroup = 'all';
        let indiceSearchTerm = '';
        let indiceSelectedGroup = 'all';
        let indiceShowFavorites = false;
        let indiceCoverageFilter = 'all';
        let notesSaveTimeout;
        
        // --- VARIABLES DE FIREBASE Y USUARIO ---
        let app, db, auth, userId, appId;
        let inventoryCollectionRef, permissionsCollectionRef, metadataDocRef, reviewHistoryCollectionRef, solpedsCollectionRef, ocsCollectionRef, appConfigDocRef;
        let unsubscribeInventory, unsubscribePermissions, unsubscribeMetadata, unsubscribeSolpeds, unsubscribeOCs, unsubscribeAppConfig;
        let currentUserRole = 'viewer'; 
        let currentUserTags = [];
        
        // --- CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCpEzBrL-Yi6kwPshw63UgwqnNOXWHH9eU",
          authDomain: "gestion-inventario-app-a11d6.firebaseapp.com",
          projectId: "gestion-inventario-app-a11d6",
          storageBucket: "gestion-inventario-app-a11d6.appspot.com",
          messagingSenderId: "817333595251",
          appId: "1:817333595251:web:437b7b2f91bdae506f4e06"
        };

        // --- FUNCIONES DE UTILIDAD ---
        function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.textContent = message; container.appendChild(toast); setTimeout(() => { toast.remove(); }, 5000); }
        function addDays(date, days) { const result = new Date(date); result.setDate(result.getDate() + days); return result; }
        
        function formatDate(isoDateString) {
            if (!isoDateString) return '';
            const date = parseDateString(isoDateString);
            if (!date) return isoDateString;

            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            
            return `${day}-${month}-${year}`;
        }

        function parseDateString(dateStr) {
            if (!dateStr || (typeof dateStr !== 'string' && typeof dateStr !== 'number') || String(dateStr).trim() === '') return null;
            
            if(typeof dateStr === 'number' && dateStr > 1) {
                const d = new Date((dateStr - 25569) * 86400000);
                 if (d instanceof Date && !isNaN(d)) {
                    d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
                    return d;
                }
            }

            const trimmedStr = String(dateStr).trim();
            
            const matchDMY = trimmedStr.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{4})$/);
            if (matchDMY) {
                const day = parseInt(matchDMY[1], 10);
                const month = parseInt(matchDMY[2], 10) - 1;
                const year = parseInt(matchDMY[3], 10);
                if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                    const d = new Date(Date.UTC(year, month, day));
                    if (d.getUTCFullYear() === year && d.getUTCMonth() === month && d.getUTCDate() === day) {
                        return d;
                    }
                }
            }

            const isoDate = new Date(trimmedStr + 'T00:00:00Z');
            if (!isNaN(isoDate.getTime())) {
                return isoDate;
            }

            return null;
        }

        const parseAndFormatDateToISO = (val) => {
            if (!val) return '';
            const d = parseDateString(val);
            if (d) return d.toISOString().split('T')[0];
            return '';
        };

        function getWeekId(d) {
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            const weekNumber = 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            return `${date.getFullYear()}-${String(weekNumber).padStart(2, '0')}`;
        }
        function daysBetween(date1, date2) { return Math.round((new Date(date2) - new Date(date1)) / (1000 * 60 * 60 * 24)); }
        function formatNumber(num) { return new Intl.NumberFormat('es-AR').format(num); }

        // --- LÓGICA DE AUTENTICACIÓN Y UI INICIAL ---
        function handleAuthError(error, elementId) { const errorEl = document.getElementById(elementId); let message = "Ocurrió un error."; switch (error.code) { case 'auth/user-not-found': case 'auth/invalid-credential': message = "Credenciales incorrectas."; break; case 'auth/wrong-password': message = "Contraseña incorrecta."; break; case 'auth/email-already-in-use': message = "El email ya está registrado."; break; case 'auth/weak-password': message = "La contraseña debe tener al menos 6 caracteres."; break; case 'auth/invalid-email': message = "El formato del email no es válido."; break; } errorEl.textContent = message; }
        async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { handleAuthError(error, 'login-error'); } }
        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast('Cuenta creada. Serás redirigido.', 'success');
            } catch (error) {
                handleAuthError(error, 'register-error');
            }
        }
        async function handleLogout() { try { await signOut(auth); window.location.reload(); } catch (error) { console.error("Error al cerrar sesión:", error); showToast('Error al cerrar sesión.', 'error'); } }
        function switchAuthView(view) { document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.add('hidden'); if (document.getElementById(view)) { document.getElementById(view).classList.remove('hidden'); } }

        // --- LÓGICA DE NAVEGACIÓN Y VISTAS ---
        function switchMainView(view) {
            currentView = view;
            document.getElementById('dashboard-view').classList.toggle('hidden', view !== 'dashboard');
            document.getElementById('indice-view').classList.toggle('hidden', view !== 'indice');
            document.getElementById('consumos-view').classList.toggle('hidden', view !== 'consumos');
            document.getElementById('solpeds-view').classList.toggle('hidden', view !== 'solpeds');
            document.getElementById('ocs-view').classList.toggle('hidden', view !== 'ocs');
            document.getElementById('reportes-view').classList.toggle('hidden', view !== 'reportes');
            
            document.querySelectorAll('#main-nav-links .nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === view);
            });

            if (view === 'indice') {
                renderIndiceView();
            } else if (view === 'consumos') {
                renderConsumosView();
            } else if (view === 'solpeds') {
                renderSolpedsView();
            } else if (view === 'ocs') {
                renderOCsView();
            } else if (view === 'reportes') {
                renderReportesView();
            }
        }

        // --- LÓGICA DE PERMISOS Y UI ---
        function adaptUiToRole(role, user) {
            const isOwner = role === 'owner';
            const isEditorOrOwner = role === 'owner' || role === 'editor';
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown-content');

            document.getElementById('admin-button-dropdown').classList.toggle('hidden', !isEditorOrOwner);
            document.getElementById('admin-actions-divider').classList.toggle('hidden', !isEditorOrOwner);
            document.getElementById('dashboard-preload-btn-dropdown').classList.toggle('hidden', !isEditorOrOwner);
            document.getElementById('dashboard-clear-btn-dropdown').classList.toggle('hidden', !isEditorOrOwner);
            document.querySelector('[data-view="reportes"]').classList.toggle('hidden', !isEditorOrOwner);
            document.getElementById('notification-container').classList.toggle('hidden', !isEditorOrOwner);
            
            userMenuButton.disabled = false;

            document.getElementById('review-container').classList.toggle('hidden', role === 'viewer');
            document.getElementById('progress-bar-container').classList.toggle('hidden', role === 'viewer');
            
            const userEmail = user.email || '';
            const userName = userEmail.split('@')[0];
            const userInitial = userName.charAt(0).toUpperCase();
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-avatar').textContent = userInitial;
        }

        // --- LÓGICA DE NOTIFICACIONES ---
        function generateNotifications() {
            const newNotifications = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const lowStockItems = getProcessedItems().filter(item => item.coverageDays < appSettings.notificationThreshold && item.coverageDays !== Infinity);
            lowStockItems.forEach(item => {
                newNotifications.push({
                    id: `lowstock_${item.id}`,
                    type: 'low_stock',
                    text: `Cobertura baja para <strong>${item.name}</strong> (${Math.round(item.coverageDays)} días).`,
                    targetId: item.id,
                    timestamp: new Date().toISOString()
                });
            });

            const delayedOCs = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate < today;
            });
            delayedOCs.forEach(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                const delayDays = daysBetween(deliveryDate, today);
                newNotifications.push({
                    id: `ocdelayed_${oc.ordenDeCompra}_${oc.posicion}`,
                    type: 'oc_delayed',
                    text: `La OC <strong>${oc.ordenDeCompra}</strong> está demorada ${delayDays} día(s).`,
                    targetId: oc.ordenDeCompra,
                    timestamp: new Date().toISOString()
                });
            });

            const existingNotificationsMap = new Map(notifications.map(n => [n.id, n]));
            newNotifications.forEach(newNotif => {
                const existing = existingNotificationsMap.get(newNotif.id);
                if (existing) {
                    newNotif.read = existing.read;
                } else {
                    newNotif.read = false;
                }
            });
            
            notifications = newNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            renderNotifications();
        }

        function renderNotifications() {
            const badge = document.getElementById('notification-count-badge');
            const dropdown = document.getElementById('notification-dropdown');
            const unreadCount = notifications.filter(n => !n.read).length;

            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
            
            let dropdownHTML = `
                <div class="p-3 border-b flex justify-between items-center">
                    <h4 class="font-semibold text-gray-800">Notificaciones</h4>
                    ${unreadCount > 0 ? '<button id="mark-all-read-btn" class="text-xs font-medium text-blue-600 hover:underline">Marcar todas como leídas</button>' : ''}
                </div>
            `;
            
            if (notifications.length === 0) {
                dropdownHTML += '<p class="p-4 text-sm text-center text-gray-500">No hay notificaciones.</p>';
            } else {
                dropdownHTML += notifications.map(n => `
                    <div class="p-3 border-b text-sm notification-item ${!n.read ? 'unread' : ''}" data-id="${n.id}" data-type="${n.type}" data-target-id="${n.targetId}">
                        <div class="flex items-start gap-3">
                           <div class="flex-shrink-0 mt-1">
                                ${n.type === 'low_stock' 
                                    ? '<svg class="w-5 h-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>'
                                    : '<svg class="w-5 h-5 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                                }
                           </div>
                           <div>${n.text}</div>
                        </div>
                    </div>
                `).join('');
            }
            dropdown.innerHTML = dropdownHTML;
        }

        function handleNotificationClick(e) {
            const item = e.target.closest('.notification-item');
            if (!item) return;
            
            const { id, type, targetId } = item.dataset;
            
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.read = true;
            }
            renderNotifications();
            document.getElementById('notification-dropdown').classList.remove('show');
            
            if (type === 'low_stock') {
                selectedConsumptionItemId = targetId;
                comparisonItemId = null;
                switchMainView('consumos');
            } else if (type === 'oc_delayed') {
                switchMainView('ocs');
                document.getElementById('ocs-search-input').value = targetId;
                renderOCsView();
            }
        }

        // --- FUNCIONES DE FIREBASE ---
        async function handleToggleFavorite(itemId) {
            const itemRef = doc(inventoryCollectionRef, itemId);
            const currentItem = items.find(i => i.id === itemId);
            if (!currentItem) return;
            const newFavoriteStatus = !currentItem.isFavorite;
            try {
                await updateDoc(itemRef, { isFavorite: newFavoriteStatus });
                showToast(newFavoriteStatus ? 'Añadido a favoritos.' : 'Quitado de favoritos.', 'success');
            } catch (error) {
                console.error("Error al actualizar favorito:", error);
                showToast('Error al cambiar estado de favorito.', 'error');
            }
        }
        function handleClearAll() { 
            document.getElementById('confirm-modal-title').textContent = 'Limpiar datos de inventario';
            document.getElementById('confirm-modal-text').textContent = 'Se borrarán todos los insumos que no estén marcados como favoritos. Los favoritos (y sus notas) se conservarán, pero su stock y pedidos se reiniciarán a cero. ¿Continuar?';
            document.getElementById('confirm-clear-modal').classList.remove('hidden');
            document.getElementById('confirm-clear-button').onclick = executeClearAll;
        }
        async function executeClearAll() { 
            if (!db) return; 
            showToast('Limpiando datos...', 'info'); 
            try { 
                const batch = writeBatch(db); 
                const querySnapshot = await getDocs(inventoryCollectionRef); 
                let favoritesKept = 0; 
                let nonFavoritesDeleted = 0; 
                querySnapshot.forEach((doc) => { 
                    const data = doc.data();
                    if (data.isFavorite) { 
                        batch.update(doc.ref, { 
                            stock: 0, 
                            monthlyConsumption: 0, 
                            delayedQuantity: 0, 
                            orderQuantities: [], 
                            isModified: false, 
                            consumos: [],
                            description_notes: data.description_notes || ''
                        }); 
                        favoritesKept++; 
                    } else { 
                        batch.delete(doc.ref); 
                        nonFavoritesDeleted++; 
                    } 
                }); 
                batch.delete(metadataDocRef); 
                await batch.commit(); 
                showToast(`Limpieza completa: ${nonFavoritesDeleted} borrados, ${favoritesKept} conservados.`, 'success'); 
            } catch (error) { 
                console.error("Error al limpiar:", error); 
                showToast('Error al limpiar los datos.', 'error'); 
            } finally { 
                document.getElementById('confirm-clear-modal').classList.add('hidden'); 
            } 
        }
        
        // --- LÓGICA DE PRECARGA Y MODALES ---
        function handleOpenPreloadModal() { document.getElementById('preload-modal').classList.remove('hidden'); document.getElementById('preload-feedback').textContent = ''; document.getElementById('preload-file-input').value = ''; }
        function handleClosePreloadModal() { document.getElementById('preload-modal').classList.add('hidden'); }
        function handleFileInputChange() { const fileInput = document.getElementById('preload-file-input'); const feedbackEl = document.getElementById('preload-feedback'); if (fileInput.files.length > 0) { feedbackEl.textContent = `Archivo: ${fileInput.files[0].name}`; } else { feedbackEl.textContent = ''; } }
        async function handleProcessPreloadData() {
            const processButton = document.getElementById('process-preload-data'), buttonText = document.getElementById('process-preload-text'), loader = document.getElementById('process-preload-loader'), fileInput = document.getElementById('preload-file-input');
            if (fileInput.files.length === 0) { showToast('Selecciona un archivo.', 'error'); return; }
            processButton.disabled = true; buttonText.classList.add('hidden'); loader.classList.remove('hidden');
            
            const favoritesMap = new Map();
            const currentInventorySnapshot = await getDocs(inventoryCollectionRef);
            currentInventorySnapshot.forEach(doc => {
                const data = doc.data();
                if (data.isFavorite) {
                    favoritesMap.set(data.code, { 
                        isFavorite: true, 
                        description_notes: data.description_notes || '' 
                    });
                }
            });

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const workbook = XLSX.read(new Uint8Array(event.target.result), { type: 'array', cellDates: true });
                    
                    const { inventoryItems: newItemsFromExcel } = processInventorySheet(workbook);
                    const { historyMap } = processHistorySheet(workbook);
                    const { solpedsData } = processSolpedsSheet(workbook);
                    const { ocsData } = processOCSheet(workbook);

                    newItemsFromExcel.forEach(item => {
                        item.consumos = historyMap.get(item.code) || [];
                        if (favoritesMap.has(item.code)) {
                            const persistentData = favoritesMap.get(item.code);
                            item.isFavorite = persistentData.isFavorite;
                            item.description_notes = persistentData.description_notes;
                        }
                    });

                    const batch = writeBatch(db);
                    
                    currentInventorySnapshot.forEach(doc => batch.delete(doc.ref));
                    newItemsFromExcel.forEach(item => batch.set(doc(inventoryCollectionRef), item));

                    const oldSolpedsSnapshot = await getDocs(solpedsCollectionRef);
                    oldSolpedsSnapshot.forEach(doc => batch.delete(doc.ref));
                    solpedsData.forEach(item => batch.set(doc(solpedsCollectionRef), item));

                    const oldOCsSnapshot = await getDocs(ocsCollectionRef);
                    oldOCsSnapshot.forEach(doc => batch.delete(doc.ref));
                    ocsData.forEach(item => batch.set(doc(ocsCollectionRef), item));

                    batch.set(metadataDocRef, { filename: file.name, lastUpdated: new Date().toISOString() });
                    await batch.commit();
                    showToast(`Sincronización completa.`, 'success');
                    setTimeout(handleClosePreloadModal, 2500);
                } catch (e) { 
                    console.error("Error procesando archivo:", e); 
                    showToast('Error al procesar el archivo.', 'error');
                } finally { 
                    processButton.disabled = false; 
                    buttonText.classList.remove('hidden'); 
                    loader.classList.add('hidden'); 
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        
        function processInventorySheet(workbook) { const sheetName = workbook.SheetNames[0]; if (!sheetName) return { inventoryItems: [], inventoryReport: { processedCount: 0, ignoredCount: 0 } }; const worksheet = workbook.Sheets[sheetName]; const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null }); const itemsMap = new Map(); const report = { processedCount: 0, ignoredCount: 0, reasons: {} }; const headerRow = rows[0].map(h => String(h).trim().toLowerCase().replace(/[\s_]+/g, '')); const colMap = { group: headerRow.indexOf('grupo'), code: headerRow.indexOf('código') !== -1 ? headerRow.indexOf('código') : headerRow.indexOf('cod'), name: headerRow.indexOf('nombre'), stock: headerRow.indexOf('stock'), monthlyConsumption: headerRow.indexOf('consumomensual'), delayedQuantity: headerRow.indexOf('demorados'), pedido: headerRow.indexOf('pedido'), fecha: headerRow.indexOf('fecha'), leadTimeDays: headerRow.indexOf('leadtime'), safetyStockDays: headerRow.indexOf('díasseguridad') }; const parseNumeric = (val) => { if (val === null || val === undefined || typeof val === 'string' && val.trim() === '' || val === '-') return 0; const cleanVal = String(val).replace(/\./g, '').replace(',', '.'); const num = parseFloat(cleanVal); return isNaN(num) ? 0 : num; }; for (let i = 1; i < rows.length; i++) { const row = rows[i]; if (!row || row.length < 2 || row.every(cell => cell === null || cell === '')) continue; const code = String(row[colMap.code] || '').trim(); const name = String(row[colMap.name] || '').trim(); if (!code || !name) { report.ignoredCount++; report.reasons['Falta Código/Nombre'] = (report.reasons['Falta Código/Nombre'] || 0) + 1; continue; } let existingItem = itemsMap.get(code); if (!existingItem) { existingItem = { code: code, group: String(row[colMap.group] || 'General').trim(), name: `${code} ${name}`, stock: parseNumeric(row[colMap.stock]), monthlyConsumption: parseNumeric(row[colMap.monthlyConsumption]), delayedQuantity: parseNumeric(row[colMap.delayedQuantity]), leadTimeDays: parseNumeric(row[colMap.leadTimeDays]), safetyStockDays: parseNumeric(row[colMap.safetyStockDays]), orderQuantities: [], isModified: false, createdAt: new Date().toISOString(), isFavorite: false, description_notes: '' }; itemsMap.set(code, existingItem); } const pedido = parseNumeric(row[colMap.pedido]); const fecha = parseAndFormatDateToISO(row[colMap.fecha]); if (pedido > 0) { if (fecha) { existingItem.orderQuantities.push({ quantity: pedido, date: fecha }); } else { report.ignoredCount++; report.reasons['Pedido sin Fecha'] = (report.reasons['Pedido sin Fecha'] || 0) + 1; } } } report.processedCount = itemsMap.size; return { inventoryItems: Array.from(itemsMap.values()), inventoryReport: report }; }
        function processHistorySheet(workbook) {
            const sheetName = workbook.SheetNames[1];
            if (!sheetName) return { historyMap: new Map(), historyReport: { processedCount: 0, ignoredCount: 0 } };
            const worksheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: null });
            const historyMap = new Map();
            const report = { processedCount: 0, ignoredCount: 0 };
            const headerRow = rows[0].map(h => String(h).trim().toLowerCase());
            const codeIndex = headerRow.indexOf('material') !== -1 ? headerRow.indexOf('material') : headerRow.indexOf('cod');
            if (codeIndex === -1) {
                console.error("No se encontró la columna 'material' o 'cod' en la Hoja2.");
                return { historyMap, historyReport: report };
            }
            const parseNumeric = (val) => {
                if (val === null || val === undefined || typeof val === 'string' && val.trim() === '' || val === '-') return 0;
                const cleanVal = String(val).replace(/\./g, '').replace(',', '.');
                const num = parseFloat(cleanVal);
                return isNaN(num) ? 0 : num;
            };
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[codeIndex]) continue;
                const code = String(row[codeIndex]).trim();
                const consumos = row.slice(2).map(parseNumeric);
                if (code) {
                    historyMap.set(code, consumos);
                } else {
                    report.ignoredCount++;
                }
            }
            report.processedCount = historyMap.size;
            return { historyMap, historyReport: report };
        }
        function processSolpedsSheet(workbook) {
            const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('solped'));
            if (!sheetName) {
                console.warn("No se encontró la hoja 'Solped' en el archivo.");
                return { solpedsData: [] };
            }
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
            const solpedsData = jsonData.map(row => ({
                solicitud: row['Solicitud de pedido'] || '',
                cod: row['Cod'] || '',
                descripcion: row['Texto breve'] || '',
                cantidad: parseFloat(String(row['Cantidad solicitada']).replace(',', '.')) || 0,
                fechaSolicitud: parseAndFormatDateToISO(row['Fecha de solicitud']),
                creadoPor: row['Creado por'] || '',
                status: row['Status'] || '',
                fechaLiberacion: parseAndFormatDateToISO(row['Fecha de liberación']),
                grupoDeCompras: row['Grupo de compras'] || ''
            }));
            return { solpedsData };
        }
        function processOCSheet(workbook) {
            const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('oc'));
            if (!sheetName) {
                console.warn("No se encontró la hoja 'OC' en el archivo.");
                return { ocsData: [] };
            }
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
            const ocsData = jsonData.map(row => ({
                solped: row['Solped'] || '',
                ordenDeCompra: row['Orden de compra'] || '',
                posicion: row['Posición'] || '',
                proxFechaEntrega: parseAndFormatDateToISO(row['Próxima fecha de entrega']),
                cantEntregaSiguiente: parseFloat(String(row['Cantidad de entrega siguiente']).replace(',', '.')) || 0,
                codigo: row['Codigo'] || '',
                denominacion: row['Denominación de material'] || '',
                cantPedido: parseFloat(String(row['Cantidad de pedido']).replace(',', '.')) || 0,
                grupoDeCompras: row['Grupo de compras'] || '',
                status: row['Status de la orden'] || ''
            }));
            return { ocsData };
        }
        
        // --- LÓGICA DEL PANEL DE ADMINISTRACIÓN ---
        async function openAdminModal() {
            document.getElementById('admin-modal').classList.remove('hidden');
            
            const permissionsTab = document.querySelector('.admin-tab[data-tab="permissions"]');
            const settingsTab = document.querySelector('.admin-tab[data-tab="settings"]');
            const permissionsContent = document.getElementById('admin-content-permissions');
            const settingsContent = document.getElementById('admin-content-settings');

            if (currentUserRole === 'owner') {
                permissionsTab.classList.remove('hidden');
                permissionsTab.classList.add('active');
                settingsTab.classList.remove('active');
                permissionsContent.classList.remove('hidden');
                settingsContent.classList.add('hidden');
                
                allUserPermissions.clear();
                const querySnapshot = await getDocs(permissionsCollectionRef);
                querySnapshot.forEach(doc => { allUserPermissions.set(doc.id, doc.data().email || doc.id); });
                renderPermissionsList();

            } else if (currentUserRole === 'editor') {
                permissionsTab.classList.add('hidden');
                settingsTab.classList.add('active');
                permissionsTab.classList.remove('active');
                permissionsContent.classList.add('hidden');
                settingsContent.classList.remove('hidden');
            }
            
            document.getElementById('setting-red-threshold').value = appSettings.coverageThresholds.red;
            document.getElementById('setting-yellow-threshold').value = appSettings.coverageThresholds.yellow;
            document.getElementById('setting-notification-threshold').value = appSettings.notificationThreshold;
            document.getElementById('setting-immobilization-months').value = appSettings.immobilizationMonths;
            
            const monthCheckboxes = document.querySelectorAll('#consumption-months-checkboxes input[type="checkbox"]');
            const selectedMonths = appSettings.consumptionMonths || Array(12).fill(true);
            monthCheckboxes.forEach((checkbox, index) => {
                checkbox.checked = selectedMonths[index];
            });
        }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
        async function renderPermissionsList() { const listEl = document.getElementById('permissions-list'); listEl.innerHTML = '<div class="flex justify-center p-4"><div class="loader"></div></div>'; const querySnapshot = await getDocs(permissionsCollectionRef); const permissions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); listEl.innerHTML = `<table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-2">Usuario</th><th class="px-4 py-2">Rol</th><th class="px-4 py-2">Grupos Editables</th><th class="px-4 py-2">Etiquetas</th></tr></thead><tbody>${permissions.map(p => `<tr class="border-b"><td class="px-4 py-2 font-mono text-xs">${p.email || p.id} ${p.id === userId ? '<span class="text-indigo-600 font-bold">(Tú)</span>' : ''}</td><td class="px-4 py-2"><select data-userid="${p.id}" class="role-select bg-gray-50 border rounded p-1" ${p.role === 'owner' || currentUserRole !== 'owner' ? 'disabled' : ''}><option value="owner" ${p.role === 'owner' ? 'selected' : ''} disabled>Propietario</option><option value="editor" ${p.role === 'editor' ? 'selected' : ''}>Editor</option><option value="viewer" ${p.role === 'viewer' ? 'selected' : ''}>Visor</option></select></td><td class="px-4 py-2"><input type="text" data-userid="${p.id}" class="groups-input w-full p-1 border rounded" value="${(p.editableGroups || []).join(',')}" ${p.role !== 'editor' || currentUserRole !== 'owner' ? 'disabled' : ''}></td><td class="px-4 py-2"><input type="text" data-userid="${p.id}" class="tags-input w-full p-1 border rounded" placeholder="Ej: Proveedor A" value="${(p.tags || []).join(',')}" ${currentUserRole !== 'owner' ? 'disabled' : ''}></td></tr>`).join('')}</tbody></table>`; }
        async function updateUserPermissions(targetUserId, role, groups, tags) { const userPermRef = doc(permissionsCollectionRef, targetUserId); const editableGroups = groups.split(',').map(g => g.trim()).filter(Boolean); const tagsArray = tags.split(',').map(t => t.trim()).filter(Boolean); try { await updateDoc(userPermRef, { role, editableGroups, tags: tagsArray }); showToast(`Permisos actualizados.`, 'success'); } catch (error) { showToast('Error al actualizar permisos.', 'error'); console.error(error); } }
        async function handleSaveSettings() {
            const red = parseInt(document.getElementById('setting-red-threshold').value, 10);
            const yellow = parseInt(document.getElementById('setting-yellow-threshold').value, 10);
            const notification = parseInt(document.getElementById('setting-notification-threshold').value, 10);
            const immobilization = parseInt(document.getElementById('setting-immobilization-months').value, 10);
            
            const monthCheckboxes = document.querySelectorAll('#consumption-months-checkboxes input[type="checkbox"]');
            const selectedMonths = Array.from(monthCheckboxes).map(cb => cb.checked);

            if (isNaN(red) || isNaN(yellow) || isNaN(notification) || isNaN(immobilization)) {
                showToast('Todos los valores deben ser números.', 'error');
                return;
            }
            if (red >= yellow) {
                showToast('El umbral rojo debe ser menor que el amarillo.', 'error');
                return;
            }
            if (red <= 0 || yellow <= 0 || notification <= 0 || immobilization <= 0) {
                showToast('Los valores deben ser mayores a cero.', 'error');
                return;
            }
            if (!selectedMonths.some(m => m)) {
                showToast('Debes seleccionar al menos un mes.', 'error');
                return;
            }

            const newSettings = {
                coverageThresholds: { red, yellow },
                notificationThreshold: notification,
                consumptionMonths: selectedMonths,
                immobilizationMonths: immobilization
            };

            try {
                await setDoc(appConfigDocRef, { settings: newSettings }, { merge: true });
                showToast('Configuración guardada correctamente.', 'success');
                closeAdminModal();
            } catch (error) {
                console.error("Error al guardar configuración:", error);
                showToast('Error al guardar la configuración.', 'error');
            }
        }

        // --- LÓGICA DE RENDERIZADO PRINCIPAL ---
        function renderApp() {
            if (!isAuthReady) return;
            
            switch (currentView) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'indice':
                    renderIndiceView();
                    break;
                case 'consumos':
                    renderConsumosView();
                    break;
                 case 'reportes':
                    renderReportesView();
                    break;
            }
        }
        function getProcessedItems() {
            return items.map(item => {
                const dailyConsumption = item.monthlyConsumption > 0 ? item.monthlyConsumption / 30 : 0;
                const coverageDays = dailyConsumption > 0 ? Math.floor(item.stock / dailyConsumption) : Infinity;
                const leadTimeDays = item.leadTimeDays || 0;
                const safetyStockDays = item.safetyStockDays || 0;
                const reorderPointDays = leadTimeDays + safetyStockDays;
                return { ...item, dailyConsumption, coverageDays, leadTimeDays, safetyStockDays, reorderPointDays };
            });
        }
        async function renderDashboard() {
            const kpiContainer = document.getElementById('kpi-container');
            if (!kpiContainer) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const processedItems = getProcessedItems(true);
            const totalProducts = processedItems.length;
            const favoriteCount = processedItems.filter(item => item.isFavorite).length;
            const uniqueGroups = [...new Set(processedItems.map(item => item.group))].length;
            
            const recordConsumptionCount = processedItems.filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            }).length;

            const solpedsVencidasCount = solpeds.filter(s => {
                const releaseDate = parseDateString(s.fechaLiberacion);
                return releaseDate && releaseDate < today;
            }).length;

            const ocsVencidasCount = ocs.filter(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                return deliveryDate && deliveryDate < today;
            }).length;

            const kpis = [
                { type: 'total', title: 'Productos Totales', value: formatNumber(totalProducts), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>', color: 'blue' },
                { type: 'favorites', title: 'Favoritos', value: favoriteCount, subtitle: 'Insumos destacados', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>', color: 'yellow' },
                { type: 'groups', title: 'Total de Grupos', value: uniqueGroups, subtitle: 'Categorías activas', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>', color: 'green' },
                { type: 'consumption-peak', title: 'Consumo Récord', value: recordConsumptionCount, subtitle: 'Superando pico histórico', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>', color: 'red' },
                { type: 'solpeds-vencidas', title: 'Solpeds Vencidas', value: solpedsVencidasCount, subtitle: 'Liberación pasada', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M12 22a2 2 0 0 0 2-2V7H10v13a2 2 0 0 0 2 2z"/><path d="M16 10h4l-4-4v4z"/><path d="M16 10h4l-4-4v4z"/></svg>', color: 'red' },
                { type: 'ocs-vencidas', title: 'OC Vencidas', value: ocsVencidasCount, subtitle: 'Entrega demorada', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>', color: 'red' }
            ];
            
            const colorClasses = { blue: { bg: 'bg-blue-100', text: 'text-blue-600' }, yellow: { bg: 'bg-yellow-100', text: 'text-yellow-600' }, green: { bg: 'bg-green-100', text: 'text-green-600' }, red: { bg: 'bg-red-100', text: 'text-red-600' } };

            kpiContainer.innerHTML = kpis.map(kpi => `
                <div class="kpi-card" data-kpi="${kpi.type}">
                    <div class="flex justify-between items-start">
                        <div><p class="text-sm font-medium text-gray-500 truncate">${kpi.title}</p><p class="mt-1 text-4xl font-bold text-gray-900">${kpi.value}</p></div>
                        <div class="p-3 rounded-full ${colorClasses[kpi.color].bg} ${colorClasses[kpi.color].text}">${kpi.icon}</div>
                    </div>
                    ${kpi.subtitle ? `<p class="text-sm text-gray-500 mt-2">${kpi.subtitle}</p>` : ''}
                </div>`).join('');
            
            renderCriticalItemsTable();

            if (currentUserRole !== 'viewer') {
                await renderReviewTable();
            }
        }

        function renderCriticalItemsTable() {
            const container = document.getElementById('low-stock-container');
            if (!container) return;

            const redThreshold = appSettings.coverageThresholds.red;
            let processedItems = getProcessedItems(true);
            let lowStockItems = processedItems.filter(item => item.coverageDays < redThreshold && item.coverageDays !== Infinity);
            const allGroups = [...new Set(lowStockItems.map(item => item.group || 'General'))].sort();

            const searchInput = container.querySelector('#low-stock-search');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            if (criticalsSelectedGroup !== 'all') {
                lowStockItems = lowStockItems.filter(item => item.group === criticalsSelectedGroup);
            }
            
            if (showOnlyFavoriteCriticals) {
                lowStockItems = lowStockItems.filter(item => item.isFavorite);
            }

            if (searchTerm) {
                lowStockItems = lowStockItems.filter(item => item.name.toLowerCase().includes(searchTerm));
            }
            
            lowStockItems.sort((a, b) => a.coverageDays - b.coverageDays);

            const favFilterBtnClass = showOnlyFavoriteCriticals ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : '';

            let groupFilterHTML = `<select id="low-stock-group-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 w-full"><option value="all">TODOS LOS GRUPOS</option>`;
            allGroups.forEach(group => {
                const selected = group === criticalsSelectedGroup ? 'selected' : '';
                groupFilterHTML += `<option value="${group}" ${selected}>${group}</option>`;
            });
            groupFilterHTML += `</select>`;

            let contentHTML = `
                <div class="p-4 border-b">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">Insumos Críticos (&lt; ${redThreshold} días)</h3>
                            <p class="text-sm text-gray-500">${lowStockItems.length} items requieren atención.</p>
                        </div>
                        <button id="low-stock-favorites-filter-btn" class="btn-main-style ${favFilterBtnClass}">Favoritos</button>
                    </div>
                    <div class="flex items-center gap-2 mt-3">
                        <div class="flex-1">${groupFilterHTML}</div>
                        <input type="text" id="low-stock-search" value="${searchTerm}" placeholder="Buscar en críticos..." class="w-full flex-1 p-2 bg-white border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div id="low-stock-list" class="max-h-[640px] overflow-y-auto">
                    ${generateLowStockListHTML(lowStockItems)}
                </div>
            `;
            container.innerHTML = contentHTML;
        }

        function generateLowStockListHTML(itemsToRender) {
            if (itemsToRender.length === 0) {
                return '<p class="p-4 text-center text-gray-500">No se encontraron insumos.</p>';
            }
            return itemsToRender.map(item => `
                <div class="p-4 flex items-center justify-between hover:bg-blue-50 border-b">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <button class="favorite-btn ${item.isFavorite ? 'is-favorite' : ''}" data-item-id="${item.id}" data-btn-type="low-stock-fav">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </button>
                        <div class="flex-1 cursor-pointer low-stock-item-details" data-item-id="${item.id}">
                            <p class="font-semibold text-gray-800 truncate">${item.name}</p>
                            <p class="text-sm text-gray-500">Grupo: ${item.group}</p>
                        </div>
                    </div>
                    <div class="text-right pl-2 cursor-pointer low-stock-item-details" data-item-id="${item.id}">
                        <p class="font-bold text-2xl ${item.coverageDays < 7 ? 'text-red-600' : 'text-yellow-600'}">${Math.round(item.coverageDays)}</p>
                        <p class="text-xs text-gray-500 -mt-1">días</p>
                    </div>
                </div>
            `).join('');
        }


        async function renderReviewTable() {
            const groupsReviewContainer = document.getElementById('groups-review-list');
            if (!groupsReviewContainer) return;

            groupsReviewContainer.innerHTML = '<div class="p-6 text-center text-gray-500"><div class="loader inline-block"></div> Cargando...</div>';

            const today = new Date();
            const prevWeekDate = new Date();
            prevWeekDate.setDate(today.getDate() - 7);
            const prevWeekId = getWeekId(prevWeekDate);
            const prevWeekReviewDocRef = doc(reviewHistoryCollectionRef, prevWeekId);
            let reviewedGroupsLastWeek = new Set();

            try {
                const docSnap = await getDoc(prevWeekReviewDocRef);
                if (docSnap.exists()) {
                    reviewedGroupsLastWeek = new Set(docSnap.data().reviewedGroups || []);
                }
            } catch (e) {
                console.error("Could not fetch last week's review status", e);
            }
            
            const groups = items.reduce((acc, item) => {
                const group = item.group || 'General';
                acc[group] = (acc[group] || 0) + 1;
                return acc;
            }, {});
            const sortedGroups = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));

            if (sortedGroups.length > 0) {
                groupsReviewContainer.innerHTML = `<ul role="list" class="divide-y divide-gray-200">${sortedGroups.map(([groupName, count]) => {
                    const wasReviewedLastWeek = reviewedGroupsLastWeek.has(groupName);
                    const rowClass = !wasReviewedLastWeek ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50';
                    return `
                    <li class="p-4 flex items-center justify-between ${rowClass}">
                        <div class="group-item-name flex-1 min-w-0 cursor-pointer" data-group-name="${groupName}">
                            <p class="text-lg font-medium text-blue-600 truncate">${groupName}</p>
                            <p class="text-sm text-gray-500">${count} insumos</p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            <label class="flex items-center space-x-2 cursor-pointer p-2 rounded-md hover:bg-gray-200">
                                <input type="checkbox" data-group-name="${groupName}" class="review-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-gray-600 hidden sm:inline">Revisado</span>
                            </label>
                        </div>
                    </li>`;
                }).join('')}</ul>`;
                loadCurrentWeekReview();
            } else {
                groupsReviewContainer.innerHTML = `<div class="p-6 text-center text-gray-500">No hay grupos para mostrar.</div>`;
            }
        }

        function handleKpiClick(kpiType) {
            if (kpiType === 'total') {
                switchMainView('indice');
            } else if (kpiType === 'favorites') {
                indiceShowFavorites = true;
                indiceSelectedGroup = 'all';
                indiceCoverageFilter = 'all';
                indiceSearchTerm = '';
                switchMainView('indice');
            } else if (kpiType === 'consumption-peak') {
                openRecordConsumptionModal();
            } else if (kpiType === 'groups') {
                switchMainView('consumos');
            } else if (kpiType === 'solpeds-vencidas') {
                showOnlyDelayedSolpeds = true;
                switchMainView('solpeds');
            } else if (kpiType === 'ocs-vencidas') {
                showOnlyDelayedOCs = true;
                switchMainView('ocs');
            }
        }
        
        function openFavoritesGroupModal() {
            const modal = document.getElementById('favorites-group-modal');
            const listEl = document.getElementById('favorites-group-list');
            
            const favoriteItems = items.filter(item => item.isFavorite);
            if (favoriteItems.length === 0) {
                showToast('No tienes insumos marcados como favoritos.', 'info');
                return;
            }
            
            const favoriteGroups = [...new Set(favoriteItems.map(item => item.group || 'General'))].sort();
            
            listEl.innerHTML = favoriteGroups.map(group => 
                `<div class="p-3 hover:bg-gray-100 cursor-pointer border-b favorite-group-item" data-group-name="${group}">${group}</div>`
            ).join('');
            
            modal.classList.remove('hidden');
        }

        function openRecordConsumptionModal() {
            const recordConsumptionItems = getProcessedItems(true).filter(item => {
                if (item.consumos && item.consumos.length > 1) {
                    const currentMonthConsumption = item.consumos[item.consumos.length - 1];
                    const historicalConsumptions = item.consumos.slice(0, -1);
                    if (historicalConsumptions.length > 0) {
                        const peakHistoricalConsumption = Math.max(...historicalConsumptions);
                        return currentMonthConsumption > peakHistoricalConsumption;
                    }
                }
                return false;
            });

            if (recordConsumptionItems.length === 0) {
                showToast('No hay insumos con consumo récord este mes.', 'info');
                return;
            }
            
            if (recordConsumptionItems.length === 1) {
                switchMainView('consumos');
                selectedConsumptionItemId = recordConsumptionItems[0].id;
                renderConsumosView();
                return;
            }
            
            const modal = document.getElementById('record-consumption-modal');
            const listEl = document.getElementById('record-consumption-item-list');
            
            listEl.innerHTML = recordConsumptionItems.map(item => 
                `<div class="p-3 hover:bg-gray-100 cursor-pointer border-b record-consumption-item" data-item-id="${item.id}">${item.name}</div>`
            ).join('');
            
            modal.classList.remove('hidden');
        }

        // --- LÓGICA DE REVISIÓN SEMANAL (FIRESTORE) ---
        async function handleSaveReview() {
            if (!userId || !reviewHistoryCollectionRef) return;
            const reviewedGroups = Array.from(document.querySelectorAll('.review-checkbox:checked')).map(cb => cb.dataset.groupName);
            
            const weekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, weekId);
            try {
                await setDoc(reviewDocRef, { 
                    reviewedGroups, 
                    lastUpdatedBy: userId, 
                    weekId, 
                    updatedAt: serverTimestamp()
                }, { merge: true });
                showToast('Revisión guardada en la base de datos.', 'success');
            } catch (error) {
                console.error("Error al guardar la revisión: ", error);
                showToast('Error al guardar la revisión.', 'error');
            }
        }

        async function handleClearReview() {
            document.querySelectorAll('.review-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateReviewProgressBar();
            
            const weekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, weekId);
            try {
                await setDoc(reviewDocRef, { reviewedGroups: [], lastUpdatedBy: userId, updatedAt: serverTimestamp() }, { merge: true });
                showToast('Revisión limpiada.', 'info');
            } catch (error) {
                console.error("Error al limpiar la revisión: ", error);
                showToast('Error al limpiar la revisión.', 'error');
            }
        }


        function handleReviewCheckboxChange(event) {
            if (!event.target.matches('.review-checkbox')) return;
            updateReviewProgressBar();
        }

        function updateReviewProgressBar() {
            const checkboxes = document.querySelectorAll('.review-checkbox');
            const total = checkboxes.length;
            if (total === 0) return;
            
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percentage = Math.round((checkedCount / total) * 100);
            
            const progressBar = document.getElementById('progress-bar');
            const progressBarText = document.getElementById('progress-bar-text');
            
            progressBar.style.width = `${percentage}%`;
            progressBarText.textContent = `${percentage}%`;
        }

        async function loadCurrentWeekReview() {
            if (!reviewHistoryCollectionRef) return;
            const currentWeekId = getWeekId(new Date());
            const reviewDocRef = doc(reviewHistoryCollectionRef, currentWeekId);
            
            try {
                const docSnap = await getDoc(reviewDocRef);
                if (docSnap.exists()) {
                    const { reviewedGroups } = docSnap.data();
                    if (reviewedGroups && Array.isArray(reviewedGroups)) {
                        reviewedGroups.forEach(groupName => {
                            const checkbox = document.querySelector(`.review-checkbox[data-group-name="${groupName}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            } catch (error) {
                console.error("Error al cargar la revisión semanal:", error);
            } finally {
                updateReviewProgressBar();
            }
        }

        async function showReviewHistory() {
            const modal = document.getElementById('review-history-modal');
            const contentEl = document.getElementById('history-modal-content');
            modal.classList.remove('hidden');
            contentEl.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>';

            try {
                const querySnapshot = await getDocs(query(collection(db, `artifacts/${appId}/users/${userId}/reviewHistory`)));
                const history = querySnapshot.docs.map(doc => doc.data());
                
                const allGroups = [...new Set(items.map(item => item.group || 'General'))].sort();
                const allWeeks = [...new Set(history.map(h => h.weekId))].sort().reverse();

                if (history.length === 0) {
                    contentEl.innerHTML = '<p class="text-center text-gray-500 p-8">No hay historial de revisiones.</p>';
                    return;
                }

                const historyMatrix = {};
                history.forEach(record => {
                    historyMatrix[record.weekId] = new Set(record.reviewedGroups);
                });

                let tableHTML = `<table class="w-full text-sm text-left text-gray-500 history-table"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-2 py-2 font-bold">Grupo</th>`;
                allWeeks.forEach(weekId => {
                    const weekNum = weekId.split('-')[1];
                    tableHTML += `<th class="px-1 py-2 text-center">${weekNum}</th>`;
                });
                tableHTML += `</tr></thead><tbody>`;

                allGroups.forEach(groupName => {
                    tableHTML += `<tr class="border-b"><td class="px-2 py-2 font-medium text-gray-900 whitespace-nowrap">${groupName}</td>`;
                    allWeeks.forEach(weekId => {
                        const isChecked = historyMatrix[weekId] && historyMatrix[weekId].has(groupName);
                        tableHTML += `<td class="px-1 py-2 text-center text-green-500 font-bold">${isChecked ? '✓' : ''}</td>`;
                    });
                    tableHTML += `</tr>`;
                });

                tableHTML += `</tbody></table>`;
                contentEl.innerHTML = tableHTML;

            } catch (error) {
                console.error("Error fetching review history:", error);
                contentEl.innerHTML = '<p class="text-center text-red-500 p-8">No se pudo cargar el historial.</p>';
            }
        }

        async function handleExportReview() {
            if (!reviewHistoryCollectionRef) {
                showToast('No se pudo acceder al historial de revisiones.', 'error');
                return;
            }

            try {
                const querySnapshot = await getDocs(reviewHistoryCollectionRef);
                const history = querySnapshot.docs.map(doc => doc.data());
                
                if (history.length === 0) {
                    showToast('No hay historial de revisiones para exportar.', 'info');
                    return;
                }

                const allGroups = [...new Set(items.map(item => item.group || 'General'))].sort();
                const dataToExport = [];
                
                const historyMap = new Map();
                history.forEach(record => {
                    historyMap.set(record.weekId, new Set(record.reviewedGroups));
                });

                const allWeeks = [...historyMap.keys()].sort();

                allWeeks.forEach(weekId => {
                    allGroups.forEach(groupName => {
                        const isReviewed = historyMap.get(weekId)?.has(groupName);
                        dataToExport.push({
                            'Semana': weekId,
                            'Grupo': groupName,
                            'Revisado': isReviewed ? 'Sí' : 'No'
                        });
                    });
                });
                
                if (dataToExport.length > 0) {
                    exportToExcel(dataToExport, 'historial_revisiones.xlsx');
                } else {
                    showToast('No se encontraron datos para exportar.', 'info');
                }

            } catch (error) {
                console.error("Error al exportar historial de revisiones:", error);
                showToast('Error al exportar el historial.', 'error');
            }
        }


        // --- LÓGICA DE LA PESTAÑA INSUMOS ---
        function renderIndiceView() {
            const container = document.getElementById('indice-table-container');
            const searchInput = document.getElementById('indice-search-input');
            const groupFilterContainer = document.getElementById('indice-group-filter-container');
            const favoritesFilterBtn = document.getElementById('indice-favorites-filter-btn');
            const { red, yellow } = appSettings.coverageThresholds;
            
            searchInput.value = indiceSearchTerm;
            if (favoritesFilterBtn) {
                favoritesFilterBtn.classList.toggle('bg-yellow-100', indiceShowFavorites);
                favoritesFilterBtn.classList.toggle('border-yellow-300', indiceShowFavorites);
                favoritesFilterBtn.classList.toggle('text-yellow-800', indiceShowFavorites);
            }
            
            const filterButtonsContainer = document.getElementById('indice-coverage-filter-buttons');
            filterButtonsContainer.querySelector('[data-filter="red"]').innerHTML = `<span class="w-2 h-2 mr-2 bg-red-500 rounded-full inline-block"></span>&lt; ${red}`;
            filterButtonsContainer.querySelector('[data-filter="yellow"]').innerHTML = `<span class="w-2 h-2 mr-2 bg-yellow-400 rounded-full inline-block"></span>${red}-${yellow}`;
            filterButtonsContainer.querySelector('[data-filter="green"]').innerHTML = `<span class="w-2 h-2 mr-2 bg-green-500 rounded-full inline-block"></span>&gt; ${yellow}`;
            
            document.querySelectorAll('#indice-coverage-filter-buttons button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === indiceCoverageFilter);
            });
            
            const uniqueGroups = [...new Set(items.map(item => item.group))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="indice-group-filter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2"><option value="all">TODOS LOS GRUPOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === indiceSelectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
                document.getElementById('indice-group-filter').value = indiceSelectedGroup;
            } else {
                groupFilterContainer.innerHTML = '';
            }

            if (items.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No hay datos de insumos.</p>';
                return;
            }

            let filteredItems = getProcessedItems();

            if (indiceCoverageFilter !== 'all') {
                filteredItems = filteredItems.filter(item => {
                    const days = item.coverageDays;
                    if (indiceCoverageFilter === 'red') return days < red;
                    if (indiceCoverageFilter === 'yellow') return days >= red && days <= yellow;
                    if (indiceCoverageFilter === 'green') return days > yellow || days === Infinity;
                    return false;
                });
            }
            if (indiceSelectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === indiceSelectedGroup);
            }
            if (indiceShowFavorites) {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            }
            if (indiceSearchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(indiceSearchTerm) ||
                    (item.description_notes || '').toLowerCase().includes(indiceSearchTerm)
                );
            }

            filteredItems.sort((a, b) => {
                const key = indiceSortConfig.key;
                const dir = indiceSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                
                if (key === 'stock' || key === 'coverageDays' || key === 'monthlyConsumption') {
                    valA = valA === Infinity ? Number.MAX_SAFE_INTEGER : parseFloat(valA) || 0;
                    valB = valB === Infinity ? Number.MAX_SAFE_INTEGER : parseFloat(valB) || 0;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });

            if (filteredItems.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No se encontraron resultados.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'isFavorite', label: '★', noSort: true, width: 'w-[5%]' },
                { key: 'group', label: 'Grupo', width: 'w-[10%]' },
                { key: 'code', label: 'Código', width: 'w-[10%]' },
                { key: 'name', label: 'Material', width: 'w-[25%]' },
                { key: 'stock', label: 'Stock Actual', class: 'justify-end border-l border-r border-gray-300', width: 'w-[10%]' },
                { key: 'monthlyConsumption', label: 'Cons. Mensual', class: 'justify-end', width: 'w-[10%]' },
                { key: 'coverageDays', label: 'Cobertura (Días)', class: 'justify-end', width: 'w-[10%]' },
                { key: 'description_notes', label: 'Notas', noSort: true, width: 'w-[20%]' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-gray-500 table-fixed"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr>`;
            headers.forEach(h => {
                const thClass = `px-4 py-2 ${h.class || ''}`;
                const widthClass = h.width || '';
                if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thClass} ${widthClass}">${h.label}</th>`;
                } else {
                    tableHTML += `<th scope="col" class="${thClass} ${widthClass}"><button class="table-sort-button ${h.class || ''}" data-sort="${h.key}">${h.label}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredItems.forEach(item => {
                let coverageClass = '';
                let coverageText = item.coverageDays === Infinity ? '∞' : Math.round(item.coverageDays);
                if (item.coverageDays !== Infinity) {
                    if (item.coverageDays < red) coverageClass = 'text-red-600 font-bold';
                    else if (item.coverageDays >= red && item.coverageDays <= yellow) coverageClass = 'text-yellow-500 font-bold';
                    else if (item.coverageDays > yellow) coverageClass = 'text-green-600 font-bold';
                } else {
                     coverageClass = 'text-green-600 font-bold';
                }

                tableHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2 text-center">
                        <button class="favorite-btn ${item.isFavorite ? 'is-favorite' : ''}" data-item-id="${item.id}" data-btn-type="indice-fav">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </button>
                    </td>
                    <td class="px-4 py-2 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.group}</td>
                    <td class="px-4 py-2 font-mono truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-gray-900 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}</td>
                    <td class="px-4 py-2 text-right truncate indice-item-details cursor-pointer text-base font-medium border-l border-r border-gray-300" data-item-id="${item.id}">${formatNumber(item.stock)}</td>
                    <td class="px-4 py-2 text-right truncate indice-item-details cursor-pointer text-base" data-item-id="${item.id}">${formatNumber(item.monthlyConsumption)}</td>
                    <td class="px-4 py-2 text-right ${coverageClass} text-base">${coverageText}</td>
                    <td class="px-4 py-2 text-xs text-gray-600 truncate indice-item-details cursor-pointer" data-item-id="${item.id}">${item.description_notes || ''}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
            const activeButton = container.querySelector(`.table-sort-button[data-sort="${indiceSortConfig.key}"]`);
            if (activeButton) {
                activeButton.classList.add('active', indiceSortConfig.direction);
                activeButton.innerHTML += sortIconSVG;
            }
        }


        // --- LÓGICA DE LA PESTAÑA CONSUMOS ---
        function renderConsumosView() {
            renderConsumoFilters('primary');
            renderConsumoFilters('comparison');
            renderConsumosContent();
        }

        function renderConsumoFilters(type) {
            const prefix = type === 'primary' ? '' : '-comparison';
            const groupFilterContainer = document.getElementById(`consumo${prefix}-group-filter-container`);
            const favoritesBtn = document.getElementById(`consumo${prefix}-favorites-filter-btn`);
            const selectedGroup = type === 'primary' ? consumoSelectedGroup : consumoComparisonSelectedGroup;
            const showFavorites = type === 'primary' ? consumoShowOnlyFavorites : consumoComparisonShowOnlyFavorites;

            const uniqueGroups = [...new Set(items.map(item => item.group))].sort();
            if (uniqueGroups.length > 0) {
                let filterHTML = `<select id="consumo${prefix}-group-filter" data-type="${type}" class="consumo-group-filter bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2"><option value="all">TODOS</option>`;
                uniqueGroups.forEach(group => {
                    const selected = group === selectedGroup ? 'selected' : '';
                    filterHTML += `<option value="${group}" ${selected}>${group}</option>`;
                });
                filterHTML += `</select>`;
                groupFilterContainer.innerHTML = filterHTML;
            } else {
                groupFilterContainer.innerHTML = '';
            }
            
            favoritesBtn.classList.toggle('bg-yellow-200', showFavorites);
            favoritesBtn.classList.toggle('border-yellow-400', showFavorites);
            favoritesBtn.classList.toggle('text-yellow-800', showFavorites);
        }
        
        function renderConsumosContent() {
            const contentArea = document.getElementById('consumo-content-area');
            contentArea.innerHTML = `
                <div id="consumo-panel-primary" class="w-1/2 bg-white overflow-y-auto"></div>
                <div class="w-px bg-gray-200"></div>
                <div id="consumo-panel-comparison" class="w-1/2 bg-white overflow-y-auto"></div>
            `;
            renderSingleConsumoPanel(selectedConsumptionItemId, 'primary');
            renderSingleConsumoPanel(comparisonItemId, 'comparison');
        }

        function renderSingleConsumoPanel(itemId, type) {
            const panel = document.getElementById(`consumo-panel-${type}`);
            if (!panel) return;

            panel.innerHTML = `
            <div class="p-4">
                <div class="flex justify-between items-center">
                    <h3 id="consumo-kpi-name-${type}" class="text-lg font-bold text-gray-900 flex-1 truncate">-</h3>
                    <div id="consumo-favorite-btn-container-${type}"></div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mt-4">
                     <div class="consumo-kpi-card text-center"> <p class="text-xs font-medium text-gray-500">STOCK ACTUAL</p> <p id="consumo-kpi-stock-${type}" class="text-3xl font-bold text-gray-900 mt-1">-</p> </div>
                     <div class="consumo-kpi-card text-center"> <p class="text-xs font-medium text-gray-500">PROMEDIO 12M</p> <p id="consumo-kpi-avg-${type}" class="text-3xl font-bold text-blue-600 mt-1">-</p> </div>
                     <div class="consumo-kpi-card text-center border-2 border-blue-500"> <p class="text-xs font-medium text-gray-500">CONSUMO MENSUAL</p> <p id="consumo-kpi-monthly-consumption-${type}" class="text-3xl font-bold text-gray-900 mt-1">-</p> </div>
                     <div class="consumo-kpi-card text-center border-2 border-blue-500"> <p class="text-xs font-medium text-gray-500">COBERTURA HOY (DÍAS)</p> <p id="consumo-kpi-coverage-today-${type}" class="text-3xl font-bold text-gray-900 mt-1">-</p> </div>
                </div>
                <div id="consumo-chart-wrapper-${type}" class="consumo-chart-wrapper">
                    <p class="text-gray-500 m-auto">Seleccione un producto para ver su historial.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <div id="consumo-solpeds-container-${type}"></div>
                    <div id="consumo-ocs-container-${type}"></div>
                </div>
                 <div class="mt-4 pt-4 border-t">
                    <label for="consumo-description-notes-${type}" class="block font-medium text-sm mb-2 text-gray-700">Notas / Descripción Breve</label>
                    <textarea id="consumo-description-notes-${type}" rows="3" class="p-2 bg-white border border-gray-300 rounded-md w-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm" placeholder="Añadir una descripción..." disabled></textarea>
                </div>
            </div>
            `;
            
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            const processedItem = getProcessedItems().find(i => i.id === itemId);

            const favoriteBtnContainer = document.getElementById(`consumo-favorite-btn-container-${type}`);
            const favoriteBtn = document.createElement('button');
            favoriteBtn.className = `favorite-btn ${item.isFavorite ? 'is-favorite' : ''}`;
            favoriteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>`;
            favoriteBtn.dataset.itemId = itemId;
            favoriteBtnContainer.innerHTML = '';
            favoriteBtnContainer.appendChild(favoriteBtn);

            document.getElementById(`consumo-kpi-name-${type}`).textContent = item.name;
            document.getElementById(`consumo-kpi-stock-${type}`).textContent = formatNumber(item.stock);
            
            const allConsumos = item.consumos || [];
            const selectedMonths = appSettings.consumptionMonths || Array(12).fill(true);
            const allMonthNames = ["M1", "M2", "M3", "M4", "M5", "M6", "M7", "M8", "M9", "M10", "M11", "M12"];
            
            const consumos = [];
            const monthLabels = [];

            selectedMonths.forEach((isSelected, index) => {
                if (isSelected && index < allConsumos.length) {
                    consumos.push(allConsumos[index]);
                    monthLabels.push(allMonthNames[index]);
                }
            });

            const avgConsumption = consumos.length > 0 ? consumos.reduce((a, b) => a + b, 0) / consumos.length : 0;
            document.getElementById(`consumo-kpi-avg-${type}`).textContent = formatNumber(Math.round(avgConsumption));
            document.getElementById(`consumo-kpi-monthly-consumption-${type}`).textContent = formatNumber(Math.round(item.monthlyConsumption));
            document.getElementById(`consumo-kpi-coverage-today-${type}`).textContent = (processedItem.coverageDays === Infinity) ? '∞' : Math.round(processedItem.coverageDays);
            
            const notesTextarea = document.getElementById(`consumo-description-notes-${type}`);
            notesTextarea.value = item.description_notes || '';
            notesTextarea.disabled = false;
            notesTextarea.dataset.itemId = itemId;
            
            const chartWrapper = document.getElementById(`consumo-chart-wrapper-${type}`);
            if (!consumos || consumos.length === 0) {
                chartWrapper.innerHTML = '<p class="text-gray-500 m-auto">Este producto no tiene historial de consumo.</p>';
            } else {
                const getNiceMaxValue = (max) => { if (max <= 0) return 10; const power = Math.floor(Math.log10(max)); const magnitude = Math.pow(10, power); return Math.ceil(max / magnitude) * magnitude; };
                
                const nonZeroConsumos = consumos.filter(c => c > 0);
                const minValue = nonZeroConsumos.length > 0 ? Math.min(...nonZeroConsumos) : 0;
                const peakConsumption = Math.max(...consumos, item.monthlyConsumption);
                const uniqueValues = [...new Set(nonZeroConsumos)];
                
                const maxValue = getNiceMaxValue(peakConsumption);
                const yAxisLabels = [0, maxValue * 0.25, maxValue * 0.5, maxValue * 0.75, maxValue];
                let yAxisHtml = '<div class="consumo-y-axis">';
                yAxisLabels.reverse().forEach(label => { yAxisHtml += `<span>${formatNumber(Math.round(label))}</span>`; });
                yAxisHtml += '</div>';

                
                let barsHtml = '<div class="consumo-chart-container">';

                if (item.monthlyConsumption > 0 && maxValue > 0) {
                    const projectedLinePosition = Math.min((item.monthlyConsumption / maxValue) * 100, 100);
                    barsHtml += `<div class="consumo-chart-projected-line" style="bottom: ${projectedLinePosition}%;"><span class="consumo-chart-projected-label">${formatNumber(Math.round(item.monthlyConsumption))}</span></div>`;
                }

                barsHtml += consumos.map((value, index) => {
                    const barHeight = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    const displayValue = value > 5000 ? (value/1000).toFixed(0) + 'k' : formatNumber(value);
                    
                    let barClass = 'bg-blue-600';
                    if (value > 0 && uniqueValues.length > 1) {
                        if (value === Math.max(...nonZeroConsumos)) barClass = 'bg-green-500';
                        else if (value === minValue) barClass = 'bg-red-500';
                    }

                    return `<div class="consumo-chart-bar-wrapper"><div class="consumo-chart-bar ${barClass}" style="height: ${barHeight}%;"><div class="consumo-chart-value">${displayValue}</div></div><div class="consumo-chart-label">${monthLabels[index]}</div></div>`;
                }).join('');
                barsHtml += '</div>';
                chartWrapper.innerHTML = yAxisHtml + barsHtml;
            }

            const solpedsContainer = document.getElementById(`consumo-solpeds-container-${type}`);
            const ocsContainer = document.getElementById(`consumo-ocs-container-${type}`);

            let itemSolpeds = solpeds.filter(s => s.cod == item.code);
            itemSolpeds.sort((a,b) => {
                const dateA = parseDateString(a.fechaLiberacion);
                const dateB = parseDateString(b.fechaLiberacion);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });
            let solpedsTableHTML = `<h4 class="font-bold text-gray-700 mb-2">Solicitudes de Pedido</h4>`;
            if(itemSolpeds.length > 0) {
                const today = new Date();
                today.setHours(0,0,0,0);
                solpedsTableHTML += `<div class="max-h-32 overflow-y-auto border rounded-lg"><table class="w-full text-sm table-fixed">
                    <thead class="bg-gray-100 sticky top-0"><tr><th class="px-2 py-1 text-left w-[40%]">N° Solped</th><th class="px-2 py-1 text-right w-[30%]">Cantidad</th><th class="px-2 py-1 text-left w-[30%]">F. Lib.</th></tr></thead><tbody>`;
                itemSolpeds.forEach(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    const isDelayed = releaseDate && releaseDate < today;
                    const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                    solpedsTableHTML += `<tr class="border-t consumo-solped-link cursor-pointer hover:bg-gray-100" data-solped-id="${s.solicitud}"><td class="px-2 py-1 truncate">${s.solicitud}</td><td class="px-2 py-1 text-right">${formatNumber(s.cantidad)}</td><td class="px-2 py-1 ${dateClass}">${formatDate(s.fechaLiberacion)}</td></tr>`;
                });
                solpedsTableHTML += `</tbody></table></div>`;
            } else {
                solpedsTableHTML += `<p class="text-sm text-gray-500">No hay Solpeds para este insumo.</p>`;
            }
            solpedsContainer.innerHTML = solpedsTableHTML;

            let itemOCs = ocs.filter(oc => oc.codigo == item.code);

            itemOCs.sort((a,b) => {
                const dateA = parseDateString(a.proxFechaEntrega);
                const dateB = parseDateString(b.proxFechaEntrega);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            let ocsTableHTML = `<h4 class="font-bold text-gray-700 mb-2">Órdenes de Compra</h4>`;
            if(itemOCs.length > 0) {
                const today = new Date();
                today.setHours(0,0,0,0);
                ocsTableHTML += `<div class="max-h-32 overflow-y-auto border rounded-lg"><table class="w-full text-sm table-fixed">
                    <thead class="bg-gray-100 sticky top-0"><tr><th class="px-2 py-1 text-left w-[40%]">N° OC</th><th class="px-2 py-1 text-right w-[30%]">Cantidad</th><th class="px-2 py-1 text-left w-[30%]">Próx. Entrega</th></tr></thead><tbody>`;
                itemOCs.forEach(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    const isDelayed = deliveryDate && deliveryDate < today;
                    const dateClass = isDelayed ? 'text-red-600 font-bold' : '';
                    ocsTableHTML += `<tr class="border-t consumo-oc-link cursor-pointer hover:bg-gray-100" data-oc-id="${oc.ordenDeCompra}"><td class="px-2 py-1 truncate">${oc.ordenDeCompra}</td><td class="px-2 py-1 text-right">${formatNumber(oc.cantEntregaSiguiente)}</td><td class="px-2 py-1 ${dateClass}">${formatDate(oc.proxFechaEntrega)}</td></tr>`;
                });
                ocsTableHTML += `</tbody></table></div>`;
            } else {
                ocsTableHTML += `<p class="text-sm text-gray-500">No hay OCs para este insumo.</p>`;
            }
            ocsContainer.innerHTML = ocsTableHTML;
        }

        function handleConsumosFilterChange(event) {
            const type = event.target.dataset.type;
            if (type === 'primary') {
                consumoSelectedGroup = event.target.value;
            } else {
                consumoComparisonSelectedGroup = event.target.value;
            }
            handleConsumosSearch({ target: { value: document.getElementById(`consumo${type === 'primary' ? '' : '-comparison'}-search-input`).value } }, type);
        }

        function handleConsumosFavoritesToggle(event) {
            const type = event.target.dataset.type;
            if (type === 'primary') {
                consumoShowOnlyFavorites = !consumoShowOnlyFavorites;
            } else {
                consumoComparisonShowOnlyFavorites = !consumoComparisonShowOnlyFavorites;
            }
            renderConsumoFilters(type);
            handleConsumosSearch({ target: { value: document.getElementById(`consumo${type === 'primary' ? '' : '-comparison'}-search-input`).value } }, type);
        }

        function handleClearConsumosFilters() {
            selectedConsumptionItemId = null;
            comparisonItemId = null;
            consumoSelectedGroup = 'all';
            consumoShowOnlyFavorites = false;
            consumoComparisonSelectedGroup = 'all';
            consumoComparisonShowOnlyFavorites = false;
            document.getElementById('consumo-search-input').value = '';
            document.getElementById('consumo-search-results').innerHTML = '';
            document.getElementById('consumo-comparison-search-input').value = '';
            document.getElementById('consumo-comparison-search-results').innerHTML = '';
            renderConsumosView();
        }

        function handleConsumosSearch(event, type) {
            const searchTerm = event.target.value.toLowerCase();
            const prefix = type === 'primary' ? '' : '-comparison';
            const resultsContainer = document.getElementById(`consumo${prefix}-search-results`);
            const selectedGroup = type === 'primary' ? consumoSelectedGroup : consumoComparisonSelectedGroup;
            const showFavorites = type === 'primary' ? consumoShowOnlyFavorites : consumoComparisonShowOnlyFavorites;
            
            let filteredItems = items;

            if (selectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === selectedGroup);
            }
            if (showFavorites) {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            }
            if (searchTerm.length >= 2) {
                filteredItems = filteredItems.filter(item => item.name.toLowerCase().includes(searchTerm));
            }

            if (searchTerm.length < 2 && selectedGroup === 'all' && !showFavorites) {
                 resultsContainer.innerHTML = '';
                 return;
            }
            
            if (filteredItems.length > 0) {
                resultsContainer.innerHTML = filteredItems
                    .map(item => `<div class="p-2 hover:bg-gray-100 cursor-pointer" data-item-id="${item.id}" data-type="${type}">${item.name}</div>`)
                    .join('');
            } else {
                resultsContainer.innerHTML = '<div class="p-2 text-gray-500">No se encontraron productos.</div>';
            }
        }

        function handleSelectConsumosItem(event) {
            const target = event.target.closest('[data-item-id]');
            if (target) {
                const { itemId, type } = target.dataset;
                const prefix = type === 'primary' ? '' : '-comparison';
                if (type === 'primary') {
                    selectedConsumptionItemId = itemId;
                } else {
                    comparisonItemId = itemId;
                }
                document.getElementById(`consumo${prefix}-search-input`).value = target.textContent;
                document.getElementById(`consumo${prefix}-search-results`).innerHTML = '';
                renderSingleConsumoPanel(itemId, type);
            }
        }

        // --- LÓGICA DE LA PESTAÑA SOLPEDS Y OCs ---
        function handleSolpedsSort(key) {
            if (solpedsSortConfig.key === key) {
                solpedsSortConfig.direction = solpedsSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                solpedsSortConfig.key = key;
                solpedsSortConfig.direction = 'asc';
            }
            renderSolpedsView();
        }
        function handleOCsSort(key) {
            if (ocsSortConfig.key === key) {
                ocsSortConfig.direction = ocsSortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                ocsSortConfig.key = key;
                ocsSortConfig.direction = 'asc';
            }
            renderOCsView();
        }
        function renderSolpedsView() {
            const container = document.getElementById('solpeds-table-container');
            const searchInput = document.getElementById('solpeds-search-input');
            const delayedFilterBtn = document.getElementById('solpeds-delayed-filter-btn');
            const searchTerm = searchInput.value.toLowerCase();

            delayedFilterBtn.classList.toggle('bg-red-200', showOnlyDelayedSolpeds);
            delayedFilterBtn.classList.toggle('border-red-400', showOnlyDelayedSolpeds);
            delayedFilterBtn.classList.toggle('text-red-800', showOnlyDelayedSolpeds);

            if (solpeds.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No hay datos de Solpeds. Precarga un archivo para visualizarlos.</p>';
                return;
            }

            let filteredSolpeds = solpeds.filter(s => {
                return (s.solicitud.toString().toLowerCase().includes(searchTerm) || 
                        s.cod.toString().toLowerCase().includes(searchTerm) || 
                        s.descripcion.toLowerCase().includes(searchTerm) || 
                        s.creadoPor.toLowerCase().includes(searchTerm) ||
                        (s.grupoDeCompras || '').toLowerCase().includes(searchTerm)
                );
            });

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (showOnlyDelayedSolpeds) {
                filteredSolpeds = filteredSolpeds.filter(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    return releaseDate && releaseDate <= today;
                });
            }

            filteredSolpeds.sort((a, b) => {
                const key = solpedsSortConfig.key;
                const dir = solpedsSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                if (key === 'cantidad') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else if (key === 'fechaSolicitud' || key === 'fechaLiberacion') {
                    valA = parseDateString(valA)?.getTime() || 0;
                    valB = parseDateString(valB)?.getTime() || 0;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });

            if (filteredSolpeds.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No se encontraron resultados para tu búsqueda.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'diasDesdeCreacion', label: 'Días Activa', noSort: true, class: 'text-center' },
                { key: 'creadoPor', label: 'Creado Por' }, { key: 'solicitud', label: 'Solicitud' },
                { key: 'fechaSolicitud', label: 'Fecha Sol.' }, { key: 'status', label: 'Status', noSort: true, class: 'text-center' },
                { key: 'cod', label: 'Código' }, { key: 'descripcion', label: 'Descripción' },
                { key: 'cantidad', label: 'Cantidad', class: 'justify-end' },
                { key: 'grupoDeCompras', label: 'Grupo Compras' },
                { key: 'fechaLiberacion', label: 'Fecha Liberación' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr>`;
            headers.forEach(h => {
                const thClass = `px-4 py-2 ${h.class && !h.noSort ? 'text-left' : h.class || ''}`;
                if (h.noSort) {
                    tableHTML += `<th scope="col" class="${thClass}">${h.label}</th>`;
                } else {
                    tableHTML += `<th scope="col" class="${thClass}"><button class="table-sort-button ${h.class || ''}" data-sort="${h.key}">${h.label}</button></th>`;
                }
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredSolpeds.forEach(s => {
                
                const creationDate = parseDateString(s.fechaSolicitud);
                let daysActive = '';
                if (creationDate) {
                    daysActive = daysBetween(creationDate, today);
                }
                
                const releaseDate = parseDateString(s.fechaLiberacion);
                const isDelayed = releaseDate && releaseDate <= today;
                const rowClass = isDelayed ? 'bg-red-100 hover:bg-red-200 text-red-900' : 'hover:bg-gray-50';
                const dateClass = isDelayed ? 'font-bold' : '';

                tableHTML += `<tr class="border-b ${rowClass}">
                    <td class="px-4 py-2 text-center font-bold">${daysActive}</td>
                    <td class="px-4 py-2">${s.creadoPor}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${s.solicitud}</td>
                    <td class="px-4 py-2">${formatDate(s.fechaSolicitud)}</td>
                    <td class="px-4 py-2 text-center">${s.status}</td>
                    <td class="px-4 py-2">${s.cod}</td>
                    <td class="px-4 py-2">${s.descripcion}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(s.cantidad)}</td>
                    <td class="px-4 py-2">${s.grupoDeCompras || ''}</td>
                    <td class="px-4 py-2 ${dateClass}">${formatDate(s.fechaLiberacion)}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
            const activeButton = container.querySelector(`.table-sort-button[data-sort="${solpedsSortConfig.key}"]`);
            if (activeButton) {
                activeButton.classList.add('active', solpedsSortConfig.direction);
                activeButton.innerHTML += sortIconSVG;
            }
        }

        function renderOCsView() {
            const container = document.getElementById('ocs-table-container');
            const searchInput = document.getElementById('ocs-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const delayedFilterBtn = document.getElementById('ocs-delayed-filter-btn');
            delayedFilterBtn.classList.toggle('bg-red-200', showOnlyDelayedOCs);
            delayedFilterBtn.classList.toggle('border-red-400', showOnlyDelayedOCs);
            delayedFilterBtn.classList.toggle('text-red-800', showOnlyDelayedOCs);

            if (ocs.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No hay datos de Órdenes de Compra. Precarga un archivo para visualizarlos.</p>';
                return;
            }

            let filteredOCs = ocs.filter(oc => {
                return (oc.solped.toString().toLowerCase().includes(searchTerm) || 
                        oc.ordenDeCompra.toString().toLowerCase().includes(searchTerm) || 
                        oc.codigo.toString().toLowerCase().includes(searchTerm) || 
                        oc.denominacion.toLowerCase().includes(searchTerm) ||
                        (oc.grupoDeCompras || '').toLowerCase().includes(searchTerm) ||
                        (oc.status || '').toLowerCase().includes(searchTerm)
                );
            });

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (showOnlyDelayedOCs) {
                filteredOCs = filteredOCs.filter(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    return deliveryDate && deliveryDate < today;
                });
            }
            
            filteredOCs.sort((a, b) => {
                const key = ocsSortConfig.key;
                const dir = ocsSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';

                if (['cantEntregaSiguiente', 'cantPedido', 'posicion'].includes(key)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else if (key === 'proxFechaEntrega') {
                    valA = parseDateString(valA)?.getTime() || 0;
                    valB = parseDateString(valB)?.getTime() || 0;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }
                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });


            if (filteredOCs.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">No se encontraron resultados para tu búsqueda.</p>';
                return;
            }
            
            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'diasParaEntrega', label: 'Días Entrega', noSort: true, class: 'text-center' },
                { key: 'solped', label: 'Solped' }, 
                { key: 'ordenDeCompra', label: 'Orden de Compra' },
                { key: 'posicion', label: 'Pos.' }, 
                { key: 'proxFechaEntrega', label: 'Próx. Entrega' },
                { key: 'codigo', label: 'Código' },
                { key: 'denominacion', label: 'Denominación' }, 
                { key: 'cantEntregaSiguiente', label: 'Cant. Entrega', class: 'justify-end' },
                { key: 'cantPedido', label: 'Cant. Pedido', class: 'justify-end' },
                { key: 'grupoDeCompras', label: 'Grupo Compras' }, { key: 'status', label: 'Status' }
            ];

            let tableHTML = `<table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr>`;
            headers.forEach(h => {
                const thClass = `px-4 py-2 ${h.class && !h.noSort ? 'text-left' : h.class || ''}`;
                tableHTML += `<th scope="col" class="${thClass}"><button class="table-sort-button ${h.class || ''}" data-sort="${h.key}">${h.label}</button></th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            filteredOCs.forEach(oc => {
                const deliveryDate = parseDateString(oc.proxFechaEntrega);
                let daysToDelivery = '';
                let daysClass = '';
                 if (deliveryDate) {
                      const diff = daysBetween(today, deliveryDate);
                      daysToDelivery = diff;
                      if (diff < 0) {
                          daysClass = 'text-red-600'; // Delayed
                      } else if (diff <= 7) {
                          daysClass = 'text-yellow-600'; // Upcoming
                      }
                 }
                const isDelayed = deliveryDate && deliveryDate < today;
                const dateClass = isDelayed ? 'text-red-600 font-bold' : '';

                let rowClass = 'hover:bg-gray-50';
                if (oc.status && oc.status.toLowerCase().includes('en proceso de autorización')) {
                    rowClass = 'bg-yellow-100 hover:bg-yellow-200';
                }
                if (oc.status && oc.status.toLowerCase().includes('rechazado')) {
                    rowClass = 'bg-red-100 hover:bg-red-200 text-red-900';
                }

                tableHTML += `<tr class="border-b ${rowClass}">
                    <td class="px-4 py-2 text-center font-bold ${daysClass}">${daysToDelivery}</td>
                    <td class="px-4 py-2">${oc.solped}</td>
                    <td class="px-4 py-2 font-medium">${oc.ordenDeCompra}</td>
                    <td class="px-4 py-2">${oc.posicion}</td>
                    <td class="px-4 py-2 ${dateClass}">${formatDate(oc.proxFechaEntrega)}</td>
                    <td class="px-4 py-2">${oc.codigo}</td>
                    <td class="px-4 py-2">${oc.denominacion}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatNumber(oc.cantEntregaSiguiente)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(oc.cantPedido)}</td>
                    <td class="px-4 py-2">${oc.grupoDeCompras}</td>
                    <td class="px-4 py-2">${oc.status}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
            
            const activeButton = container.querySelector(`.table-sort-button[data-sort="${ocsSortConfig.key}"]`);
            if (activeButton) {
                activeButton.classList.add('active', ocsSortConfig.direction);
                activeButton.innerHTML += sortIconSVG;
            }
        }

        // --- LÓGICA DE LA PESTAÑA REPORTES ---
        function renderReportesView() {
            renderImmobilizedStockReport();
        }

        function renderImmobilizedStockReport() {
            const container = document.getElementById('immobilized-stock-table-container');
            const searchInput = document.getElementById('immobilized-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            const immobilizationMonths = appSettings.immobilizationMonths;

            let processedItems = getProcessedItems().map(item => {
                let monthsWithoutConsumption = 0;
                if (item.consumos) {
                    for (let i = item.consumos.length - 1; i >= 0; i--) {
                        if (item.consumos[i] === 0) {
                            monthsWithoutConsumption++;
                        } else {
                            break;
                        }
                    }
                }
                return { ...item, monthsWithoutConsumption };
            });
            
            let immobilizedItems = processedItems.filter(item => 
                item.stock > 0 && item.monthsWithoutConsumption >= immobilizationMonths
            );
            
            if(searchTerm) {
                 immobilizedItems = immobilizedItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.group.toLowerCase().includes(searchTerm)
                );
            }

            immobilizedItems.sort((a, b) => {
                const key = immobilizedSortConfig.key;
                const dir = immobilizedSortConfig.direction === 'asc' ? 1 : -1;
                let valA = a[key] ?? '';
                let valB = b[key] ?? '';
                
                if (key === 'stock' || key === 'monthsWithoutConsumption') {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return -1 * dir;
                if (valA > valB) return 1 * dir;
                return 0;
            });
            
            if (immobilizedItems.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-10">No se encontraron insumos con stock inmovilizado por ${immobilizationMonths} o más meses.</p>`;
                return;
            }

            const sortIconSVG = `<svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`;
            const headers = [
                { key: 'group', label: 'Grupo' },
                { key: 'code', label: 'Código' },
                { key: 'name', label: 'Material' },
                { key: 'stock', label: 'Stock Actual', class: 'justify-end' },
                { key: 'monthsWithoutConsumption', label: 'Meses sin Consumo', class: 'justify-end' }
            ];
            
            let tableHTML = `<table class="w-full text-sm text-left text-gray-500"><thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0"><tr>`;
            headers.forEach(h => {
                const thClass = `px-4 py-2 ${h.class || ''}`;
                tableHTML += `<th scope="col" class="${thClass}"><button class="table-sort-button ${h.class || ''}" data-sort="${h.key}">${h.label}</button></th>`;
            });
            tableHTML += `</tr></thead><tbody>`;
            
            immobilizedItems.forEach(item => {
                 tableHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2">${item.group}</td>
                    <td class="px-4 py-2 font-mono">${item.code}</td>
                    <td class="px-4 py-2 font-medium text-gray-900">${item.name.replace(new RegExp(`^${item.code}\\s*`), '')}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatNumber(item.stock)}</td>
                    <td class="px-4 py-2 text-right font-bold text-red-600">${item.monthsWithoutConsumption}</td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;

            const activeButton = container.querySelector(`.table-sort-button[data-sort="${immobilizedSortConfig.key}"]`);
            if (activeButton) {
                activeButton.classList.add('active', immobilizedSortConfig.direction);
                activeButton.innerHTML += sortIconSVG;
            }
        }
        
        // --- LÓGICA DE EXPORTACIÓN ---
        function exportToExcel(data, filename) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Datos');
            XLSX.writeFile(workbook, filename);
            showToast(`Exportado a ${filename}`, 'success');
        }
        function handleExportSolpeds() {
            const searchInput = document.getElementById('solpeds-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            let dataToExport = solpeds.filter(s => 
                (s.solicitud.toString().toLowerCase().includes(searchTerm) || 
                 s.cod.toString().toLowerCase().includes(searchTerm) || 
                 s.descripcion.toLowerCase().includes(searchTerm) || 
                 s.creadoPor.toLowerCase().includes(searchTerm) ||
                 (s.grupoDeCompras || '').toLowerCase().includes(searchTerm))
            );
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (showOnlyDelayedSolpeds) {
                dataToExport = dataToExport.filter(s => {
                    const releaseDate = parseDateString(s.fechaLiberacion);
                    return releaseDate && releaseDate <= today;
                });
            }
            if(dataToExport.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }
            const formattedData = dataToExport.map(s => ({
                'Días Activa': s.fechaSolicitud ? daysBetween(parseDateString(s.fechaSolicitud), today) : '',
                'Creado Por': s.creadoPor,
                'Solicitud': s.solicitud,
                'Fecha Solicitud': formatDate(s.fechaSolicitud),
                'Status': s.status,
                'Código': s.cod,
                'Descripción': s.descripcion,
                'Cantidad': s.cantidad,
                'Grupo Compras': s.grupoDeCompras,
                'Fecha Liberación': formatDate(s.fechaLiberacion)
            }));
            exportToExcel(formattedData, 'solpeds.xlsx');
        }

        function handleExportOCs() {
            const searchInput = document.getElementById('ocs-search-input');
            const searchTerm = searchInput.value.toLowerCase();
            let dataToExport = ocs.filter(oc => 
                (oc.solped.toString().toLowerCase().includes(searchTerm) || 
                 oc.ordenDeCompra.toString().toLowerCase().includes(searchTerm) || 
                 oc.codigo.toString().toLowerCase().includes(searchTerm) || 
                 oc.denominacion.toLowerCase().includes(searchTerm) ||
                 (oc.grupoDeCompras || '').toLowerCase().includes(searchTerm) ||
                 (oc.status || '').toLowerCase().includes(searchTerm))
            );
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (showOnlyDelayedOCs) {
                dataToExport = dataToExport.filter(oc => {
                    const deliveryDate = parseDateString(oc.proxFechaEntrega);
                    return deliveryDate && deliveryDate < today;
                });
            }
            if(dataToExport.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }
            const formattedData = dataToExport.map(oc => ({
                'Días Para Entrega': oc.proxFechaEntrega ? daysBetween(today, parseDateString(oc.proxFechaEntrega)) : '',
                'Solped': oc.solped,
                'Orden de Compra': oc.ordenDeCompra,
                'Posición': oc.posicion,
                'Próxima Entrega': formatDate(oc.proxFechaEntrega),
                'Código': oc.codigo,
                'Denominación': oc.denominacion,
                'Cant. Entrega': oc.cantEntregaSiguiente,
                'Cant. Pedido': oc.cantPedido,
                'Grupo Compras': oc.grupoDeCompras,
                'Status': oc.status
            }));
            exportToExcel(formattedData, 'ordenes_de_compra.xlsx');
        }
        
        function handleExportIndice() {
            let filteredItems = getProcessedItems();

            if (indiceCoverageFilter !== 'all') {
                 filteredItems = filteredItems.filter(item => {
                    const days = item.coverageDays;
                    const { red, yellow } = appSettings.coverageThresholds;
                    if (indiceCoverageFilter === 'red') return days < red;
                    if (indiceCoverageFilter === 'yellow') return days >= red && days <= yellow;
                    if (indiceCoverageFilter === 'green') return days > yellow || days === Infinity;
                    return false;
                });
            }
            if (indiceSelectedGroup !== 'all') {
                filteredItems = filteredItems.filter(item => item.group === indiceSelectedGroup);
            }
            if (indiceShowFavorites) {
                filteredItems = filteredItems.filter(item => item.isFavorite);
            }
            if (indiceSearchTerm) {
                filteredItems = filteredItems.filter(item => item.name.toLowerCase().includes(indiceSearchTerm));
            }

            if (filteredItems.length === 0) {
                showToast('No hay datos para exportar.', 'info');
                return;
            }

            const formattedData = filteredItems.map(item => ({
                'Grupo': item.group,
                'Código': item.code,
                'Material': item.name.replace(new RegExp(`^${item.code}\\s*`), ''),
                'Stock Actual': item.stock,
                'Consumo Mensual': item.monthlyConsumption,
                'Cobertura (Días)': item.coverageDays === Infinity ? 'N/A' : Math.round(item.coverageDays),
                'Notas': item.description_notes || ''
            }));
            exportToExcel(formattedData, 'insumos.xlsx');
        }

        // --- INICIALIZACIÓN ---
        async function initializeAppFlow() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                appId = firebaseConfig.projectId;

                permissionsCollectionRef = collection(db, `artifacts/${appId}/public/data/permissions`);
                
                onAuthStateChanged(auth, async (user) => {
                    if (unsubscribeInventory) unsubscribeInventory();
                    if (unsubscribePermissions) unsubscribePermissions();
                    if (unsubscribeMetadata) unsubscribeMetadata();
                    if (unsubscribeSolpeds) unsubscribeSolpeds();
                    if (unsubscribeOCs) unsubscribeOCs();
                    if (unsubscribeAppConfig) unsubscribeAppConfig();
                    isAuthReady = false;

                    if (user) {
                        userId = user.uid;
                        await checkUserPermissions(user);
                    } else {
                        document.getElementById('app-container').classList.add('hidden');
                        document.getElementById('auth-container').classList.remove('hidden');
                        switchAuthView('login-view');
                    }
                });
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                showToast("No se pudo conectar a la base de datos.", "error");
            }
        }

        async function checkUserPermissions(user) {
            const permissionsDocRef = doc(permissionsCollectionRef, user.uid);
            try {
                const docSnap = await getDoc(permissionsDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentUserRole = data.role || 'viewer';
                    currentUserTags = data.tags || [];
                    isAuthReady = true;
                    
                    document.getElementById('auth-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    adaptUiToRole(currentUserRole, user);
                    activateDataListeners();
                } else {
                    await createInitialPermissions(user);
                    await checkUserPermissions(user);
                }
            } catch (error) {
                console.error("FirebaseError checking permissions:", error);
                showToast("No se pudieron verificar sus permisos de acceso.", "error");
                await signOut(auth);
            }
        }

        async function createInitialPermissions(user) {
            appConfigDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'appConfig');
            const userPermRef = doc(permissionsCollectionRef, user.uid);
            try {
                await runTransaction(db, async (transaction) => {
                    const appConfigDoc = await transaction.get(appConfigDocRef);
                    let role = 'viewer';
                    if (!appConfigDoc.exists() || !appConfigDoc.data().ownerAssigned) {
                        role = 'owner';
                        transaction.set(appConfigDocRef, { ownerAssigned: true, settings: appSettings }, { merge: true });
                    }
                    transaction.set(userPermRef, { 
                        email: user.email, 
                        role: role, 
                        editableGroups: role === 'owner' ? ['*'] : [], 
                        tags: []
                    });
                });
            } catch (error) {
                 console.error("Error creating initial permissions:", error);
                 throw error;
            }
        }

        function activateDataListeners() {
            if (!isAuthReady || !userId) {
                console.warn("Attempted to activate data listeners before auth was ready. Aborting.");
                return;
            }
            if (unsubscribeInventory) unsubscribeInventory();
            if (unsubscribeMetadata) unsubscribeMetadata();
            if (unsubscribeSolpeds) unsubscribeSolpeds();
            if (unsubscribeOCs) unsubscribeOCs();
            if (unsubscribeAppConfig) unsubscribeAppConfig();

            inventoryCollectionRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            reviewHistoryCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/reviewHistory`);
            metadataDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'dataSource');
            solpedsCollectionRef = collection(db, `artifacts/${appId}/public/data/solpeds`);
            ocsCollectionRef = collection(db, `artifacts/${appId}/public/data/ocs`);
            appConfigDocRef = doc(db, `artifacts/${appId}/public/data/metadata`, 'appConfig');
            
            unsubscribeAppConfig = onSnapshot(appConfigDocRef, (snap) => {
                if (snap.exists() && snap.data().settings) {
                    appSettings = { ...appSettings, ...snap.data().settings };
                }
                renderApp(); 
            });

            unsubscribeInventory = onSnapshot(inventoryCollectionRef, (snap) => {
                items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateNotifications();
                renderApp();
            }, (error) => { console.error("Error de permisos:", error); showToast('No tienes permiso para ver el inventario.', 'error'); });
            
            unsubscribeSolpeds = onSnapshot(solpedsCollectionRef, (snap) => {
                solpeds = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'solpeds' || currentView === 'dashboard') {
                    renderApp(); 
                }
            }, (error) => { console.error("Error de permisos en Solpeds:", error); showToast('No tienes permiso para ver las Solpeds.', 'error'); });

            unsubscribeOCs = onSnapshot(ocsCollectionRef, (snap) => {
                ocs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                generateNotifications();
                if (currentView === 'ocs' || currentView === 'dashboard') {
                    renderApp();
                }
            }, (error) => { console.error("Error de permisos en OCs:", error); showToast('No tienes permiso para ver las OCs.', 'error'); });

            unsubscribeMetadata = onSnapshot(metadataDocRef, (docSnap) => {
                const dbInfoContainer = document.getElementById('db-info-container');
                if (dbInfoContainer) {
                    let dbName = "Sin Datos";
                    if (docSnap.exists()) { dbName = docSnap.data().filename.split('.').slice(0, -1).join('.') || docSnap.data().filename; }
                    dbInfoContainer.innerHTML = `<div class="btn-main-style bg-green-100 text-green-800 border-green-200 font-bold text-xs">DB: ${dbName}</div>`;
                }
            });
        }
        

        document.addEventListener('DOMContentLoaded', () => {
            initializeAppFlow();
            
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('register-form')?.addEventListener('submit', handleRegister);
            document.getElementById('show-register-view-btn')?.addEventListener('click', () => switchAuthView('register-view'));
            document.getElementById('show-login-view-btn')?.addEventListener('click', () => switchAuthView('login-view'));
            document.getElementById('main-nav-links')?.addEventListener('click', (e) => { if (e.target.matches('.nav-link')) { switchMainView(e.target.dataset.view); } });
            
            const userMenuButton = document.getElementById('user-menu-button');
            const userDropdown = document.getElementById('user-dropdown-content');
            userMenuButton?.addEventListener('click', (e) => { 
                if (!userMenuButton.disabled) {
                    e.stopPropagation(); 
                    userDropdown.classList.toggle('show'); 
                }
            });
            document.getElementById('logout-button-dropdown')?.addEventListener('click', handleLogout);
            document.getElementById('admin-button-dropdown')?.addEventListener('click', openAdminModal);
            document.getElementById('manual-button-dropdown')?.addEventListener('click', () => document.getElementById('manual-modal').classList.remove('hidden'));
            document.getElementById('close-manual-modal-button')?.addEventListener('click', () => document.getElementById('manual-modal').classList.add('hidden'));

            document.getElementById('notification-bell-btn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('notification-dropdown').classList.toggle('show');
            });
            document.getElementById('notification-dropdown')?.addEventListener('click', (e) => {
                if (e.target.id === 'mark-all-read-btn') {
                    notifications.forEach(n => n.read = true);
                    renderNotifications();
                } else {
                    handleNotificationClick(e);
                }
            });

            document.getElementById('dashboard-view')?.addEventListener('click', (e) => {
                const kpiCard = e.target.closest('.kpi-card');
                if (kpiCard) handleKpiClick(kpiCard.dataset.kpi);
                
                const groupItem = e.target.closest('.group-item-name');
                if (groupItem) {
                    const groupName = groupItem.dataset.groupName;
                    indiceSelectedGroup = groupName;
                    switchMainView('indice');
                }

                const criticalItemDetails = e.target.closest('.low-stock-item-details');
                if (criticalItemDetails) {
                    const itemId = criticalItemDetails.dataset.itemId;
                    selectedConsumptionItemId = itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }

                if (e.target.id === 'low-stock-favorites-filter-btn') {
                    showOnlyFavoriteCriticals = !showOnlyFavoriteCriticals;
                    renderCriticalItemsTable();
                }

                const favBtn = e.target.closest('.favorite-btn[data-btn-type="low-stock-fav"]');
                if(favBtn) {
                    e.stopPropagation();
                    handleToggleFavorite(favBtn.dataset.itemId);
                }
            });

             document.getElementById('dashboard-view')?.addEventListener('input', (e) => {
                if (e.target.id === 'low-stock-search') {
                    renderCriticalItemsTable();
                }
            });

             document.getElementById('dashboard-view')?.addEventListener('change', (e) => {
                if (e.target.id === 'low-stock-group-filter') {
                    criticalsSelectedGroup = e.target.value;
                    renderCriticalItemsTable();
                }
            });

            document.getElementById('save-review-btn')?.addEventListener('click', handleSaveReview);
            document.getElementById('clear-review-btn')?.addEventListener('click', handleClearReview);
            document.getElementById('export-review-btn')?.addEventListener('click', handleExportReview);
            document.getElementById('groups-review-list')?.addEventListener('change', handleReviewCheckboxChange);
            document.getElementById('show-history-btn')?.addEventListener('click', showReviewHistory);
            document.getElementById('close-history-modal-button')?.addEventListener('click', () => document.getElementById('review-history-modal').classList.add('hidden'));

            document.getElementById('indice-view').addEventListener('input', (e) => {
                if(e.target.id === 'indice-search-input') {
                    indiceSearchTerm = e.target.value.toLowerCase();
                    renderIndiceView();
                }
            });
             document.getElementById('indice-view').addEventListener('change', (e) => {
                if(e.target.id === 'indice-group-filter') {
                    indiceSelectedGroup = e.target.value;
                    renderIndiceView();
                }
            });
            document.getElementById('indice-view').addEventListener('click', (e) => {
                const sortBtn = e.target.closest('.table-sort-button');
                if (sortBtn) {
                    const key = sortBtn.dataset.sort;
                    if (indiceSortConfig.key === key) {
                        indiceSortConfig.direction = indiceSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        indiceSortConfig.key = key;
                        indiceSortConfig.direction = 'asc';
                    }
                    renderIndiceView();
                }
                const coverageBtn = e.target.closest('#indice-coverage-filter-buttons button');
                if (coverageBtn) {
                    indiceCoverageFilter = coverageBtn.dataset.filter;
                    renderIndiceView();
                }
                if (e.target.id === 'export-indice-btn') {
                    handleExportIndice();
                }
                if (e.target.id === 'indice-favorites-filter-btn') {
                    indiceShowFavorites = !indiceShowFavorites;
                    renderIndiceView();
                }
                const favBtn = e.target.closest('.favorite-btn[data-btn-type="indice-fav"]');
                if(favBtn) {
                    e.stopPropagation();
                    handleToggleFavorite(favBtn.dataset.itemId);
                }
                const row = e.target.closest('.indice-item-details');
                if(row) {
                    const itemId = row.dataset.itemId;
                    selectedConsumptionItemId = itemId;
                    comparisonItemId = null;
                    switchMainView('consumos');
                }
            });

            document.getElementById('consumos-view').addEventListener('input', (e) => {
                 if (e.target.matches('#consumo-search-input')) handleConsumosSearch(e, 'primary');
                 if (e.target.matches('#consumo-comparison-search-input')) handleConsumosSearch(e, 'comparison');
                 if (e.target.matches('[id^="consumo-description-notes-"]')) handleNotesInput(e);
            });
            document.getElementById('consumos-view')?.addEventListener('click', (e) => {
                if(e.target.closest('#consumo-search-results')) handleSelectConsumosItem(e);
                if(e.target.closest('#consumo-comparison-search-results')) handleSelectConsumosItem(e);
                if(e.target.matches('#consumo-favorites-filter-btn')) handleConsumosFavoritesToggle(e);
                if(e.target.matches('#consumo-comparison-favorites-filter-btn')) handleConsumosFavoritesToggle(e);
                if(e.target.matches('#consumo-clear-filters-btn')) handleClearConsumosFilters();
                const favBtn = e.target.closest('.favorite-btn');
                if (favBtn) {
                    handleToggleFavorite(favBtn.dataset.itemId);
                }
                const solpedLink = e.target.closest('.consumo-solped-link');
                if (solpedLink) {
                    const solpedId = solpedLink.dataset.solpedId;
                    if (solpedId) {
                        switchMainView('solpeds');
                        document.getElementById('solpeds-search-input').value = solpedId;
                        renderSolpedsView();
                    }
                }
                const ocLink = e.target.closest('.consumo-oc-link');
                if (ocLink) {
                    const ocId = ocLink.dataset.ocId;
                    if (ocId) {
                        switchMainView('ocs');
                        document.getElementById('ocs-search-input').value = ocId;
                        renderOCsView();
                    }
                }
            });
            document.getElementById('consumos-view').addEventListener('change', (e) => { if (e.target.matches('.consumo-group-filter')) { handleConsumosFilterChange(e); } });

            document.getElementById('solpeds-search-input')?.addEventListener('input', renderSolpedsView);
            document.getElementById('solpeds-view')?.addEventListener('click', (e) => { 
                const btn = e.target.closest('.table-sort-button'); 
                if (btn) handleSolpedsSort(btn.dataset.sort); 
                if (e.target.id === 'solpeds-delayed-filter-btn') { showOnlyDelayedSolpeds = !showOnlyDelayedSolpeds; renderSolpedsView(); }
                if (e.target.id === 'export-solpeds-btn') { handleExportSolpeds(); }
            });
            
            document.getElementById('ocs-search-input')?.addEventListener('input', renderOCsView);
            document.getElementById('ocs-view')?.addEventListener('click', (e) => { 
                const btn = e.target.closest('.table-sort-button'); 
                if (btn) handleOCsSort(btn.dataset.sort); 
                if (e.target.id === 'ocs-delayed-filter-btn') { showOnlyDelayedOCs = !showOnlyDelayedOCs; renderOCsView(); }
                if (e.target.id === 'export-ocs-btn') { handleExportOCs(); }
            });

            document.getElementById('reportes-view')?.addEventListener('input', (e) => { if (e.target.id === 'immobilized-search-input') { renderImmobilizedStockReport(); } });
            document.getElementById('reportes-view')?.addEventListener('click', (e) => { 
                const btn = e.target.closest('.table-sort-button');
                if (btn) {
                    const key = btn.dataset.sort;
                    if (immobilizedSortConfig.key === key) {
                        immobilizedSortConfig.direction = immobilizedSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        immobilizedSortConfig.key = key;
                        immobilizedSortConfig.direction = 'asc';
                    }
                    renderImmobilizedStockReport();
                }
            });


            document.getElementById('dashboard-preload-btn-dropdown')?.addEventListener('click', handleOpenPreloadModal);
            document.getElementById('dashboard-clear-btn-dropdown')?.addEventListener('click', handleClearAll);
            document.getElementById('close-preload-modal')?.addEventListener('click', handleClosePreloadModal);
            document.getElementById('process-preload-data')?.addEventListener('click', handleProcessPreloadData);
            document.getElementById('preload-file-input')?.addEventListener('change', handleFileInputChange);
            document.getElementById('cancel-clear-button')?.addEventListener('click', () => document.getElementById('confirm-clear-modal').classList.add('hidden'));
            
            document.getElementById('admin-tabs')?.addEventListener('click', (e) => {
                const tab = e.target.dataset.tab;
                if (!tab) return;
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                document.getElementById('admin-content-permissions').classList.toggle('hidden', tab !== 'permissions');
                document.getElementById('admin-content-settings').classList.toggle('hidden', tab !== 'settings');
            });
            document.getElementById('admin-content-permissions')?.addEventListener('change', (e) => {
                if (e.target.matches('.role-select, .groups-input, .tags-input')) {
                    const userId = e.target.dataset.userid;
                    const row = e.target.closest('tr');
                    const role = row.querySelector('.role-select').value;
                    const groups = row.querySelector('.groups-input').value;
                    const tags = row.querySelector('.tags-input').value;
                    updateUserPermissions(userId, role, groups, tags);
                }
            });
            document.getElementById('save-settings-btn')?.addEventListener('click', handleSaveSettings);
            document.getElementById('close-admin-modal-button')?.addEventListener('click', closeAdminModal);
            
            document.getElementById('favorites-group-modal')?.addEventListener('click', (e) => {
                const groupItem = e.target.closest('.favorite-group-item');
                if (groupItem) {
                    const groupName = groupItem.dataset.groupName;
                    switchMainView('consumos');
                    consumoSelectedGroup = groupName;
                    consumoShowOnlyFavorites = true;
                    renderConsumosView();
                    document.getElementById('favorites-group-modal').classList.add('hidden');
                }
            });
            document.getElementById('close-favorites-modal-button')?.addEventListener('click', () => document.getElementById('favorites-group-modal').classList.add('hidden'));

            document.getElementById('record-consumption-modal')?.addEventListener('click', (e) => {
                const itemEl = e.target.closest('.record-consumption-item');
                if (itemEl) {
                    const itemId = itemEl.dataset.itemId;
                    switchMainView('consumos');
                    selectedConsumptionItemId = itemId;
                    renderConsumosView();
                    document.getElementById('record-consumption-modal').classList.add('hidden');
                }
            });
            document.getElementById('close-record-consumption-modal-button')?.addEventListener('click', () => document.getElementById('record-consumption-modal').classList.add('hidden'));

            window.addEventListener('click', (e) => {
                if (!e.target.closest('#notification-container') && !e.target.closest('#user-menu-container')) {
                    document.querySelectorAll('.dropdown-content.show').forEach(d => d.classList.remove('show'));
                }
            });
        });

        function handleNotesInput(e) {
            const itemId = e.target.dataset.itemId;
            if (itemId) {
                if (notesSaveTimeout) clearTimeout(notesSaveTimeout);

                const itemInState = items.find(i => i.id === itemId);
                if (itemInState) itemInState.description_notes = e.target.value;

                notesSaveTimeout = setTimeout(async () => {
                    const notes = e.target.value;
                    const itemRef = doc(inventoryCollectionRef, itemId);
                    try {
                        await updateDoc(itemRef, { description_notes: notes });
                        showToast('Nota guardada.', 'success');
                    } catch (error) {
                        console.error("Error al guardar la nota:", error);
                        showToast('Error al guardar la nota.', 'error');
                    }
                }, 1000); // Debounce for 1 second
            }
        }
    </script>
</body>
</html>



